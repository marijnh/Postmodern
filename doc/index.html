<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-07-12 Fri 09:37 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Postmodern</title>
<meta name="author" content="Sabra Crolleton" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" type="text/css" href="style.css" />
<style>pre.src{background:#343131;color:white;} </style>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Postmodern</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#8993c7bd-4ba2-4080-8c5a-ff90de45eca5">Reference</a></li>
<li><a href="#6887e7c3-c818-469a-b5f1-10a4b578b90b">Dependencies</a></li>
<li><a href="#554e0dee-93b3-47b1-b808-3bd6c366b784">License</a></li>
<li><a href="#6f05b344-12c2-42b0-b231-3aaced30afb8">Download and installation</a></li>
<li><a href="#b5bb7222-8134-4dcb-83b7-f764b7f2bb33">Quickstart</a>
<ul>
<li><a href="#postmodern-connections">Connections</a>
<ul>
<li><a href="#postmodern-connections-single-long-life">Single Long Life Connections With No Multi-threading or Executable Creation</a></li>
<li><a href="#postmodern-connections-multiples">Multiple Connections, Multi-threading or Executable Creation</a></li>
<li><a href="#postmodern-connections-pooling">Pooling Connections</a></li>
</ul>
</li>
<li><a href="#postmodern-basic-queries">Basic Queries</a></li>
<li><a href="#postmodern-dao-classes">DAO Classes</a>
<ul>
<li><a href="#postmodern-define-dao-class-macro">Define-Dao-Class Macro (New to version 1.33.12)</a></li>
</ul>
</li>
<li><a href="#eccad49e-8df8-4451-89ff-4987b103c9dd">Table Creation</a>
<ul>
<li><a href="#7629810d-8ccb-4236-b540-6aff596a042f">With SQL or S-SQL</a></li>
<li><a href="#5129ed89-2ff3-45b4-ae70-41c2c286eacc">With a Previously Created DAO</a></li>
</ul>
</li>
<li><a href="#0b22f6d2-20e4-49cd-a311-083aade58cbf">Inserting Data</a></li>
</ul>
</li>
<li><a href="#b15533d8-efa3-43a9-b632-a3256cea261f">Authentication</a></li>
<li><a href="#e2475974-6131-40ef-9ca3-54bf111a5dd0">Data Types</a>
<ul>
<li><a href="#b850ea6c-b61e-4601-8423-65a8a626cb58">Data Types</a></li>
</ul>
</li>
<li><a href="#passing-binary-parameters">Passing Parameters as Text or Binary</a></li>
<li><a href="#fc095960-ba9d-4a98-ac89-0db7a56777f1">Caveats and to-dos</a>
<ul>
<li><a href="#e5c68251-0ca6-4f96-8d36-175cec626eeb">Timezones and Simple-Date and Local-Time</a>
<ul>
<li><a href="#simple-date-library-use">Simple-Date Library Use</a></li>
<li><a href="#local-time-library-use">Local-Time Library Use</a></li>
</ul>
</li>
<li><a href="#bdf9ddb0-5f95-4807-8862-8970b35bd142">Portability</a></li>
<li><a href="#565fad0b-aef4-497c-92d8-096a0a78c804">Reserved Words</a></li>
<li><a href="#4ac8f5f4-d3b0-41c5-a222-fe3086049279">Things that should be implemented</a></li>
</ul>
</li>
<li><a href="#773ee4ef-a685-484e-bc6a-6daa849a7d04">Resources</a></li>
<li><a href="#844add79-070b-4e89-8797-3bc21ea3173b">Running tests</a></li>
</ul>
</div>
</div>
<p>
Version 1.33.12
</p>

<p>
Postmodern is a Common Lisp library for interacting with <a href="https://postgresql.org">PostgreSQL databases</a>.
Features are:
</p>

<ul class="org-ul">
<li>Efficient communication with the database server without need for foreign libraries.</li>
<li>Support for UTF-8 on Unicode-aware Lisp implementations</li>
<li>A syntax for mixing SQL and Lisp code</li>
<li>Convenient support for prepared statements and stored procedures</li>
<li>A metaclass for simple database-access objects</li>
</ul>

<p>
The biggest differences between this library and <a href="http://quickdocs.org/clsql/">clsql</a> or <a href="https://github.com/fukamachi/cl-dbi">cl-dbi</a>
are that Postmodern has no intention of being portable across different SQL
implementations (it embraces non-standard PostgreSQL features), and approaches
extensions like lispy SQL and database access objects in a quite different way.
This library was written because the CLSQL approach did not really work for
me. Your mileage may vary.
</p>

<div id="outline-container-8993c7bd-4ba2-4080-8c5a-ff90de45eca5" class="outline-2">
<h2 id="8993c7bd-4ba2-4080-8c5a-ff90de45eca5">Reference</h2>
<div class="outline-text-2" id="text-8993c7bd-4ba2-4080-8c5a-ff90de45eca5">
<p>
The reference manuals for the different components of Postmodern are kept
in separate files. For using the library in the most straightforward way,
you only really need to read the Postmodern reference and glance over the
S-SQL reference. The simple-date reference explains the time-related data
types included in Postmodern, and the CL-postgres reference might be useful
if you just want a low-level library for talking to a PostgreSQL server.
</p>

<ul class="org-ul">
<li><a href="postmodern.html">Postmodern</a></li>
<li><a href="s-sql.html">S-SQL</a></li>
<li><a href="simple-date.html">Simple-date</a></li>
<li><a href="cl-postgres.html">CL-postgres</a></li>
</ul>

<p>
Some specific topics in more detail
</p>

<ul class="org-ul">
<li><a href="s-sql-examples.html">S-SQL Examples</a></li>
<li><a href="array-notes.html">Array-Notes</a></li>
<li><a href="create-tables.html">Creating Tables</a></li>
<li><a href="dao-classes.html">Database Access Object (Dao) Classes</a></li>
<li><a href="dynamic-queries.html">Dynamic Queries</a></li>
<li><a href="interval-notes.html">Interval Notes</a></li>
<li><a href="isolation-notes.html">Isolation Notes</a></li>
</ul>
</div>
</div>

<div id="outline-container-6887e7c3-c818-469a-b5f1-10a4b578b90b" class="outline-2">
<h2 id="6887e7c3-c818-469a-b5f1-10a4b578b90b">Dependencies</h2>
<div class="outline-text-2" id="text-6887e7c3-c818-469a-b5f1-10a4b578b90b">
<p>
The library depends on <a href="http://quickdocs.org/usocket/">usocket</a> (except on <a href="http://sbcl.org/">SBCL</a> and <a href="https://franz.com/products/allegrocl/">ACL</a>, where the built-in socket library is used), <a href="https://github.com/pmai/md5.git">md5</a>, <a href="https://github.com/pcostanza/closer-mop.git">closer-mop</a>, <a href="https://github.com/sionescu/bordeaux-threads.git">bordeaux-threads</a> if you want
thread-safe connection pools, and <a href="https://github.com/cl-plus-ssl/cl-plus-ssl.git">CL+SSL</a> when SSL connections are needed.
</p>

<p>
As of version 1.3 it also depends on <a href="https://github.com/sharplispers/ironclad">ironclad</a>, <a href="https://github.com/massung/base64">base64</a> and <a href="https://github.com/sabracrolleton/uax-15">uax-15</a> because of the need to support scram-sha-256 authentication.
</p>

<p>
Postmodern itself is split into four different packages, some of which can be used independently:
</p>

<ul class="org-ul">
<li><a href="simple-date.html">Simple-date</a> is a very basic implementation of date and time objects, used to support storing and retrieving time-related</li>
</ul>
<p>
SQL types. It is not loaded by default and you can use <a href="https://github.com/dlowe-net/local-time">local-time</a> instead.
</p>

<ul class="org-ul">
<li><a href="cl-postgres.html">CL-postgres</a> is the low-level library used for interfacing with a PostgreSQL server over a socket.</li>

<li><a href="s-sql.html">S-SQL</a> is used to compile s-expressions to strings of SQL code, escaping any Lisp values inside, and doing as much as</li>
</ul>
<p>
possible of the work at compile time. Finally,
</p>

<ul class="org-ul">
<li><a href="postmodern.html">Postmodern</a> itself is a wrapper around these packages and provides higher level functions, a very simple data access object that can be mapped directly to database tables and some convient utilities. It then tries to put all these things together into a convenient programming interface.itself is the library that tries to put all these things together into a convenient programming interface.</li>
</ul>
</div>
</div>

<div id="outline-container-554e0dee-93b3-47b1-b808-3bd6c366b784" class="outline-2">
<h2 id="554e0dee-93b3-47b1-b808-3bd6c366b784">License</h2>
<div class="outline-text-2" id="text-554e0dee-93b3-47b1-b808-3bd6c366b784">
<p>
Postmodern is released under a zlib-style license. Which approximately
means you can use the code in whatever way you like, except for passing
it off as your own or releasing a modified version without indication
that it is not the original.
</p>

<p>
The functions execute-file.lisp were ported from <a href="https://github.com/dimitri/pgloader">pgloader</a> with grateful thanks to
Dimitri Fontaine and are released under a BSD-3 license.
</p>
</div>
</div>

<div id="outline-container-6f05b344-12c2-42b0-b231-3aaced30afb8" class="outline-2">
<h2 id="6f05b344-12c2-42b0-b231-3aaced30afb8">Download and installation</h2>
<div class="outline-text-2" id="text-6f05b344-12c2-42b0-b231-3aaced30afb8">
<p>
We suggest using <a href="https://quicklisp.org">quicklisp.org</a> for installation.
</p>

<p>
A git repository with the most recent changes can be viewed or checked out at:
</p>

<p>
&gt; git clone <a href="https://github.com/marijnh/Postmodern">https://github.com/marijnh/Postmodern</a>
</p>
</div>
</div>

<div id="outline-container-b5bb7222-8134-4dcb-83b7-f764b7f2bb33" class="outline-2">
<h2 id="b5bb7222-8134-4dcb-83b7-f764b7f2bb33">Quickstart</h2>
<div class="outline-text-2" id="text-b5bb7222-8134-4dcb-83b7-f764b7f2bb33">
<p>
This quickstart is intended to give you a feel of the way coding with
Postmodern works. Further details about the workings of the library
can be found in the reference manuals linked below.
</p>

<p>
Assuming you have already installed quicklisp, load postmodern.
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>ql:quickload <span style="color: #483d8b;">:postmodern</span><span style="color: #c66;">)</span>
<span style="color: #c66;">(</span>use-package <span style="color: #483d8b;">:postmodern</span><span style="color: #c66;">)</span>
</pre>
</div>
</div>

<div id="outline-container-postmodern-connections" class="outline-3">
<h3 id="postmodern-connections">Connections</h3>
<div class="outline-text-3" id="text-postmodern-connections">
</div>
<div id="outline-container-postmodern-connections-single-long-life" class="outline-4">
<h4 id="postmodern-connections-single-long-life">Single Long Life Connections With No Multi-threading or Executable Creation</h4>
<div class="outline-text-4" id="text-postmodern-connections-single-long-life">
<p>
If you have a PostgreSQL server running on localhost, with a database called 'testdb' on it, which is accessible for user 'foucault' with password 'surveiller', there are two basic ways to connect to a database. If your role/application/database(s) looks like a 1:1 relationship and you are not using threads and you are not going to create an executable, you can connect like this:
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>connect-toplevel <span style="color: #8b2252;">"testdb"</span> <span style="color: #8b2252;">"foucault"</span> <span style="color: #8b2252;">"surveiller"</span> <span style="color: #8b2252;">"localhost"</span><span style="color: #c66;">)</span>
</pre>
</div>

<p>
This will establish a connection to be used by all code, except for that wrapped
in a with-connection form, which takes the same arguments but only establishes
the connection within that lexical scope. This method is often used in development or debugging.
</p>

<p>
Connect-toplevel will maintain a single connection for the life of your running lisp instance.
</p>

<p>
If the server is not on localhost, replace that string with a string containing the ip address of the server:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>connect-toplevel <span style="color: #8b2252;">"testdb"</span> <span style="color: #8b2252;">"foucault"</span> <span style="color: #8b2252;">"surveiller"</span> <span style="color: #8b2252;">"216.27.61.135"</span><span style="color: #c66;">)</span>
</pre>
</div>

<p>
If the Postgresql server is running on a port other than 5432,
you would also pass the appropriate keyword port parameter. E.g.:
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>connect-toplevel <span style="color: #8b2252;">"testdb"</span> <span style="color: #8b2252;">"foucault"</span> <span style="color: #8b2252;">"surveiller"</span> <span style="color: #8b2252;">"localhost"</span> <span style="color: #483d8b;">:port</span> 5434<span style="color: #c66;">)</span>
</pre>
</div>

<p>
Ssl connections would similarly use the keyword parameter :use-ssl and
pass :no, :try, :require, :yes, or :full
</p>

<ul class="org-ul">
<li>:try means if the server supports it</li>
<li>:require means use provided ssl certificate with no verification</li>
<li>:yes means verify that the server cert is issued by a trusted CA, but does not verify the server hostname</li>
<li>:full means expect a CA-signed cert for the supplied hostname and verify the server hostname</li>
</ul>

<p>
When using ssl, you can set the cl-postgres exported variables <code>*ssl-certificate-file*</code>,  <code>*ssl-key-file*</code> and  <code>*ssl-root-ca-file*</code> to provide client key, certificate files
and root ca files. They can be either NIL, for no file, or a pathname.
</p>
</div>
</div>

<div id="outline-container-postmodern-connections-multiples" class="outline-4">
<h4 id="postmodern-connections-multiples">Multiple Connections, Multi-threading or Executable Creation</h4>
<div class="outline-text-4" id="text-postmodern-connections-multiples">
<p>
If you have multiple roles connecting to one or more databases, i.e. 1:many or
many:1, (in other words, changing connections) or you are using threads (each thread must have its own connection) or you are going to create an executable, then you can use the <code>with-connection</code> form which establishes a connection with a lexical scope is more appropriate.
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span><span style="color: #a020f0;">with-connection</span> '<span style="color: #6c6;">(</span><span style="color: #8b2252;">"testdb"</span> <span style="color: #8b2252;">"foucault"</span> <span style="color: #8b2252;">"surveiller"</span> <span style="color: #8b2252;">"localhost"</span><span style="color: #6c6;">)</span>
  ...<span style="color: #c66;">)</span>
</pre>
</div>

<p>
The same additional parameters apply to specifying ports or establishing an ssl connection
</p>

<p>
For other connection options, please see <a href="https://marijnhaverbeke.nl/postmodern.html#function-connection">https://marijnhaverbeke.nl/postmodern.html#function-connection</a>
</p>

<p>
If you are creating a database, you need to have established a connection
to a currently existing database (typically "postgres"). Assuming the foucault role
is a superuser and you want to stay in a development connection with your new database afterwards, you would first use with-connection to connect to postgres, create the database and then switch to connect-toplevel for development ease.
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span><span style="color: #a020f0;">with-connection</span> '<span style="color: #6c6;">(</span><span style="color: #8b2252;">"postgres"</span> <span style="color: #8b2252;">"foucault"</span> <span style="color: #8b2252;">"surveiller"</span> <span style="color: #8b2252;">"localhost"</span><span style="color: #6c6;">)</span>
  <span style="color: #6c6;">(</span>create-database 'testdb <span style="color: #483d8b;">:limit-public-access</span> t
                     <span style="color: #483d8b;">:comment</span> <span style="color: #8b2252;">"This database is for testing silly theories"</span><span style="color: #6c6;">)</span><span style="color: #c66;">)</span>

<span style="color: #c66;">(</span>connect-toplevel <span style="color: #8b2252;">"testdb"</span> <span style="color: #8b2252;">"foucault"</span> <span style="color: #8b2252;">"surveiller"</span> <span style="color: #8b2252;">"localhost"</span><span style="color: #c66;">)</span>
</pre>
</div>
<p>
Note: (create-database) functionality is new to postmodern v. 1.32. Setting the
:limit-public-access parameter to t will block connections to that database from
anyone who you have not explicitly given permission (except other superusers).
</p>
</div>
</div>

<div id="outline-container-postmodern-connections-pooling" class="outline-4">
<h4 id="postmodern-connections-pooling">Pooling Connections</h4>
<div class="outline-text-4" id="text-postmodern-connections-pooling">
<p>
A word about Postgresql connections. Postgresql connections are not lightweight
threads. They actually consume about 10 MB of memory per connection. In addition, any connections which require security (ssl or scram authentication) will take additiona time and create more overhead.
</p>

<p>
Postgresql can be tuned to limit the number of connections allowed at any one time. It defaults to 100. The parameter is set in the postgresql.conf file. Depending on the size of your server and what you are doing, the sweet spot generally seems to be between 200-400 connections before you need to bring in connection pooling.
</p>

<p>
If your application is threaded, each thread should use its own connection. Connections are stateful and attempts to use the same connection for multiple threads will likely have problems.
</p>

<p>
If you have an application like a web app which will make many connections, you also
generally do not want to create and drop connections for every query. The usual solution
is to use connection pools so that the application is grabbing an already existing connection
and returning it to the pool when finished, saving connection time and memory.
</p>

<p>
To use postmodern's simple connection pooler, the <code>with-connection</code> call would look like:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span><span style="color: #a020f0;">with-connection</span> '<span style="color: #6c6;">(</span><span style="color: #8b2252;">"testdb"</span> <span style="color: #8b2252;">"foucault"</span> <span style="color: #8b2252;">"surveiller"</span> <span style="color: #8b2252;">"localhost"</span> <span style="color: #483d8b;">:pooled-p</span> t<span style="color: #6c6;">)</span>
      ...<span style="color: #c66;">)</span>
</pre>
</div>

<p>
The maximum number of connections in the pool is set in the special variable
<code>*max-pool-size*</code>, which defaults to nil (no maximum).
</p>
</div>
</div>
</div>

<div id="outline-container-postmodern-basic-queries" class="outline-3">
<h3 id="postmodern-basic-queries">Basic Queries</h3>
<div class="outline-text-3" id="text-postmodern-basic-queries">
<p>
Now for a basic sanity test which does not need a database connection at all:
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span><span style="color: #a020f0;">with-connection</span> '<span style="color: #6c6;">(</span><span style="color: #8b2252;">"testdb"</span> <span style="color: #8b2252;">"foucault"</span> <span style="color: #8b2252;">"surveiller"</span> <span style="color: #8b2252;">"localhost"</span><span style="color: #6c6;">)</span>
    <span style="color: #6c6;">(</span>query <span style="color: #8b2252;">"select 22, 'Folie et d&#233;raison', 4.5"</span><span style="color: #6c6;">)</span><span style="color: #c66;">)</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">=&gt; ((22 "Folie et d&#233;raison" 9/2))</span>
</pre>
</div>
<p>
Query is the basic way to send queries to the database. Please see <a href="postmodern.html#querying">the documentation for query</a> for details on return types, parameterized queries, etc.
</p>

<p>
The same query can be expressed in s-sql like this:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>query <span style="color: #6c6;">(</span><span style="color: #483d8b;">:select</span> 22 <span style="color: #8b2252;">"Folie et d&#233;raison"</span> 4.5<span style="color: #6c6;">)</span><span style="color: #c66;">)</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">=&gt; ((22 "Folie et d&#233;raison" 9/2))</span>
</pre>
</div>

<p>
In many contexts, query strings and lists starting with keywords can be used
interchangeably. The lists will be compiled to SQL. The <a href="s-sql.html">S-SQL manual</a> describes
the syntax used by these expressions and provides many examples. Lisp values occurring in them are
automatically escaped. In the above query, only constant values are used, but
it is possible to transparently use run-time values as well:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span><span style="color: #a020f0;">defun</span> <span style="color: #0000ff;">database-powered-addition</span> <span style="color: #6c6;">(</span>a b<span style="color: #6c6;">)</span>
  <span style="color: #6c6;">(</span>query <span style="color: #69f;">(</span><span style="color: #483d8b;">:select</span> <span style="color: #cc6;">(</span><span style="color: #483d8b;">:+</span> a b<span style="color: #cc6;">)</span><span style="color: #69f;">)</span> <span style="color: #483d8b;">:single</span><span style="color: #6c6;">)</span><span style="color: #c66;">)</span>

<span style="color: #c66;">(</span>database-powered-addition 1030 204<span style="color: #c66;">)</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">=&gt; 1234</span>
</pre>
</div>

<p>
That last argument, :single, indicates that we want the result not as a list
of lists (for the result rows), but as a single value, since we know that we
are only selecting one value. Some other options are :rows, :row, :column, :alists,
:plists, :array-hash, :json-strs, :json-str, :json-array-str, :dao, :vectors and :none.
These, and others, and their precise effect is documented in the <a href="postmodern.html">Postmodern reference manual</a> under <a href="postmodern.html#querying">Queries</a>
</p>

<p>
You do not have to pull in the whole result of a query at once, you can
also iterate over it with the doquery macro:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>doquery <span style="color: #6c6;">(</span><span style="color: #483d8b;">:select</span> 'x 'y <span style="color: #483d8b;">:from</span> 'some-imaginary-table<span style="color: #6c6;">)</span> <span style="color: #6c6;">(</span>x y<span style="color: #6c6;">)</span>
  <span style="color: #6c6;">(</span>format t <span style="color: #8b2252;">"On this row, x = ~A and y = ~A.~%"</span> x y<span style="color: #6c6;">)</span><span style="color: #c66;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-postmodern-dao-classes" class="outline-3">
<h3 id="postmodern-dao-classes">DAO Classes</h3>
<div class="outline-text-3" id="text-postmodern-dao-classes">
<p>
You can work directly with the database or you can use a simple
database-access-class (aka dao) which would cover all the fields in a row.
This is what a database-access class looks like:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span><span style="color: #a020f0;">defclass</span> <span style="color: #228b22;">country</span> <span style="color: #6c6;">()</span>
  <span style="color: #6c6;">(</span><span style="color: #69f;">(</span>name <span style="color: #483d8b;">:col-type</span> string <span style="color: #483d8b;">:initarg</span> <span style="color: #483d8b;">:name</span>
         <span style="color: #483d8b;">:reader</span> country-name<span style="color: #69f;">)</span>
   <span style="color: #69f;">(</span>inhabitants <span style="color: #483d8b;">:col-type</span> integer <span style="color: #483d8b;">:initarg</span> <span style="color: #483d8b;">:inhabitants</span>
                <span style="color: #483d8b;">:accessor</span> country-inhabitants<span style="color: #69f;">)</span>
   <span style="color: #69f;">(</span>sovereign <span style="color: #483d8b;">:col-type</span> <span style="color: #cc6;">(</span>or db-null string<span style="color: #cc6;">)</span> <span style="color: #483d8b;">:initarg</span> <span style="color: #483d8b;">:sovereign</span>
              <span style="color: #483d8b;">:accessor</span> country-sovereign<span style="color: #69f;">)</span><span style="color: #6c6;">)</span>
  <span style="color: #6c6;">(</span><span style="color: #483d8b;">:metaclass</span> dao-class<span style="color: #6c6;">)</span>
  <span style="color: #6c6;">(</span><span style="color: #483d8b;">:keys</span> name<span style="color: #6c6;">)</span><span style="color: #c66;">)</span>
</pre>
</div>
<p>
The above defines a class that can be used to handle records in a table named
'country' with three columns: name, inhabitants, and sovereign. The :keys
parameter specifies which column(s) are used for the primary key. Once you have
created the class, you can return an instance of the country class by calling
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>get-dao 'country <span style="color: #8b2252;">"Croatia"</span><span style="color: #c66;">)</span>
</pre>
</div>

<p>
You can also define classes that use multiple columns in the primary key:
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span><span style="color: #a020f0;">defclass</span> <span style="color: #228b22;">points</span> <span style="color: #6c6;">()</span>
  <span style="color: #6c6;">(</span><span style="color: #69f;">(</span>x <span style="color: #483d8b;">:col-type</span> integer <span style="color: #483d8b;">:initarg</span> <span style="color: #483d8b;">:x</span>
      <span style="color: #483d8b;">:reader</span> point-x<span style="color: #69f;">)</span>
   <span style="color: #69f;">(</span>y <span style="color: #483d8b;">:col-type</span> integer <span style="color: #483d8b;">:initarg</span> <span style="color: #483d8b;">:y</span>
      <span style="color: #483d8b;">:reader</span> point-y<span style="color: #69f;">)</span>
   <span style="color: #69f;">(</span>value <span style="color: #483d8b;">:col-type</span> integer <span style="color: #483d8b;">:initarg</span> <span style="color: #483d8b;">:value</span>
          <span style="color: #483d8b;">:accessor</span> value<span style="color: #69f;">)</span><span style="color: #6c6;">)</span>
  <span style="color: #6c6;">(</span><span style="color: #483d8b;">:metaclass</span> dao-class<span style="color: #6c6;">)</span>
  <span style="color: #6c6;">(</span><span style="color: #483d8b;">:keys</span> x y<span style="color: #6c6;">)</span><span style="color: #c66;">)</span>
</pre>
</div>

<p>
In this case, retrieving a points record would look like the following where
12 and 34 would be the values you are looking to find in the x column and y
column respectively.:
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>get-dao 'points 12 34<span style="color: #c66;">)</span>
</pre>
</div>

<p>
Consider a slightly more complicated version of country:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span><span style="color: #a020f0;">defclass</span> <span style="color: #228b22;">country-c</span> <span style="color: #6c6;">()</span>
  <span style="color: #6c6;">(</span><span style="color: #69f;">(</span>id <span style="color: #483d8b;">:col-type</span> integer <span style="color: #483d8b;">:col-identity</span> t <span style="color: #483d8b;">:accessor</span> id<span style="color: #69f;">)</span>
   <span style="color: #69f;">(</span>name <span style="color: #483d8b;">:col-type</span> string <span style="color: #483d8b;">:col-unique</span> t <span style="color: #483d8b;">:check</span> <span style="color: #cc6;">(</span><span style="color: #483d8b;">:&lt;&gt;</span> 'name <span style="color: #8b2252;">""</span><span style="color: #cc6;">)</span>
         <span style="color: #483d8b;">:initarg</span> <span style="color: #483d8b;">:name</span> <span style="color: #483d8b;">:reader</span> country-name<span style="color: #69f;">)</span>
   <span style="color: #69f;">(</span>inhabitants <span style="color: #483d8b;">:col-type</span> integer <span style="color: #483d8b;">:initarg</span> <span style="color: #483d8b;">:inhabitants</span>
                <span style="color: #483d8b;">:accessor</span> country-inhabitants<span style="color: #69f;">)</span>
   <span style="color: #69f;">(</span>sovereign <span style="color: #483d8b;">:col-type</span> <span style="color: #cc6;">(</span>or db-null string<span style="color: #cc6;">)</span> <span style="color: #483d8b;">:initarg</span> <span style="color: #483d8b;">:sovereign</span>
              <span style="color: #483d8b;">:accessor</span> country-sovereign<span style="color: #69f;">)</span>
   <span style="color: #69f;">(</span>region-id <span style="color: #483d8b;">:col-type</span> integer <span style="color: #483d8b;">:col-references</span> <span style="color: #cc6;">(</span><span style="color: #6cc;">(</span>regions id<span style="color: #6cc;">)</span><span style="color: #cc6;">)</span>
              <span style="color: #483d8b;">:initarg</span> <span style="color: #483d8b;">:region-id</span> <span style="color: #483d8b;">:accessor</span> region-id<span style="color: #69f;">)</span><span style="color: #6c6;">)</span>
  <span style="color: #6c6;">(</span><span style="color: #483d8b;">:metaclass</span> dao-class<span style="color: #6c6;">)</span>
  <span style="color: #6c6;">(</span><span style="color: #483d8b;">:table-name</span> countries<span style="color: #6c6;">)</span><span style="color: #c66;">)</span>
</pre>
</div>

<p>
In this example we have an id column which is specified to be an identity column.
Postgresql will automatically generate a sequence of of integers and this will
be the primary key.
</p>

<p>
We have a name column which is specified as unique and is not null and the
check will ensure that the database refuses to accept an empty string as the name.
</p>

<p>
We have a region-id column which references the id column in the regions table.
This is a foreign key constraint and Postgresql will not accept inserting a country
into the database unless there is an existing region with an id that matches this
number. Postgresql will also not allow deleting a region if there are countries
that reference that region's id. If we wanted Postgresql to delete countries when
regions are deleted, that column would be specified as:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>region-id <span style="color: #483d8b;">:col-type</span> integer <span style="color: #483d8b;">:col-references</span> <span style="color: #6c6;">(</span><span style="color: #69f;">(</span>regions id<span style="color: #69f;">)</span> <span style="color: #483d8b;">:cascade</span><span style="color: #6c6;">)</span>
  <span style="color: #483d8b;">:initarg</span> <span style="color: #483d8b;">:region-id</span> <span style="color: #483d8b;">:accessor</span> region-id<span style="color: #c66;">)</span>
</pre>
</div>

<p>
Now you can see why the double parens.
</p>

<p>
We also specify that the table name is not "country" but "countries". (Some style guides recommend that table names be plural and references to rows be singular.)
</p>

<p>
More detailed information on DAO classes is found here: <a href="dao-classes.html">Database Access Object (Dao) Classes</a>
</p>
</div>

<div id="outline-container-postmodern-define-dao-class-macro" class="outline-4">
<h4 id="postmodern-define-dao-class-macro">Define-Dao-Class Macro (New to version 1.33.12)</h4>
<div class="outline-text-4" id="text-postmodern-define-dao-class-macro">
<p>
New to Postmodern version 1.33.12 (thank you Killianmh) is a macro that makes defining a dao class slightly easier. It is like defclass except two postmodern specific changes:
</p>
<ol class="org-ol">
<li>The dao-class metaclass options is automatically added.</li>
<li>If second value in a slot is not a keyword, it is assumed to be col-type.</li>
</ol>
<p>
Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>define-dao-class id-class <span style="color: #6c6;">()</span>
<span style="color: #6c6;">(</span><span style="color: #69f;">(</span>id integer <span style="color: #483d8b;">:initarg</span> <span style="color: #483d8b;">:id</span> <span style="color: #483d8b;">:accessor</span> test-id<span style="color: #69f;">)</span>
 <span style="color: #69f;">(</span>email <span style="color: #483d8b;">:col-type</span> text <span style="color: #483d8b;">:initarg</span> <span style="color: #483d8b;">:email</span> <span style="color: #483d8b;">:accessor</span> email<span style="color: #69f;">)</span><span style="color: #6c6;">)</span>
<span style="color: #6c6;">(</span><span style="color: #483d8b;">:keys</span> id<span style="color: #6c6;">)</span><span style="color: #c66;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-eccad49e-8df8-4451-89ff-4987b103c9dd" class="outline-3">
<h3 id="eccad49e-8df8-4451-89ff-4987b103c9dd">Table Creation</h3>
<div class="outline-text-3" id="text-eccad49e-8df8-4451-89ff-4987b103c9dd">
</div>
<div id="outline-container-7629810d-8ccb-4236-b540-6aff596a042f" class="outline-4">
<h4 id="7629810d-8ccb-4236-b540-6aff596a042f">With SQL or S-SQL</h4>
<div class="outline-text-4" id="text-7629810d-8ccb-4236-b540-6aff596a042f">
<p>
You can create tables directly without the need to define a class, and in more
complicated cases, you may need to use the s-sql :create-table operator or plain
vanilla sql. Staying with examples that will match our slightly more complicated
dao-class above (but ignoring the fact that the references parameter would
actually require us to create the regions table first) and using s-sql rather
than plain vanilla sql would be the following:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>query <span style="color: #6c6;">(</span><span style="color: #483d8b;">:create-table</span> 'countries
      <span style="color: #69f;">(</span><span style="color: #cc6;">(</span>id <span style="color: #483d8b;">:type</span> integer  <span style="color: #483d8b;">:primary-key</span> t <span style="color: #483d8b;">:identity-always</span> t<span style="color: #cc6;">)</span>
       <span style="color: #cc6;">(</span>name <span style="color: #483d8b;">:type</span> string <span style="color: #483d8b;">:unique</span> t <span style="color: #483d8b;">:check</span> <span style="color: #6cc;">(</span><span style="color: #483d8b;">:&lt;&gt;</span> 'name <span style="color: #8b2252;">""</span><span style="color: #6cc;">)</span><span style="color: #cc6;">)</span>
       <span style="color: #cc6;">(</span>inhabitants <span style="color: #483d8b;">:type</span> integer<span style="color: #cc6;">)</span>
       <span style="color: #cc6;">(</span>sovereign <span style="color: #483d8b;">:type</span> <span style="color: #6cc;">(</span>or db-null string<span style="color: #6cc;">)</span><span style="color: #cc6;">)</span>
       <span style="color: #cc6;">(</span>region-id <span style="color: #483d8b;">:type</span> integer <span style="color: #483d8b;">:references</span> <span style="color: #6cc;">(</span><span style="color: #c6c;">(</span>regions id<span style="color: #c6c;">)</span><span style="color: #6cc;">)</span><span style="color: #cc6;">)</span><span style="color: #69f;">)</span><span style="color: #6c6;">)</span><span style="color: #c66;">)</span>
</pre>
</div>

<p>
Restated using vanilla sql:
</p>
<div class="org-src-container">
<pre class="src src-sql">(query "<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> countries (
           id <span style="color: #228b22;">INTEGER</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span> <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> <span style="color: #a020f0;">GENERATED</span> ALWAYS <span style="color: #a020f0;">AS</span> <span style="color: #a020f0;">IDENTITY</span>,
           <span style="color: #a020f0;">name</span> TEXT <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span> <span style="color: #a020f0;">UNIQUE</span> <span style="color: #a020f0;">CHECK</span> (<span style="color: #a020f0;">NAME</span> &lt;&gt; E<span style="color: #8b2252;">''</span>),
           inhabitants <span style="color: #228b22;">INTEGER</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
           sovereign TEXT,
           region_id <span style="color: #228b22;">INTEGER</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span> <span style="color: #a020f0;">REFERENCES</span> regions(id)
             <span style="color: #a020f0;">MATCH</span> <span style="color: #a020f0;">SIMPLE</span> <span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">DELETE</span> <span style="color: #a020f0;">RESTRICT</span> <span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">UPDATE</span> <span style="color: #a020f0;">RESTRICT</span>)")
</pre>
</div>
<p>
Let's look at a slightly different example:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>query <span style="color: #6c6;">(</span><span style="color: #483d8b;">:create-table</span> so-items
         <span style="color: #69f;">(</span><span style="color: #cc6;">(</span>item-id <span style="color: #483d8b;">:type</span> integer<span style="color: #cc6;">)</span>
          <span style="color: #cc6;">(</span>so-id <span style="color: #483d8b;">:type</span> <span style="color: #6cc;">(</span>or integer db-null<span style="color: #6cc;">)</span> <span style="color: #483d8b;">:references</span> <span style="color: #6cc;">(</span><span style="color: #c6c;">(</span>so-headers id<span style="color: #c6c;">)</span><span style="color: #6cc;">)</span><span style="color: #cc6;">)</span>
          <span style="color: #cc6;">(</span>product-id <span style="color: #483d8b;">:type</span> <span style="color: #6cc;">(</span>or integer db-null<span style="color: #6cc;">)</span><span style="color: #cc6;">)</span>
          <span style="color: #cc6;">(</span>qty <span style="color: #483d8b;">:type</span> <span style="color: #6cc;">(</span>or integer db-null<span style="color: #6cc;">)</span><span style="color: #cc6;">)</span>
          <span style="color: #cc6;">(</span>net-price <span style="color: #483d8b;">:type</span> <span style="color: #6cc;">(</span>or numeric db-null<span style="color: #6cc;">)</span><span style="color: #cc6;">)</span><span style="color: #69f;">)</span>
         <span style="color: #69f;">(</span><span style="color: #483d8b;">:primary-key</span> item-id so-id<span style="color: #69f;">)</span><span style="color: #6c6;">)</span><span style="color: #c66;">)</span>
</pre>
</div>

<p>
Restated using plain sql:
</p>
<div class="org-src-container">
<pre class="src src-sql">(query "<span style="color: #a020f0;">CREATE</span> <span style="color: #a020f0;">TABLE</span> so_items (
           item_id <span style="color: #228b22;">INTEGER</span> <span style="color: #a020f0;">NOT</span> <span style="color: #a020f0;">NULL</span>,
           so_id <span style="color: #228b22;">INTEGER</span> <span style="color: #a020f0;">REFERENCES</span> so_headers(id)
                 <span style="color: #a020f0;">MATCH</span> <span style="color: #a020f0;">SIMPLE</span> <span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">DELETE</span> <span style="color: #a020f0;">RESTRICT</span> <span style="color: #a020f0;">ON</span> <span style="color: #a020f0;">UPDATE</span> <span style="color: #a020f0;">RESTRICT</span>,
           product_id <span style="color: #228b22;">INTEGER</span>,
           qty <span style="color: #228b22;">INTEGER</span>,
           net_price <span style="color: #228b22;">NUMERIC</span>,
           <span style="color: #a020f0;">PRIMARY</span> <span style="color: #a020f0;">KEY</span> (item_id, so_id)
     );")
</pre>
</div>
<p>
In the above case, the new table's name will be so_items because sql does not
allow hyphens and plain vanilla sql will require that. Postmodern will
generally allow you to use the quoted symbol 'so-items. This is also true for
all the column names. The column item-id is an integer and cannot be null. The
column so-id is also an integer, but is allowed to be null and is a foreign key
to the id field in the so-headers table so-headers. The primary key is actually
a composite of item-id and so-id. (If we wanted the primary key to be just
item-id, we could have specified that in the form defining item-id.)
</p>

<p>
For more detail and examples on building tables using the s-sql approach,
see <a href="create-tables.html">create-tables.html</a>
</p>
</div>
</div>

<div id="outline-container-5129ed89-2ff3-45b4-ae70-41c2c286eacc" class="outline-4">
<h4 id="5129ed89-2ff3-45b4-ae70-41c2c286eacc">With a Previously Created DAO</h4>
<div class="outline-text-4" id="text-5129ed89-2ff3-45b4-ae70-41c2c286eacc">
<p>
You can also use a previously defined dao to create a table as well. The
dao-table-definition function examines a dao class and generates the plain vanilla
sql for creating a table. That can be passed on to the execute function to create
a table. For example the simple country dao would generate:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>dao-table-definition 'country<span style="color: #c66;">)</span>

<span style="color: #8b2252;">"CREATE TABLE country</span>
<span style="color: #8b2252;">  (name TEXT NOT NULL,</span>
<span style="color: #8b2252;">   inhabitants INTEGER NOT NULL,</span>
<span style="color: #8b2252;">   sovereign TEXT DEFAULT NULL,</span>
<span style="color: #8b2252;">  PRIMARY KEY (name))"</span>

<span style="color: #c66;">(</span>execute <span style="color: #6c6;">(</span>dao-table-definition 'country<span style="color: #6c6;">)</span><span style="color: #c66;">)</span>
</pre>
</div>
<p>
(Execute works like query, but does not expect any results back.)
</p>

<p>
The slightly more complicated country-c version would generate:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>dao-table-definition 'country-c<span style="color: #c66;">)</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">=&gt; "CREATE TABLE countries (</span>
<span style="color: #b22222;">;;       </span><span style="color: #b22222;">id INTEGER NOT NULL PRIMARY KEY generated always as identity,</span>
<span style="color: #b22222;">;;       </span><span style="color: #b22222;">name TEXT NOT NULL UNIQUE,</span>
<span style="color: #b22222;">;;       </span><span style="color: #b22222;">inhabitants INTEGER NOT NULL,</span>
<span style="color: #b22222;">;;       </span><span style="color: #b22222;">sovereign TEXT DEFAULT NULL,</span>
<span style="color: #b22222;">;;       </span><span style="color: #b22222;">region_id INTEGER NOT NULL REFERENCES regions(id)</span>
<span style="color: #b22222;">;;         </span><span style="color: #b22222;">MATCH SIMPLE ON DELETE RESTRICT ON UPDATE RESTRICT)</span>

<span style="color: #c66;">(</span>execute <span style="color: #6c6;">(</span>dao-table-definition 'country-c<span style="color: #6c6;">)</span><span style="color: #c66;">)</span>
</pre>
</div>
<p>
For the rest of the discussion on this page, we will use the simpler version
and save the more complicated version for the <a href="postmodern.html">postmodern</a> manuals.
</p>
</div>
</div>
</div>

<div id="outline-container-0b22f6d2-20e4-49cd-a311-083aade58cbf" class="outline-3">
<h3 id="0b22f6d2-20e4-49cd-a311-083aade58cbf">Inserting Data</h3>
<div class="outline-text-3" id="text-0b22f6d2-20e4-49cd-a311-083aade58cbf">
<p>
Similarly to table creation, you can insert data using the s-sql wrapper, plain
vanilla sql or daos.
</p>

<p>
The s-sql approach would be:
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>query <span style="color: #6c6;">(</span><span style="color: #483d8b;">:insert-into</span> 'country <span style="color: #483d8b;">:set</span> 'name <span style="color: #8b2252;">"The Netherlands"</span>
                                   'inhabitants 16800000
                                   'sovereign <span style="color: #8b2252;">"Willem-Alexander"</span><span style="color: #6c6;">)</span><span style="color: #c66;">)</span>

<span style="color: #c66;">(</span>query <span style="color: #6c6;">(</span><span style="color: #483d8b;">:insert-into</span> 'country <span style="color: #483d8b;">:set</span> 'name <span style="color: #8b2252;">"Croatia"</span>
                                   'inhabitants 4400000<span style="color: #6c6;">)</span><span style="color: #c66;">)</span>
</pre>
</div>

<p>
You could also insert multiple rows at a time but that requires the same columns for each row:
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>query <span style="color: #6c6;">(</span><span style="color: #483d8b;">:insert-rows-into</span> 'country <span style="color: #483d8b;">:columns</span> 'name 'inhabitants 'sovereign
                                   <span style="color: #483d8b;">:values</span> '<span style="color: #69f;">(</span><span style="color: #cc6;">(</span><span style="color: #8b2252;">"The Netherlands"</span> 16800000 <span style="color: #8b2252;">"Willem-Alexander"</span><span style="color: #cc6;">)</span>
                                             <span style="color: #cc6;">(</span><span style="color: #8b2252;">"Croatia"</span> 4400000 <span style="color: #483d8b;">:null</span><span style="color: #cc6;">)</span><span style="color: #69f;">)</span><span style="color: #6c6;">)</span><span style="color: #c66;">)</span>
</pre>
</div>

<p>
The sql approach would be:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>query <span style="color: #8b2252;">"insert into country (name, inhabitants, sovereign)</span>
<span style="color: #8b2252;">                            values ('The Netherlands', 16800000, 'Willem-Alexander')"</span><span style="color: #c66;">)</span>

<span style="color: #c66;">(</span>query <span style="color: #8b2252;">"insert into country (name, inhabitants)</span>
<span style="color: #8b2252;">                            values ('Croatia', 4400000)"</span><span style="color: #c66;">)</span>
</pre>
</div>

<p>
The multiple row sql approach would be:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>query <span style="color: #8b2252;">"insert into country (name, inhabitants, sovereign)</span>
<span style="color: #8b2252;">                            values</span>
<span style="color: #8b2252;">                              ('The Netherlands', 16800000, 'Willem-Alexander'),</span>
<span style="color: #8b2252;">                              ('Croatia', 4400000, NULL)"</span><span style="color: #c66;">)</span>
</pre>
</div>

<p>
Using dao classes would look like:
Let us go back to our approach using a dao class and add a few countries:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>insert-dao <span style="color: #6c6;">(</span>make-instance 'country <span style="color: #483d8b;">:name</span> <span style="color: #8b2252;">"The Netherlands"</span>
                                    <span style="color: #483d8b;">:inhabitants</span> 16800000
                                    <span style="color: #483d8b;">:sovereign</span> <span style="color: #8b2252;">"Willem-Alexander"</span><span style="color: #6c6;">)</span><span style="color: #c66;">)</span>
<span style="color: #c66;">(</span>insert-dao <span style="color: #6c6;">(</span>make-instance 'country <span style="color: #483d8b;">:name</span> <span style="color: #8b2252;">"Croatia"</span>
                                    <span style="color: #483d8b;">:inhabitants</span> 4400000<span style="color: #6c6;">)</span><span style="color: #c66;">)</span>
</pre>
</div>
<p>
Postmodern does not yet have an insert-daos (plural) function.
</p>

<p>
Staying with the dao class approach, to update Croatia's population, we could do this:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span><span style="color: #a020f0;">let</span> <span style="color: #6c6;">(</span><span style="color: #69f;">(</span>croatia <span style="color: #cc6;">(</span>get-dao 'country <span style="color: #8b2252;">"Croatia"</span><span style="color: #cc6;">)</span><span style="color: #69f;">)</span><span style="color: #6c6;">)</span>
  <span style="color: #6c6;">(</span>setf <span style="color: #69f;">(</span>country-inhabitants croatia<span style="color: #69f;">)</span> 4500000<span style="color: #6c6;">)</span>
  <span style="color: #6c6;">(</span>update-dao croatia<span style="color: #6c6;">)</span><span style="color: #c66;">)</span>
<span style="color: #c66;">(</span>query <span style="color: #6c6;">(</span><span style="color: #483d8b;">:select</span> '* <span style="color: #483d8b;">:from</span> 'country<span style="color: #6c6;">)</span><span style="color: #c66;">)</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">=&gt; (("The Netherlands" 16800000 "Willem-Alexander")</span>
<span style="color: #b22222;">;;     </span><span style="color: #b22222;">("Croatia" 4500000 :NULL))</span>
</pre>
</div>
<p>
Please see the <a href="s-sql.html">documentation for s-sql</a> for more examples of using s-sql rather than daos.
</p>

<p>
Next, to demonstrate a bit more of the S-SQL syntax, here is the query the
utility function list-tables uses to get a list of the tables in a database:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>sql <span style="color: #6c6;">(</span><span style="color: #483d8b;">:select</span> 'relname <span style="color: #483d8b;">:from</span> 'pg-catalog.pg-class
      <span style="color: #483d8b;">:inner-join</span> 'pg-catalog.pg-namespace <span style="color: #483d8b;">:on</span> <span style="color: #69f;">(</span><span style="color: #483d8b;">:=</span> 'relnamespace
                                                   'pg-namespace.oid<span style="color: #69f;">)</span>
      <span style="color: #483d8b;">:where</span> <span style="color: #69f;">(</span><span style="color: #483d8b;">:and</span> <span style="color: #cc6;">(</span><span style="color: #483d8b;">:=</span> 'relkind <span style="color: #8b2252;">"r"</span><span style="color: #cc6;">)</span>
                   <span style="color: #cc6;">(</span><span style="color: #483d8b;">:not-in</span> 'nspname <span style="color: #6cc;">(</span><span style="color: #483d8b;">:set</span> <span style="color: #8b2252;">"pg_catalog"</span> <span style="color: #8b2252;">"pg_toast"</span><span style="color: #6cc;">)</span><span style="color: #cc6;">)</span>
                   <span style="color: #cc6;">(</span><span style="color: #483d8b;">:pg-catalog.pg-table-is-visible</span> 'pg-class.oid<span style="color: #cc6;">)</span><span style="color: #69f;">)</span><span style="color: #6c6;">)</span><span style="color: #c66;">)</span>

<span style="color: #b22222;">;; </span><span style="color: #b22222;">=&gt; "(SELECT relname FROM pg_catalog.pg_class</span>
<span style="color: #b22222;">;;      </span><span style="color: #b22222;">INNER JOIN pg_catalog.pg_namespace ON (relnamespace = pg_namespace.oid)</span>
<span style="color: #b22222;">;;      </span><span style="color: #b22222;">WHERE ((relkind = 'r') and (nspname NOT IN ('pg_catalog', 'pg_toast'))</span>
<span style="color: #b22222;">;;             </span><span style="color: #b22222;">and pg_catalog.pg_table_is_visible(pg_class.oid)))"</span>
</pre>
</div>

<p>
sql is a macro that will simply compile a query, it can be useful for seeing
how your queries are expanded or if you want to do something unexpected with
them.
</p>

<p>
As you can see, lists starting with keywords are used to express SQL commands
and operators (lists starting with something else will be evaluated and then
inserted into the query). Quoted symbols name columns or tables (keywords can
also be used but might introduce ambiguities). The syntax supports subqueries,
multiple joins, stored procedures, etc. See the <a href="s-sql.html">S-SQL reference manual</a> for a
complete treatment.
</p>

<p>
Finally, here is an example of the use of prepared statements:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>defprepared sovereign-of
  <span style="color: #6c6;">(</span><span style="color: #483d8b;">:select</span> 'sovereign <span style="color: #483d8b;">:from</span> 'country <span style="color: #483d8b;">:where</span> <span style="color: #69f;">(</span><span style="color: #483d8b;">:=</span> 'name '$1<span style="color: #69f;">)</span><span style="color: #6c6;">)</span>
  <span style="color: #483d8b;">:single!</span><span style="color: #c66;">)</span>
<span style="color: #c66;">(</span>sovereign-of <span style="color: #8b2252;">"The Netherlands"</span><span style="color: #c66;">)</span>
<span style="color: #b22222;">;; </span><span style="color: #b22222;">=&gt; "Willem-Alexander"</span>
</pre>
</div>

<p>
The defprepared macro creates a function that takes the same amount of
arguments as there are $X placeholders in the given query. The query will
only be parsed and planned once (per database connection), which can be
faster, especially for complex queries.
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>disconnect-toplevel<span style="color: #c66;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-b15533d8-efa3-43a9-b632-a3256cea261f" class="outline-2">
<h2 id="b15533d8-efa3-43a9-b632-a3256cea261f">Authentication</h2>
<div class="outline-text-2" id="text-b15533d8-efa3-43a9-b632-a3256cea261f">
<p>
Postmodern can use either md5 or scram-sha-256 authentication. Scram-sha-256
authentication is obviously more secure, but slower than md5, so take that into
account if you are planning on opening and closing many connections without
using a connection pooling setup..
</p>

<p>
Other authentication methods have not been tested. Please let us know if there
is a authentication method that you believe should be considered.
</p>
</div>
</div>

<div id="outline-container-e2475974-6131-40ef-9ca3-54bf111a5dd0" class="outline-2">
<h2 id="e2475974-6131-40ef-9ca3-54bf111a5dd0">Data Types</h2>
<div class="outline-text-2" id="text-e2475974-6131-40ef-9ca3-54bf111a5dd0">
</div>
<div id="outline-container-b850ea6c-b61e-4601-8423-65a8a626cb58" class="outline-3">
<h3 id="b850ea6c-b61e-4601-8423-65a8a626cb58">Data Types</h3>
<div class="outline-text-3" id="text-b850ea6c-b61e-4601-8423-65a8a626cb58">
<p>
For a short comparison of lisp and Postgresql data types (date and time datatypes are described in the next section)
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">SQL type</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">smallint</td>
<td class="org-left">-32,768 to +32,768 2-byte storage</td>
</tr>

<tr>
<td class="org-left">integer</td>
<td class="org-left">-2147483648 to +2147483647 integer, 4-byte storage</td>
</tr>

<tr>
<td class="org-left">bigint</td>
<td class="org-left">-9223372036854775808 to 9223372036854775807 8-byte storage</td>
</tr>

<tr>
<td class="org-left">numeric(X, Y)</td>
<td class="org-left">User specified, see notes below</td>
</tr>

<tr>
<td class="org-left">real</td>
<td class="org-left">float, 6 decimal digit precision 4-byte storage</td>
</tr>

<tr>
<td class="org-left">double-precision</td>
<td class="org-left">floating, 15 decimal digit precision 8-byte storage</td>
</tr>

<tr>
<td class="org-left">text</td>
<td class="org-left">variable length string, no limit specified</td>
</tr>

<tr>
<td class="org-left">char(X)</td>
<td class="org-left">char(length), blank-padded string, fixed storage length</td>
</tr>

<tr>
<td class="org-left">varchar(X)</td>
<td class="org-left">varchar(length), non-blank-padded string, variable storage length</td>
</tr>

<tr>
<td class="org-left">boolean</td>
<td class="org-left">boolean, 'true'/'false', 1 byte</td>
</tr>

<tr>
<td class="org-left">bytea</td>
<td class="org-left">binary string allowing non-printable octets</td>
</tr>

<tr>
<td class="org-left">date</td>
<td class="org-left">date range: 4713 BC to 5874897 AD</td>
</tr>

<tr>
<td class="org-left">interval</td>
<td class="org-left">See <a href="interval-notes.html">interval</a></td>
</tr>

<tr>
<td class="org-left">array</td>
<td class="org-left">See discussion at <a href="array-notes.html">array-notes.html</a></td>
</tr>
</tbody>
</table>

<p>
Numeric and decimal are variable storage size numbers with user specified precision.
Up to 131072 digits before the decimal point; up to 16383 digits after the decimal point.
The syntax is numeric(precision, scale). Numeric columns with a specified scale will coerce input
values to that scale. For more detail, see <a href="https://www.postgresql.org/docs/current/datatype-numeric.html">https://www.postgresql.org/docs/current/datatype-numeric.html</a>
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">PG Type</th>
<th scope="col" class="org-left">Sample Postmodern Return Value</th>
<th scope="col" class="org-left">Lisp Type (per sbcl)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">boolean</td>
<td class="org-left">T</td>
<td class="org-left">BOOLEAN</td>
</tr>

<tr>
<td class="org-left">boolean</td>
<td class="org-left">NIL  (Note: within Postgresql this will show 'f')</td>
<td class="org-left">BOOLEAN</td>
</tr>

<tr>
<td class="org-left">int2</td>
<td class="org-left">273</td>
<td class="org-left">(INTEGER 0 4611686018427387903)</td>
</tr>

<tr>
<td class="org-left">int4</td>
<td class="org-left">2</td>
<td class="org-left">(INTEGER 0 4611686018427387903)</td>
</tr>

<tr>
<td class="org-left">char</td>
<td class="org-left">A</td>
<td class="org-left">(VECTOR CHARACTER 64)</td>
</tr>

<tr>
<td class="org-left">varchar</td>
<td class="org-left">id&amp;wl;19</td>
<td class="org-left">(VECTOR CHARACTER 64)</td>
</tr>

<tr>
<td class="org-left">numeric</td>
<td class="org-left">78239/100</td>
<td class="org-left">RATIO</td>
</tr>

<tr>
<td class="org-left">json</td>
<td class="org-left">{ "customer": "John Doe", "items": {"product": "Beer","qty": 6}}</td>
<td class="org-left">(VECTOR CHARACTER 64)</td>
</tr>

<tr>
<td class="org-left">jsonb</td>
<td class="org-left">{"title": "Sleeping Beauties", "genres": ["Fiction", "Thriller", "Horror"]}</td>
<td class="org-left">(VECTOR CHARACTER 128)</td>
</tr>

<tr>
<td class="org-left">float</td>
<td class="org-left">782.31</td>
<td class="org-left">SINGLE-FLOAT</td>
</tr>

<tr>
<td class="org-left">point</td>
<td class="org-left">(0.0d0 0.0d0)</td>
<td class="org-left">CONS</td>
</tr>

<tr>
<td class="org-left">lseg</td>
<td class="org-left">((-1.0d0 0.0d0) (2.0d0 4.0d0))</td>
<td class="org-left">CONS</td>
</tr>

<tr>
<td class="org-left">path</td>
<td class="org-left">((1,0),(2,4))</td>
<td class="org-left">(VECTOR CHARACTER 64)</td>
</tr>

<tr>
<td class="org-left">box</td>
<td class="org-left">((1.0d0 1.0d0) (0.0d0 0.0d0))</td>
<td class="org-left">CONS</td>
</tr>

<tr>
<td class="org-left">polygon</td>
<td class="org-left">((21,0),(2,4))</td>
<td class="org-left">(VECTOR CHARACTER 64)</td>
</tr>

<tr>
<td class="org-left">line</td>
<td class="org-left">{2,-1,0}</td>
<td class="org-left">(VECTOR CHARACTER 64)</td>
</tr>

<tr>
<td class="org-left">double_precision</td>
<td class="org-left">2.38921379231d8</td>
<td class="org-left">DOUBLE-FLOAT</td>
</tr>

<tr>
<td class="org-left">double_float</td>
<td class="org-left">2.3892137923231d8</td>
<td class="org-left">DOUBLE-FLOAT</td>
</tr>

<tr>
<td class="org-left">circle</td>
<td class="org-left">&lt;(0,0),2&gt;</td>
<td class="org-left">(VECTOR CHARACTER 64)</td>
</tr>

<tr>
<td class="org-left">cidr</td>
<td class="org-left">100.24.10.0/24</td>
<td class="org-left">(VECTOR CHARACTER 64)</td>
</tr>

<tr>
<td class="org-left">inet</td>
<td class="org-left">100.24.10.0/24</td>
<td class="org-left">(VECTOR CHARACTER 64)</td>
</tr>

<tr>
<td class="org-left">interval</td>
<td class="org-left">#&lt;INTERVAL P1Y3H20m&gt;</td>
<td class="org-left">INTERVAL</td>
</tr>

<tr>
<td class="org-left">bit</td>
<td class="org-left">#*1</td>
<td class="org-left">(SIMPLE-BIT-VECTOR 1)</td>
</tr>

<tr>
<td class="org-left">int4range</td>
<td class="org-left">[11,24)</td>
<td class="org-left">(VECTOR CHARACTER 64)</td>
</tr>

<tr>
<td class="org-left">uuid</td>
<td class="org-left">40e6215d-b5c6-4896-987c-f30f3678f608</td>
<td class="org-left">(VECTOR CHARACTER 64)</td>
</tr>

<tr>
<td class="org-left">text_array</td>
<td class="org-left">#(text one text two text three)</td>
<td class="org-left">(SIMPLE-VECTOR 3)</td>
</tr>

<tr>
<td class="org-left">integer_array</td>
<td class="org-left">#(3 5 7 8)</td>
<td class="org-left">(SIMPLE-VECTOR 4)</td>
</tr>

<tr>
<td class="org-left">bytea</td>
<td class="org-left">#(222 173 190 239)</td>
<td class="org-left">(SIMPLE-ARRAY (UNSIGNED-BYTE 8) (4))</td>
</tr>

<tr>
<td class="org-left">text</td>
<td class="org-left">Lorem ipsum dolor sit amet, consectetur adipiscing elit</td>
<td class="org-left">(VECTOR CHARACTER 64)</td>
</tr>

<tr>
<td class="org-left">enum_mood</td>
<td class="org-left">happy *Note: enum_mood was defined as 'sad','ok' or 'happy'</td>
<td class="org-left">(VECTOR CHARACTER 64)</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<div id="outline-container-passing-binary-parameters" class="outline-2">
<h2 id="passing-binary-parameters">Passing Parameters as Text or Binary</h2>
<div class="outline-text-2" id="text-passing-binary-parameters">
<p>
To avoid sql injection attacks you should be using parameterized queries. They also help avoid the hassle of worrying about double quotes and single quotes. They are also a required part of prepared queries. The following shows an example of parameterized query in regular sql and s-sql.
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>query <span style="color: #8b2252;">"select name, address from customers where id = $1"</span> 237<span style="color: #c66;">)</span>

<span style="color: #c66;">(</span>query <span style="color: #6c6;">(</span><span style="color: #483d8b;">:select</span> 'name 'address <span style="color: #483d8b;">:from</span> 'customers <span style="color: #483d8b;">:where</span> <span style="color: #69f;">(</span><span style="color: #483d8b;">:=</span> 'id '$1<span style="color: #69f;">)</span><span style="color: #6c6;">)</span> 237<span style="color: #c66;">)</span>
</pre>
</div>
<p>
Postmodern defaults to passing query parameters as text. In an example like the above, Postgresql would look at the customer table, see that "id" must be an integer or big integer and proceed accordingly. If Postgresql does not have a table column which would allow it to determine the appropriate data type and you do not specify the date type in the query, Postgresql treats the parameter as text. The following example in plain sql demonstrates:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>query <span style="color: #8b2252;">"select $1"</span> 1 <span style="color: #483d8b;">:single</span><span style="color: #c66;">)</span>
<span style="color: #8b2252;">"1"</span>
<span style="color: #c66;">(</span>query <span style="color: #8b2252;">"select $1"</span> 1.5 <span style="color: #483d8b;">:single</span><span style="color: #c66;">)</span>
<span style="color: #8b2252;">"1.5"</span>
<span style="color: #c66;">(</span>query <span style="color: #8b2252;">"select $1"</span> T <span style="color: #483d8b;">:single</span><span style="color: #c66;">)</span>
<span style="color: #8b2252;">"true"</span>
<span style="color: #c66;">(</span>query <span style="color: #8b2252;">"select $1"</span> nil <span style="color: #483d8b;">:single</span><span style="color: #c66;">)</span>
<span style="color: #8b2252;">"false"</span>
<span style="color: #c66;">(</span>query <span style="color: #8b2252;">"select $1"</span> <span style="color: #483d8b;">:NULL</span> <span style="color: #483d8b;">:single</span><span style="color: #c66;">)</span>
<span style="color: #483d8b;">:NULL</span>
</pre>
</div>

<p>
You can specify the type and Postgresql will attempt to follow that:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>query <span style="color: #8b2252;">"select $1::integer"</span> 1 <span style="color: #483d8b;">:single</span><span style="color: #c66;">)</span>
1
</pre>
</div>
<p>
As of version 1.33, Postmodern provides an optional setting in the database connection object which will cause Postmodern to pass parameters to Postgresql in binary format if that format is available for that datatype. Currently this means int2, int4, int8, float, double-float (except clisp) and boolean. Rational numbers continue to be passed as text.
</p>

<p>
The default for cl-postgres/Postmodern is to continue to pass parameters to Postgresql as text (not in binary format) in order to avoid breaking existing user code. If you want to pass parameters to Postgresql in binary format, you can either provide the keyword parameter :use-binary in creating a connection like so:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>connect <span style="color: #8b2252;">"test-db"</span> <span style="color: #8b2252;">"test-user"</span> <span style="color: #8b2252;">"test-password"</span> <span style="color: #8b2252;">"192.168.5.223"</span>
         <span style="color: #483d8b;">:port</span> 5434 <span style="color: #483d8b;">:pooled-p</span> t <span style="color: #483d8b;">:use-ssl</span> try <span style="color: #483d8b;">:application-name</span> <span style="color: #8b2252;">"test-app"</span> <span style="color: #483d8b;">:use-binary</span> t<span style="color: #c66;">)</span>
</pre>
</div>
<p>
or use the postmodern <code>with-connection</code> macro:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span><span style="color: #a020f0;">with-connection</span> '<span style="color: #6c6;">(</span><span style="color: #8b2252;">"database-name"</span> <span style="color: #8b2252;">"user-name"</span> <span style="color: #8b2252;">"user-password"</span> <span style="color: #8b2252;">"localhost or IP address"</span>
                   <span style="color: #483d8b;">:use-binary</span> t [any other keyword parameters you want to apply]<span style="color: #6c6;">)</span>
  ...<span style="color: #c66;">)</span>
</pre>
</div>
<p>
You can also change the flag after the connection is established with the <code>use-binary-parameters</code> function, passing T to use binary parameters or nil to use text parameters:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>use-binary-parameters *database* t<span style="color: #c66;">)</span>

<span style="color: #c66;">(</span>use-binary-parameters some-database-connection t<span style="color: #c66;">)</span>
</pre>
</div>
<p>
Using binary parameters the results has the following results:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>query <span style="color: #8b2252;">"select $1"</span> 1 <span style="color: #483d8b;">:single</span><span style="color: #c66;">)</span>
1
<span style="color: #c66;">(</span>query <span style="color: #8b2252;">"select $1"</span> 1.5 <span style="color: #483d8b;">:single</span><span style="color: #c66;">)</span>
1.5
<span style="color: #c66;">(</span>query <span style="color: #8b2252;">"select $1"</span> T <span style="color: #483d8b;">:single</span><span style="color: #c66;">)</span>
T
<span style="color: #c66;">(</span>query <span style="color: #8b2252;">"select $1"</span> nil <span style="color: #483d8b;">:single</span><span style="color: #c66;">)</span>
NIL
<span style="color: #c66;">(</span>query <span style="color: #8b2252;">"select $1"</span> <span style="color: #483d8b;">:NULL</span> <span style="color: #483d8b;">:single</span><span style="color: #c66;">)</span>
<span style="color: #483d8b;">:NULL</span>
</pre>
</div>
<p>
Using binary parameters does tighten type checking when using prepared queries. You will not be able to use prepared queries with varying formats. In other words, if you have a prepared query that you pass an integer as the first parameter and a string as the second parameter the first time it is used, any subsequent uses of that prepared query during that session will also have to pass an integer as the first parameter and a string as the second parameter.
</p>

<p>
Benchmarking does indicate a slight speed and consing benefit to passing parameters as binary, but your mileage will vary depending on your use case.
</p>
</div>
</div>

<div id="outline-container-fc095960-ba9d-4a98-ac89-0db7a56777f1" class="outline-2">
<h2 id="fc095960-ba9d-4a98-ac89-0db7a56777f1">Caveats and to-dos</h2>
<div class="outline-text-2" id="text-fc095960-ba9d-4a98-ac89-0db7a56777f1">
</div>
<div id="outline-container-e5c68251-0ca6-4f96-8d36-175cec626eeb" class="outline-3">
<h3 id="e5c68251-0ca6-4f96-8d36-175cec626eeb">Timezones and Simple-Date and Local-Time</h3>
<div class="outline-text-3" id="text-e5c68251-0ca6-4f96-8d36-175cec626eeb">
<p>
It is important to understand how postgresql (not postmodern) handles
timestamps and timestamps with time zones. Postgresql keeps everything
in UTC, it does not store a timezone even in a timezone aware column.
If you use a timestamp with timezone column, postgresql will calculate
the UTC time and will normalize the timestamp data to UTC. When you
later select the record, postgresql will look at the timezone for the
postgresql session, retrieve the data and then provide the data
recalculated from UTC to the timezone for that postgresql session.
There is a good writeup of timezones at
<a href="http://blog.untrod.com/2016/08/actually-understanding-timezones-in-postgresql.html">http://blog.untrod.com/2016/08/actually-understanding-timezones-in-postgresql.html</a>
and <a href="http://phili.pe/posts/timestamps-and-time-zones-in-postgresql/">http://phili.pe/posts/timestamps-and-time-zones-in-postgresql/</a>.
</p>

<p>
Without simple-date or local-time properly loaded and without use of the
Postgresql to_char function, sample date and time data from postgresql will
look like:
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-right">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">PG Type</th>
<th scope="col" class="org-right">Sample Return Value</th>
<th scope="col" class="org-left">Lisp Type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">date</td>
<td class="org-right">3798576000</td>
<td class="org-left">(INTEGER 0 4611686018427387903)</td>
</tr>

<tr>
<td class="org-left">time_wo_tz</td>
<td class="org-right">((HOURS 9) (MINUTES 47) (SECONDS 9) (MICROSECONDS 926531))</td>
<td class="org-left">CONS</td>
</tr>

<tr>
<td class="org-left">time_w_tz</td>
<td class="org-right">09:47:16.510459-04</td>
<td class="org-left">(VECTOR CHARACTER 64)</td>
</tr>

<tr>
<td class="org-left">timestamp_wo_tz</td>
<td class="org-right">3798611253</td>
<td class="org-left">(INTEGER 0 4611686018427387903)</td>
</tr>

<tr>
<td class="org-left">timestamp_w_tz</td>
<td class="org-right">3798625647</td>
<td class="org-left">(INTEGER 0 4611686018427387903)</td>
</tr>
</tbody>
</table>

<p>
YOU DO NOT NEED TO ADD ANY OTHER LIBRARIES IF ALL YOU WANT TO DO IS GET ISO 8601 or
<a href="https://tools.ietf.org/html/rfc3339">RFC 3339</a> PROPERLY FORMATTED TIME AND DATE STRINGS WITH THE <a href="https://www.postgresql.org/docs/current/functions-formatting.html">TO_CHAR</a> POSTGRESQL
FUNCTION.
</p>

<p>
Assume a data table with columns  "col_timestamp_without_time_zone", "col_timestamp_with_time_zone", "col_timestamptz", "col_timestamp", "col_time"
and "col_date".
</p>

<p>
First, just basic sql. In this example we ask for the timestamp_with_time_zone field
three times to show differences in the result dealing with time zones. First we do not
add a timezone parameter to the pattern, the second time  we ask for the time zone
using TZ, the third time we ask for the offset from UTC and get back -04. We would get
the same result using those additional parameters with the col_timestamptz field.
</p>

<div class="org-src-container">
<pre class="src src-sql">(query "(<span style="color: #a020f0;">SELECT</span> to_char(col_timestamp_with_time_zone, E<span style="color: #8b2252;">'YYYY-MM-DD HH24:MI:SS'</span>),
                to_char(col_timestamp_with_time_zone, E<span style="color: #8b2252;">'YYYY-MM-DD HH24:MI:SS TZ'</span>),
                to_char(col_timestamp_with_time_zone, E<span style="color: #8b2252;">'YYYY-MM-DD HH24:MI:SS OF'</span>),
                to_char(col_timestamptz, E<span style="color: #8b2252;">'YYYY-MM-DD HH24:MI:SS'</span>),
                to_char(col_timestamp, E<span style="color: #8b2252;">'YYYY-MM-DD HH24:MI:SS'</span>),
                to_char(col_time, E<span style="color: #8b2252;">'HH24:MI:SS'</span>),
                to_char(col_date, E<span style="color: #8b2252;">'YYYY-MM-DD'</span>)
         <span style="color: #a020f0;">FROM</span> short_data_type_tests
         <span style="color: #a020f0;">WHERE</span> (id = 1))")
(("2020-10-30 19:30:54" "2020-10-30 19:30:54 EDT" "2020-10-30 19:30:54 -04"
"2020-10-30 19:30:54" "2020-10-30 19:30:54" "19:30:54" "2020-10-30"))
</pre>
</div>

<p>
Now the s-sql version:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>query <span style="color: #6c6;">(</span><span style="color: #483d8b;">:select</span>  <span style="color: #69f;">(</span><span style="color: #483d8b;">:to-char</span> 'col_timestamp_with_time_zone <span style="color: #8b2252;">"YYYY-MM-DD HH24:MI:SS TZ"</span><span style="color: #69f;">)</span>
                 <span style="color: #69f;">(</span><span style="color: #483d8b;">:to-char</span> 'col_timestamp_with_time_zone <span style="color: #8b2252;">"YYYY-MM-DD HH24:MI:SS OF"</span><span style="color: #69f;">)</span>
                 <span style="color: #69f;">(</span><span style="color: #483d8b;">:to-char</span> 'col_timestamptz <span style="color: #8b2252;">"YYYY-MM-DD HH24:MI:SS"</span><span style="color: #69f;">)</span>
                 <span style="color: #69f;">(</span><span style="color: #483d8b;">:to-char</span> 'col_timestamp <span style="color: #8b2252;">"YYYY-MM-DD HH24:MI:SS"</span><span style="color: #69f;">)</span>
                 <span style="color: #69f;">(</span><span style="color: #483d8b;">:to-char</span> 'col_time <span style="color: #8b2252;">"HH24:MI:SS"</span><span style="color: #69f;">)</span>
                 <span style="color: #69f;">(</span><span style="color: #483d8b;">:to-char</span> 'col_date <span style="color: #8b2252;">"YYYY-MM-DD"</span><span style="color: #69f;">)</span>
        <span style="color: #483d8b;">:from</span> 'short-data-type-tests
        <span style="color: #483d8b;">:where</span> <span style="color: #69f;">(</span><span style="color: #483d8b;">:=</span> 'id 1<span style="color: #69f;">)</span><span style="color: #6c6;">)</span><span style="color: #c66;">)</span>

<span style="color: #c66;">(</span><span style="color: #6c6;">(</span><span style="color: #8b2252;">"2020-10-30 19:30:54 EDT"</span> <span style="color: #8b2252;">"2020-10-30 19:30:54 -04"</span> <span style="color: #8b2252;">"2020-10-30 19:30:54"</span>
  <span style="color: #8b2252;">"2020-10-30 19:30:54"</span> <span style="color: #8b2252;">"19:30:54"</span> <span style="color: #8b2252;">"2020-10-30"</span><span style="color: #6c6;">)</span><span style="color: #c66;">)</span>
</pre>
</div>
</div>
<div id="outline-container-simple-date-library-use" class="outline-4">
<h4 id="simple-date-library-use">Simple-Date Library Use</h4>
<div class="outline-text-4" id="text-simple-date-library-use">
<p>
The Simple-date add-on library (not enabled by default)
provides types (CLOS classes) for dates, timestamps, and intervals
similar to the ones SQL databases use, in order to be able to store and read
these to and from a database in a straighforward way. A few obvious operations
are defined on these types.
</p>

<p>
To use simple-date with cl-postgres or postmodern,
load simple-date-cl-postgres-glue and register suitable SQL
readers and writers for the associated database types.
</p>

<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>ql:quickload <span style="color: #483d8b;">:simple-date/postgres-glue</span><span style="color: #c66;">)</span>

<span style="color: #c66;">(</span>setf cl-postgres:*sql-readtable*
        <span style="color: #6c6;">(</span>cl-postgres:copy-sql-readtable
          simple-date-cl-postgres-glue:*simple-date-sql-readtable*<span style="color: #6c6;">)</span><span style="color: #c66;">)</span>
</pre>
</div>

<p>
With simple date loaded, the same data will look like this:
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">PG Type</th>
<th scope="col" class="org-left">Sample Return Value</th>
<th scope="col" class="org-left">Lisp Type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">date</td>
<td class="org-left">#&lt;DATE 16-05-2020&gt;</td>
<td class="org-left">DATE</td>
</tr>

<tr>
<td class="org-left">time_without_timezone</td>
<td class="org-left">#&lt;TIME-OF-DAY 09:47:09.926531&gt;</td>
<td class="org-left">TIME-OF-DAY</td>
</tr>

<tr>
<td class="org-left">time_with_timezone</td>
<td class="org-left">09:47:16.510459-04</td>
<td class="org-left">(VECTOR CHARACTER 64)</td>
</tr>

<tr>
<td class="org-left">timestamp_without_timezone</td>
<td class="org-left">#&lt;TIMESTAMP 16-05-2020T09:47:33,315&gt;</td>
<td class="org-left">TIMESTAMP</td>
</tr>

<tr>
<td class="org-left">timestamp_with_timezone</td>
<td class="org-left">#&lt;TIMESTAMP 16-05-2020T13:47:27,855&gt;</td>
<td class="org-left">TIMESTAMP</td>
</tr>
</tbody>
</table>

<p>
You can export these as json-strings with the encode-json-to-string function. E.g.
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>encode-json-to-string <span style="color: #6c6;">(</span>query <span style="color: #69f;">(</span><span style="color: #483d8b;">:select</span> 'timestamp-without-time-zone
                               <span style="color: #483d8b;">:from</span> 'test-data
                               <span style="color: #483d8b;">:where</span> <span style="color: #cc6;">(</span><span style="color: #483d8b;">:=</span> 'id 1<span style="color: #cc6;">)</span><span style="color: #69f;">)</span>
                               <span style="color: #483d8b;">:single</span><span style="color: #6c6;">)</span><span style="color: #c66;">)</span>
<span style="color: #8b2252;">"\"2020-12-30 13:30:54:0\""</span>
</pre>
</div>
<p>
Or more simply with passing one of the json result type parameters to the query
function. E.g.
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>query <span style="color: #6c6;">(</span><span style="color: #483d8b;">:select</span> 'timestamp-with-time-zone
        <span style="color: #483d8b;">:from</span> 'test-data
        <span style="color: #483d8b;">:where</span> <span style="color: #69f;">(</span><span style="color: #483d8b;">:&lt;</span> 'id 3<span style="color: #69f;">)</span><span style="color: #6c6;">)</span>
  <span style="color: #483d8b;">:json-strs</span><span style="color: #c66;">)</span>

'<span style="color: #c66;">(</span><span style="color: #8b2252;">"{\"timestampWithTimeZone\":\"2019-12-30 18:30:54:0\"}"</span>
  <span style="color: #8b2252;">"{\"timestampWithTimeZone\":\"1919-12-30 18:30:54:0\"}"</span><span style="color: #c66;">)</span>
</pre>
</div>
<p>
To get back to the default cl-postgres reader:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>setf cl-postgres:*sql-readtable*
        <span style="color: #6c6;">(</span>cl-postgres:copy-sql-readtable
          cl-postgres::*default-sql-readtable*<span style="color: #6c6;">)</span><span style="color: #c66;">)</span>
</pre>
</div>
<p>
However <a href="http://marijnhaverbeke.nl/postmodern/simple-date.html">Simple-date</a> has no concept of time zones. Many users use another library,
<a href="https://github.com/dlowe-net/local-time">local-time</a>, which solves the same problem as simple-date, but does understand
time zones. One thing to remember is that PostgreSQL doesn't store timezone
information when using `timestamp with time zone`. Time zone information only
used to convert it to proper UTC timestamp.
</p>
</div>
</div>

<div id="outline-container-local-time-library-use" class="outline-4">
<h4 id="local-time-library-use">Local-Time Library Use</h4>
<div class="outline-text-4" id="text-local-time-library-use">
<p>
For those who want to use local-time, to enable the local-time reader:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>ql:quickload <span style="color: #483d8b;">:cl-postgres+local-time</span><span style="color: #c66;">)</span>
<span style="color: #c66;">(</span>local-time:set-local-time-cl-postgres-readers<span style="color: #c66;">)</span>
</pre>
</div>

<p>
With that set postgresql time datatype returns look like:
With local-time loaded and local-time:set-local-time-cl-postgres-readers run,
the same sample data looks like:
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">PG Type</th>
<th scope="col" class="org-left">Sample Return Value</th>
<th scope="col" class="org-left">Lisp Type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">date</td>
<td class="org-left">2020-05-15T20:00:00.000000-04:00</td>
<td class="org-left">TIMESTAMP</td>
</tr>

<tr>
<td class="org-left">time_without_timezone</td>
<td class="org-left">2000-03-01T04:47:09.926531-05:00</td>
<td class="org-left">TIMESTAMP</td>
</tr>

<tr>
<td class="org-left">time_with_timezone</td>
<td class="org-left">09:47:16.510459-04</td>
<td class="org-left">(VECTOR CHARACTER 64)</td>
</tr>

<tr>
<td class="org-left">timestamp_without_timezone</td>
<td class="org-left">2020-05-16T05:47:33.315622-04:00</td>
<td class="org-left">TIMESTAMP</td>
</tr>

<tr>
<td class="org-left">timestamp_with_timezone</td>
<td class="org-left">2020-05-16T09:47:27.855146-04:00</td>
<td class="org-left">TIMESTAMP</td>
</tr>
</tbody>
</table>

<p>
Similarly to simple-date timestamps, these can be exported as json-strings with the encode-json-to-string function. E.g.
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>encode-json-to-string <span style="color: #6c6;">(</span>query <span style="color: #69f;">(</span><span style="color: #483d8b;">:select</span> 'timestamp-with-time-zone
                               <span style="color: #483d8b;">:from</span> 'test-data
                               <span style="color: #483d8b;">:where</span> <span style="color: #cc6;">(</span><span style="color: #483d8b;">:=</span> 'id 1<span style="color: #cc6;">)</span><span style="color: #69f;">)</span>
                               <span style="color: #483d8b;">:single</span><span style="color: #6c6;">)</span><span style="color: #c66;">)</span>
<span style="color: #8b2252;">"\"{2020-12-30T08:30:54.000000-05:00}\""</span>
</pre>
</div>
<p>
Or more simply with passing one of the json result type parameters to the query
function. E.g.
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>query <span style="color: #6c6;">(</span><span style="color: #483d8b;">:select</span> 'timestamp-with-time-zone
        <span style="color: #483d8b;">:from</span> 'test-data
        <span style="color: #483d8b;">:where</span> <span style="color: #69f;">(</span><span style="color: #483d8b;">:&lt;</span> 'id 3<span style="color: #69f;">)</span><span style="color: #6c6;">)</span>
  <span style="color: #483d8b;">:json-strs</span><span style="color: #c66;">)</span>

'<span style="color: #c66;">(</span><span style="color: #8b2252;">"{\"timestampWithTimeZone\":\"{2019-12-30T13:30:54.000000-05:00}\"}"</span>
  <span style="color: #8b2252;">"{\"timestampWithTimeZone\":\"{1919-12-30T13:30:54.000000-05:00}\"}"</span><span style="color: #c66;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-bdf9ddb0-5f95-4807-8862-8970b35bd142" class="outline-3">
<h3 id="bdf9ddb0-5f95-4807-8862-8970b35bd142">Portability</h3>
<div class="outline-text-3" id="text-bdf9ddb0-5f95-4807-8862-8970b35bd142">
<p>
The Lisp code in Postmodern is theoretically portable across implementations,
and seems to work on all major ones as well as some minor ones such as Genera.
It is regularly tested on ccl, sbcl, ecl, abcl and cmucl.
</p>

<p>
ABCL version 1.8.0 broke the dao class inheritance. See <a href="https://abcl.org/trac/ticket/479">https://abcl.org/trac/ticket/479</a>.
Everything other than dao-classes works.
</p>

<p>
Clisp currently has issues with executing a file of sql statements (Postmodern's execute-file function).
</p>

<p>
Implementations that do not have meta-object protocol support will not have
DAOs, but all other parts of the library should work (all widely used
implementations do support this).
</p>

<p>
The library is not likely to work for PostgreSQL versions older than 8.4.
Other features only work in newer Postgresql versions as the features
were only introduced in those newer versions.
</p>
</div>
</div>

<div id="outline-container-565fad0b-aef4-497c-92d8-096a0a78c804" class="outline-3">
<h3 id="565fad0b-aef4-497c-92d8-096a0a78c804">Reserved Words</h3>
<div class="outline-text-3" id="text-565fad0b-aef4-497c-92d8-096a0a78c804">
<p>
It is highly suggested that you do not use words that are reserved by Postgresql
and the sql standard as identifiers (e.g. table names, columns). The reserved
words are:
</p>

<p>
"all" "analyse" "analyze" "and" "any" "array" "as" "asc" "asymmetric"
"authorization" "between" "binary" "both" "case" "cast" "check" "collate"
"column" "concurrently" "constraint" "create" "cross" "current-catalog"
"current-date" "current-role" "current-schema" "current-time"
"current-timestamp" "current-user" "default" "deferrable" "desc" "distinct" "do"
"else" "end" "except" "false" "fetch" "filter" "for" "foreign" "freeze" "from"
"full" "grant" "group" "having" "ilike" "in" "initially" "inner" "intersect"
"into" "is" "isnull" "join" "lateral" "leading" "left" "like" "limit"
"localtime" "localtimestamp" "natural" "new" "not" "notnull"  "nowait" "null"
"off" "offset" "old" "on" "only" "or" "order" "outer" "overlaps" "placing"
"primary" "references" "returning" "right" "select" "session-user" "share"
"similar" "some" "symmetric" "table" "then" "to" "trailing" "true" "union"
"unique" "user" "using" "variadic" "verbose" "when" "where" "window" "with"
</p>
</div>
</div>

<div id="outline-container-4ac8f5f4-d3b0-41c5-a222-fe3086049279" class="outline-3">
<h3 id="4ac8f5f4-d3b0-41c5-a222-fe3086049279">Things that should be implemented</h3>
<div class="outline-text-3" id="text-4ac8f5f4-d3b0-41c5-a222-fe3086049279">
<p>
Postmodern is under active maintenance so issues and feature requests should
be flagged on <a href="https://github.com/marijnh/Postmodern">Postmodern's site on github</a>.
</p>
</div>
</div>
</div>

<div id="outline-container-773ee4ef-a685-484e-bc6a-6daa849a7d04" class="outline-2">
<h2 id="773ee4ef-a685-484e-bc6a-6daa849a7d04">Resources</h2>
<div class="outline-text-2" id="text-773ee4ef-a685-484e-bc6a-6daa849a7d04">
<ul class="org-ul">
<li><a href="https://mailman.common-lisp.net/listinfo/postmodern-devel">Mailing List</a></li>
<li><a href="https://sites.google.com/site/sabraonthehill/postmodern-examples">A collection of Postmodern examples</a></li>
<li><a href="http://www.postgresql.org/docs/current/static/index.html">The PostgreSQL manuals</a></li>
<li><a href="http://www.postgresql.org/docs/current/static/protocol.html">The wire protocol Postmodern uses</a></li>
<li><a href="http://clsql.b9.com/">CLSQL</a></li>
<li><a href="https://github.com/filonenko-mikhail/cl-ewkb">Common Lisp Postgis library</a></li>
<li><a href="http://common-lisp.net/project/local-time/">Local-time</a></li>
</ul>
</div>
</div>

<div id="outline-container-844add79-070b-4e89-8797-3bc21ea3173b" class="outline-2">
<h2 id="844add79-070b-4e89-8797-3bc21ea3173b">Running tests</h2>
<div class="outline-text-2" id="text-844add79-070b-4e89-8797-3bc21ea3173b">
<p>
Postmodern uses <a href="https://github.com/sionescu/fiveam">FiveAM</a> for
testing.  The different component systems of Postmodern have tests
defined in corresponding test systems, each defining a test suite.
The test systems and corresponding top-level test suites are:
</p>

<ul class="org-ul">
<li>`:postmodern` in `postmodern/tests`,</li>
<li>`:cl-postgres` in `cl-postgres/tests`,</li>
<li>`:s-sql` in `s-sql/tests`, and</li>
<li>`:simple-date` in `simple-date/tests`.</li>
</ul>

<p>
Before running the tests make sure PostgreSQL is running and a test
database is created.  By default tests use the following connection
parameters to run the tests:
</p>

<ul class="org-ul">
<li>Database name: test</li>
<li>User: test</li>
<li>Password: &lt;empty&gt;</li>
<li>Hostname: localhost</li>
<li>Port: 5432</li>
<li>Use-SSL :NO</li>
</ul>

<p>
If connection with these parameters fails then you will be asked to
provide the connection parameters interactively.  The parameters will
be stored in `cl-postgres-tests:*test-connection*` variable and
automatically used on successive test runs.  This variable can also be
set manually before running the tests.
</p>

<p>
To test a particular component one would first load the corresponding
test system, and then run the test suite.  For example, to test the
`postmodern` system in the REPL one would do the following:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>ql:quickload <span style="color: #8b2252;">"postmodern/tests"</span><span style="color: #c66;">)</span>
<span style="color: #c66;">(</span>5am:run! <span style="color: #483d8b;">:postmodern</span><span style="color: #c66;">)</span>

    <span style="color: #b22222;">;; </span><span style="color: #b22222;">... test output ...</span>
</pre>
</div>


<p>
It is also possible to test multiple components at once by first
loading test systems and then running all tests:
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #c66;">(</span>ql:quickload '<span style="color: #6c6;">(</span><span style="color: #8b2252;">"cl-postgres/tests"</span> <span style="color: #8b2252;">"s-sql/tests"</span><span style="color: #6c6;">)</span><span style="color: #c66;">)</span>
<span style="color: #c66;">(</span>5am:run-all-tests<span style="color: #c66;">)</span>

    <span style="color: #b22222;">;; </span><span style="color: #b22222;">... test output ...</span>
</pre>
</div>

<p>
To run the tests from command-line specify the same forms using your
implementation's command-line syntax.  For instance, to test all
Postmodern components on SBCL, use the following command:
</p>

<p>
env DB_USER=$USER sbcl &#x2013;noinform \
    &#x2013;eval '(ql:quickload "postmodern/tests")' \
    &#x2013;eval '(ql:quickload "cl-postgres/tests")' \
    &#x2013;eval '(ql:quickload "s-sql/tests")' \
    &#x2013;eval '(ql:quickload "simple-date/tests")' \
    &#x2013;eval '(progn (setq 5am:*print-names* nil) (5am:run-all-tests))' \
    &#x2013;eval '(sb-ext:exit)'
</p>

<p>
As you can see from above, database connection parameters can be
provided using environment variables:
</p>

<ul class="org-ul">
<li>`DB_NAME`: database name,</li>
<li>`DB_USER`: user,</li>
<li>`DB_PASS`: password,</li>
<li>`DB_HOST`: hostname.</li>
</ul>
</div>
</div>
</div>
</body>
</html>
