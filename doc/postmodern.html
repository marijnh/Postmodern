<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2020-11-03 Tue 07:30 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Postmodern Reference Manual</title>
<meta name="generator" content="Org mode">
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="style.css" />
<style>pre.src{background:#343131;color:white;} </style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<header>
<h1 class="title">Postmodern Reference Manual</h1>
</header><nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#connecting">Connecting</a>
<ul>
<li><a href="#dfc95b36-94d7-42ab-827b-8622f593e7f6">class database-connection</a></li>
<li><a href="#d4aa3e04-ab90-4271-b3e7-60a48e4f2e49">function connect (database user-name password host &amp;key (port 5432) pooled-p use-ssl)</a></li>
<li><a href="#e140fab3-b6fe-4e88-b9ca-241bbb64fce4">variable <b>default-use-ssl</b></a></li>
<li><a href="#9a1a03af-a67e-4419-9066-d79a81885f81">method disconnect (database-connection)</a></li>
<li><a href="#a660d0cc-4795-41df-b183-0ea31f6b6584">function connected-p (database-connection)</a></li>
<li><a href="#426a8f5d-5dc7-4973-a1fc-11b488afcd82">method reconnect (database-connection)</a></li>
<li><a href="#9b9cf868-214b-4026-8f80-25b23f445c91">variable <b>database</b></a></li>
<li><a href="#056d4921-c834-4655-a487-83314f22da42">macro with-connection (spec &amp;body body)</a></li>
<li><a href="#0e0c03e9-7681-433f-ae75-8f06c9685221">macro call-with-connection (spec thunk)</a></li>
<li><a href="#a74be5d0-9b86-4c15-b738-76cd92908d25">function connect-toplevel (database user-name password host &amp;key (port 5432))</a></li>
<li><a href="#a63f929c-805d-42d5-8fbe-f1c01e62b50a">function disconnect-toplevel ()</a></li>
<li><a href="#56c370e4-8f4e-414a-82b6-ae4408fc0b61">function clear-connection-pool ()</a></li>
<li><a href="#97aa1ebb-ef91-4254-a6b7-bfcd8128ad96">variable <b>max-pool-size</b></a></li>
<li><a href="#09583f9a-388a-400a-bb3c-d118242508c8">function list-connections ()</a></li>
</ul>
</li>
<li><a href="#querying">Querying</a>
<ul>
<li><a href="#5a8c24fb-6d7b-4952-8520-b5e8ea98dd77">macro query (query &amp;rest args/format)</a></li>
<li><a href="#71106869-4169-49c8-ba7d-ce6b9fc7d780">macro execute (query &amp;rest args)</a></li>
<li><a href="#66aa9f57-ac8a-4457-9891-3453682518e0">macro doquery (query (&amp;rest names) &amp;body body)</a></li>
<li><a href="#625b6ade-7b09-49dc-b288-78c550b25d83">macro prepare (query &amp;optional (format :rows))</a></li>
<li><a href="#b2ed5fb5-d5f5-4425-b30e-5c40a2997eee">macro defprepared (name query &amp;optional (format :rows))</a></li>
<li><a href="#73823e7b-1fc5-40b2-908f-cec99ac1bc9e">macro defprepared-with-names (name (&amp;rest args) (query &amp;rest query-args) &amp;optional (format :rows))</a></li>
<li><a href="#453612e6-2835-41b2-8305-01b6b5473138">macro with-transaction ((&amp;optional name isolation-level) &amp;body body)</a></li>
<li><a href="#10b5d3e9-b174-4f02-8c47-6eb3430e60fe">function commit-transaction (transaction)</a></li>
<li><a href="#58a7459f-a1f4-4797-83b5-8b5257ca2cf7">function abort-transaction (transaction)</a></li>
<li><a href="#org1f0878d">function rollback-transaction (transaction)</a></li>
<li><a href="#5899097b-a5fb-4b7a-961b-3c65a95f81d4">macro with-savepoint (name &amp;body body)</a></li>
<li><a href="#a6d99838-ed98-4839-ac13-c03ecbfd6f96">function release-savepoint (savepoint)</a></li>
<li><a href="#1f84633f-e567-42c6-bcfc-2167dad89165">function rollback-savepoint (savepoint)</a></li>
<li><a href="#919494ae-625f-4f63-b271-6cc5d0b16549">method commit-hooks (transaction-or-savepoint), setf (commit-hooks transaction-or-savepoint)</a></li>
<li><a href="#94700fa6-1f29-4c0f-86ad-487e640933b9">function abort-hooks (transaction-or-savepoint), setf (abort-hooks transaction-or-savepoint)</a></li>
<li><a href="#44dac415-f1b2-4f01-bb05-a31c6c977b4c">variable <b>isolation-level</b></a></li>
<li><a href="#5fdcafe3-5da4-48ee-8bb0-8567c7e00837">macro with-logical-transaction ((&amp;optional name isolation-level) &amp;body body)</a></li>
<li><a href="#7d237c64-5c3e-44a6-8b7c-6eecc4379b71">function abort-logical-transaction (transaction-or-savepoint)</a></li>
<li><a href="#ae0f0c99-0bda-491e-99a5-3a61e0a86166">function commit-logical-transaction (transaction-or-savepoint)</a></li>
<li><a href="#bf78478f-92a2-4162-963d-b4e101b23154">variable <b>current-logical-transaction</b></a></li>
<li><a href="#6ad767b2-75b7-48ee-a260-6caece5bad62">macro ensure-transaction (&amp;body body)</a></li>
<li><a href="#9ca2ed2b-60ea-4e34-b370-a4f54c1f1dcd">macro ensure-transaction-with-isolation-level (isolation-level &amp;body body)</a></li>
</ul>
</li>
<li><a href="#prepared-statement-helper-functions">Helper functions for Prepared Statements</a>
<ul>
<li><a href="#533331a5-6780-41bd-9ae8-2efac3a3c2c2">defparameter <b>allow-overwriting-prepared-statements</b></a></li>
<li><a href="#7ca58f04-2ad5-4896-b8c2-b13b276b4f5b">function prepared-statement-exists-p (name)</a></li>
<li><a href="#3788ef72-d6a7-4e3b-acad-3f2608914dfb">function list-prepared-statements (&amp;optional (names-only nil))</a></li>
<li><a href="#7ec6297f-85a7-419e-a9d4-8f6e2ceb9559">function drop-prepared-statement (statement-name &amp;key (location :both) (database <b>database</b>))</a></li>
<li><a href="#b6049a3a-55a2-44be-9dc0-1af2849e2128">function list-postmodern-prepared-statements (&amp;optional (names-only nil))</a></li>
<li><a href="#06ea4b19-3d57-4f08-b92d-d477bf61c456">function find-postgresql-prepared-statement (name)</a></li>
<li><a href="#b728be40-afaf-45d3-849c-3b7e27b3b0c1">function find-postmodern-prepared-statement (name)</a></li>
<li><a href="#967c2e66-3ec9-4e07-9de9-1a06d758ac27">function reset-prepared-statement (condition)</a></li>
<li><a href="#a172b4cb-826f-4bcf-9c50-70676bb7599a">function get-pid ()</a></li>
<li><a href="#b0afcff9-dfa9-466a-a3a2-06b189eac23a">function get-pid-from-postmodern ()</a></li>
<li><a href="#10b17274-a4d8-4805-adbe-b7386fe28cfb">function cancel-backend (pid)</a></li>
<li><a href="#203185f5-030c-48e7-8767-e765ac96f8cb">function terminate-backend (pid)</a></li>
</ul>
</li>
<li><a href="#database-management">Database Management</a>
<ul>
<li><a href="#c3da07c5-73e2-407c-a4cf-155b3ae416b2">function create-database (database-name &amp;key (encoding "UTF8") (connection-limit -1) owner limit-public-access comment collation template)</a></li>
<li><a href="#database-management">function drop-database (database)</a></li>
</ul>
</li>
<li><a href="#daos">Database access objects</a>
<ul>
<li><a href="#d1d4b5c3-8c21-478e-8ac1-404e4ffdbec5">metaclass dao-class</a></li>
<li><a href="#9027b960-0a1a-4b64-a621-d1d4ab2906f0">Out of Sync Dao Objects</a></li>
<li><a href="#b12ed2b8-fc3f-4d3a-ba2a-3c9484d770dc">method dao-keys (class)</a></li>
<li><a href="#34196ad8-c657-4fd0-a475-e2f0b81ff86c">method dao-keys (dao)</a></li>
<li><a href="#org055dcc7">method find-primary-key-column</a></li>
<li><a href="#d5835157-a4ba-4bf0-abbd-214b5a90bc80">method dao-exists-p (dao)</a></li>
<li><a href="#24bce212-b7c3-4526-a869-92c0218f187d">method make-dao (type &amp;rest args &amp;key &amp;allow-other-keys)</a></li>
<li><a href="#org5d65e55">method fetch-defaults (dao)</a></li>
<li><a href="#orgc0460c2">method find-primary-key-column (class)</a></li>
<li><a href="#f7351c36-cb79-43a2-8a5b-5f8aac8ea2d9">macro define-dao-finalization (((dao-name class) &amp;rest keyword-args) &amp;body body)</a></li>
<li><a href="#73e62fab-5bfa-4986-b8c4-992e4d0a134b">method get-dao (type &amp;rest keys)</a></li>
<li><a href="#cd11fa85-5019-4b94-a24c-d0857d633bd2">macro select-dao (type &amp;optional (test t) &amp;rest sort)</a></li>
<li><a href="#6273d302-4199-44a0-aa18-3d8f91affd84">macro do-select-dao (((type type-var) &amp;optional (test t) &amp;rest sort) &amp;body body)</a></li>
<li><a href="#6e5766fb-14dd-4f1e-a68a-fd14d781ac9e">macro query-dao (type query &amp;rest args)</a></li>
<li><a href="#702edc9e-ef43-4df1-9e99-dac6047bdecc">function do-query-dao (((type type-var) query &amp;rest args) &amp;body body)</a></li>
<li><a href="#4a1219dc-d0bc-4fb7-81c9-cb734cb051cc">variable <b>ignore-unknown-columns</b></a></li>
<li><a href="#4a83ef48-a40a-423c-a97c-3d6743ce940c">method insert-dao (dao)</a></li>
<li><a href="#08306ea2-4027-40e8-a9df-8bb2fbc63b3e">method update-dao (dao)</a></li>
<li><a href="#4697a909-970c-492b-b1d6-7e05895f8882">function save-dao (dao)</a></li>
<li><a href="#62a09a7f-8583-404d-b9f3-28b1eb416b0f">function save-dao/transaction (dao)</a></li>
<li><a href="#8eeaf5dd-a802-4ba0-9983-dc153ffc1dae">method upsert-dao (dao)</a></li>
<li><a href="#b135af85-b194-4a5c-9c2d-be87f6827877">method delete-dao (dao)</a></li>
<li><a href="#436e6c77-8550-4462-a956-3affe6d0970c">function dao-table-name (class)</a></li>
<li><a href="#289d7bc0-b4a3-45e3-991b-14b9cfbdcf68">function dao-table-definition (class)</a></li>
<li><a href="#d8aa15a1-7dfc-47b3-ae14-70626c33bcc3">macro with-column-writers ((&amp;rest writers) &amp;body body)</a></li>
</ul>
</li>
<li><a href="#table-definition">Table definition and creation</a>
<ul>
<li><a href="#16d26863-ae01-49f3-9350-8ea2d5ca363c">macro deftable (name &amp;body definition)</a></li>
<li><a href="#d7e145ff-9666-43eb-813d-78a87116532e">variable <b>table-name</b></a></li>
<li><a href="#00432de6-10f6-4e52-85d9-6c622e6c37ec">variable <b>table-symbol</b></a></li>
<li><a href="#01902b36-20f9-4644-9347-fa6cbead2334">function !dao-def ()</a></li>
<li><a href="#b0e0a7d4-1c23-4ba2-88a4-dac55a3584c8">function !index (&amp;rest columns), !unique-index (&amp;rest columns)</a></li>
<li><a href="#eba9236f-a947-4194-8337-4d0f828f5542">function !foreign (target fields &amp;rest target-fields/on-delete/on-update/deferrable/initially-deferred)</a></li>
<li><a href="#5ccbe683-8a43-4373-9371-529a3007bd40">function !unique (target-fields &amp;key deferrable initially-deferred)</a></li>
<li><a href="#e1834b87-e348-44ab-9361-0ad1021d1163">function create-table (symbol)</a></li>
<li><a href="#eba2d105-d5c7-49c0-bfed-828e4ff53b09">function create-all-tables ()</a></li>
<li><a href="#a49e80c8-3204-4803-b263-a0cac063ea12">function create-package-tables (package)</a></li>
<li><a href="#a932fe23-c677-4bb7-8df8-6dd2adf2beff">variables <b>table-name</b>, <b>table-symbol</b></a></li>
<li><a href="#f6879b3f-12dc-44a4-b92e-03dbedd0b1cd">function drop-table (table-name &amp;key if-exists cascade)</a></li>
<li><a href="#9b329d91-58c8-4153-950f-4e58b71455dc">Introduction to Multi-table dao class objects</a></li>
</ul>
</li>
<li><a href="#roles">Roles</a>
<ul>
<li><a href="#694123c8-957f-4b11-a344-094525d35e7f">function role-exists-p (role-name)</a></li>
<li><a href="#07a9f936-c1b7-4a7d-b5a5-57cd6a24870a">function create-role</a></li>
<li><a href="#e527824a-811e-41fa-ae49-2dd24f436ed3">function drop-role (role-name &amp;optional (new-owner "postgres") (database :all))</a></li>
<li><a href="#20f2425f-6a17-46b0-a8b7-22843a7f11e1">function alter-role-search-path (role search-path)</a></li>
<li><a href="#08c10e1f-96a3-4f3b-8b9c-f4a0251d43cd">function change-password (role password &amp;optional expiration-date)</a></li>
<li><a href="#41e66f79-aa57-4f00-b218-5f1a85c7d970">function grant-role-permissions (role-type name &amp;key (schema :public) (tables :all) (databases :all))</a></li>
<li><a href="#ac447228-8f95-4a30-840d-10a1a9a418f4">function grant-readonly-permissions (schema-name role-name &amp;optional (table-name nil))</a></li>
<li><a href="#1a271dc1-5e76-4b90-84d5-423a24059e8b">function grant-editor-permissions (schema-name role-name &amp;optional (table-name nil))</a></li>
<li><a href="#4ac88ea3-bf89-462b-a9dd-cfa115234fb3">function grant-admin-permissions (schema-name role-name &amp;optional (table-name nil))</a></li>
<li><a href="#6e7e67b0-0fb1-461e-a842-a6e6c59f4c2f">function revoke-all-on-table (table-name role-name)</a></li>
<li><a href="#77975516-0416-428c-a9c8-6655b5aebedd">function list-role-accessible-databases (role-name)</a></li>
<li><a href="#a5bdaaca-11e5-438d-83a8-495cef9b85fa">function list-roles (&amp;optional (lt nil))</a></li>
<li><a href="#fd161f71-a334-4959-8b42-dda5271ef6d5">function list-role-permissions (&amp;optional role)</a></li>
</ul>
</li>
<li><a href="#database-information">Database Information</a>
<ul>
<li><a href="#22c6eb1c-c0ca-44fc-a8f1-590fda047866">function add-comment (type name comment &amp;optional (second-name ""))</a></li>
<li><a href="#d993f27b-95d6-4a5b-bdf3-3e06beed0213">function get-database-comment (database-name)</a></li>
<li><a href="#29d56bfd-15a0-40bb-b7f1-a1683b392695">function postgresql-version ()</a></li>
<li><a href="#29d56bfd-15a0-40bb-b7f1-a1683b392695">function database-version ()</a></li>
<li><a href="#69269619-9b8a-4e88-8ede-777182579d0a">function current-database ()</a></li>
<li><a href="#03fec9c2-6282-4b33-abf8-4db16044cf52">function database-exists-p (database-name)</a></li>
<li><a href="#d8827c9d-64ff-4334-9a14-1ca4536f8d0a">function database-size (&amp;optional database-name)</a></li>
<li><a href="#25b5233f-9a2c-4e39-8902-4a0b88e3b5b3">function num-records-in-database ()</a></li>
<li><a href="#b5909c41-f24b-4678-8bd9-759d543c4d81">function list-databases (&amp;key (order-by-size nil) (size t))</a></li>
<li><a href="#ff1d636e-12ba-4fb0-8513-7f808617b956">function list-database-functions ()</a></li>
<li><a href="#5810bfc5-9338-4a6b-807f-bc72265771a0">function list-database-users ()</a></li>
<li><a href="#36e580f9-d647-4f6d-869b-0fcd347fb9d5">function list-database-access-rights (&amp;optional database-name)</a></li>
<li><a href="#3aeac559-710e-4f60-b687-33b25a6f575a">function list-available-types ()</a></li>
<li><a href="#da41c0fb-9479-4e23-bdf2-ba73db959e36">function list-available-collations ()</a></li>
<li><a href="#f6a3893a-0d39-4484-9d3d-40d0ba2e05fd">function list-available-extensions ()</a></li>
<li><a href="#2855d5f5-3957-49ba-9d07-f61464e6da28">function list-installed-extensions ()</a></li>
<li><a href="#5bc847be-5de4-4e64-8feb-7256f58b1a0a">function list-templates ()</a></li>
<li><a href="#e0ce24b7-5619-4ab7-9912-48ebfca4605f">function change-toplevel-database (new-database user password host)</a></li>
<li><a href="#932d1dde-71e2-4f26-bac4-17a238101e24">function cache-hit-ratio ()</a></li>
<li><a href="#84bc40e4-44bf-4c1e-91d2-b32ba77f86c4">function bloat-measurement ()</a></li>
<li><a href="#10ec1cf5-e865-43e9-a093-8f27916af0d2">function unused-indexes ()</a></li>
<li><a href="#c532268f-61d7-4613-85cc-460d7d92aab0">function check-query-performance (&amp;optional (ob nil) (num-calls 100) (limit 20))</a></li>
</ul>
</li>
<li><a href="#constraints">Constraints</a>
<ul>
<li><a href="#e20d9e5c-b0a7-44a6-8907-ad205ec1e0b8">function list-unique-or-primary-constraints (table-name)</a></li>
<li><a href="#4b8a62cb-647b-4c3b-b2a7-58476fff58d1">function list-all-constraints (table-name)</a></li>
<li><a href="#4f692c41-549f-462d-b98c-a8f7e400f4cc">function describe-constraint (table-name constraint-name)</a></li>
<li><a href="#dfe5a61e-7450-47b7-a17b-0d9bd83e1706">function describe-foreign-key-constraints ()</a></li>
</ul>
</li>
<li><a href="#indexes">Indexes/Indices</a>
<ul>
<li><a href="#21392a30-a33c-4330-9a96-abaebcc0af66">function create-index (name  &amp;key unique if-not-exists concurrently on using fields)</a></li>
<li><a href="#6bfcf7a6-6c14-4fad-82f4-5be599f1466b">function drop-index (name &amp;key concurrently if-exists cascade)</a></li>
<li><a href="#42f1ee95-201b-4d66-b02e-1b35b0e1614c">function list-indices (&amp;optional strings-p)</a></li>
<li><a href="#72f27f96-392f-4f33-a152-e15888a98c5d">function list-table-indices (table-name &amp;optional strings-p)</a></li>
<li><a href="#c01dc7a8-0153-4857-acad-cb7ec8eccbdc">function index-exists-p (name)</a></li>
<li><a href="#07e4d320-8201-4cc5-803d-c83ee681d103">function list-indexed-column-and-attributes (table-name)</a></li>
<li><a href="#56922f26-5ab4-4c1a-98a2-a0ab56eff9bb">function list-index-definitions (table-name)</a></li>
</ul>
</li>
<li><a href="#keys">Keys</a>
<ul>
<li><a href="#5bf78e17-6506-4f49-b103-9900978f8344">function find-primary-key-info (table-name &amp;optional (just-key nil))</a></li>
<li><a href="#68d136c2-a216-4def-87f9-726f72dda631">function list-foreign-keys (table-name)</a></li>
</ul>
</li>
<li><a href="#schema">Schema/Schemata</a>
<ul>
<li><a href="#9b1b791c-5e04-4512-91cb-9b44fac7b76e">macro with-schema ((namespace &amp;key :strict t :if-not-exist :create :drop-after) &amp;body body)</a></li>
<li><a href="#cb98d8fa-8750-4d3c-b7c2-a060205609d6">function list-schemata ()</a></li>
<li><a href="#612d3bfd-36e2-4b27-a3e9-9f4e4cf15428">function list-schemas ()</a></li>
<li><a href="#a8a3a0df-edf5-4f17-bb97-a3d76973d078">function schema-exists-p (schema)</a></li>
<li><a href="#06e76060-e646-4fe8-b1b3-142afb2e370b">function create-schema (schema)</a></li>
<li><a href="#79d7fdbb-54d7-48e1-821d-9379e3940577">function drop-schema (schema &amp;key (if-exists nil) (cascade nil))</a></li>
<li><a href="#b8999d95-0ef5-492e-af5b-cfbdc91278e6">function get-search-path ()</a></li>
<li><a href="#125a3594-080f-40eb-997d-d7ef927420e6">function set-search-path (path)</a></li>
<li><a href="#cfacd9fe-b640-4aee-985b-149f4b9ce930">function split-fully-qualified-tablename (name)</a></li>
</ul>
</li>
<li><a href="#sequences">Sequences</a>
<ul>
<li><a href="#4d295beb-7a6d-402e-a831-00db88584cb4">function create-sequence (name &amp;key temp if-not-exists increment min-value max-value start cache)</a></li>
<li><a href="#47336489-34f5-401b-be21-2d7cb0b47e85">function sequence-next (sequence)</a></li>
<li><a href="#e316b343-ad9c-4610-b074-0d554e4b63ed">function drop-sequence (name &amp;key if-exists cascade)</a></li>
<li><a href="#320f409d-dfc2-4145-b106-0e642b21fa95">function list-sequences (&amp;optional strings-p)</a></li>
<li><a href="#da78ff64-0fb8-41a7-b17e-1f24ec8abe63">function sequence-exists-p (name)</a></li>
</ul>
</li>
<li><a href="#tables">Tables</a>
<ul>
<li><a href="#ba11f8df-3297-4720-a267-02896b49575a">function list-tables (&amp;optional strings-p)</a></li>
<li><a href="#ad67dcb1-7123-47dc-9402-e5adcecc7e6a">function list-all-tables (&amp;optional (fully-qualified-names-only nil))</a></li>
<li><a href="#37cd0ae4-b9b2-4776-a58e-dc396e639161">function list-tables-in-schema (&amp;optional (schema-name "public") (strings-p nil))</a></li>
<li><a href="#5d66ed97-c2b2-4ac5-aede-d6fb70a983c8">function list-table-sizes (&amp;key (schema "public") (order-by-size nil) (size t))</a></li>
<li><a href="#55bb44d8-2732-4257-aabd-d38c5e72ef0f">function table-exists-p (name)</a></li>
<li><a href="#bb623170-32c2-43b4-807d-66c34efe9c40">function table-size (table-name)</a></li>
<li><a href="#ee444ea2-f49f-41c9-905c-177d89770254">function table-description (name &amp;optional schema-name)</a></li>
<li><a href="#795b7f54-85ee-4c77-b962-9176f93ad7ac">function table-description-plus (table-name)</a></li>
<li><a href="#74baf413-72fb-4f17-abb0-1e7535af33ab">function list-columns (table-name)</a></li>
<li><a href="#9ada61bd-a670-49f3-8c04-cf025cde431f">function list-columns-with-types (table-name)</a></li>
<li><a href="#11e937a0-91f6-4475-b393-8f4f2e5d9659">function column-exists-p (table-name column-name &amp;optional schema-name)</a></li>
<li><a href="#8ab55683-e44b-44df-bb11-67909d402383">function get-table-oid (table-name &amp;optional schema-name)</a></li>
<li><a href="#e8d6e402-5c76-4533-9b5c-a823b9582c26">function get-table-comment (table-name &amp;optional schema-name)</a></li>
<li><a href="#org8f67d37">function rename-table (old-name new-name)</a></li>
<li><a href="#org0ca0bf5">function rename-column (table-name old-name new-name)</a></li>
</ul>
</li>
<li><a href="#tablespaces">Tablespaces</a>
<ul>
<li><a href="#70537823-781b-47dd-8c38-9936756c666c">function list-tablespaces ()</a></li>
</ul>
</li>
<li><a href="#triggers">Triggers</a>
<ul>
<li><a href="#7327ab9a-b79e-4180-8165-434fd4c8d383">function describe-triggers ()</a></li>
<li><a href="#3bcdabed-dd01-4457-bc18-284598aee0a4">function list-triggers (&amp;optional table-name)</a></li>
<li><a href="#fc3761c2-fc2e-42e4-86f2-0e918c891b5e">function list-detailed-triggers ()</a></li>
</ul>
</li>
<li><a href="#views">Views</a>
<ul>
<li><a href="#4fd820d9-857e-48fa-a62b-e2d72313a10c">function list-views (&amp;optional strings-p)</a></li>
<li><a href="#f9ba3cce-95e0-45a0-9ede-5654bb71e98e">function view-exists-p (name)</a></li>
<li><a href="#bbf87da5-981c-42ad-b97e-38c7fafbf8ca">function describe-views (&amp;optional (schema "public")</a></li>
</ul>
</li>
<li><a href="#misc-utility-functions">Miscellaneous Utility Functions</a>
<ul>
<li><a href="#9e576b29-c33d-425d-8759-e8e5e8367593">function coalesce (&amp;rest arguments)</a></li>
<li><a href="#441f2929-9c04-4b01-8b85-7c474e200755">function execute-file (filename &amp;optional (print nil))</a></li>
<li><a href="#fcf022af-ae93-470d-be11-23a25acf0bb9">function num-records-in-database ()</a></li>
<li><a href="#1870a515-3f02-45c6-b42c-97659580f257">function postgres-array-string-to-list (str)</a></li>
<li><a href="#6fa88adf-cd17-40a8-beb2-0ecea529f6db">function postgres-array-string-to-array (str)</a></li>
</ul>
</li>
<li><a href="#b9ec79c0-8e2e-4bad-adcd-e8aa9b6c9a27">Imported From s-sql</a>
<ul>
<li><a href="#8c74e736-6b4f-4996-88c4-f087f46cff05">macro sql (form)</a></li>
<li><a href="#ace3cbb6-04f0-435b-b2d9-55e2612ea01b">function sql-compile (form)</a></li>
<li><a href="#55a205bf-c9f4-450c-aa86-45cce006ee79">deftype smallint ()</a></li>
<li><a href="#80a15f41-d550-4f3b-adc5-4558d3ddf166">deftype bigint ()</a></li>
<li><a href="#4a38ba2c-b03b-4887-905b-1bf85cd3f607">deftype numeric (&amp;optional precision/scale scale)</a></li>
<li><a href="#8e094b66-fcc0-4f6e-91dd-5f3c63a7e8a0">deftype double-precision ()</a></li>
<li><a href="#f4e4e8ac-2d8c-4dea-991f-af57fa589932">deftype bytea ()</a></li>
<li><a href="#a18ec054-2fcb-482f-bda5-988ab94e9763">deftype text ()</a></li>
<li><a href="#d4aa0266-7d2d-4207-909f-8b5767be03fd">deftype varchar (length)</a></li>
<li><a href="#20cabfe5-d425-422d-a91a-06e7c4cf0a30">deftype serial ()</a></li>
<li><a href="#15d4e630-03c8-4fe0-9b1e-b42a2b42910b">deftype serial8 ()</a></li>
<li><a href="#f862411e-45cb-4f24-9caa-15edbe804999">deftype db-null ()</a></li>
<li><a href="#24878142-d801-4fb0-b58b-b59454ee414d">function from-sql-name (str)</a></li>
<li><a href="#0205cc17-d05d-4ac1-96eb-1c2431e948c8">function parse-queries (file-content)</a></li>
<li><a href="#de3bb099-ed34-423a-9bcd-535e1a5f588b">function read-queries (filename)</a></li>
<li><a href="#a6245312-f133-481b-8aed-2bd7c4d4b972">function sql-escape-string (string)</a></li>
<li><a href="#73012d8f-1e5d-4518-8df8-368a4fae3441">method sql-escape (arg)</a></li>
<li><a href="#1723409d-0013-459a-a89c-236d1c7f2fb5">macro register-sql-operators (arity &amp;rest names)</a></li>
<li><a href="#678a9397-e784-42bf-ba21-7d1d8a5816e2">variable <b>escape-sql-names-p</b></a></li>
<li><a href="#3cbda7a6-974c-475d-a87c-90353ac15b75">function to-sql-name (name &amp;optional (escape-p <b>escape-sql-names-p</b>) (ignore-reserved-words nil))</a></li>
<li><a href="#2970d836-dcaa-4b49-aa95-27aa9d3d4f3f">condition sql-error</a></li>
</ul>
</li>
<li><a href="#5ccb5ff2-0d42-48d4-90c0-2ef6e7f8f1c7">Conditions Imported From cl-postgres</a>
<ul>
<li><a href="#b16b281c-2103-4f65-bb48-d9ac0083a302">condition database-connection-error</a></li>
<li><a href="#06f35002-f176-4bae-b9cc-271b8b3b2cf1">condition database-error</a></li>
<li><a href="#77cc7700-9573-4280-ba3a-cb368fa96dcc">function database-error-constraint-name (err)</a></li>
<li><a href="#52fe59d2-396d-4c36-9a94-5ef452702d79">function database-error-extract-name (err)</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<p>
This is the reference manual for the component named postmodern, which is part
of a library of the same name.
</p>

<p>
Note that this package also exports the database-connection and database-error
types from CL-postgres and a few operators from S-SQL.
</p>

<p>
query, execute, and any other function that would logically need to communicate
with the database will raise a condition of the type database-error when
something goes wrong. As a special case, errors that break the connection
(socket errors, database shutdowns) will be raised as subtypes of
database-connection-error, providing a :reconnect restart to re-try the
operation that encountered to the error.
</p>

<div id="outline-container-org92e12b9" class="outline-2">
<h2 id="connecting"><a id="org92e12b9"></a><a id="ID-75c23b08-3840-4d28-8ced-978d10a629d5"></a>Connecting</h2>
<div class="outline-text-2" id="text-connecting">
</div>
<div id="outline-container-orgfe75b57" class="outline-3">
<h3 id="dfc95b36-94d7-42ab-827b-8622f593e7f6"><a id="orgfe75b57"></a><a id="ID-821e500c-5206-4f8b-a505-266d18faf8cb"></a>class database-connection</h3>
<div class="outline-text-3" id="text-dfc95b36-94d7-42ab-827b-8622f593e7f6">
<p>
Representation of a database connection. Contains login information in order to
be able to automatically re-establish a connection when it is somehow closed.
</p>
</div>
</div>

<div id="outline-container-orga0a9f08" class="outline-3">
<h3 id="d4aa3e04-ab90-4271-b3e7-60a48e4f2e49"><a id="orga0a9f08"></a><a id="ID-66e24327-bae9-4378-987c-ccdacc312ddf"></a>function connect (database user-name password host &amp;key (port 5432) pooled-p use-ssl)</h3>
<div class="outline-text-3" id="text-d4aa3e04-ab90-4271-b3e7-60a48e4f2e49">
<p>
→ database-connection
</p>

<p>
Create a new database connection for the given user and the database. Port will
default to 5432, which is where most PostgreSQL servers are running. If
pooled-p is T, a connection will be taken from a pool of connections of this
type, if one is available there, and when the connection is disconnected it will
be put back into this pool instead. use-ssl can be :no, :try, :require, :yes, or :full
and defaults to the value of <b>default-use-ssl</b>
</p>

<ul class="org-ul">
<li>:try means if the server supports it</li>
<li>:require means use provided ssl certificate with no verification</li>
<li>:yes means verify that the server cert is issued by a trusted CA, but does not verify the server hostname</li>
<li>:full means expect a CA-signed cert for the supplied hostname and verify the server hostname</li>
</ul>
<p>
If you set it to anything other than :no be sure to also load the CL+SSL library.
</p>
</div>
</div>

<div id="outline-container-org824aea3" class="outline-3">
<h3 id="e140fab3-b6fe-4e88-b9ca-241bbb64fce4"><a id="org824aea3"></a><a id="ID-106f14f7-270e-4e27-a238-34c50b14e44b"></a>variable <b>default-use-ssl</b></h3>
<div class="outline-text-3" id="text-e140fab3-b6fe-4e88-b9ca-241bbb64fce4">
<p>
The default for connect's use-ssl argument.
Valid settings are :no, :try, :require, :yes, or :full
:try means if the server supports it
:require means use provided ssl certificate with no verification
:yes means verify that the server cert is issued by a trusted CA, but does not verify the server hostname
:full means expect a CA-signed cert for the supplied hostname and verify the server hostname
If you set it to anything other than :no be sure to also load the CL+SSL library.
</p>
</div>
</div>

<div id="outline-container-org5c0c04e" class="outline-3">
<h3 id="9a1a03af-a67e-4419-9066-d79a81885f81"><a id="org5c0c04e"></a><a id="ID-4c9746be-27ce-485c-b35e-d739e7def9c4"></a>method disconnect (database-connection)</h3>
<div class="outline-text-3" id="text-9a1a03af-a67e-4419-9066-d79a81885f81">
<p>
Disconnects a normal database connection, or moves a pooled connection into the
pool.
</p>
</div>
</div>

<div id="outline-container-orgaa1cef7" class="outline-3">
<h3 id="a660d0cc-4795-41df-b183-0ea31f6b6584"><a id="orgaa1cef7"></a><a id="ID-d9f11a8d-3676-42e9-aee9-a544ef67df28"></a>function connected-p (database-connection)</h3>
<div class="outline-text-3" id="text-a660d0cc-4795-41df-b183-0ea31f6b6584">
<p>
→ boolean
</p>

<p>
Returns a boolean indicating whether the given connection is still connected to
the server.
</p>
</div>
</div>

<div id="outline-container-org5f984c6" class="outline-3">
<h3 id="426a8f5d-5dc7-4973-a1fc-11b488afcd82"><a id="org5f984c6"></a><a id="ID-6e117ba4-b3f7-48f3-9616-67e3c3e2b7e4"></a>method reconnect (database-connection)</h3>
<div class="outline-text-3" id="text-426a8f5d-5dc7-4973-a1fc-11b488afcd82">
<p>
Reconnect a disconnected database connection. This is not allowed for pooled
connections ― after they are disconnected they might be in use by some other
process, and should no longer be used.
</p>
</div>
</div>

<div id="outline-container-orgc55d932" class="outline-3">
<h3 id="9b9cf868-214b-4026-8f80-25b23f445c91"><a id="orgc55d932"></a><a id="ID-73c9e729-4db7-4ef3-a095-7b91a9db6238"></a>variable <b>database</b></h3>
<div class="outline-text-3" id="text-9b9cf868-214b-4026-8f80-25b23f445c91">
<p>
Special variable holding the current database connection information. Most
functions and macros operating on a database assume this binds to a connected
database.
</p>
</div>
</div>

<div id="outline-container-org61a94ec" class="outline-3">
<h3 id="056d4921-c834-4655-a487-83314f22da42"><a id="org61a94ec"></a><a id="ID-c5d5b7f9-9555-4a0e-b691-1b10742e482d"></a>macro with-connection (spec &amp;body body)</h3>
<div class="outline-text-3" id="text-056d4921-c834-4655-a487-83314f22da42">
<p>
Evaluates the body with <b>database</b> bound to a connection as specified by spec,
which should be list that connect can be applied to.
</p>
</div>
</div>

<div id="outline-container-orgcb0671c" class="outline-3">
<h3 id="0e0c03e9-7681-433f-ae75-8f06c9685221"><a id="orgcb0671c"></a><a id="ID-476f90d8-15ac-49fb-ac19-1dc3dfdfcef7"></a>macro call-with-connection (spec thunk)</h3>
<div class="outline-text-3" id="text-0e0c03e9-7681-433f-ae75-8f06c9685221">
<p>
The functional backend to with-connection. Binds <b>database</b> to a new connection
as specified by spec, which should be a list that connect can be applied to, and
runs the zero-argument function given as second argument in the new environment.
When the function returns or throws, the new connection is disconnected.
</p>
</div>
</div>

<div id="outline-container-org804f6f4" class="outline-3">
<h3 id="a74be5d0-9b86-4c15-b738-76cd92908d25"><a id="org804f6f4"></a><a id="ID-ffab8aae-0ed7-4466-a68d-fc90d2e36dbe"></a>function connect-toplevel (database user-name password host &amp;key (port 5432))</h3>
<div class="outline-text-3" id="text-a74be5d0-9b86-4c15-b738-76cd92908d25">
<p>
Bind the <b>database</b> to a new connection. Use this if you only need one
connection, or if you want a connection for debugging from the REPL.
</p>
</div>
</div>

<div id="outline-container-orgdd2374e" class="outline-3">
<h3 id="a63f929c-805d-42d5-8fbe-f1c01e62b50a"><a id="orgdd2374e"></a><a id="ID-f5819286-2754-468d-bfdd-e4ee06b877e3"></a>function disconnect-toplevel ()</h3>
<div class="outline-text-3" id="text-a63f929c-805d-42d5-8fbe-f1c01e62b50a">
<p>
Disconnect the <b>database</b>.
</p>
</div>
</div>

<div id="outline-container-org00ce7b6" class="outline-3">
<h3 id="56c370e4-8f4e-414a-82b6-ae4408fc0b61"><a id="org00ce7b6"></a><a id="ID-04d09496-6a7b-4794-a204-8667f3b69011"></a>function clear-connection-pool ()</h3>
<div class="outline-text-3" id="text-56c370e4-8f4e-414a-82b6-ae4408fc0b61">
<p>
Disconnect and remove all connections from the connection pools.
</p>
</div>
</div>

<div id="outline-container-org9705b9f" class="outline-3">
<h3 id="97aa1ebb-ef91-4254-a6b7-bfcd8128ad96"><a id="org9705b9f"></a><a id="ID-92ab48e3-bf8f-4327-8d9c-69b6c168f94e"></a>variable <b>max-pool-size</b></h3>
<div class="outline-text-3" id="text-97aa1ebb-ef91-4254-a6b7-bfcd8128ad96">
<p>
Set the maximum amount of connections kept in a single connection pool, where a
pool consists of all the stored connections with the exact same connect
arguments. Defaults to NIL, which means there is no maximum.
</p>
</div>
</div>

<div id="outline-container-org00f993e" class="outline-3">
<h3 id="09583f9a-388a-400a-bb3c-d118242508c8"><a id="org00f993e"></a><a id="ID-1410d2f2-3f68-4e3d-947b-46167ecf1d37"></a>function list-connections ()</h3>
<div class="outline-text-3" id="text-09583f9a-388a-400a-bb3c-d118242508c8">
<p>
→ list
</p>

<p>
List the current postgresql connections to the currently connected database. It
does this by returningo info from pg_stat_activity on open connections.
</p>
</div>
</div>
</div>
<div id="outline-container-org85a874f" class="outline-2">
<h2 id="querying"><a id="org85a874f"></a><a id="ID-e5e99216-0a15-4de8-b1d9-21bdcdf378fa"></a>Querying</h2>
<div class="outline-text-2" id="text-querying">
</div>
<div id="outline-container-org033bc31" class="outline-3">
<h3 id="5a8c24fb-6d7b-4952-8520-b5e8ea98dd77"><a id="org033bc31"></a><a id="ID-0f8ab85f-b592-4648-8936-d16abce50faa"></a>macro query (query &amp;rest args/format)</h3>
<div class="outline-text-3" id="text-5a8c24fb-6d7b-4952-8520-b5e8ea98dd77">
<p>
→ result
</p>

<p>
Execute the given query, which can be either a string or an S-SQL form
(list starting with a keyword). If the query contains placeholders ($1, $2, etc)
their values can be given as extra arguments. If one of these arguments
is a keyword occurring in the table below, it will not be used as a query
argument, but will determine the format in which the results are returned
instead. Any of the following formats can be used, with the default being :rows:
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">:none</td>
<td class="org-left">Ignore the result values.</td>
</tr>

<tr>
<td class="org-left">:lists, :rows</td>
<td class="org-left">Return a list of lists, each list containing the values for a row.</td>
</tr>

<tr>
<td class="org-left">:list, :row</td>
<td class="org-left">Return a single row as a list.</td>
</tr>

<tr>
<td class="org-left">:alists</td>
<td class="org-left">Return a list of alists which map column names to values, with the names represented as keywords.</td>
</tr>

<tr>
<td class="org-left">:alist</td>
<td class="org-left">Return a single row as an alist.</td>
</tr>

<tr>
<td class="org-left">:str-alists</td>
<td class="org-left">Like :alists, but use the original column names.</td>
</tr>

<tr>
<td class="org-left">:str-alist</td>
<td class="org-left">Return a single row as an alist, with strings for names.</td>
</tr>

<tr>
<td class="org-left">:plists</td>
<td class="org-left">Return a list of plists which map column names to values,with the names represented as keywords.</td>
</tr>

<tr>
<td class="org-left">:plist</td>
<td class="org-left">Return a single row as a plist.</td>
</tr>

<tr>
<td class="org-left">:column</td>
<td class="org-left">Return a single column as a list.</td>
</tr>

<tr>
<td class="org-left">:single</td>
<td class="org-left">Return a single value. Will raise an error if the query returns more than one field. If the query returns more than one row, it returns the first row.</td>
</tr>

<tr>
<td class="org-left">:single!</td>
<td class="org-left">Like :single except that it will throw an error when the number of selected rows is not equal to 1.</td>
</tr>

<tr>
<td class="org-left">:array-hash</td>
<td class="org-left">Return an array of hashtables which map column names to hash table keys</td>
</tr>

<tr>
<td class="org-left">:json-strs</td>
<td class="org-left">Return a list of strings where each row is a json object expressed as a string</td>
</tr>

<tr>
<td class="org-left">:json-strs</td>
<td class="org-left">Return a single string where the row returned is a json object expressed as a string</td>
</tr>

<tr>
<td class="org-left">:json-array-str</td>
<td class="org-left">Return a string containing a json array, each element in the array is a selected row expressed as a json object</td>
</tr>

<tr>
<td class="org-left">(:dao type)</td>
<td class="org-left">Return a list of DAOs of the given type. The names of the fields returned by the query must match slots in the DAO class the same way as with query-dao.</td>
</tr>

<tr>
<td class="org-left">(:dao type :single)</td>
<td class="org-left">Return a single DAO of the given type.</td>
</tr>
</tbody>
</table>

<p>
Some Examples:
</p>
</div>
<div id="outline-container-org86de3e8" class="outline-4">
<h4 id="org86de3e8">Default</h4>
<div class="outline-text-4" id="text-org86de3e8">
<p>
The default is :lists
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'id 'int4 'text <span style="color: #98fb98; font-weight: bold;">:from</span> 'short-data-type-tests <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:&lt;</span> 'id 3)))
((1 2147483645 <span style="color: #cd8162;">"text one"</span>) (2 0 <span style="color: #cd8162;">"text two"</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-org02e62bf" class="outline-4">
<h4 id="org02e62bf">Single</h4>
<div class="outline-text-4" id="text-org02e62bf">
<p>
Returns a single field. Will throw an error if the queries returns more than one field or more than one row
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'text <span style="color: #98fb98; font-weight: bold;">:from</span> 'short-data-type-tests <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'id 3)) <span style="color: #98fb98; font-weight: bold;">:single</span>)
<span style="color: #cd8162;">"text three"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orge5bc7cf" class="outline-4">
<h4 id="orge5bc7cf">List</h4>
<div class="outline-text-4" id="text-orge5bc7cf">
<p>
Returns a list containing the selected fields. Will throw an error if the query returns more than one row
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'id 'int4 'text <span style="color: #98fb98; font-weight: bold;">:from</span> 'short-data-type-tests <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'id 3)) <span style="color: #98fb98; font-weight: bold;">:list</span>)
(3 3 <span style="color: #cd8162;">"text three"</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-orge16f6fb" class="outline-4">
<h4 id="orge16f6fb">Lists</h4>
<div class="outline-text-4" id="text-orge16f6fb">
<p>
This is the default
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'id 'int4 'text <span style="color: #98fb98; font-weight: bold;">:from</span> 'short-data-type-tests <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:&lt;</span> 'id 3)) <span style="color: #98fb98; font-weight: bold;">:lists</span>)
((1 2147483645 <span style="color: #cd8162;">"text one"</span>) (2 0 <span style="color: #cd8162;">"text two"</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-orge169878" class="outline-4">
<h4 id="orge169878">Alist</h4>
<div class="outline-text-4" id="text-orge169878">
<p>
Returns an alist containing the field name as a keyword and the selected fields. Will throw an error if the query returns more than one row.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'id 'int4 'text <span style="color: #98fb98; font-weight: bold;">:from</span> 'test-data <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'id 3)) <span style="color: #98fb98; font-weight: bold;">:alist</span>)
((<span style="color: #98fb98; font-weight: bold;">:ID</span> . 3) (<span style="color: #98fb98; font-weight: bold;">:INT4</span> . 3) (<span style="color: #98fb98; font-weight: bold;">:TEXT</span> . <span style="color: #cd8162;">"text three"</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-org9083d55" class="outline-4">
<h4 id="org9083d55">Str-alist</h4>
<div class="outline-text-4" id="text-org9083d55">
<p>
Returns an alist containing the field name as a lower case string and the selected fields. Will throw an error if the query returns more than one row.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'id 'int4 'text <span style="color: #98fb98; font-weight: bold;">:from</span> 'short-data-type-tests <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'id 3)) <span style="color: #98fb98; font-weight: bold;">:str-alist</span>)
((<span style="color: #cd8162;">"id"</span> . 3) (<span style="color: #cd8162;">"int4"</span> . 3) (<span style="color: #cd8162;">"text"</span> . <span style="color: #cd8162;">"text three"</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbc25e47" class="outline-4">
<h4 id="orgbc25e47">Alists</h4>
<div class="outline-text-4" id="text-orgbc25e47">
<p>
Returns a list of alists containing the field name as a keyword and the selected fields.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'id 'int4 'text <span style="color: #98fb98; font-weight: bold;">:from</span> 'short-data-type-tests <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:&lt;</span> 'id 3)) <span style="color: #98fb98; font-weight: bold;">:alists</span>)
(((<span style="color: #98fb98; font-weight: bold;">:ID</span> . 1) (<span style="color: #98fb98; font-weight: bold;">:INT4</span> . 2147483645) (<span style="color: #98fb98; font-weight: bold;">:TEXT</span> . <span style="color: #cd8162;">"text one"</span>))
 ((<span style="color: #98fb98; font-weight: bold;">:ID</span> . 2) (<span style="color: #98fb98; font-weight: bold;">:INT4</span> . 0) (<span style="color: #98fb98; font-weight: bold;">:TEXT</span> . <span style="color: #cd8162;">"text two"</span>)))
</pre>
</div>
</div>
</div>
<div id="outline-container-orga3b29a8" class="outline-4">
<h4 id="orga3b29a8">Str-alists</h4>
<div class="outline-text-4" id="text-orga3b29a8">
<p>
Returns a list of alists containing the field name as a lower case string and the selected fields.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'id 'int4 'text <span style="color: #98fb98; font-weight: bold;">:from</span> 'short-data-type-tests <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:&lt;</span> 'id 3)) <span style="color: #98fb98; font-weight: bold;">:str-alists</span>)
(((<span style="color: #cd8162;">"id"</span> . 1) (<span style="color: #cd8162;">"int4"</span> . 2147483645) (<span style="color: #cd8162;">"text"</span> . <span style="color: #cd8162;">"text one"</span>))
 ((<span style="color: #cd8162;">"id"</span> . 2) (<span style="color: #cd8162;">"int4"</span> . 0) (<span style="color: #cd8162;">"text"</span> . <span style="color: #cd8162;">"text two"</span>)))
</pre>
</div>
</div>
</div>
<div id="outline-container-org1fe962c" class="outline-4">
<h4 id="org1fe962c">Plist</h4>
<div class="outline-text-4" id="text-org1fe962c">
<p>
Returns a plist containing the field name as a keyword and the selected fields. Will throw an error if the query returns more than one row.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'id 'int4 'text <span style="color: #98fb98; font-weight: bold;">:from</span> 'short-data-type-tests <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'id 3)) <span style="color: #98fb98; font-weight: bold;">:plist</span>)
(<span style="color: #98fb98; font-weight: bold;">:ID</span> 3 <span style="color: #98fb98; font-weight: bold;">:INT4</span> 3 <span style="color: #98fb98; font-weight: bold;">:TEXT</span> <span style="color: #cd8162;">"text three"</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-org7c6706d" class="outline-4">
<h4 id="org7c6706d">Plists</h4>
<div class="outline-text-4" id="text-org7c6706d">
<p>
Returns a list of plists containing the field name as a keyword and the selected fields.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'id 'int4 'text <span style="color: #98fb98; font-weight: bold;">:from</span> 'short-data-type-tests <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:&lt;</span> 'id 3)) <span style="color: #98fb98; font-weight: bold;">:plists</span>)
((<span style="color: #98fb98; font-weight: bold;">:ID</span> 1 <span style="color: #98fb98; font-weight: bold;">:INT4</span> 2147483645 <span style="color: #98fb98; font-weight: bold;">:TEXT</span> <span style="color: #cd8162;">"text one"</span>) (<span style="color: #98fb98; font-weight: bold;">:ID</span> 2 <span style="color: #98fb98; font-weight: bold;">:INT4</span> 0 <span style="color: #98fb98; font-weight: bold;">:TEXT</span> <span style="color: #cd8162;">"text two"</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-org77e2bf4" class="outline-4">
<h4 id="org77e2bf4">Array-hash</h4>
<div class="outline-text-4" id="text-org77e2bf4">
<p>
Returns a vector of hashtables where each hash table is a returned row from the query with field name as the key expressed as a lower case string.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'id 'int4 'text <span style="color: #98fb98; font-weight: bold;">:from</span> 'short-data-type-tests <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:&lt;</span> 'id 3)) <span style="color: #98fb98; font-weight: bold;">:array-hash</span>)
#(#&lt;HASH-TABLE <span style="color: #98fb98; font-weight: bold;">:TEST</span> EQUAL <span style="color: #98fb98; font-weight: bold;">:COUNT</span> 3 {100D982B53}&gt;
  #&lt;HASH-TABLE <span style="color: #98fb98; font-weight: bold;">:TEST</span> EQUAL <span style="color: #98fb98; font-weight: bold;">:COUNT</span> 3 {100D982ED3}&gt;)

(alexandria:hash-table-alist
  (aref
    (query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'id 'int4 'text <span style="color: #98fb98; font-weight: bold;">:from</span> 'short-data-type-tests <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:&lt;</span> 'id 3)) <span style="color: #98fb98; font-weight: bold;">:array-hash</span>)
    1))
((<span style="color: #cd8162;">"text"</span> . <span style="color: #cd8162;">"text two"</span>) (<span style="color: #cd8162;">"int4"</span> . 0) (<span style="color: #cd8162;">"id"</span> . 2))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbb6e89d" class="outline-4">
<h4 id="orgbb6e89d">Dao</h4>
<div class="outline-text-4" id="text-orgbb6e89d">
<p>
Returns a list of daos of the type specified
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> '* <span style="color: #98fb98; font-weight: bold;">:from</span> 'country) (<span style="color: #98fb98; font-weight: bold;">:dao</span> country))
(#&lt;COUNTRY {1010464023}&gt; #&lt;COUNTRY {1010465CB3}&gt;)

(query (<span style="color: #98fb98; font-weight: bold;">:select</span> '* <span style="color: #98fb98; font-weight: bold;">:from</span> 'country <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'name <span style="color: #cd8162;">"Croatia"</span>)) (<span style="color: #98fb98; font-weight: bold;">:dao</span> country))
(#&lt;COUNTRY {1010688943}&gt;)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgddfdade" class="outline-4">
<h4 id="orgddfdade">Column</h4>
<div class="outline-text-4" id="text-orgddfdade">
<p>
Returns a list of field values of a single field. Will throw an error if more than one field is selected
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'id <span style="color: #98fb98; font-weight: bold;">:from</span> 'short-data-type-tests <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:&lt;</span> 'id 3)) <span style="color: #98fb98; font-weight: bold;">:column</span>)
(1 2)

(query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'id <span style="color: #98fb98; font-weight: bold;">:from</span> 'short-data-type-tests <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'id 3)) <span style="color: #98fb98; font-weight: bold;">:column</span>)
(3)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgec8cd7c" class="outline-4">
<h4 id="orgec8cd7c">Json-strs</h4>
<div class="outline-text-4" id="text-orgec8cd7c">
<p>
Return a list of strings where the row returned is a json object expressed as a string
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'id 'int4 'text <span style="color: #98fb98; font-weight: bold;">:from</span> 'short-data-type-tests <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:&lt;</span> 'id 3)) <span style="color: #98fb98; font-weight: bold;">:json-strs</span>)
(<span style="color: #cd8162;">"{\"id\":1,\"int4\":2147483645,\"text\":\"text one\"}"</span>
 <span style="color: #cd8162;">"{\"id\":2,\"int4\":0,\"text\":\"text two\"}"</span>)
</pre>
</div>
<p>
This will also handle local-time timestamps and simple-date timestamps,
time-of-day and date. E.g. (with a local-time timestamp)
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'timestamp-with-time-zone
        <span style="color: #98fb98; font-weight: bold;">:from</span> 'test-data
        <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:&lt;</span> 'id 3))
  <span style="color: #98fb98; font-weight: bold;">:json-strs</span>)

'(<span style="color: #cd8162;">"{\"timestampWithTimeZone\":\"{2019-12-30T13:30:54.000000-05:00}\"}"</span>
  <span style="color: #cd8162;">"{\"timestampWithTimeZone\":\"{1919-12-30T13:30:54.000000-05:00}\"}"</span>)
</pre>
</div>

<p>
The following is an example with a simple-date timestamp.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'timestamp-with-time-zone
                       <span style="color: #98fb98; font-weight: bold;">:from</span> 'test-data
                       <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:&lt;</span> 'id 3)) <span style="color: #98fb98; font-weight: bold;">:json-strs</span>)
'(<span style="color: #cd8162;">"{\"timestampWithTimeZone\":\"2019-12-30 18:30:54:0\"}"</span>
  <span style="color: #cd8162;">"{\"timestampWithTimeZone\":\"1919-12-30 18:30:54:0\"}"</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-org6bada5b" class="outline-4">
<h4 id="org6bada5b">Json-str</h4>
<div class="outline-text-4" id="text-org6bada5b">
<p>
Return a single string where the row returned is a json object expressed as a string
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'id 'int4 'text <span style="color: #98fb98; font-weight: bold;">:from</span> 'short-data-type-tests <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'id 3)) <span style="color: #98fb98; font-weight: bold;">:json-str</span>)
<span style="color: #cd8162;">"{\"id\":3,\"int4\":3,\"text\":\"text three\"}"</span>
</pre>
</div>
<p>
As with :json-strs, this will also work for either simple-date or local-time timestamps
</p>
</div>
</div>

<div id="outline-container-org0cdd964" class="outline-4">
<h4 id="org0cdd964">Json-array-str</h4>
<div class="outline-text-4" id="text-org0cdd964">
<p>
Return a string containing a json array, each element in the array is a selected row expressed as a json object
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'id 'int4 'text <span style="color: #98fb98; font-weight: bold;">:from</span> 'short-data-type-tests <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:&lt;</span> 'id 3)) <span style="color: #98fb98; font-weight: bold;">:json-array-str</span>)
<span style="color: #cd8162;">"[{\"id\":1,\"int4\":2147483645,\"text\":\"text one\"}, {\"id\":2,\"int4\":0,\"text\":\"text two\"}]"</span>
</pre>
</div>
<p>
As with :json-strs, this will also work for either simple-date or local-time timestamps
</p>
</div>
</div>
<div id="outline-container-orgd9f67ae" class="outline-4">
<h4 id="orgd9f67ae">Second value returned</h4>
<div class="outline-text-4" id="text-orgd9f67ae">
<p>
If the database returns information about the amount rows that were affected,
such as with updating or deleting queries, this is returned as a second value.
</p>
</div>
</div>
</div>

<div id="outline-container-org9b58e56" class="outline-3">
<h3 id="71106869-4169-49c8-ba7d-ce6b9fc7d780"><a id="org9b58e56"></a><a id="ID-b494a547-353c-4de4-8071-e8703a62b919"></a>macro execute (query &amp;rest args)</h3>
<div class="outline-text-3" id="text-71106869-4169-49c8-ba7d-ce6b9fc7d780">
<p>
Execute a query, ignore the results. So, in effect, Like a query called with
format :none. Returns the amount of affected rows as its first returned value.
(Also returns this amount as the second returned value, but use of this is
deprecated.)
</p>
</div>
</div>

<div id="outline-container-orgab9dd3e" class="outline-3">
<h3 id="66aa9f57-ac8a-4457-9891-3453682518e0"><a id="orgab9dd3e"></a><a id="ID-db023195-6f0f-446d-9188-0886d895202b"></a>macro doquery (query (&amp;rest names) &amp;body body)</h3>
<div class="outline-text-3" id="text-66aa9f57-ac8a-4457-9891-3453682518e0">
<p>
Execute the given query (a string or a list starting with a keyword), iterating
over the rows in the result. The body will be executed with the values in the
row bound to the symbols given in names. To iterate over a parameterised query,
one can specify a list whose car is the query, and whose cdr contains the
arguments. For example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(doquery (<span style="color: #98fb98; font-weight: bold;">:select</span> 'name 'score <span style="color: #98fb98; font-weight: bold;">:from</span> 'scores) (n s)
  (incf (gethash n *scores*) s))

(doquery ((<span style="color: #98fb98; font-weight: bold;">:select</span> 'name <span style="color: #98fb98; font-weight: bold;">:from</span> 'scores <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:&gt;</span> 'score '$1)) 100) (name)
  (print name))
</pre>
</div>
</div>
</div>

<div id="outline-container-org5a42434" class="outline-3">
<h3 id="625b6ade-7b09-49dc-b288-78c550b25d83"><a id="org5a42434"></a><a id="ID-0daaa786-45e9-4853-934c-e1499b4c87f0"></a>macro prepare (query &amp;optional (format :rows))</h3>
<div class="outline-text-3" id="text-625b6ade-7b09-49dc-b288-78c550b25d83">
<p>
→ function
</p>

<p>
Wraps a query into a function that can be used as the interface to a prepared
statement. The given query (either a string or an S-SQL form) may contain
placeholders, which look like $1, $2, etc. The resulting function takes one
argument for every placeholder in the query, executes the prepared query, and
returns the result in the format specified. (Allowed formats are the same as for
query.)
</p>

<p>
For queries that have to be run very often, especially when they are complex,
it may help performance since the server only has to plan them once. See the <a href="http://www.postgresql.org/docs/current/static/sql-prepare.html">
PostgreSQL manual</a> for details.
</p>

<p>
In some cases, the server will complain about not being able to deduce the type
of the arguments in a statement. In that case you should add type declarations
(either with the PostgreSQL's CAST SQL-conforming syntax or
historical :: syntax, or with S-SQL's :type construct) to help it out.
</p>

<p>
Note that it will attempt to automatically reconnect if
database-connection-error, or admin-shutdown. It will reset prepared statements
triggering an invalid-sql-statement-name error. It will overwrite old prepared
statements triggering a duplicate-prepared-statement error.
</p>
</div>
</div>

<div id="outline-container-org8912dbc" class="outline-3">
<h3 id="b2ed5fb5-d5f5-4425-b30e-5c40a2997eee"><a id="org8912dbc"></a><a id="ID-d95a6214-b951-4fcd-96ab-a0c40d62ee2b"></a>macro defprepared (name query &amp;optional (format :rows))</h3>
<div class="outline-text-3" id="text-b2ed5fb5-d5f5-4425-b30e-5c40a2997eee">
<p>
→ function
</p>

<p>
This is the macro-style variant of prepare. It is like prepare, but gives the
function a name which now becomes a top-level function for the prepared
statement. The name should not a string but may be quoted.
</p>
</div>
</div>

<div id="outline-container-orgc54ae51" class="outline-3">
<h3 id="73823e7b-1fc5-40b2-908f-cec99ac1bc9e"><a id="orgc54ae51"></a><a id="ID-b29f3cc1-4af4-4619-9817-ecbc06d98d51"></a>macro defprepared-with-names (name (&amp;rest args) (query &amp;rest query-args) &amp;optional (format :rows))</h3>
<div class="outline-text-3" id="text-73823e7b-1fc5-40b2-908f-cec99ac1bc9e">
<p>
Like defprepared, but allows to specify names of the function arguments in a
lambda list as well as arguments supplied to the query.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(defprepared-with-names user-messages (user <span style="color: #7ccd7c;">&amp;key</span> (limit 10))
  (<span style="color: #cd8162;">"select * from messages</span>
<span style="color: #cd8162;">    where user_id = $1</span>
<span style="color: #cd8162;">    order by date desc</span>
<span style="color: #cd8162;">    limit $2"</span> (user-id user) limit)
  <span style="color: #98fb98; font-weight: bold;">:plists</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org8560c04" class="outline-3">
<h3 id="453612e6-2835-41b2-8305-01b6b5473138"><a id="org8560c04"></a><a id="ID-29d50700-9459-4e40-baaa-efafc7fbe0cf"></a>macro with-transaction ((&amp;optional name isolation-level) &amp;body body)</h3>
<div class="outline-text-3" id="text-453612e6-2835-41b2-8305-01b6b5473138">
<p>
Execute the given body within a database transaction, committing it when the
body exits normally, and aborting otherwise. An optional name and/or
isolation-level can be given to the transaction. The name can be used to
force a commit or abort before the body unwinds. The isolation-level
will set the isolation-level used by the transaction.
</p>

<p>
You can specify the following isolation levels in postmodern transactions:
</p>

<ul class="org-ul">
<li>:read-committed-rw (read committed with read and write)</li>
<li>:read-committed-ro (read committed with read only)</li>
<li>:repeatable-read-rw (repeatable read with read and write)</li>
<li>:repeatable-read-ro (repeatable read with read only)</li>
<li>:serializable (serializable with reand and write)</li>
</ul>

<p>
Sample usage where "george" is just the name given to the transaction (not
quoted or a string) and &#x2026; simply indicates other statements would be
expected here:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #00ffff;">with-transaction</span> ()
  (execute (<span style="color: #98fb98; font-weight: bold;">:insert-into</span> 'test-data <span style="color: #98fb98; font-weight: bold;">:set</span> 'value 77))
  ...)

(<span style="color: #00ffff;">with-transaction</span> (george)
  (execute (<span style="color: #98fb98; font-weight: bold;">:insert-into</span> 'test-data <span style="color: #98fb98; font-weight: bold;">:set</span> 'value 22))
  ...)

(<span style="color: #00ffff;">with-transaction</span> (george <span style="color: #98fb98; font-weight: bold;">:read-committed-rw</span>)
  (execute (<span style="color: #98fb98; font-weight: bold;">:insert-into</span> 'test-data <span style="color: #98fb98; font-weight: bold;">:set</span> 'value 33))
  (query (<span style="color: #98fb98; font-weight: bold;">:select</span> '* <span style="color: #98fb98; font-weight: bold;">:from</span> 'test-data))
  ...)

(<span style="color: #00ffff;">with-transaction</span> (<span style="color: #98fb98; font-weight: bold;">:serializable</span>)
  (execute (<span style="color: #98fb98; font-weight: bold;">:insert-into</span> 'test-data <span style="color: #98fb98; font-weight: bold;">:set</span> 'value 44))
  ...)
</pre>
</div>

<p>
Further discussion of transactions and isolation levels can found at
<a href="isolation-notes.html">isolation-notes.html</a> in the doc directory.
</p>
</div>
</div>

<div id="outline-container-org03bce89" class="outline-3">
<h3 id="10b5d3e9-b174-4f02-8c47-6eb3430e60fe"><a id="org03bce89"></a><a id="ID-c5f3a2df-ebef-4180-af02-f54921552736"></a>function commit-transaction (transaction)</h3>
<div class="outline-text-3" id="text-10b5d3e9-b174-4f02-8c47-6eb3430e60fe">
<p>
Immediately commit an open transaction.
</p>
</div>
</div>

<div id="outline-container-orgafc64fd" class="outline-3">
<h3 id="58a7459f-a1f4-4797-83b5-8b5257ca2cf7"><a id="orgafc64fd"></a><a id="ID-6c705c87-8bd9-41cd-b63a-7ef67d5691f6"></a>function abort-transaction (transaction)</h3>
<div class="outline-text-3" id="text-58a7459f-a1f4-4797-83b5-8b5257ca2cf7">
<p>
Roll back the given transaction, but the transaction
block is still active. Thus calling abort-transaction in the middle of a
transaction does not end the transaction. Any subsequent statements will still
be executed. Per the Postgresql documentation: ABORT rolls back the current
transaction and causes all the updates made by the transaction to be discarded.
This command is identical in behavior to the standard SQL command ROLLBACK, and
is present only for historical reasons..
</p>
</div>
</div>

<div id="outline-container-org1f0878d" class="outline-3">
<h3 id="org1f0878d">function rollback-transaction (transaction)</h3>
<div class="outline-text-3" id="text-org1f0878d">
<p>
Roll back the given transaction, but the transaction
block is still active. Thus calling abort-transaction in the middle of a
transaction does not end the transaction. Any subsequent statements will still
be executed. Per the Postgresql documentation: this rolls back the current
transaction and causes all the updates made by the transaction to be discarded.
</p>
</div>
</div>

<div id="outline-container-orgecb5cff" class="outline-3">
<h3 id="5899097b-a5fb-4b7a-961b-3c65a95f81d4"><a id="orgecb5cff"></a><a id="ID-2b3980a2-969c-4376-92aa-ce9ee5867b6c"></a>macro with-savepoint (name &amp;body body)</h3>
<div class="outline-text-3" id="text-5899097b-a5fb-4b7a-961b-3c65a95f81d4">
<p>
Can only be used within a transaction. Establishes a savepoint with the given
name at the start of body, and binds the same name to a handle for that
savepoint. The body is executed and, at the end of body, the savepoint is
released, unless a condition is thrown, in which case it is rolled back.
Execute the body within a savepoint, releasing savepoint when the body exits
normally, and rolling back otherwise. NAME is both the variable that can be
used to release or rolled back before the body unwinds, and the SQL name of the
savepoint.
</p>

<p>
The following example demonstrates with-savepoint, rollback-savepoint and
release-savepoint.
</p>

<div class="org-src-container">
<pre class="src src-lisp">(execute (<span style="color: #98fb98; font-weight: bold;">:create-table</span> test-data ((value <span style="color: #98fb98; font-weight: bold;">:type</span> integer))))

(<span style="color: #00ffff;">defun</span> <span style="color: #63b8ff;">test12</span> (x <span style="color: #7ccd7c;">&amp;optional</span> (y nil))
  (<span style="color: #00ffff;">with-logical-transaction</span> (lt1 <span style="color: #98fb98; font-weight: bold;">:read-committed-rw</span>)
    (execute (<span style="color: #98fb98; font-weight: bold;">:insert-into</span> 'test-data <span style="color: #98fb98; font-weight: bold;">:set</span> 'value 0))
    (<span style="color: #00ffff;">with-savepoint</span> sp1
      (execute (<span style="color: #98fb98; font-weight: bold;">:insert-into</span> 'test-data <span style="color: #98fb98; font-weight: bold;">:set</span> 'value 1))
      (format t <span style="color: #cd8162;">"1-1. ~a Savepoint-name ~a~%"</span> (query <span style="color: #cd8162;">"select * from test_data"</span>)
              (pomo::savepoint-name sp1))
      (<span style="color: #00ffff;">if</span> (&lt; x 0)
          (rollback-savepoint sp1)
          (release-savepoint sp1))
      (format t <span style="color: #cd8162;">"1-2. ~a~%"</span> (query <span style="color: #cd8162;">"select * from test_data"</span>)))
    (<span style="color: #00ffff;">with-savepoint</span> sp2
      (execute (<span style="color: #98fb98; font-weight: bold;">:insert-into</span> 'test-data <span style="color: #98fb98; font-weight: bold;">:set</span> 'value 2))
      (format t <span style="color: #cd8162;">"2-1. ~a Savepoint-name ~a~%"</span> (query <span style="color: #cd8162;">"select * from test_data"</span>)
              (pomo::savepoint-name sp2))
      (<span style="color: #00ffff;">with-savepoint</span> sp3
        (execute (<span style="color: #98fb98; font-weight: bold;">:insert-into</span> 'test-data <span style="color: #98fb98; font-weight: bold;">:set</span> 'value 3))
        (format t <span style="color: #cd8162;">"3-1. ~a Savepoint-name ~a~%"</span> (query <span style="color: #cd8162;">"select * from test_data"</span>)
                (pomo::savepoint-name sp3))
        (<span style="color: #00ffff;">if</span> (&gt; x 0)
            (rollback-savepoint sp3)
            (release-savepoint sp3))
        (format t <span style="color: #cd8162;">"3-2. ~a~%"</span> (query <span style="color: #cd8162;">"select * from test_data"</span>))
        (<span style="color: #00ffff;">when</span> y (rollback-savepoint sp2))
        (format t <span style="color: #cd8162;">"3-3. ~a~%"</span> (query <span style="color: #cd8162;">"select * from test_data"</span>)))
      (<span style="color: #00ffff;">if</span> (= x 0)
          (rollback-savepoint sp2)
          (release-savepoint sp2))
      (format t <span style="color: #cd8162;">"2-2. ~a~%"</span> (query <span style="color: #cd8162;">"select * from test_data"</span>)))
    (format t <span style="color: #cd8162;">"4. ~a~%"</span> (query <span style="color: #cd8162;">"select * from test_data"</span>))
    (<span style="color: #00ffff;">when</span> (string= y <span style="color: #cd8162;">"abrt"</span>)
      (abort-transaction lt1))
    (format t <span style="color: #cd8162;">"5. ~a~%"</span> (query <span style="color: #cd8162;">"select * from test_data"</span>))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org0c9c71a" class="outline-3">
<h3 id="a6d99838-ed98-4839-ac13-c03ecbfd6f96"><a id="org0c9c71a"></a><a id="ID-1d876de8-f717-4a15-a222-18aa4c344583"></a>function release-savepoint (savepoint)</h3>
<div class="outline-text-3" id="text-a6d99838-ed98-4839-ac13-c03ecbfd6f96">
<p>
Immediately release a savepoint, commiting its results.
</p>
</div>
</div>

<div id="outline-container-orgee0fb2c" class="outline-3">
<h3 id="1f84633f-e567-42c6-bcfc-2167dad89165"><a id="orgee0fb2c"></a><a id="ID-a19e709e-b574-4494-bb79-aa788fcc0200"></a>function rollback-savepoint (savepoint)</h3>
<div class="outline-text-3" id="text-1f84633f-e567-42c6-bcfc-2167dad89165">
<p>
Immediately roll back a savepoint, aborting the results.
</p>
</div>
</div>

<div id="outline-container-orge5b593d" class="outline-3">
<h3 id="919494ae-625f-4f63-b271-6cc5d0b16549"><a id="orge5b593d"></a><a id="ID-c297fecf-bcb8-451c-bd91-22892d04c96d"></a>method commit-hooks (transaction-or-savepoint), setf (commit-hooks transaction-or-savepoint)</h3>
<div class="outline-text-3" id="text-919494ae-625f-4f63-b271-6cc5d0b16549">
<p>
An accessor for the transaction or savepoint's list of commit hooks, each of
which should be a function with no required arguments. These functions will be
executed when a transaction is committed or a savepoint released.
</p>
</div>
</div>

<div id="outline-container-org5e25024" class="outline-3">
<h3 id="94700fa6-1f29-4c0f-86ad-487e640933b9"><a id="org5e25024"></a><a id="ID-7dd2980a-9f3d-4bff-a1f5-0745adecba24"></a>function abort-hooks (transaction-or-savepoint), setf (abort-hooks transaction-or-savepoint)</h3>
<div class="outline-text-3" id="text-94700fa6-1f29-4c0f-86ad-487e640933b9">
<p>
An accessor for the transaction or savepoint's list of abort hooks, each of
which should be a function with no required arguments. These functions will be
executed when a transaction is aborted or a savepoint rolled back (whether via a
non-local transfer of control or explicitly by either abort-transaction or
rollback-savepoint).
</p>
</div>
</div>

<div id="outline-container-orga8c65e8" class="outline-3">
<h3 id="44dac415-f1b2-4f01-bb05-a31c6c977b4c"><a id="orga8c65e8"></a><a id="ID-01275b50-0fa5-4b2f-968f-c360bc3efde0"></a>variable <b>isolation-level</b></h3>
<div class="outline-text-3" id="text-44dac415-f1b2-4f01-bb05-a31c6c977b4c">
<p>
The transaction isolation level currently in use. Defaults to :read-committed-rw
</p>

<p>
You can specify the following isolation levels in postmodern transactions:
</p>

<ul class="org-ul">
<li>:read-committed-rw (read committed with read and write)</li>
<li>:read-committed-ro (read committed with read only)</li>
<li>:repeatable-read-rw (repeatable read with read and write)</li>
<li>:repeatable-read-ro (repeatable read with read only)</li>
<li>:serializable (serializable with reand and write)</li>
</ul>
</div>
</div>


<div id="outline-container-orgb3dc191" class="outline-3">
<h3 id="5fdcafe3-5da4-48ee-8bb0-8567c7e00837"><a id="orgb3dc191"></a><a id="ID-355157ce-0f0c-4f9a-9be0-cfd12fd7bea0"></a>macro with-logical-transaction ((&amp;optional name isolation-level) &amp;body body)</h3>
<div class="outline-text-3" id="text-5fdcafe3-5da4-48ee-8bb0-8567c7e00837">
<p>
Executes body within a with-transaction form if no transaction is currently
in progress, otherwise simulates a nested transaction by executing it
within a with-savepoint form. The transaction or savepoint is bound to name
if one is supplied. The isolation-level will set the isolation-level used by the
transaction.
</p>

<p>
You can specify the following isolation levels in postmodern transactions:
</p>

<ul class="org-ul">
<li>:read-committed-rw (read committed with read and write)</li>
<li>:read-committed-ro (read committed with read only)</li>
<li>:repeatable-read-rw (repeatable read with read and write)</li>
<li>:repeatable-read-ro (repeatable read with read only)</li>
<li>:serializable (serializable with reand and write)</li>
</ul>

<p>
For more information see <a href="isolation-notes.html">isolation-notes</a>
</p>

<p>
Sample usage where "george" is just the name given to the transaction (not
quoted or a string) and &#x2026; simply indicates other statements would be
expected here:
</p>

<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #00ffff;">with-logical-transaction</span> ()
  (execute (<span style="color: #98fb98; font-weight: bold;">:insert-into</span> 'test-data <span style="color: #98fb98; font-weight: bold;">:set</span> 'value 77))
  ...)

(<span style="color: #00ffff;">with-logical-transaction</span> (george)
  (execute (<span style="color: #98fb98; font-weight: bold;">:insert-into</span> 'test-data <span style="color: #98fb98; font-weight: bold;">:set</span> 'value 22))
  ...)

(<span style="color: #00ffff;">with-logical-transaction</span> (george <span style="color: #98fb98; font-weight: bold;">:read-committed-rw</span>)
  (execute (<span style="color: #98fb98; font-weight: bold;">:insert-into</span> 'test-data <span style="color: #98fb98; font-weight: bold;">:set</span> 'value 33))
  ...)

(<span style="color: #00ffff;">with-logical-transaction</span> (<span style="color: #98fb98; font-weight: bold;">:serializable</span>)
  (execute (<span style="color: #98fb98; font-weight: bold;">:insert-into</span> 'test-data <span style="color: #98fb98; font-weight: bold;">:set</span> 'value 44))
  ...)
</pre>
</div>
</div>
</div>

<div id="outline-container-org60bd325" class="outline-3">
<h3 id="7d237c64-5c3e-44a6-8b7c-6eecc4379b71"><a id="org60bd325"></a><a id="ID-196ef5b0-9c58-4f28-9766-e37334448d3c"></a>function abort-logical-transaction (transaction-or-savepoint)</h3>
<div class="outline-text-3" id="text-7d237c64-5c3e-44a6-8b7c-6eecc4379b71">
<p>
Roll back the given logical transaction, regardless of whether it is an actual
transaction or a savepoint.
</p>
</div>
</div>

<div id="outline-container-orge6418e4" class="outline-3">
<h3 id="ae0f0c99-0bda-491e-99a5-3a61e0a86166"><a id="orge6418e4"></a><a id="ID-33fd01cd-603f-48e0-a2d9-1433d9b7f4db"></a>function commit-logical-transaction (transaction-or-savepoint)</h3>
<div class="outline-text-3" id="text-ae0f0c99-0bda-491e-99a5-3a61e0a86166">
<p>
Commit the given logical transaction, regardless of whether it is an actual
transaction or a savepoint.
</p>
</div>
</div>

<div id="outline-container-org0f54d96" class="outline-3">
<h3 id="bf78478f-92a2-4162-963d-b4e101b23154"><a id="org0f54d96"></a><a id="ID-2a5d91c2-f990-4a3c-a775-5e1fd539fee8"></a>variable <b>current-logical-transaction</b></h3>
<div class="outline-text-3" id="text-bf78478f-92a2-4162-963d-b4e101b23154">
<p>
This is bound to the current transaction-handle or savepoint-handle instance
representing the innermost open logical transaction.
</p>
</div>
</div>

<div id="outline-container-orgd3fe9c8" class="outline-3">
<h3 id="6ad767b2-75b7-48ee-a260-6caece5bad62"><a id="orgd3fe9c8"></a><a id="ID-34881db5-1c47-444e-bb55-bb6249d4764c"></a>macro ensure-transaction (&amp;body body)</h3>
<div class="outline-text-3" id="text-6ad767b2-75b7-48ee-a260-6caece5bad62">
<p>
Ensures that body is executed within a transaction, but does not begin a new
transaction if one is already in progress.
</p>
</div>
</div>

<div id="outline-container-org3b70f36" class="outline-3">
<h3 id="9ca2ed2b-60ea-4e34-b370-a4f54c1f1dcd"><a id="org3b70f36"></a><a id="ID-dba390df-3c75-4d4c-b8c9-79af3f763914"></a>macro ensure-transaction-with-isolation-level (isolation-level &amp;body body)</h3>
<div class="outline-text-3" id="text-9ca2ed2b-60ea-4e34-b370-a4f54c1f1dcd">
<p>
Executes body within a with-transaction form if and only if no transaction is
already in progress. This adds the ability to specify an isolation level other
than the current default
</p>
</div>
</div>
</div>

<div id="outline-container-orgc863969" class="outline-2">
<h2 id="prepared-statement-helper-functions"><a id="orgc863969"></a><a id="ID-d4846b02-aa2f-4e44-9294-7e5811e61e6c"></a>Helper functions for Prepared Statements</h2>
<div class="outline-text-2" id="text-prepared-statement-helper-functions">
</div>

<div id="outline-container-org5c290ad" class="outline-3">
<h3 id="533331a5-6780-41bd-9ae8-2efac3a3c2c2"><a id="org5c290ad"></a><a id="ID-ca5ba066-3d35-4bb1-97b1-c22436c1bc6d"></a>defparameter <b>allow-overwriting-prepared-statements</b></h3>
<div class="outline-text-3" id="text-533331a5-6780-41bd-9ae8-2efac3a3c2c2">
<p>
When set to t, ensured-prepared will overwrite prepared statements having the
same name if the query statement itself in the postmodern meta connection is
different than the query statement provided to ensure-prepared.
</p>
</div>
</div>

<div id="outline-container-org332a1a4" class="outline-3">
<h3 id="7ca58f04-2ad5-4896-b8c2-b13b276b4f5b"><a id="org332a1a4"></a><a id="ID-a9d22ab2-b849-475c-b325-a91638aed7a0"></a>function prepared-statement-exists-p (name)</h3>
<div class="outline-text-3" id="text-7ca58f04-2ad5-4896-b8c2-b13b276b4f5b">
<p>
→ boolean
This returns t if the prepared statement exists in the current postgresql
session, otherwise nil.
</p>
</div>
</div>

<div id="outline-container-org5dae613" class="outline-3">
<h3 id="3788ef72-d6a7-4e3b-acad-3f2608914dfb"><a id="org5dae613"></a><a id="ID-0028b494-ebd0-40ca-ac31-a4ae7b598609"></a>function list-prepared-statements (&amp;optional (names-only nil))</h3>
<div class="outline-text-3" id="text-3788ef72-d6a7-4e3b-acad-3f2608914dfb">
<p>
→ list
</p>

<p>
This is syntactic sugar. It runs a query that lists the prepared statements in
the session in which the function is run. If the names-only parameter is set
to t, it will only return a list of the names of the prepared statements.
</p>
</div>
</div>

<div id="outline-container-org3bb2fe2" class="outline-3">
<h3 id="7ec6297f-85a7-419e-a9d4-8f6e2ceb9559"><a id="org3bb2fe2"></a><a id="ID-7ce9f5ff-3750-4359-9850-e9a23b0a279a"></a>function drop-prepared-statement (statement-name &amp;key (location :both) (database <b>database</b>))</h3>
<div class="outline-text-3" id="text-7ec6297f-85a7-419e-a9d4-8f6e2ceb9559">
<p>
The statement name can be a string or quoted symbol.
</p>

<p>
Prepared statements are stored both in the meta slot in the postmodern
connection and in postgresql session information. In the case of prepared
statements generated with defprepared, there is also a lisp function with
the same name.
</p>

<p>
If you know the prepared statement name, you can delete the prepared statement
from both locations (the default behavior), just from postmodern by passing
:postmodern to the location key parameter or just from postgresql by passing
:postgresql to the location key parameter.
</p>

<p>
If you pass the name 'All' as the statement name, it will
delete all prepared statements.
</p>

<p>
The default behavior is to also remove any lisp function of the same name.
This behavior is controlled by the remove-function key parameter.
</p>
</div>
</div>

<div id="outline-container-org2f882b8" class="outline-3">
<h3 id="b6049a3a-55a2-44be-9dc0-1af2849e2128"><a id="org2f882b8"></a><a id="ID-3350ba3c-2389-44d7-af61-a7b2193794f4"></a>function list-postmodern-prepared-statements (&amp;optional (names-only nil))</h3>
<div class="outline-text-3" id="text-b6049a3a-55a2-44be-9dc0-1af2849e2128">
<p>
→ list
</p>

<p>
List the prepared statements that postmodern has put in the meta slot in the
connection. It will return a list of alists of form:
  ((:NAME . \"SNY24\")
  (:STATEMENT . \"(SELECT name, salary FROM employee WHERE (city = $1))\")
  (:PREPARE-TIME . #&lt;TIMESTAMP 25-11-2018T15:36:43,385&gt;)
  (:PARAMETER-TYPES . \"{text}\") (:FROM-SQL)
</p>

<p>
If the names-only parameter is set to t, it will only return a list of
the names of the prepared statements.
</p>
</div>
</div>

<div id="outline-container-org54bfeb6" class="outline-3">
<h3 id="06ea4b19-3d57-4f08-b92d-d477bf61c456"><a id="org54bfeb6"></a><a id="ID-72bb535d-6a0c-4f59-a00d-fdcb5d84680b"></a>function find-postgresql-prepared-statement (name)</h3>
<div class="outline-text-3" id="text-06ea4b19-3d57-4f08-b92d-d477bf61c456">
<p>
→ string
</p>

<p>
Returns the specified named prepared statement (if any) that postgresql has for
this session and placed in the meta slot in the connection.
</p>
</div>
</div>

<div id="outline-container-orgd77f128" class="outline-3">
<h3 id="b728be40-afaf-45d3-849c-3b7e27b3b0c1"><a id="orgd77f128"></a><a id="ID-4eb910d7-0fbe-48a2-9002-8075050c937d"></a>function find-postmodern-prepared-statement (name)</h3>
<div class="outline-text-3" id="text-b728be40-afaf-45d3-849c-3b7e27b3b0c1">
<p>
→ string
</p>

<p>
Returns the specified named prepared statement (if any) that postmodern has put
in the meta slot in the connection. Note that this is the statement itself, not
the name.
</p>
</div>
</div>

<div id="outline-container-orgc8d5d6b" class="outline-3">
<h3 id="967c2e66-3ec9-4e07-9de9-1a06d758ac27"><a id="orgc8d5d6b"></a><a id="ID-96e37531-56dd-4580-9fdc-d0e2bb3fbebc"></a>function reset-prepared-statement (condition)</h3>
<div class="outline-text-3" id="text-967c2e66-3ec9-4e07-9de9-1a06d758ac27">
<p>
→ restart
</p>

<p>
If you have received an invalid-prepared-statement error but the prepared
statement is still in the meta slot in the postmodern connection, this will try
to regenerate the prepared statement at the database connection level and
restart the connection.
</p>
</div>
</div>

<div id="outline-container-orgddade05" class="outline-3">
<h3 id="a172b4cb-826f-4bcf-9c50-70676bb7599a"><a id="orgddade05"></a><a id="ID-92d74162-757f-449d-a52a-5c9daa20c5f0"></a>function get-pid ()</h3>
<div class="outline-text-3" id="text-a172b4cb-826f-4bcf-9c50-70676bb7599a">
<p>
→ integer
</p>

<p>
Get the process id used by postgresql for this connection.
</p>
</div>
</div>

<div id="outline-container-org15535fa" class="outline-3">
<h3 id="b0afcff9-dfa9-466a-a3a2-06b189eac23a"><a id="org15535fa"></a><a id="ID-693e7941-c239-406f-8870-566cbb5c9209"></a>function get-pid-from-postmodern ()</h3>
<div class="outline-text-3" id="text-b0afcff9-dfa9-466a-a3a2-06b189eac23a">
<p>
→ integer
</p>

<p>
Get the process id used by postgresql for this connection, but get it from the
postmodern connection parameters.
</p>
</div>
</div>

<div id="outline-container-org0ab03b0" class="outline-3">
<h3 id="10b17274-a4d8-4805-adbe-b7386fe28cfb"><a id="org0ab03b0"></a><a id="ID-09b6f356-9e36-4de6-8c74-58331bfea8de"></a>function cancel-backend (pid)</h3>
<div class="outline-text-3" id="text-10b17274-a4d8-4805-adbe-b7386fe28cfb">
<p>
Polite way of terminating a query at the database (as opposed to calling
close-database). This is slower than (terminate-backend pid) and does not
always work.
</p>
</div>
</div>

<div id="outline-container-org7af3cb6" class="outline-3">
<h3 id="203185f5-030c-48e7-8767-e765ac96f8cb"><a id="org7af3cb6"></a><a id="ID-d8baac2e-115a-485d-b212-02ae397e5117"></a>function terminate-backend (pid)</h3>
<div class="outline-text-3" id="text-203185f5-030c-48e7-8767-e765ac96f8cb">
<p>
Less polite way of terminating at the database (as opposed to calling
close-database). Faster than (cancel-backend pid) and more reliable.
</p>
</div>
</div>
</div>
<div id="outline-container-org883e98c" class="outline-2">
<h2 id="database-management"><a id="org883e98c"></a>Database Management</h2>
<div class="outline-text-2" id="text-database-management">
</div>

<div id="outline-container-orgd1476b6" class="outline-3">
<h3 id="c3da07c5-73e2-407c-a4cf-155b3ae416b2"><a id="orgd1476b6"></a>function create-database (database-name &amp;key (encoding "UTF8") (connection-limit -1) owner limit-public-access comment collation template)</h3>
<div class="outline-text-3" id="text-c3da07c5-73e2-407c-a4cf-155b3ae416b2">
<p>
Creates a basic database. Besides the obvious database-name parameter, you
can also use key parameters to set encoding (defaults to UTF8), owner,
connection-limit (defaults to no limit)). If limit-public-access is set to t,
then only superuser roles or roles with explicit access to this database will
be able to access it. See <a href="#roles">Roles</a>.
</p>

<p>
If collation is set, the assumption is that template0 needs to be used as the base
of the database rather than template1 which may contain encoding specific or locale
specific data.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(create-database 'testdb <span style="color: #98fb98; font-weight: bold;">:limit-public-access</span> t
                         <span style="color: #98fb98; font-weight: bold;">:comment</span> <span style="color: #cd8162;">"This database is for testing silly theories"</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-org4494822" class="outline-3">
<h3 id="database-management"><a id="org4494822"></a>function drop-database (database)</h3>
<div class="outline-text-3" id="text-database-management">
<p>
Drop the specified database. The database parameter can be a string or a
symbol. Note: Only the owner of a database (or superuser) can drop a database
and there cannot be any current connections to the database.
[[#database-information][See Database information below for information specific functions]
</p>
</div>
</div>
</div>
<div id="outline-container-orgfd63992" class="outline-2">
<h2 id="daos"><a id="orgfd63992"></a><a id="ID-8e7cee8c-f2b9-4569-bf65-e8f3d2f9e31b"></a>Database access objects</h2>
<div class="outline-text-2" id="text-daos">
<p>
Postmodern contains a simple system for defining CLOS classes that represent
rows in the database. This is not intended as a full-fledged object-relational
magic system ― while serious ORM systems have their place, they are notoriously
hard to get right, and are outside of the scope of a humble SQL library like
this.
</p>
</div>

<div id="outline-container-org7df4cd5" class="outline-3">
<h3 id="d1d4b5c3-8c21-478e-8ac1-404e4ffdbec5"><a id="org7df4cd5"></a><a id="ID-bbf28a59-551a-4805-b2f6-b2d0bd8feaf3"></a>metaclass dao-class</h3>
<div class="outline-text-3" id="text-d1d4b5c3-8c21-478e-8ac1-404e4ffdbec5">
<p>
You can work directly with the database or you can use a simple
database-access-class (aka dao) which would cover all the fields in a row.
</p>

<p>
Postmodern allows you to have a relatively simple but straight forward matching
of clos classes to a database table. At the heart of Postmodern's DAO system is
the dao-class metaclass. It allows you to define classes for your
database-access objects as regular CLOS classes. Some of the slots in these
classes will refer to columns in the database.
</p>

<p>
To specify that a slot refers to a column, give it a :col-type option containing
an S-SQL type expression (useful if you want to be able to derive a table
definition from the class definition), or simply a :column option with value T.
Such slots can also take a :col-default option, used to provide a database-side
default value as an S-SQL expression. You can use the :col-name initarg (whose
unevaluated value will be passed to to-sql-name) to specify the slot's column's
name.
</p>

<p>
DAO class definitions support two extra class options: :table-name to give the
name of the table that the class refers to (defaults to the class name),
and :keys to provide a set of primary keys for the table if they have not been
specified in a single column. If more than one key is provided, this creates a
multi-column primary key and all keys must be specified when using operations
such as update-dao and get-dao. When no primary keys are defined, operations
such as update-dao and get-dao will not work.
</p>

<p>
IMPORTANT: Class finalization for a dao class instance are wrapped with a thread
lock. However, any time you are using threads and a class that inherits from
other classes, you should ensure that classes are finalized before you start
generating threads that create new instances of that class.
</p>

<p>
The (or db-null integer) form is used to indicate a column can have NULL values
otherwise the column will be treated as NOT NULL.
</p>

<p>
Simple example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #00ffff;">defclass</span> <span style="color: #7ccd7c;">users</span> ()
  ((name <span style="color: #98fb98; font-weight: bold;">:col-type</span> string <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:name</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> name)
   (creditcard <span style="color: #98fb98; font-weight: bold;">:col-type</span> (or db-null integer) <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:card</span> <span style="color: #98fb98; font-weight: bold;">:col-default</span> <span style="color: #98fb98; font-weight: bold;">:null</span>)
   (score <span style="color: #98fb98; font-weight: bold;">:col-type</span> bigint <span style="color: #98fb98; font-weight: bold;">:col-default</span> 0 <span style="color: #98fb98; font-weight: bold;">:accessor</span> score))
  (<span style="color: #98fb98; font-weight: bold;">:metaclass</span> dao-class)
  (<span style="color: #98fb98; font-weight: bold;">:keys</span> name))
</pre>
</div>
<p>
In this case the name of the users will be treated as the primary key and the
database table is assumed to be users. (It might be worth noting that "user" is
a reserved word for Postgresql and using reserved words, while possible using
quotes, is generally not worth the additional trouble they cause.)
</p>

<p>
The name and score slots cannot be null, but the creditcard slot can be null
and actually defaults to null. The :col-default :null specification ensures that
the default in the database for this field is null, but it does not bound the
slot to a default form. Thus, making an instance of the class without
initializing this slot will leave it in an unbound state.
</p>

<p>
An example of a class where the keys are set as multiple column keys is here:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #00ffff;">defclass</span> <span style="color: #7ccd7c;">points</span> ()
  ((x <span style="color: #98fb98; font-weight: bold;">:col-type</span> integer <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:x</span>
      <span style="color: #98fb98; font-weight: bold;">:reader</span> point-x)
   (y <span style="color: #98fb98; font-weight: bold;">:col-type</span> integer <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:y</span>
      <span style="color: #98fb98; font-weight: bold;">:reader</span> point-y)
   (value <span style="color: #98fb98; font-weight: bold;">:col-type</span> integer <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:value</span>
          <span style="color: #98fb98; font-weight: bold;">:accessor</span> value))
  (<span style="color: #98fb98; font-weight: bold;">:metaclass</span> dao-class)
  (<span style="color: #98fb98; font-weight: bold;">:keys</span> x y))
</pre>
</div>

<p>
In this case, retrieving a points record would look like the following where
12 and 34 would be the values you are looking to find in the x column and y
column respectively.:
</p>

<div class="org-src-container">
<pre class="src src-lisp">(get-dao 'points 12 34)
</pre>
</div>

<p>
Now look at a slightly more complex example.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #00ffff;">defclass</span> <span style="color: #7ccd7c;">country</span> ()
  ((id <span style="color: #98fb98; font-weight: bold;">:col-type</span> integer <span style="color: #98fb98; font-weight: bold;">:col-identity</span> t <span style="color: #98fb98; font-weight: bold;">:accessor</span> id)
   (name <span style="color: #98fb98; font-weight: bold;">:col-type</span> string <span style="color: #98fb98; font-weight: bold;">:col-unique</span> t <span style="color: #98fb98; font-weight: bold;">:check</span> (<span style="color: #98fb98; font-weight: bold;">:&lt;&gt;</span> 'name <span style="color: #cd8162;">""</span>)
         <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:name</span> <span style="color: #98fb98; font-weight: bold;">:reader</span> country-name)
   (inhabitants <span style="color: #98fb98; font-weight: bold;">:col-type</span> integer <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:inhabitants</span>
                <span style="color: #98fb98; font-weight: bold;">:accessor</span> country-inhabitants)
   (sovereign <span style="color: #98fb98; font-weight: bold;">:col-type</span> (or db-null string) <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:sovereign</span>
              <span style="color: #98fb98; font-weight: bold;">:accessor</span> country-sovereign)
   (region-id <span style="color: #98fb98; font-weight: bold;">:col-type</span> integer <span style="color: #98fb98; font-weight: bold;">:col-references</span> ((regions id))
              <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:region-id</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> region-id))
  (<span style="color: #98fb98; font-weight: bold;">:documentation</span> <span style="color: #cd8162;">"Dao class for a countries record."</span>)
  (<span style="color: #98fb98; font-weight: bold;">:metaclass</span> dao-class)
  (<span style="color: #98fb98; font-weight: bold;">:table-name</span> countries))
</pre>
</div>
<p>
In this example we have an id column which is specified to be an identity column.
Postgresql will automatically generate a sequence of of integers and this will
be the primary key.
</p>

<p>
We have a name column which is specified as unique and is not null.
</p>

<p>
We have a region-id column which references the id column in the regions table.
This is a foreign key constraint and Postgresql will not accept inserting a
country into the database unless there is an existing region table with an id
that matches this number. Postgresql will also not allow deleting a region if
there are countries that reference that region's id. If we wanted Postgresql to
delete countries when regions are deleted, that column would be specified as:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(region-id <span style="color: #98fb98; font-weight: bold;">:col-type</span> integer <span style="color: #98fb98; font-weight: bold;">:col-references</span> ((regions id) <span style="color: #98fb98; font-weight: bold;">:cascade</span>)
  <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:region-id</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> region-id)
</pre>
</div>
<p>
Now you can see why the double parens.
</p>

<p>
We also specified that the table name is not "country" but "countries".
(Some style guides recommend that table names be plural and references to rows
be singular.)
</p>

<p>
When inheriting from DAO classes, a subclass' set of columns also contains all
the columns of its superclasses. The primary key for such a class is the union
of its own keys and all the keys from its superclasses. Classes inheriting from
DAO classes should probably always use the dao-class metaclass themselves.
</p>

<p>
When a DAO is created with make-instance, the :fetch-defaults keyword argument
can be passed, which, when T, will cause a query to fetch the default values for
all slots that refers to columns with defaults and were not bound through
initargs. In some cases, such as serial and identity columns, which have an
implicit default, this will not work. You can work around this by creating
your own sequence, e.g. "my_sequence", and defining a (:nextval "my_sequence")
default.
</p>

<p>
Finally, DAO class slots can have an option :ghost t to specify them as ghost
slots. These are selected when retrieving instances, but not written when
updating or inserting, or even included in the table definition. The only known
use for this to date is for creating the table with (oids=true), and specify a
slot like this:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(oid <span style="color: #98fb98; font-weight: bold;">:col-type</span> integer <span style="color: #98fb98; font-weight: bold;">:ghost</span> t <span style="color: #98fb98; font-weight: bold;">:accessor</span> get-oid)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdeb3eaf" class="outline-3">
<h3 id="9027b960-0a1a-4b64-a621-d1d4ab2906f0"><a id="orgdeb3eaf"></a>Out of Sync Dao Objects</h3>
<div class="outline-text-3" id="text-9027b960-0a1a-4b64-a621-d1d4ab2906f0">
<p>
What Happens when dao classes are out of sync with the database table?
Let's establish our baseline
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #00ffff;">defclass</span> <span style="color: #7ccd7c;">test-data</span> ()
    ((id <span style="color: #98fb98; font-weight: bold;">:col-type</span> serial <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:id</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> test-id)
     (a <span style="color: #98fb98; font-weight: bold;">:col-type</span> (or (varchar 100) db-null) <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:a</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> test-a)
     (b <span style="color: #98fb98; font-weight: bold;">:col-type</span> boolean <span style="color: #98fb98; font-weight: bold;">:col-default</span> nil <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:b</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> test-b)
     (c <span style="color: #98fb98; font-weight: bold;">:col-type</span> integer <span style="color: #98fb98; font-weight: bold;">:col-default</span> 0 <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:c</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> test-c)
     (d <span style="color: #98fb98; font-weight: bold;">:col-type</span> numeric <span style="color: #98fb98; font-weight: bold;">:col-default</span> 0.0 <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:d</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> test-d))
    (<span style="color: #98fb98; font-weight: bold;">:metaclass</span> dao-class)
    (<span style="color: #98fb98; font-weight: bold;">:table-name</span> dao-test)
    (<span style="color: #98fb98; font-weight: bold;">:keys</span> id))

#&lt;DAO-CLASS S-SQL-TESTS::TEST-DATA&gt;

(execute (dao-table-definition 'test-data))
</pre>
</div>

<p>
Now we define a class that uses the same table, but does not have all the columns.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #00ffff;">defclass</span> <span style="color: #7ccd7c;">test-data-short</span> ()
  ((id <span style="color: #98fb98; font-weight: bold;">:col-type</span> serial <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:id</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> test-id)
   (a <span style="color: #98fb98; font-weight: bold;">:col-type</span> (or (varchar 100) db-null) <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:a</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> test-a))
  (<span style="color: #98fb98; font-weight: bold;">:metaclass</span> dao-class)
  (<span style="color: #98fb98; font-weight: bold;">:table-name</span> dao-test)
  (<span style="color: #98fb98; font-weight: bold;">:keys</span> id))
</pre>
</div>

<p>
We create an instance of the shortened class and try to save it, then
check the results.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #00ffff;">let</span> ((dao (make-instance 'test-data-short <span style="color: #98fb98; font-weight: bold;">:a</span> <span style="color: #cd8162;">"first short"</span>)))
       (save-dao dao))

(query (<span style="color: #98fb98; font-weight: bold;">:select</span> '* <span style="color: #98fb98; font-weight: bold;">:from</span> 'dao-test) <span style="color: #98fb98; font-weight: bold;">:alists</span>)
(((<span style="color: #98fb98; font-weight: bold;">:ID</span> . 1) (<span style="color: #98fb98; font-weight: bold;">:A</span> . <span style="color: #cd8162;">"first short"</span>) (<span style="color: #98fb98; font-weight: bold;">:B</span>) (<span style="color: #98fb98; font-weight: bold;">:C</span> . 0) (<span style="color: #98fb98; font-weight: bold;">:D</span> . 0)))
</pre>
</div>

<p>
It was a successful save, and we see that the missing columns took their
default values.
</p>

<p>
Now we define a shortened class, but the a slot is now numeric or null
instead of a string and try to save it and check it.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #00ffff;">defclass</span> <span style="color: #7ccd7c;">test-data-short-wrong-1</span> ()
  ((id <span style="color: #98fb98; font-weight: bold;">:col-type</span> serial <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:id</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> test-id)
   (a <span style="color: #98fb98; font-weight: bold;">:col-type</span> (or numeric db-null) <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:a</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> test-a))
  (<span style="color: #98fb98; font-weight: bold;">:metaclass</span> dao-class)
  (<span style="color: #98fb98; font-weight: bold;">:table-name</span> dao-test)
  (<span style="color: #98fb98; font-weight: bold;">:keys</span> id))

  (<span style="color: #00ffff;">let</span> ((dao (make-instance 'test-data-short-wrong-1 <span style="color: #98fb98; font-weight: bold;">:a</span> 12.75)))
       (save-dao dao))

(query (<span style="color: #98fb98; font-weight: bold;">:select</span> '* <span style="color: #98fb98; font-weight: bold;">:from</span> 'dao-test) <span style="color: #98fb98; font-weight: bold;">:alists</span>)

(((<span style="color: #98fb98; font-weight: bold;">:ID</span> . 1) (<span style="color: #98fb98; font-weight: bold;">:A</span> . <span style="color: #cd8162;">"first short"</span>) (<span style="color: #98fb98; font-weight: bold;">:B</span>) (<span style="color: #98fb98; font-weight: bold;">:C</span> . 0) (<span style="color: #98fb98; font-weight: bold;">:D</span> . 0))
 ((<span style="color: #98fb98; font-weight: bold;">:ID</span> . 2) (<span style="color: #98fb98; font-weight: bold;">:A</span> . <span style="color: #cd8162;">"12.75"</span>) (<span style="color: #98fb98; font-weight: bold;">:B</span>) (<span style="color: #98fb98; font-weight: bold;">:C</span> . 0) (<span style="color: #98fb98; font-weight: bold;">:D</span> . 0))
</pre>
</div>

<p>
Notice that the 12.75 has been converted into a string when it was saved.
Postgresql did this automatically. Anything going into a text or varchar
column will be converted to a string.
</p>

<p>
Now we will go the other way and define a dao with the right number
of columns, but col d is a string when the database expects a numeric
and check that.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #00ffff;">defclass</span> <span style="color: #7ccd7c;">test-data-d-string</span> ()
    ((id <span style="color: #98fb98; font-weight: bold;">:col-type</span> serial <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:id</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> test-id)
     (a <span style="color: #98fb98; font-weight: bold;">:col-type</span> (or (varchar 100) db-null) <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:a</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> test-a)
     (b <span style="color: #98fb98; font-weight: bold;">:col-type</span> boolean <span style="color: #98fb98; font-weight: bold;">:col-default</span> nil <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:b</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> test-b)
     (c <span style="color: #98fb98; font-weight: bold;">:col-type</span> integer <span style="color: #98fb98; font-weight: bold;">:col-default</span> 0 <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:c</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> test-c)
     (d <span style="color: #98fb98; font-weight: bold;">:col-type</span> text <span style="color: #98fb98; font-weight: bold;">:col-default</span> <span style="color: #cd8162;">""</span> <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:d</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> test-d))
    (<span style="color: #98fb98; font-weight: bold;">:metaclass</span> dao-class)
    (<span style="color: #98fb98; font-weight: bold;">:table-name</span> dao-test)
    (<span style="color: #98fb98; font-weight: bold;">:keys</span> id))

  (<span style="color: #00ffff;">let</span> ((dao (make-instance 'test-data-d-string <span style="color: #98fb98; font-weight: bold;">:a</span> <span style="color: #cd8162;">"D string"</span> <span style="color: #98fb98; font-weight: bold;">:b</span> nil <span style="color: #98fb98; font-weight: bold;">:c</span> 14
                            <span style="color: #98fb98; font-weight: bold;">:d</span> <span style="color: #cd8162;">"Trying string"</span>)))
       (save-dao dao))

Database error 22P02: invalid input syntax for type numeric: <span style="color: #cd8162;">"Trying string"</span>
QUERY: INSERT INTO dao_test (d, c, b, a) VALUES (E'Trying string', 14, false, E'D string') RETURNING id
   [Condition of type DATA-EXCEPTION]

</pre>
</div>
<p>
Ok. That threw a data exception. What happens if we try to force a numeric into
an integer column?
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #00ffff;">let</span> ((dao (make-instance 'test-data-d-string <span style="color: #98fb98; font-weight: bold;">:a</span> <span style="color: #cd8162;">"D string"</span> <span style="color: #98fb98; font-weight: bold;">:b</span> nil <span style="color: #98fb98; font-weight: bold;">:c</span> 14.37
                            <span style="color: #98fb98; font-weight: bold;">:d</span> 18.78)))
       (save-dao dao))

Database error 22P02: invalid input syntax for type integer: <span style="color: #cd8162;">"14.37"</span>
   [Condition of type CL-POSTGRES-ERROR:DATA-EXCEPTION]

</pre>
</div>
<p>
Ok. Postgresql is enforcing the types.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #00ffff;">let</span> ((dao (make-instance 'test-data-d-string <span style="color: #98fb98; font-weight: bold;">:a</span> <span style="color: #cd8162;">"D string"</span> <span style="color: #98fb98; font-weight: bold;">:b</span> nil <span style="color: #98fb98; font-weight: bold;">:c</span> 14
                            <span style="color: #98fb98; font-weight: bold;">:d</span> 18.78)))
       (save-dao dao))

(query (<span style="color: #98fb98; font-weight: bold;">:select</span> '* <span style="color: #98fb98; font-weight: bold;">:from</span> 'dao-test) <span style="color: #98fb98; font-weight: bold;">:alists</span>)
(((<span style="color: #98fb98; font-weight: bold;">:ID</span> . 1) (<span style="color: #98fb98; font-weight: bold;">:A</span> . <span style="color: #cd8162;">"first short"</span>) (<span style="color: #98fb98; font-weight: bold;">:B</span>) (<span style="color: #98fb98; font-weight: bold;">:C</span> . 0) (<span style="color: #98fb98; font-weight: bold;">:D</span> . 0))
 ((<span style="color: #98fb98; font-weight: bold;">:ID</span> . 2) (<span style="color: #98fb98; font-weight: bold;">:A</span> . <span style="color: #cd8162;">"12.75"</span>) (<span style="color: #98fb98; font-weight: bold;">:B</span>) (<span style="color: #98fb98; font-weight: bold;">:C</span> . 0) (<span style="color: #98fb98; font-weight: bold;">:D</span> . 0))
 ((<span style="color: #98fb98; font-weight: bold;">:ID</span> . 3) (<span style="color: #98fb98; font-weight: bold;">:A</span> . <span style="color: #cd8162;">"D string"</span>) (<span style="color: #98fb98; font-weight: bold;">:B</span>) (<span style="color: #98fb98; font-weight: bold;">:C</span> . 14) (<span style="color: #98fb98; font-weight: bold;">:D</span> . 939/50)))
</pre>
</div>

<p>
Notice that postmodern returned a ratio 939/50 for the numeric 18.78.
</p>

<p>
We have looked at saving daos. Now look at returning a dao from the database
where the dao definition is different than the table definition.
First checking to see if we can get a correct dao back.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(get-dao 'test-data 3)
#&lt;TEST-DATA {100C82AA33}&gt;
</pre>
</div>
<p>
Ok. That worked as expected.
</p>

<p>
Second using a shortened dao that is correct in type of columns, but
incorrect n the number of columns compared to the database table.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(get-dao 'test-data-short 3)
No slot named b in class TEST-DATA-SHORT. DAO out of sync with table, or
incorrect query used.
   [Condition of type SIMPLE-ERROR]

Restarts:
 0: [RETRY] Retry SLIME REPL evaluation request.
 1: [*ABORT] Return to SLIME's top level.
 2: [ABORT] abort thread (#&lt;THREAD <span style="color: #cd8162;">"new-repl-thread"</span> RUNNING {100C205083}&gt;)

</pre>
</div>
<p>
Not only did it throw an exception, but I needed to actually use an interrupt
from the repl to get back in operation. And then use (reconnect <b>database</b>).
Very Bad result.
</p>

<p>
THIS ERROR IS CONTROLLABLE BY THE VARIABLE <b>IGNORE-UNKNOWN-COLUMNS</b>
</p>

<p>
Now if we setf the default global variable <b>ignore-unknown-columns</b> to t
</p>
<div class="org-src-container">
<pre class="src src-lisp">(setf *ignore-unknown-columns* t)

(get-dao 'test-data-short 3)
#&lt;TEST-DATA-SHORT {10054DFED3}&gt;

(describe (get-dao 'test-data-short 3))
#&lt;TEST-DATA-SHORT {100B249783}&gt;
  [standard-object]

Slots with <span style="color: #98fb98; font-weight: bold;">:INSTANCE</span> allocation:
  ID                             = 3
  A                              = <span style="color: #cd8162;">"D string"</span>
</pre>
</div>
<p>
We now have a dao that has fewer slots than the database table it pulled from.
Just to validate that:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:select</span> '* <span style="color: #98fb98; font-weight: bold;">:from</span> 'dao-test <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'id 3)))

((3 <span style="color: #cd8162;">"D string"</span> NIL 14 939/50))
</pre>
</div>
<p>
Just to be thorough, let's use a dao that has more slots than the database table.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #00ffff;">defclass</span> <span style="color: #7ccd7c;">test-data-long</span> ()
    ((id <span style="color: #98fb98; font-weight: bold;">:col-type</span> serial <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:id</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> test-id)
     (a <span style="color: #98fb98; font-weight: bold;">:col-type</span> (or (varchar 100) db-null) <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:a</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> test-a)
     (b <span style="color: #98fb98; font-weight: bold;">:col-type</span> boolean <span style="color: #98fb98; font-weight: bold;">:col-default</span> nil <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:b</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> test-b)
     (c <span style="color: #98fb98; font-weight: bold;">:col-type</span> integer <span style="color: #98fb98; font-weight: bold;">:col-default</span> 0 <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:c</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> test-c)
     (d <span style="color: #98fb98; font-weight: bold;">:col-type</span> numeric <span style="color: #98fb98; font-weight: bold;">:col-default</span> 0.0 <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:d</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> test-d)
     (e <span style="color: #98fb98; font-weight: bold;">:col-type</span> text <span style="color: #98fb98; font-weight: bold;">:col-default</span> <span style="color: #cd8162;">"sell by date"</span> <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:e</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> test-e))
    (<span style="color: #98fb98; font-weight: bold;">:metaclass</span> dao-class)
    (<span style="color: #98fb98; font-weight: bold;">:table-name</span> dao-test)
    (<span style="color: #98fb98; font-weight: bold;">:keys</span> id))
</pre>
</div>
<p>
Now if we make an instance of this dao and try to save it in the dao-class table:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #00ffff;">let</span> ((dao (make-instance 'test-data-long <span style="color: #98fb98; font-weight: bold;">:a</span> <span style="color: #cd8162;">"first short"</span> <span style="color: #98fb98; font-weight: bold;">:d</span> 37.3)))
       (save-dao dao))

Database error 42703: column <span style="color: #cd8162;">"e"</span> does not exist
QUERY: INSERT INTO dao_test (d, a)  VALUES ($1, $2) RETURNING e, c, b, id
   [Condition of type CL-POSTGRES-ERROR:UNDEFINED-COLUMN]
</pre>
</div>
<p>
Postgresql rejected the attempted insert with an undefined column error.
</p>
</div>
</div>
<div id="outline-container-org9d9ca98" class="outline-3">
<h3 id="b12ed2b8-fc3f-4d3a-ba2a-3c9484d770dc"><a id="org9d9ca98"></a><a id="ID-959682ab-ee0f-4afe-8cf3-38bb5f6de672"></a>method dao-keys (class)</h3>
<div class="outline-text-3" id="text-b12ed2b8-fc3f-4d3a-ba2a-3c9484d770dc">
<p>
→ list
</p>

<p>
Returns list of slot names that are the primary key of DAO class. This is likely
interesting if you have primary keys which are composed of more than one slot.
Pay careful attention to situations where the primary key not only has more than
one column, but they are actually in a different order than they are in the
database table itself. You can check this with the internal
find-primary-key-info function. Obviously the table needs to have been defined.
The class must be quoted.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(pomo:find-primary-key-info 'country1)

((<span style="color: #cd8162;">"name"</span> <span style="color: #cd8162;">"text"</span>) (<span style="color: #cd8162;">"id"</span> <span style="color: #cd8162;">"integer"</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc8b4a76" class="outline-3">
<h3 id="34196ad8-c657-4fd0-a475-e2f0b81ff86c"><a id="orgc8b4a76"></a><a id="ID-4fa1fc88-dfb8-433f-90dc-c88e8908a5a8"></a>method dao-keys (dao)</h3>
<div class="outline-text-3" id="text-34196ad8-c657-4fd0-a475-e2f0b81ff86c">
<p>
→ list
</p>

<p>
Returns list of values that are the primary key of dao. Explicit keys takes
priority over col-identity which takes priority over col-primary-key.
</p>

<p>
This is likely interesting if you have primary keys which are composed of
more than one slot. Pay careful attention to situations where the primary key
not only has more than one column, but they are actually in a different order
than they are in the database table itself.  Obviously the table needs to have
been defined. You can provide a quoted class-name or an instance of a dao.
</p>
</div>
</div>

<div id="outline-container-org055dcc7" class="outline-3">
<h3 id="org055dcc7">method find-primary-key-column</h3>
<div class="outline-text-3" id="text-org055dcc7">
<p>
→ symbol
</p>

<p>
Loops through a class's column definitions and returns the first column name
that has bound either col-identity or col-primary-key.
</p>
</div>
</div>

<div id="outline-container-org273bb85" class="outline-3">
<h3 id="d5835157-a4ba-4bf0-abbd-214b5a90bc80"><a id="org273bb85"></a><a id="ID-4a55236e-edfb-4f07-a237-fae3453fc99d"></a>method dao-exists-p (dao)</h3>
<div class="outline-text-3" id="text-d5835157-a4ba-4bf0-abbd-214b5a90bc80">
<p>
→ boolean
</p>

<p>
Test whether a row with the same primary key as the given dao exists in the
database. Will also return NIL when any of the key slots in the object are
unbound.
</p>
</div>
</div>

<div id="outline-container-orgf6a464d" class="outline-3">
<h3 id="24bce212-b7c3-4526-a869-92c0218f187d"><a id="orgf6a464d"></a><a id="ID-a812726c-52ea-4321-9bae-f9646bccc128"></a>method make-dao (type &amp;rest args &amp;key &amp;allow-other-keys)</h3>
<div class="outline-text-3" id="text-24bce212-b7c3-4526-a869-92c0218f187d">
<p>
→ dao
</p>

<p>
Combines make-instance with insert-dao. Make the instance of the given class and
insert it into the database, returning the created dao.
</p>
</div>
</div>

<div id="outline-container-org5d65e55" class="outline-3">
<h3 id="org5d65e55">method fetch-defaults (dao)</h3>
<div class="outline-text-3" id="text-org5d65e55">
<p>
→ dao if there were unbound slots with default values, otherwise nil
</p>

<p>
Used to fetch the default values of an object on creation.
An example would be creating a dao object with unbounded slots.
Fetch-defaults could then be used to fetch the default values from the database
and bind the unbound slots which have default values. E.g.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #00ffff;">let</span> ((dao (make-instance 'test-data <span style="color: #98fb98; font-weight: bold;">:a</span> 23)))
    (pomo:fetch-defaults dao))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc0460c2" class="outline-3">
<h3 id="orgc0460c2">method find-primary-key-column (class)</h3>
<div class="outline-text-3" id="text-orgc0460c2">
<p>
→ symbol
</p>

<p>
Loops through a class's column definitions and returns
the first column name that has bound either col-identity or col-primary-key.
Returns a symbol.
</p>
</div>
</div>

<div id="outline-container-orga2b28d2" class="outline-3">
<h3 id="f7351c36-cb79-43a2-8a5b-5f8aac8ea2d9"><a id="orga2b28d2"></a><a id="ID-645a03ec-739a-4ee5-b83d-dcbe43ef009a"></a>macro define-dao-finalization (((dao-name class) &amp;rest keyword-args) &amp;body body)</h3>
<div class="outline-text-3" id="text-f7351c36-cb79-43a2-8a5b-5f8aac8ea2d9">
<p>
Create an :around-method for make-dao. The body is executed in a lexical
environment where dao-name is bound to a freshly created and inserted DAO. The
representation of the DAO in the database is then updated to reflect changes
that body might have introduced. Useful for processing values of slots with the
type serial, which are unknown before insert-dao.
</p>
</div>
</div>

<div id="outline-container-org498695b" class="outline-3">
<h3 id="73e62fab-5bfa-4986-b8c4-992e4d0a134b"><a id="org498695b"></a><a id="ID-6dd7dd12-0f9a-4c47-94ee-43f0886df956"></a>method get-dao (type &amp;rest keys)</h3>
<div class="outline-text-3" id="text-73e62fab-5bfa-4986-b8c4-992e4d0a134b">
<p>
→ dao
</p>

<p>
Get the single DAO object from the row that has the given primary key values, or NIL
if no such row exists. Objects created by this function will have
initialize-instance called on them (after loading in the values from the
database) without any arguments ― even :default-initargs are skipped. The same
goes for select-dao and query-dao.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(get-dao 'country <span style="color: #cd8162;">"The Netherlands"</span>)
#&lt;COUNTRY {1010F0DCF3}&gt;
</pre>
</div>

<p>
From an sql perspective, the standard call to get-dao translates as:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #00ffff;">select</span> * <span style="color: #00ffff;">from</span> <span style="color: #00ffff;">table</span>
</pre>
</div>

<p>
NOTE: if you have added fields to the database table without updating the class
definition, get-dao and select-dao will throw errors. This may cause your
application to appear to hang unless you have the necessary condition handling
in your code. Usually this will only happen during development, so throwing an
error is not a bad idea. If you want to ignore the errors,
set <b>ignore-unknown-columns</b> to t.
</p>
</div>
</div>

<div id="outline-container-orgcf96436" class="outline-3">
<h3 id="cd11fa85-5019-4b94-a24c-d0857d633bd2"><a id="orgcf96436"></a><a id="ID-8b3533e5-2399-47e4-8fac-5345ec44c878"></a>macro select-dao (type &amp;optional (test t) &amp;rest sort)</h3>
<div class="outline-text-3" id="text-cd11fa85-5019-4b94-a24c-d0857d633bd2">
<p>
→ list
</p>

<p>
Select DAO objects for the rows in the associated table for which the given
test (either an S-SQL expression or a string) holds. When sorting arguments are
given, which can also be S-SQL forms or strings, these are used to sort the
result.
</p>

<p>
(Note that, if you want to sort, you have to pass the test argument.)
</p>
<div class="org-src-container">
<pre class="src src-lisp">(select-dao 'country)
(#&lt;COUNTRY {101088F6F3}&gt; #&lt;COUNTRY {101088FAA3}&gt;)
2

(select-dao 'country (<span style="color: #98fb98; font-weight: bold;">:&gt;</span> 'inhabitants 50000000))
NIL
0

(select-dao 'country (<span style="color: #98fb98; font-weight: bold;">:&gt;</span> 'inhabitants 5000000))
(#&lt;COUNTRY {10108AD293}&gt;)
1

(select-dao 'country (<span style="color: #98fb98; font-weight: bold;">:&gt;</span> 'inhabitants 5000))
(#&lt;COUNTRY {10108CA773}&gt; #&lt;COUNTRY {10108CAB23}&gt;)
2

(select-dao 'country (<span style="color: #98fb98; font-weight: bold;">:&gt;</span> 'inhabitants 5000) 'name) <span style="color: #cd4f39;">;sorted by name</span>
(#&lt;COUNTRY {10108EF423}&gt; #&lt;COUNTRY {10108EF643}&gt;)

(mapcar 'country-name (select-dao 'country (<span style="color: #98fb98; font-weight: bold;">:&gt;</span> 'inhabitants 5000) 'name))
(<span style="color: #cd8162;">"Croatia"</span> <span style="color: #cd8162;">"The Netherlands"</span>)

(mapcar 'country-name (select-dao 'country (<span style="color: #98fb98; font-weight: bold;">:&gt;</span> 'inhabitants 5000)))
(<span style="color: #cd8162;">"The Netherlands"</span> <span style="color: #cd8162;">"Croatia"</span>)
</pre>
</div>
<p>
If for some reason, you wanted the list in reverse alphabetical order, then:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(select-dao 'country (<span style="color: #98fb98; font-weight: bold;">:&gt;</span> 'id  0) (<span style="color: #98fb98; font-weight: bold;">:desc</span> 'name))
</pre>
</div>
</div>
</div>
<div id="outline-container-org60a187d" class="outline-3">
<h3 id="6273d302-4199-44a0-aa18-3d8f91affd84"><a id="org60a187d"></a><a id="ID-b1a7accd-8c3e-429b-a8c8-35f2283855c4"></a>macro do-select-dao (((type type-var) &amp;optional (test t) &amp;rest sort) &amp;body body)</h3>
<div class="outline-text-3" id="text-6273d302-4199-44a0-aa18-3d8f91affd84">
<p>
Like select-dao, but iterates over the results rather than returning them.
For each matching DAO, body is evaluated with type-var bound to the DAO
instance.
</p>

<p>
Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #00ffff;">do-select-dao</span> (('user user) (<span style="color: #98fb98; font-weight: bold;">:&gt;</span> 'score 10000) 'name)
  (pushnew user high-scorers))
</pre>
</div>
</div>
</div>

<div id="outline-container-orga3cf571" class="outline-3">
<h3 id="6e5766fb-14dd-4f1e-a68a-fd14d781ac9e"><a id="orga3cf571"></a><a id="ID-134f9dcb-0784-461b-a38c-85c14d850910"></a>macro query-dao (type query &amp;rest args)</h3>
<div class="outline-text-3" id="text-6e5766fb-14dd-4f1e-a68a-fd14d781ac9e">
<p>
→ list
</p>

<p>
Execute the given query (which can be either a string or an S-SQL expression)
and return the result as DAOs of the given type. If the query contains
placeholders ($1, $2, etc) their values can be given as extra arguments. The
names of the fields returned by the query must either match slots in the DAO
class, or be bound through with-column-writers.
</p>
</div>
</div>

<div id="outline-container-orgb8a49b7" class="outline-3">
<h3 id="702edc9e-ef43-4df1-9e99-dac6047bdecc"><a id="orgb8a49b7"></a><a id="ID-8f5738c2-a11e-4c1b-91bc-b52f62502fbd"></a>function do-query-dao (((type type-var) query &amp;rest args) &amp;body body)</h3>
<div class="outline-text-3" id="text-702edc9e-ef43-4df1-9e99-dac6047bdecc">
<p>
→ list
</p>

<p>
Like query-dao, but iterates over the results rather than returning them.
For each matching DAO, body is evaluated with type-var bound to the instance.
</p>

<p>
Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #00ffff;">do-query-dao</span> (('user user) (<span style="color: #98fb98; font-weight: bold;">:order-by</span> (<span style="color: #98fb98; font-weight: bold;">:select</span> '* <span style="color: #98fb98; font-weight: bold;">:from</span> 'user <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:&gt;</span> 'score 10000)) 'name))
  (pushnew user high-scorers))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb5a194c" class="outline-3">
<h3 id="4a1219dc-d0bc-4fb7-81c9-cb734cb051cc"><a id="orgb5a194c"></a><a id="ID-a6627d60-61f4-4a9b-86e7-5c1454a4e487"></a>variable <b>ignore-unknown-columns</b></h3>
<div class="outline-text-3" id="text-4a1219dc-d0bc-4fb7-81c9-cb734cb051cc">
<p>
Normally, when get-dao, select-dao, or query-dao finds a column in the database
that's not in the DAO class, it will raise an error. Setting this variable to a
non-NIL will cause it to simply ignore the unknown column.
</p>
</div>
</div>

<div id="outline-container-org81d8f1c" class="outline-3">
<h3 id="4a83ef48-a40a-423c-a97c-3d6743ce940c"><a id="org81d8f1c"></a><a id="ID-6e534cce-6d6a-4710-875e-bf53aadb2045"></a>method insert-dao (dao)</h3>
<div class="outline-text-3" id="text-4a83ef48-a40a-423c-a97c-3d6743ce940c">
<p>
→ dao
</p>

<p>
Insert the given dao into the database. Column slots of the object which are
unbound implies the database defaults. Hence, if these columns has no defaults
defined in the database, the the insertion of the dao will be failed. (This
feature only works on PostgreSQL 8.2 and up.)
</p>
</div>
</div>

<div id="outline-container-orgd5a9c29" class="outline-3">
<h3 id="08306ea2-4027-40e8-a9df-8bb2fbc63b3e"><a id="orgd5a9c29"></a><a id="ID-faf45a30-c384-461f-9367-9e7c40c466a5"></a>method update-dao (dao)</h3>
<div class="outline-text-3" id="text-08306ea2-4027-40e8-a9df-8bb2fbc63b3e">
<p>
→ dao
</p>

<p>
Update the representation of the given dao in the database to the values in the
object. This is not defined for tables that do not have any non-primary-key
columns. Raises an error when no row matching the dao exists.
</p>
</div>
</div>

<div id="outline-container-org0fda93c" class="outline-3">
<h3 id="4697a909-970c-492b-b1d6-7e05895f8882"><a id="org0fda93c"></a><a id="ID-a61016ef-bf72-4d7f-804f-c4396098833b"></a>function save-dao (dao)</h3>
<div class="outline-text-3" id="text-4697a909-970c-492b-b1d6-7e05895f8882">
<p>
→ boolean
</p>

<p>
Tries to insert the given dao using insert-dao. If the dao has unbound slots,
those slots will be updated and bound by default data triggered by the
database. If this raises a unique key violation error, it tries to update it by
using update-dao instead. In this case, if the dao has unbound slots, updating
will fail with an unbound slots error.
</p>

<p>
Be aware that there is a possible race condition here ― if some other process
deletes the row at just the right moment, the update fails as well. Returns a
boolean telling you whether a new row was inserted.
</p>

<p>
This function is unsafe to use inside of a transaction ― when a row with the
given keys already exists, the transaction will be aborted. Use
save-dao/transaction instead in such a situation.
</p>

<p>
See also: upsert-dao.
</p>
</div>
</div>

<div id="outline-container-org6a289d6" class="outline-3">
<h3 id="62a09a7f-8583-404d-b9f3-28b1eb416b0f"><a id="org6a289d6"></a><a id="ID-0162b077-c274-48b0-9d5d-655de2482012"></a>function save-dao/transaction (dao)</h3>
<div class="outline-text-3" id="text-62a09a7f-8583-404d-b9f3-28b1eb416b0f">
<p>
→ boolean
</p>

<p>
The transaction safe version of save-dao. Tries to insert the given dao using
insert-dao. If this raises a unique key violation error, it tries to update it
by using update-dao instead. If the dao has unbound slots, updating will fail
with an unbound slots error. If the dao has unbound slots, those slots will be
updated and bound by default data triggered by the database.
</p>

<p>
Be aware that there is a possible race condition here ― if some other process
deletes the row at just the right moment, the update fails as well. Returns a
boolean telling you whether a new row was inserted.
</p>

<p>
Acts exactly like save-dao, except that it protects its attempt to insert the
object with a rollback point, so that a failure will not abort the transaction.
</p>

<p>
See also: upsert-dao.
</p>
</div>
</div>

<div id="outline-container-org8e7e2a6" class="outline-3">
<h3 id="8eeaf5dd-a802-4ba0-9983-dc153ffc1dae"><a id="org8e7e2a6"></a><a id="ID-ab8ea79a-1761-402c-a1bc-3a5c4fd53c24"></a>method upsert-dao (dao)</h3>
<div class="outline-text-3" id="text-8eeaf5dd-a802-4ba0-9983-dc153ffc1dae">
<p>
→ dao
</p>

<p>
Like save-dao or save-dao/transaction but using a different method that doesn't
involve a database exception. This is safe to use both in and outside a
transaction, though it's advisable to always do it in a transaction to prevent
a race condition. The way it works is:
</p>

<p>
If the object contains unbound slots, we call insert-dao directly, thus the
behavior is like save-dao.
</p>

<p>
Otherwise we try to update a record with the same primary key. If the PostgreSQL
returns a non-zero number of rows updated it treated as the record is already
exists in the database, and we stop here.
</p>

<p>
If the PostgreSQL returns a zero number of rows updated, it treated as the
record does not exist and we call insert-dao.
</p>

<p>
The race condition might occur at step 3 if there's no transaction: if UPDATE
returns zero number of rows updated and another thread inserts the record at
that moment, the insertion implied by step 3 will fail.
</p>

<p>
Note, that triggers and rules may affect the number of inserted or updated rows
returned by PostgreSQL, so zero or non-zero number of affected rows may not
actually indicate the existence of record in the database.
</p>

<p>
This method returns two values: the DAO object and a boolean (T if the object
was inserted, NIL if it was updated).
</p>

<p>
IMPORTANT: This is not the same as insert on conflict (sometimes called an upsert)
in Postgresq. An upsert in Postgresql terms is an insert with a fallback of updating
the row if the insert key conflicts with an already existing row. An upsert-dao
in Postmodern terms is the reverse. First you try updating an existing object. If
there is no existing object to oupdate, then you insert a new object.
</p>
</div>
</div>

<div id="outline-container-orgd869184" class="outline-3">
<h3 id="b135af85-b194-4a5c-9c2d-be87f6827877"><a id="orgd869184"></a><a id="ID-f3371904-cd84-4392-a301-0f910bcf1b90"></a>method delete-dao (dao)</h3>
<div class="outline-text-3" id="text-b135af85-b194-4a5c-9c2d-be87f6827877">
<p>
Delete the given dao from the database.
</p>
</div>
</div>

<div id="outline-container-orge125ba7" class="outline-3">
<h3 id="436e6c77-8550-4462-a956-3affe6d0970c"><a id="orge125ba7"></a><a id="ID-718c03fe-5c70-43c1-a986-bc361d1e2ee6"></a>function dao-table-name (class)</h3>
<div class="outline-text-3" id="text-436e6c77-8550-4462-a956-3affe6d0970c">
<p>
→ string
</p>

<p>
Get the name of the table associated with the given DAO class (or symbol naming
such a class).
</p>
</div>
</div>

<div id="outline-container-org1a7fc03" class="outline-3">
<h3 id="289d7bc0-b4a3-45e3-991b-14b9cfbdcf68"><a id="org1a7fc03"></a><a id="ID-e796fdb5-a8d9-4399-893a-6783dd925e78"></a>function dao-table-definition (class)</h3>
<div class="outline-text-3" id="text-289d7bc0-b4a3-45e3-991b-14b9cfbdcf68">
<p>
→ string
</p>

<p>
Given a DAO class, or the name of one, this will produce an SQL query string
with a definition of the table. This is just the bare simple definition, so if
you need any extra indices or or constraints, you'll have to write your own
queries to add them, in which case look to s-sql's create-table function.
</p>
</div>
</div>

<div id="outline-container-orgf2cd8b3" class="outline-3">
<h3 id="d8aa15a1-7dfc-47b3-ae14-70626c33bcc3"><a id="orgf2cd8b3"></a><a id="ID-52b95f7c-f8f0-4e53-8e60-622746f18e16"></a>macro with-column-writers ((&amp;rest writers) &amp;body body)</h3>
<div class="outline-text-3" id="text-d8aa15a1-7dfc-47b3-ae14-70626c33bcc3">
<p>
Provides control over the way get-dao, select-dao, and query-dao read values
from the database. This is not commonly needed, but can be used to reduce the
amount of queries a system makes. writers should be a list of alternating column
names (strings or symbols) and writers, where writers are either symbols
referring to a slot in the objects, or functions taking two arguments ― an
instance and a value ― which can be used to somehow store the value in the new
instance. When any DAO-fetching function is called in the body, and columns
matching the given names are encountered in the result, the writers are used
instead of the default behaviour (try and store the value in the slot that
matches the column name).
</p>

<p>
An example of using this is to add some non-column slots to a DAO class, and use
query-dao within a with-column-writers form to pull in extra information about
the objects, and immediately store it in the new instances.
</p>
</div>
</div>
</div>

<div id="outline-container-orgf124b32" class="outline-2">
<h2 id="table-definition"><a id="orgf124b32"></a><a id="ID-1c0a254a-4a0e-4012-b519-8fe8cbf9ae02"></a>Table definition and creation</h2>
<div class="outline-text-2" id="text-table-definition">
<p>
It can be useful to have the SQL statements needed to build an application's
tables available from the source code, to do things like automatically deploying
a database. The following macro and functions allow you to group sets of SQL
statements under symbols, with some shortcuts for common elements
in table definitions.
</p>
</div>

<div id="outline-container-org50cc112" class="outline-3">
<h3 id="16d26863-ae01-49f3-9350-8ea2d5ca363c"><a id="org50cc112"></a><a id="ID-39e40910-e25a-4db4-bd0a-b4b6d1a75630"></a>macro deftable (name &amp;body definition)</h3>
<div class="outline-text-3" id="text-16d26863-ae01-49f3-9350-8ea2d5ca363c">
<p>
Define a table. name can be either a symbol or a (symbol string) list. In the
first case, the table name is derived from the symbol's name by S-SQL's rules.
In the second case, the name is given explicitly. The body of definitions can
contain anything that evaluates to a string, as well as S-SQL expressions. The
variables <b>table-name</b> and <b>table-symbol</b> are bound to the relevant values in
the body. Note that the evaluation of the definition is ordered, so you'll
generally want to create your table first and then define indices on it.
</p>
</div>
</div>

<div id="outline-container-org49f4e00" class="outline-3">
<h3 id="d7e145ff-9666-43eb-813d-78a87116532e"><a id="org49f4e00"></a><a id="ID-3e565b16-153c-4281-8f17-3653e7a9dc5d"></a>variable <b>table-name</b></h3>
<div class="outline-text-3" id="text-d7e145ff-9666-43eb-813d-78a87116532e">
<p>
Used inside deftable to find the name of the table being defined.
</p>
</div>
</div>

<div id="outline-container-orge49c488" class="outline-3">
<h3 id="00432de6-10f6-4e52-85d9-6c622e6c37ec"><a id="orge49c488"></a><a id="ID-551359a0-8d5b-4d4f-932d-df8759105ee1"></a>variable <b>table-symbol</b></h3>
<div class="outline-text-3" id="text-00432de6-10f6-4e52-85d9-6c622e6c37ec">
<p>
Used inside deftable to find the symbol naming the table being defined.
</p>
</div>
</div>

<div id="outline-container-orgfd0fac3" class="outline-3">
<h3 id="01902b36-20f9-4644-9347-fa6cbead2334"><a id="orgfd0fac3"></a><a id="ID-eb1680a7-2a82-4e6a-b31b-aeea22bf7362"></a>function !dao-def ()</h3>
<div class="outline-text-3" id="text-01902b36-20f9-4644-9347-fa6cbead2334">
<p>
Should only be used inside a deftable form. Define this table using the
corresponding DAO class' slots. Adds the result of calling dao-table-definition
on <b>table-symbol</b> to the definition.
</p>
</div>
</div>

<div id="outline-container-org842b73d" class="outline-3">
<h3 id="b0e0a7d4-1c23-4ba2-88a4-dac55a3584c8"><a id="org842b73d"></a><a id="ID-5ceae010-3712-400a-9c8c-0616b8406390"></a>function !index (&amp;rest columns), !unique-index (&amp;rest columns)</h3>
<div class="outline-text-3" id="text-b0e0a7d4-1c23-4ba2-88a4-dac55a3584c8">
<p>
Used inside a deftable form. Define an index on the table being defined. The
columns can be given as symbols or strings.
</p>
</div>
</div>

<div id="outline-container-org0870ed5" class="outline-3">
<h3 id="eba9236f-a947-4194-8337-4d0f828f5542"><a id="org0870ed5"></a><a id="ID-1378528c-3e7a-452b-8775-b3d84d897ebd"></a>function !foreign (target fields &amp;rest target-fields/on-delete/on-update/deferrable/initially-deferred)</h3>
<div class="outline-text-3" id="text-eba9236f-a947-4194-8337-4d0f828f5542">
<p>
Used insde a deftable form. Add a foreign key to the table being defined.
target-table is the referenced table. columns is a list of column names or
single name in this table, and, if the columns have different names in the
referenced table, target-columns must be another list of column names or single
column name of the target-table, or :primary-key to denote the column(s) of the
target-table's primary key as referenced column(s).
</p>

<p>
The on-delete and on-update arguments can be used to specify ON DELETE and ON
UPDATE actions, as per the keywords allowed in create-table. In addition, the
deferrable and initially-deferred arguments can be used to indicate whether
constraint checking can be deferred until the current transaction completed, and
whether this should be done by default. Note that none of these are
really &amp;key arguments, but rather are picked out of a &amp;rest arg at runtime, so
that they can be specified even when target-columns is not given.
</p>
</div>
</div>

<div id="outline-container-org6dafb22" class="outline-3">
<h3 id="5ccbe683-8a43-4373-9371-529a3007bd40"><a id="org6dafb22"></a><a id="ID-c4631db6-9994-40df-97b7-150df71bb121"></a>function !unique (target-fields &amp;key deferrable initially-deferred)</h3>
<div class="outline-text-3" id="text-5ccbe683-8a43-4373-9371-529a3007bd40">
<p>
Constrains one or more columns to only contain unique (combinations of) values,
with deferrable and initially-deferred defined as in !foreign
</p>
</div>
</div>

<div id="outline-container-org03430d5" class="outline-3">
<h3 id="e1834b87-e348-44ab-9361-0ad1021d1163"><a id="org03430d5"></a><a id="ID-333d4860-6cfe-4009-80f8-a480174d64e1"></a>function create-table (symbol)</h3>
<div class="outline-text-3" id="text-e1834b87-e348-44ab-9361-0ad1021d1163">
<p>
Takes the name of a dao-class and creates the table identified by symbol by
executing all forms in its definition as found in the <b>tables</b> list.
</p>
</div>
</div>

<div id="outline-container-org57ef4fd" class="outline-3">
<h3 id="eba2d105-d5c7-49c0-bfed-828e4ff53b09"><a id="org57ef4fd"></a><a id="ID-7477cdc4-59bf-47fb-9b60-25ee9c38eb66"></a>function create-all-tables ()</h3>
<div class="outline-text-3" id="text-eba2d105-d5c7-49c0-bfed-828e4ff53b09">
<p>
Creates all defined tables.
</p>
</div>
</div>

<div id="outline-container-org6bfb8e5" class="outline-3">
<h3 id="a49e80c8-3204-4803-b263-a0cac063ea12"><a id="org6bfb8e5"></a><a id="ID-8e36190a-a3a4-4e66-8df4-0a6b6b74f617"></a>function create-package-tables (package)</h3>
<div class="outline-text-3" id="text-a49e80c8-3204-4803-b263-a0cac063ea12">
<p>
Creates all tables identified by symbols interned in the given package.
</p>
</div>
</div>

<div id="outline-container-org9c256aa" class="outline-3">
<h3 id="a932fe23-c677-4bb7-8df8-6dd2adf2beff"><a id="org9c256aa"></a><a id="ID-25924943-75d9-4612-b2a3-dc94f292c2a5"></a>variables <b>table-name</b>, <b>table-symbol</b></h3>
<div class="outline-text-3" id="text-a932fe23-c677-4bb7-8df8-6dd2adf2beff">
<p>
Used inside deftable to find the name of the table being defined.
</p>

<p>
Used inside deftable to find the symbol naming the table being defined.
</p>
</div>
</div>

<div id="outline-container-orgbdb7357" class="outline-3">
<h3 id="f6879b3f-12dc-44a4-b92e-03dbedd0b1cd"><a id="orgbdb7357"></a><a id="ID-0427ecce-416e-4266-a5c7-90e58e22e0b7"></a>function drop-table (table-name &amp;key if-exists cascade)</h3>
<div class="outline-text-3" id="text-f6879b3f-12dc-44a4-b92e-03dbedd0b1cd">
<p>
If a table exists, drop a table. Available additional key parameters
are :if-exists and :cascade.
</p>
</div>
</div>

<div id="outline-container-orgea79f88" class="outline-3">
<h3 id="9b329d91-58c8-4153-950f-4e58b71455dc"><a id="orgea79f88"></a><a id="ID-e76fc507-bfa6-481b-b429-128ed0ede9e3"></a>Introduction to Multi-table dao class objects</h3>
<div class="outline-text-3" id="text-9b329d91-58c8-4153-950f-4e58b71455dc">
<p>
Postmodern's dao-class objects are not required to be tied down to a specific
table. They can be used simply as classes to hold data for whatever purpose your
application may use.
</p>

<p>
For this introduction, we will use two sets of tables: (1) country-d and
region-d and (2) country-n and region-n. In each case the country table will
have a foreign key tied to a region.
</p>

<p>
A foreign key is a "constraint" referencing a primary key in another table. The
table containing the foreign key is the referencing or child table and the table
referenced by the foreign key is the referenced or parent table. The foreign key
enforces a requirement that the child table column refering to another table
must refer to a row that exists in the other table. In other words, you cannot
create a row in table country-d that references a region-d name "Transylvania"
if the region-d name "Transylvania" does not yet exist in the region-d table. At
the same time, you could not later delete the region-d row with "Transylvania"
if the country-d row referencing it still exists.
</p>

<p>
Do you remember the slightly more complicated version of country from earlier on
the page?
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #00ffff;">defclass</span> <span style="color: #7ccd7c;">country</span> ()
  ((id <span style="color: #98fb98; font-weight: bold;">:col-type</span> integer <span style="color: #98fb98; font-weight: bold;">:col-identity</span> t <span style="color: #98fb98; font-weight: bold;">:accessor</span> id)
   (name <span style="color: #98fb98; font-weight: bold;">:col-type</span> string <span style="color: #98fb98; font-weight: bold;">:col-unique</span> t <span style="color: #98fb98; font-weight: bold;">:check</span> (<span style="color: #98fb98; font-weight: bold;">:&lt;&gt;</span> 'name <span style="color: #cd8162;">""</span>)
         <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:name</span> <span style="color: #98fb98; font-weight: bold;">:reader</span> country-name)
   (inhabitants <span style="color: #98fb98; font-weight: bold;">:col-type</span> integer <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:inhabitants</span>
                <span style="color: #98fb98; font-weight: bold;">:accessor</span> country-inhabitants)
   (sovereign <span style="color: #98fb98; font-weight: bold;">:col-type</span> (or db-null string) <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:sovereign</span>
              <span style="color: #98fb98; font-weight: bold;">:accessor</span> country-sovereign)
   (region-id <span style="color: #98fb98; font-weight: bold;">:col-type</span> integer <span style="color: #98fb98; font-weight: bold;">:col-references</span> ((regions id))
              <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:region-id</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> region-id))
  (<span style="color: #98fb98; font-weight: bold;">:documentation</span> <span style="color: #cd8162;">"Dao class for a countries record."</span>)
  (<span style="color: #98fb98; font-weight: bold;">:metaclass</span> dao-class)
  (<span style="color: #98fb98; font-weight: bold;">:table-name</span> countries))
</pre>
</div>
<p>
That one specified a foreign key reference in the region-id column, so we
cannot insert the data from a country dao unless there is already a region
table with an id column equal to the region-id in the country dao.
</p>

<p>
Lets look at two slightly different ways of handling countries and regions.
</p>

<p>
In our first set of tables, country-d will have a region column that references
the name column in a region-d table (so the name column in region-d must be the
primary key for region-d).
</p>

<p>
This looks relatively straight forward and it is in this simple case. Things
start getting more complicated if you start having to reference a table where
there are many items with the same name. An example would be tracking library
books. There may be multiple copies of a book title, but you need to know which
book was checked out to which library patron. In these types of situations, the
primary key cannot be the name of the region, it needs to reference some
particular id.
</p>

<p>
In our second set of tables, country-n will have a region-id column that
references an id column in a region-d table (so the id column in region-d must
be the primary key for region-d).
</p>
</div>

<div id="outline-container-org74695a5" class="outline-4">
<h4 id="da13ef47-1c9c-4d8e-be07-26a2ffa25fdc"><a id="org74695a5"></a><a id="ID-2758d7e8-ae00-4d01-8c8b-c7ff3a827047"></a>Simple Version</h4>
<div class="outline-text-4" id="text-da13ef47-1c9c-4d8e-be07-26a2ffa25fdc">
<p>
Lets start by declaring our classes and we will use the deftable make to create
a definition for our tables that gets stored in the <b>tables</b> special variable.
We can then use the (create-table 'class-name) function to create the table in
the database.
</p>

<p>
Just to be slightly different, we are going to declare the classes without the
:col-reference and :col-unique modifiers and put those into the (deftable) macro
call. We will set the id as a serial in the -d version because we want to use
name as the primary key and seting id as an identity would cause it to be the
primary key.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #00ffff;">defclass</span> <span style="color: #7ccd7c;">region-d</span> ()
  ((id <span style="color: #98fb98; font-weight: bold;">:col-type</span> serial <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:id</span> <span style="color: #98fb98; font-weight: bold;">:reader</span> region-id)
   (name <span style="color: #98fb98; font-weight: bold;">:col-type</span> string <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:name</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> region-name))
  (<span style="color: #98fb98; font-weight: bold;">:metaclass</span> pomo:dao-class)
  (<span style="color: #98fb98; font-weight: bold;">:keys</span> name))

(deftable region-d
  (!dao-def)
  (!unique 'name))

(create-table 'region-d)

(<span style="color: #00ffff;">defclass</span> <span style="color: #7ccd7c;">country-d</span> ()
  ((id <span style="color: #98fb98; font-weight: bold;">:col-type</span> serial <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:id</span> <span style="color: #98fb98; font-weight: bold;">:reader</span> country-id)
   (name <span style="color: #98fb98; font-weight: bold;">:col-type</span> string <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:name</span>
         <span style="color: #98fb98; font-weight: bold;">:reader</span> country-name)
   (region-name <span style="color: #98fb98; font-weight: bold;">:col-type</span> string <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:region-name</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> region-name))
   (<span style="color: #98fb98; font-weight: bold;">:metaclass</span> pomo:dao-class)
   (<span style="color: #98fb98; font-weight: bold;">:keys</span> name))

(deftable country-d
  (!dao-def)
  (!unique 'name)
  (!foreign 'region-d 'region-name 'name))

(create-table 'country-d)
</pre>
</div>
<p>
The new function !foreign insde the deftable adds a foreign key which requires
that a region with that id already exist before you can insert a country.
By the way, because of the foreign key constraint, postgresql will require that
the region-d table be created before the country-d table.
</p>

<p>
Look at <b>tables</b> for a moment:
</p>
<div class="org-src-container">
<pre class="src src-lisp">*tables*
((REGION-D . #&lt;FUNCTION (<span style="color: #00ffff;">LAMBDA</span> ()) {534D126B}&gt;)
 (COUNTRY-D . #&lt;FUNCTION (<span style="color: #00ffff;">LAMBDA</span> ()) {52A1484B}&gt;))
</pre>
</div>
<p>
The region-d lambda looks like this:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #00ffff;">LAMBDA</span> ()
    (<span style="color: #00ffff;">LET</span> ((*TABLE-NAME* <span style="color: #cd8162;">"region_d"</span>) (*TABLE-SYMBOL* 'REGION-D))
      (<span style="color: #00ffff;">DOLIST</span> (STAT (LIST (!DAO-DEF) (!UNIQUE 'NAME))) (EXECUTE STAT))))
</pre>
</div>
<p>
The country-d lambda looks like this:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #00ffff;">LAMBDA</span> ()
    (<span style="color: #00ffff;">LET</span> ((*TABLE-NAME* <span style="color: #cd8162;">"country_d"</span>) (*TABLE-SYMBOL* 'COUNTRY-D))
      (<span style="color: #00ffff;">DOLIST</span>
          (STAT
           (LIST (!DAO-DEF) (!UNIQUE 'NAME)
                 (!FOREIGN 'REGION-D 'REGION-NAME 'NAME)))
        (EXECUTE STAT))))
</pre>
</div>
</div>
</div>
<div id="outline-container-org37b0ca8" class="outline-4">
<h4 id="d8cb7f38-7ef3-4ec2-85a2-b4df7b2c4997"><a id="org37b0ca8"></a><a id="ID-933f58e1-a4da-4e7f-a227-0fac621e14b0"></a>Less Simple Version</h4>
<div class="outline-text-4" id="text-d8cb7f38-7ef3-4ec2-85a2-b4df7b2c4997">
<p>
In the -n version, we are going to use the id columns as the primary key.
We will not need to tell deftable t
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #00ffff;">defclass</span> <span style="color: #7ccd7c;">region-n</span> ()
  ((id <span style="color: #98fb98; font-weight: bold;">:col-type</span> integer <span style="color: #98fb98; font-weight: bold;">:col-identity</span> t <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:id</span> <span style="color: #98fb98; font-weight: bold;">:reader</span> region-id)
   (name <span style="color: #98fb98; font-weight: bold;">:col-type</span> string <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:name</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> region-name))
  (<span style="color: #98fb98; font-weight: bold;">:metaclass</span> pomo:dao-class))

(deftable region-n
  (!dao-def)
  (!unique 'name))

(create-table 'region-n)

(<span style="color: #00ffff;">defclass</span> <span style="color: #7ccd7c;">country-n</span> ()
  ((id <span style="color: #98fb98; font-weight: bold;">:col-type</span> integer <span style="color: #98fb98; font-weight: bold;">:col-identity</span> t <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:id</span> <span style="color: #98fb98; font-weight: bold;">:reader</span> country-id)
   (name <span style="color: #98fb98; font-weight: bold;">:col-type</span> string <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:name</span>
         <span style="color: #98fb98; font-weight: bold;">:reader</span> country-name)
   (region-id <span style="color: #98fb98; font-weight: bold;">:col-type</span> integer <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:region-id</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> region-id))
   (<span style="color: #98fb98; font-weight: bold;">:metaclass</span> dao-class))

(deftable country-n
  (!dao-def)
  (!unique 'name)
  (!foreign 'region-n 'region-id 'id))

(create-table 'country-n)
</pre>
</div>
<p>
How do you find the region-id? While we set the primary key as name for both
country and region in the simple version, it will be a little more work in the
less simple version. Lets start by inserting a couple of regions and we will
stick with the dao method for the moment:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(insert-dao (make-instance 'region-d <span style="color: #98fb98; font-weight: bold;">:name</span> <span style="color: #cd8162;">"Western Europe"</span>))
(insert-dao (make-instance 'region-n <span style="color: #98fb98; font-weight: bold;">:name</span> <span style="color: #cd8162;">"Western Europe"</span>))
(insert-dao (make-instance 'region-d <span style="color: #98fb98; font-weight: bold;">:name</span> <span style="color: #cd8162;">"Southern Europe"</span>))
(insert-dao (make-instance 'region-n <span style="color: #98fb98; font-weight: bold;">:name</span> <span style="color: #cd8162;">"Southern Europe"</span>))
</pre>
</div>

<p>
Now we can add a few countries to country-d:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(insert-dao (make-instance 'country-d <span style="color: #98fb98; font-weight: bold;">:name</span> <span style="color: #cd8162;">"The Netherlands"</span>
                                      <span style="color: #98fb98; font-weight: bold;">:region-name</span> <span style="color: #cd8162;">"Western Europe"</span>))

(insert-dao (make-instance 'country-d <span style="color: #98fb98; font-weight: bold;">:name</span> <span style="color: #cd8162;">"Croatia"</span>
                                      <span style="color: #98fb98; font-weight: bold;">:region-name</span> <span style="color: #cd8162;">"Southern Europe"</span>))
</pre>
</div>
<p>
Now we can add a few countries to country-n, remembering that for this version,
name is not the primary key so how to get the region dao with the name "Western Europe"? For region-d
it is easy because the name is the primary key. So
</p>
<div class="org-src-container">
<pre class="src src-lisp">(get-dao 'region-d <span style="color: #cd8162;">"Western Europe"</span>)
#&lt;REGION-D {100A322D43}&gt;
</pre>
</div>
<p>
For region-n it is a little more complicated because the primary key is the id
column, not the name column. So there are a couple of ways to do it. First is
select-dao which will return a list of daos meeting a test criteria, in a sorted
order if that third parameter is also provided. Eg.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(select-dao 'region-n (<span style="color: #98fb98; font-weight: bold;">:=</span> 'id 1))
(#&lt;REGION-N {100AAC6E13}&gt;)

(select-dao 'region-n (<span style="color: #98fb98; font-weight: bold;">:=</span> 'name <span style="color: #cd8162;">"Western Europe"</span>))
(#&lt;REGION-N {100A813CF3}&gt;)

(select-dao 'region-n t 'name)
(#&lt;REGION-N {100AC90FA3}&gt; #&lt;REGION-N {100AC911B3}&gt;)
</pre>
</div>

<p>
Another method with is query-dao, which takes a row and inserts it into a dao.
That gets us a list of daos meeting the select criteria.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query-dao 'region-n <span style="color: #cd8162;">"select * from region_n where name = 'Western Europe'"</span>)
(#&lt;REGION {1009E75E63}&gt;)
</pre>
</div>
<p>
or, using s-sql expression
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query-dao 'region-n (<span style="color: #98fb98; font-weight: bold;">:select</span> '*
                      <span style="color: #98fb98; font-weight: bold;">:from</span> 'region-n
                      <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'name <span style="color: #cd8162;">"Western Europe"</span>)))
(#&lt;REGION-D {100A50DA13}&gt;)
</pre>
</div>

<p>
Here are two different ways of generating the region-id so we can insert a new dao
into country-n:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(insert-dao
  (make-instance 'country-n
                 <span style="color: #98fb98; font-weight: bold;">:name</span> <span style="color: #cd8162;">"The Netherlands"</span>
                 <span style="color: #98fb98; font-weight: bold;">:region-id</span> (region-id
                              (first (select-dao 'region-n
                                                 (<span style="color: #98fb98; font-weight: bold;">:=</span> 'name <span style="color: #cd8162;">"Western Europe"</span>))))))
#&lt;COUNTRY-N {1002AD79B3}&gt;

(insert-dao
  (make-instance 'country-n
                 <span style="color: #98fb98; font-weight: bold;">:name</span> <span style="color: #cd8162;">"Croatia"</span>
                 <span style="color: #98fb98; font-weight: bold;">:region-id</span> (query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'id
                                    <span style="color: #98fb98; font-weight: bold;">:from</span> 'region-n
                                    <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'name <span style="color: #cd8162;">"Southern Europe"</span>))
                             <span style="color: #98fb98; font-weight: bold;">:single</span>)))
#&lt;COUNTRY-N {1002ADE2B3}&gt;
</pre>
</div>
<p>
But the returned row need not be the result from a single table. Suppose we
create a third table that has population by year and inserted a couple of rows.
This time we will do it with s-sql.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:create-table</span> 'country-population ((id <span style="color: #98fb98; font-weight: bold;">:type</span> bigserial)
                                          (country-id <span style="color: #98fb98; font-weight: bold;">:type</span> integer)
                                          (year <span style="color: #98fb98; font-weight: bold;">:type</span> integer)
                                          (population <span style="color: #98fb98; font-weight: bold;">:type</span> integer))))

(<span style="color: #00ffff;">let</span> ((country-id (query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'id
                          <span style="color: #98fb98; font-weight: bold;">:from</span> 'country-d
                          <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'name <span style="color: #cd8162;">"The Netherlands"</span>))
                         <span style="color: #98fb98; font-weight: bold;">:single</span>)))
  (query (<span style="color: #98fb98; font-weight: bold;">:insert-rows-into</span> 'country-population
          <span style="color: #98fb98; font-weight: bold;">:columns</span> 'country-id 'year 'population
          <span style="color: #98fb98; font-weight: bold;">:values</span> `((,country-id 2014 16830000)
                    (,country-id 2015 16900000)
                    (,country-id 2016 16980000)
                    (,country-id 2017 17080000)))))

(<span style="color: #00ffff;">let</span> ((country-id (query (<span style="color: #98fb98; font-weight: bold;">:select</span> 'id
                          <span style="color: #98fb98; font-weight: bold;">:from</span> 'country-d
                          <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'name <span style="color: #cd8162;">"Croatia"</span>))
                         <span style="color: #98fb98; font-weight: bold;">:single</span>)))
  (query (<span style="color: #98fb98; font-weight: bold;">:insert-rows-into</span> 'country-population
          <span style="color: #98fb98; font-weight: bold;">:columns</span> 'country-id 'year 'population
          <span style="color: #98fb98; font-weight: bold;">:values</span> `((,country-id 2014 4255518)
                    (,country-id 2015 4232873)
                    (,country-id 2016 4208611)
                    (,country-id 2017 4182846)))))
</pre>
</div>
<p>
Now we create a class that pulls from all three tables (country, region and
country-population).
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #00ffff;">defclass</span> <span style="color: #7ccd7c;">country-with-population</span> ()
  ((country-name <span style="color: #98fb98; font-weight: bold;">:col-type</span> string <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:country-name</span>
           <span style="color: #98fb98; font-weight: bold;">:reader</span> country-name)
     (region-name <span style="color: #98fb98; font-weight: bold;">:col-type</span> string <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:region-name</span> <span style="color: #98fb98; font-weight: bold;">:accessor</span> region-name)
     (year <span style="color: #98fb98; font-weight: bold;">:col-type</span> integer <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:year</span> <span style="color: #98fb98; font-weight: bold;">:reader</span> year)
     (population <span style="color: #98fb98; font-weight: bold;">:col-type</span> integer <span style="color: #98fb98; font-weight: bold;">:initarg</span> <span style="color: #98fb98; font-weight: bold;">:population</span> <span style="color: #98fb98; font-weight: bold;">:reader</span> population))
     (<span style="color: #98fb98; font-weight: bold;">:metaclass</span> dao-class)
     (<span style="color: #98fb98; font-weight: bold;">:keys</span> country-name))
</pre>
</div>
<p>
Can we use query-dao to get a list of country-with-population daos with the most
recent population data? The answer is yes. That would give us a class that maybe
our application can use without having to worry about constantly going back to
the database to look for the region's name or whatever.
</p>

<p>
Of course you still need to get the data into the class instances. You could
write the following one time as a function to generate your list of countries
with the most recent population data. Note that you need to rename the columns
to the appropriate initarg name (e.g. 'country-n.name is selected as
'country-name). You do not need to worry about the order of the selected rows.
So long as the selections are renamed properly, the slots will be populated
properly.
</p>

<p>
In the data that we have in the system, we happen to know that the years
available are the same for every country. In that case, we just want the
information for the maximum year. One way to do that would be:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query-dao 'country-with-population
                 (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:as</span> 'country-n.name 'country-name)
                          'year
                          (<span style="color: #98fb98; font-weight: bold;">:as</span> 'region-n.name 'region-name)
                          'population
                      <span style="color: #98fb98; font-weight: bold;">:from</span> 'country-n
                      <span style="color: #98fb98; font-weight: bold;">:inner-join</span> 'region-n
                      <span style="color: #98fb98; font-weight: bold;">:on</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'country-n.region-id 'region-n.id)
                      <span style="color: #98fb98; font-weight: bold;">:inner-join</span> 'country-population
                      <span style="color: #98fb98; font-weight: bold;">:on</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'country-n.id 'country-population.country-id)
                      <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'year (<span style="color: #98fb98; font-weight: bold;">:select</span> (<span style="color: #98fb98; font-weight: bold;">:max</span> 'year)
                                        <span style="color: #98fb98; font-weight: bold;">:from</span> 'country-population))))
</pre>
</div>
<p>
But what happens if the data is not the same for both countries? Lets drop the
2017 population data row for Croatia and make sure it still returns the most
current year that we have for both countries.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (<span style="color: #98fb98; font-weight: bold;">:delete-from</span> 'country-population
        <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:and</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'country-id 2)
                     (<span style="color: #98fb98; font-weight: bold;">:=</span> 'year 2017))))
</pre>
</div>
<p>
If we run the same query from above, we only get an instance for The Netherlands
because that was the only data available for the maximum year (2017). We need to
approach the data slightly differently.Because this is postmodern and we only
care about the Postgresql database, we can use its DISTINCT ON extension to the
SQL standard.
</p>

<p>
See <a href="https://www.postgresql.org/docs/current/sql-select.html#SQL-DISTINCT">https://www.postgresql.org/docs/current/sql-select.html#SQL-DISTINCT</a>
for more documentation.
</p>

<p>
The following query will pull the most recent year for both countries. How did
that happen? We limited the select clause to distinct country names so we would
only pull one of each country, then ordered the result by country-name, but most
importantly by year descending.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query-dao 'country-with-population
                 (<span style="color: #98fb98; font-weight: bold;">:order-by</span> (<span style="color: #98fb98; font-weight: bold;">:select</span>  (<span style="color: #98fb98; font-weight: bold;">:as</span> 'country-n.name 'country-name)
                                      'year
                                      (<span style="color: #98fb98; font-weight: bold;">:as</span> 'region-n.name 'region-name)
                                      'population
                             <span style="color: #98fb98; font-weight: bold;">:distinct-on</span> 'country-n.name
                             <span style="color: #98fb98; font-weight: bold;">:from</span> 'country-n
                             <span style="color: #98fb98; font-weight: bold;">:inner-join</span> 'region-n
                             <span style="color: #98fb98; font-weight: bold;">:on</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'country-n.region-id 'region-n.id)
                             <span style="color: #98fb98; font-weight: bold;">:inner-join</span> 'country-population
                             <span style="color: #98fb98; font-weight: bold;">:on</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'country-n.id
                                     'country-population.country-id))
                     'country-name
                     (<span style="color: #98fb98; font-weight: bold;">:desc</span> 'year)))
(#&lt;COUNTRY-WITH-POPULATION {1009AFAEC3}&gt;
 #&lt;COUNTRY-WITH-POPULATION {1009AFC963}&gt;)
</pre>
</div>
<p>
At this point you could write a function that gets a country-with-population dao
pulling the most recent population year from the database:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #00ffff;">defun</span> <span style="color: #63b8ff;">get-country-with-most-recent-population</span> (country)
  (car (query-dao 'country-with-population
                  (<span style="color: #98fb98; font-weight: bold;">:order-by</span> (<span style="color: #98fb98; font-weight: bold;">:select</span>  (<span style="color: #98fb98; font-weight: bold;">:as</span> 'country-n.name 'country-name)
                                       'year
                                       (<span style="color: #98fb98; font-weight: bold;">:as</span> 'region-n.name 'region-name)
                                       'population
                                       <span style="color: #98fb98; font-weight: bold;">:distinct-on</span> 'country-n.name
                                       <span style="color: #98fb98; font-weight: bold;">:from</span> 'country-n
                                       <span style="color: #98fb98; font-weight: bold;">:inner-join</span> 'region-n
                                       <span style="color: #98fb98; font-weight: bold;">:on</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'country-n.region-id
                                               'region-n.id)
                                       <span style="color: #98fb98; font-weight: bold;">:inner-join</span> 'country-population
                                       <span style="color: #98fb98; font-weight: bold;">:on</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'country-n.id
                                               'country-population.country-id)
                                       <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'country-n.name '$1))
                             'country-name
                             (<span style="color: #98fb98; font-weight: bold;">:desc</span> 'year))
                  country)))
</pre>
</div>
<p>
Obviously it is not get-dao, which is simpler but just pulls everything in a
single row from a table and this pulls just the data you want from three
different tables and it is bespoken for that class. Because get-dao is a generic
function, with the normal method being applied when passing a symbol, you could
write a new method for get-dao that would apply if you passed it an actual
country-with-population class instance.
</p>

<p>
If you want to display fields in a record which matches a dao class that you
have set up, you can call get-dao with the name of table and the primary key.
In this example, the table is "countries and the primary key happens to be the
field "id" with a value of 1.
</p>

<p>
For example, assume we pull a dao object out of our country-n table for
Croatia:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(describe (get-dao 'country-n 2))
#&lt;COUNTRY-N {1005BF7273}&gt;
  [standard-object]

Slots with <span style="color: #98fb98; font-weight: bold;">:INSTANCE</span> allocation:
  ID                             = 2
  NAME                           = <span style="color: #cd8162;">"Croatia"</span>
  REGION-ID                      = 2
</pre>
</div>
<p>
Notice that the region-id field has an integer value. This works. But assume it
has a slot of region-id, which refers to an id in the table "regions" and you
want the name of the region displayed rather than the region-id. There is a hack
using with-column-writers which essentially writes the name into the link slot.
Now, we write a function that uses the with-column-writers macro and pull in the
actual region name from the regions table.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #00ffff;">defun</span> <span style="color: #63b8ff;">get-country2</span> (country-name )
  (first (<span style="color: #00ffff;">with-column-writers</span>
         ('region-n 'region-id)
         (query-dao 'country-n
                    (<span style="color: #98fb98; font-weight: bold;">:select</span> 'country-n.* (<span style="color: #98fb98; font-weight: bold;">:as</span> 'region-n.name 'region-n)
                             <span style="color: #98fb98; font-weight: bold;">:from</span> 'country-n
                             <span style="color: #98fb98; font-weight: bold;">:left-join</span> 'region-n
                             <span style="color: #98fb98; font-weight: bold;">:on</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'country-n.region-id 'region-n.id)
                             <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'country-n.name country-name))))))

(describe (get-country2 <span style="color: #cd8162;">"Croatia"</span>))
#&lt;COUNTRIES {1003AD23D1}&gt;
  [standard-object]
(describe (get-country2 <span style="color: #cd8162;">"Croatia"</span>))
#&lt;COUNTRY-N {100593DF03}&gt;
  [standard-object]

Slots with <span style="color: #98fb98; font-weight: bold;">:INSTANCE</span> allocation:
  ID                             = 2
  NAME                           = <span style="color: #cd8162;">"Croatia"</span>
  REGION-ID                      = <span style="color: #cd8162;">"Southern Europe"</span>


(region-id (get-country2 <span style="color: #cd8162;">"Croatia"</span>))
<span style="color: #cd8162;">"Southern Europe"</span>
</pre>
</div>

<p>
Normally calling the accessor region-id would return an integer, but now it is
returning the name of the region. if you are using the dao as a simple way to
get the relevant data out of the database and you are just going to display
this value, this saves you from having to make additional database calls.
Otherwise, you would have to make an additional call to get the information
from all the foreign tables.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org62b251c" class="outline-2">
<h2 id="roles"><a id="org62b251c"></a>Roles</h2>
<div class="outline-text-2" id="text-roles">
<p>
Every connection is specific to a particular database. However, creating roles
or users is global to the entire cluster (the running postgresql server). You
can create policies for any individual database, schema or table, but you need
to ensure that those policies also apply to any subsequently created database,
schema or table. Note that each user is automatically a member of the public
group, so you need to change those policies for public as well.
</p>

<p>
Per the Postgresql Documentation, CREATE ROLE adds a new role to a PostgreSQL
database cluster. A role is an entity that can own database objects and have
database privileges; a role can be considered a “user”, a “group”, or both
depending on how it is used.
<a href="https://www.postgresql.org/docs/current/sql-createrole.html">https://www.postgresql.org/docs/current/sql-createrole.html</a>. The only real
difference between "create role" and "create user" is that create user
defaults to having a login attribute and create role defaults to not having
a login attribute.
</p>

<p>
Often applications will have their own concept of users and the application
will itself have one or more types of roles to which the application user is
assigned. So, for example, the application may have two roles - reader and
editor with which it interacts with postgresql and then there are many
application users registered with the application and probably listed in some
type of user table in postgresql that the application manages. When users 1,2
or 3 log in to the application, the application might connect to the postgresql
cluster using a role that only has read (select) permissions. When users 4 or 5
log in to the application, the applicatin might connect to the postgresql cluster
using a role that has read, insert, update and delete permission. Postmodern
provides a simplified create-role system allowing easy creation of roles that
have readonly, editor or superuser type permissions. Further, those
permissions can be limited to individual databases, schemas or tables.
</p>

<p>
We suggest that you separate application users from roles. Make it easy to
drop application users. Dropping roles requires going through every database,
reassigning ownership of any objects that role might own or have privileges
on, then dropping ownership of objects, then dropping the role itself.
</p>
</div>

<div id="outline-container-orga2e3f27" class="outline-3">
<h3 id="694123c8-957f-4b11-a344-094525d35e7f"><a id="orga2e3f27"></a>function role-exists-p (role-name)</h3>
<div class="outline-text-3" id="text-694123c8-957f-4b11-a344-094525d35e7f">
<p>
→ boolean
</p>

<p>
Does the named role exist in this database cluster? Returns t or nil.
</p>
</div>
</div>
<div id="outline-container-orgbe513b3" class="outline-3">
<h3 id="07a9f936-c1b7-4a7d-b5a5-57cd6a24870a"><a id="orgbe513b3"></a>function create-role</h3>
<div class="outline-text-3" id="text-07a9f936-c1b7-4a7d-b5a5-57cd6a24870a">
<p>
(name password &amp;key (base-role :readonly) (schema :public)
                                    (tables :all) (databases :current)
                                    (allow-whitespace nil)
                                    (allow-utf8 nil)
                                    (allow-disallowed-names nil) (comment nil))
</p>

<p>
Keyword parameters: Base-role. Base-role should be one of :readonly, :editor,
:admin, :standard or :superuser. A readonly user can only select existing data in the
specified tables or databases. An editor has the ability to insert, update,
delete or select data. An admin has all privileges on a database, but cannot
create new databases, roles, or replicate the system. A standard user has no
particular privileges other than connecting to databases.
</p>

<p>
 :schema defaults to :public but can be a list of schemas. User will not have
access to any schemas not in the list.
</p>

<p>
 :tables defaults to :all but can be a list of tables. User will not have access
to any tables not in the list.
</p>

<p>
 :databases defaults to :current but can be a list of databases. User will not
have access to any databases not in the list.
</p>

<p>
 :allow-whitespace - Whitespace in either the name or password is not allowed by
default.
</p>

<p>
 :allow-utf8 defaults to nil. If t, the name and password will be normalized. If
nil, the name and password are limited to printable ascii characters. For fun
reading on utf8 user names see
<a href="https://labs.spotify.com/2013/06/18/creative-usernames">https://labs.spotify.com/2013/06/18/creative-usernames</a>. Also interesting reading
is <a href="https://github.com/flurdy/bad_usernames">https://github.com/flurdy/bad_usernames</a> and <a href="https://github.com/dsignr/disallowed-usernames/blob/master/disallowed%20usernames.csv">https://github.com/dsignr/disallowed-usernames/blob/master/disallowed%20usernames.csv</a>,
and <a href="https://www.b-list.org/weblog/2018/feb/11/usernames/">https://www.b-list.org/weblog/2018/feb/11/usernames/</a>
</p>

<p>
 :allow-disallowed-names defaults to nil. If nil, the user name will be checked
against <b>disallowed-role-names</b>.
</p>

<p>
 As an aside, if allowing utf8 in names, you might want to think about whether
you should second copy of the username in the original casing and normalized as
NFC for display purposes as opposed to normalizing to NFKC. It might be viewed
as culturally insensitive to change the display of the name.
</p>
</div>
</div>
<div id="outline-container-orge595e24" class="outline-3">
<h3 id="e527824a-811e-41fa-ae49-2dd24f436ed3"><a id="orge595e24"></a>function drop-role (role-name &amp;optional (new-owner "postgres") (database :all))</h3>
<div class="outline-text-3" id="text-e527824a-811e-41fa-ae49-2dd24f436ed3">
<p>
→ boolean
</p>

<p>
The role-name and optional new-owner name should be strings. If they are
symbols, they will be converted to string and hyphens will be converted to
underscores.
</p>

<p>
Before dropping the role, you must drop all the objects it owns (or reassign
their ownership) and revoke any privileges the role has been granted on other
objects. If database is :all, drop-role will loop through all databases in
the cluster ensuring that the role has no privileges or owned objects in
every database. Otherwise drop-role will drop objects owned by a role in the
current database.
</p>

<p>
We will reassign ownership of the objects to the postgres role
unless otherwise specified in the optional second parameter. Returns t if
successful. Will not drop the postgres role.
</p>
</div>
</div>
<div id="outline-container-org80062ab" class="outline-3">
<h3 id="20f2425f-6a17-46b0-a8b7-22843a7f11e1"><a id="org80062ab"></a>function alter-role-search-path (role search-path)</h3>
<div class="outline-text-3" id="text-20f2425f-6a17-46b0-a8b7-22843a7f11e1">
<p>
Changes the priority of where a role looks for tables (which schema first,
second, etc. Role should be a string or symbol. Search-path could be a list of schema
names either as strings or symbols.
</p>
</div>
</div>
<div id="outline-container-org838ebd2" class="outline-3">
<h3 id="08c10e1f-96a3-4f3b-8b9c-f4a0251d43cd"><a id="org838ebd2"></a>function change-password (role password &amp;optional expiration-date)</h3>
<div class="outline-text-3" id="text-08c10e1f-96a3-4f3b-8b9c-f4a0251d43cd">
<p>
Alters a role's password. If the optional expiration-date parameter is provided,
the password will expire at the stated date. A sample expiration date would be
'December 31, 2020'. If the expiration date is 'infinity', it will never expire.
The password will be encrypted in the system catalogs. This is
automatic with postgresql versions 10 and above.
</p>
</div>
</div>

<div id="outline-container-org7419b99" class="outline-3">
<h3 id="41e66f79-aa57-4f00-b218-5f1a85c7d970"><a id="org7419b99"></a>function grant-role-permissions (role-type name &amp;key (schema :public) (tables :all) (databases :all))</h3>
<div class="outline-text-3" id="text-41e66f79-aa57-4f00-b218-5f1a85c7d970">
<p>
Grant-role-permissions assumes that a role has already been created, but
permissions need to be granted or revoked on a particular database.
</p>

<p>
   A  :superuser can create databases, roles, replication, etc. Returns nil.
   A  :standard user has no particular privileges or restrictions. Returns nil.
   An :admin user can edit existing data, insert new data and create new tables
in the specified databases/schemas/tables.
   An :editor user can update fields or insert new records but cannot create new
tables in the specified tables or databases.
   A  :readonly role can only read existing data in the specified schemas,
tables or databases. Schema, tables or databases can be :all or a list of
schemas, tables or databases to be granted permission.
</p>

<p>
Granting :all provides access to all future items of that type as well.
</p>

<p>
  Note that the schema and table rights and revocations granted are limited to
the connected database at the time of execution of this function.
</p>
</div>
</div>
<div id="outline-container-orgc341f29" class="outline-3">
<h3 id="ac447228-8f95-4a30-840d-10a1a9a418f4"><a id="orgc341f29"></a>function grant-readonly-permissions (schema-name role-name &amp;optional (table-name nil))</h3>
<div class="outline-text-3" id="text-ac447228-8f95-4a30-840d-10a1a9a418f4">
<p>
Grants select privileges to a role for the named schema. If the optional
table-name parameter is provided, the privileges are only granted with respect
to that table. Note that we are giving some function execute permissions if
table-name is nil, but if the table-name is specified, those are not provided.
Your mileage may vary on how many privileges you want to provide to a
read-only role with access to only a limited number of tables.
</p>
</div>
</div>
<div id="outline-container-org3496a75" class="outline-3">
<h3 id="1a271dc1-5e76-4b90-84d5-423a24059e8b"><a id="org3496a75"></a>function grant-editor-permissions (schema-name role-name &amp;optional (table-name nil))</h3>
<div class="outline-text-3" id="text-1a271dc1-5e76-4b90-84d5-423a24059e8b">
<p>
Grants select, insert, update and delete privileges to a role for the named
schema. If the optional table-name parameter is provided, the privileges are only
granted with respect to that table. Note that we are giving some function execute
permissions if table-name is nil, but if the table-name is specified, those are
not provided. Your mileage may vary on how many privileges you want to provide
to a editor role with access to only a limited number of tables.
</p>
</div>
</div>
<div id="outline-container-org78af081" class="outline-3">
<h3 id="4ac88ea3-bf89-462b-a9dd-cfa115234fb3"><a id="org78af081"></a>function grant-admin-permissions (schema-name role-name &amp;optional (table-name nil))</h3>
<div class="outline-text-3" id="text-4ac88ea3-bf89-462b-a9dd-cfa115234fb3">
<p>
Grants all privileges to a role for the named schema. If the optional table-name
parameter is provided, the privileges are only granted with respect to that table.
</p>
</div>
</div>
<div id="outline-container-orge3b8018" class="outline-3">
<h3 id="6e7e67b0-0fb1-461e-a842-a6e6c59f4c2f"><a id="orge3b8018"></a>function revoke-all-on-table (table-name role-name)</h3>
<div class="outline-text-3" id="text-6e7e67b0-0fb1-461e-a842-a6e6c59f4c2f">
<p>
Takes a table-name which could be a string, symbol or list of strings or
symbols of tables names, a role name and revokes all privileges that
role-name may have with that/those tables. This is limited to the currently
connected database and can only revoke the privileges granted by the caller
of the function.
</p>
</div>
</div>
<div id="outline-container-org6d04ae2" class="outline-3">
<h3 id="77975516-0416-428c-a9c8-6655b5aebedd"><a id="org6d04ae2"></a>function list-role-accessible-databases (role-name)</h3>
<div class="outline-text-3" id="text-77975516-0416-428c-a9c8-6655b5aebedd">
<p>
→ list
</p>

<p>
Returns a list of the databases to which the specified role can connect.
</p>
</div>
</div>
<div id="outline-container-orgd11ff36" class="outline-3">
<h3 id="a5bdaaca-11e5-438d-83a8-495cef9b85fa"><a id="orgd11ff36"></a><a id="ID-e6d13898-e158-4001-b54c-cc7e58342023"></a>function list-roles (&amp;optional (lt nil))</h3>
<div class="outline-text-3" id="text-a5bdaaca-11e5-438d-83a8-495cef9b85fa">
<p>
→ list
</p>

<p>
Returns a list of alists of rolenames, role attributes and membership in roles.
See <a href="https://www.postgresql.org/docs/current/role-membership.html">https://www.postgresql.org/docs/current/role-membership.html</a> for an
explanation. Optionally passing :alists or :plists can be used to set the return
list types to :alists or :plists. This is the same as the psql function \du.
</p>
</div>
</div>

<div id="outline-container-orgf1d6981" class="outline-3">
<h3 id="fd161f71-a334-4959-8b42-dda5271ef6d5"><a id="orgf1d6981"></a>function list-role-permissions (&amp;optional role)</h3>
<div class="outline-text-3" id="text-fd161f71-a334-4959-8b42-dda5271ef6d5">
<p>
→ list
</p>

<p>
This returns a list of sublists of the permissions granted  within the
currently connected database. If an optional role is provided, the result is
limited to that role. The sublist returned will be in the form of role-name,
schema-name, table-name and then a string containing all the rights of that role
on that table in that schema.
</p>
</div>
</div>
</div>
<div id="outline-container-orgb98fb5e" class="outline-2">
<h2 id="database-information"><a id="orgb98fb5e"></a><a id="ID-ecc7ca5e-9117-488b-aa7c-011d56409f76"></a>Database Information</h2>
<div class="outline-text-2" id="text-database-information">
</div>
<div id="outline-container-org59f5135" class="outline-3">
<h3 id="22c6eb1c-c0ca-44fc-a8f1-590fda047866"><a id="org59f5135"></a>function add-comment (type name comment &amp;optional (second-name ""))</h3>
<div class="outline-text-3" id="text-22c6eb1c-c0ca-44fc-a8f1-590fda047866">
<p>
Attempts to add a comment to a particular database object. The first parameter is a keyword for the type of database object. The second parameter is the name of the object. The third parameter is the comment itself. Some objects require an additional identifier. The names can be strings or symbols.
</p>

<p>
Example usage would be:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(add-comment <span style="color: #98fb98; font-weight: bold;">:database</span> 'my-database-name <span style="color: #cd8162;">"Does anyone actually use this database?"</span>)

(add-comment <span style="color: #98fb98; font-weight: bold;">:column</span> 'country-locations.name <span style="color: #cd8162;">"Is what it looks like - the name of a country"</span>)

(add-comment <span style="color: #98fb98; font-weight: bold;">:column</span> <span style="color: #cd8162;">"country_locations.name"</span> <span style="color: #cd8162;">"Is what it looks like - the name of a country"</span>)
</pre>
</div>

<p>
Example usage where two identifiers are required would be constraints:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(add-comment <span style="color: #98fb98; font-weight: bold;">:constraint</span> 'constraint1  <span style="color: #cd8162;">"Some kind of constraint descriptions here"</span>
             'country-locations)
</pre>
</div>
</div>
</div>

<div id="outline-container-org7fbc1a7" class="outline-3">
<h3 id="d993f27b-95d6-4a5b-bdf3-3e06beed0213"><a id="org7fbc1a7"></a>function get-database-comment (database-name)</h3>
<div class="outline-text-3" id="text-d993f27b-95d6-4a5b-bdf3-3e06beed0213">
<p>
→ string
</p>

<p>
Returns the comment, if any, attached to a database.
</p>
</div>
</div>
<div id="outline-container-org9ceab48" class="outline-3">
<h3 id="29d56bfd-15a0-40bb-b7f1-a1683b392695"><a id="org9ceab48"></a><a id="ID-9243f0ff-2001-4427-8cf9-33f9a9b6fd5c"></a>function postgresql-version ()</h3>
<div class="outline-text-3" id="text-29d56bfd-15a0-40bb-b7f1-a1683b392695">
<p>
→ string
</p>

<p>
Returns the version string provided by postgresql of the current postgresql
server. E.g. "PostgreSQL 12.2 on x86_64-pc-linux-gnu, compiled by gcc
(Arch Linux 9.3.0-1) 9.3.0, 64-bit". If you want just the postgresql version
number, use (cl-postgres:get-postgresql-version).
</p>
</div>
</div>

<div id="outline-container-orgd0f9177" class="outline-3">
<h3 id="29d56bfd-15a0-40bb-b7f1-a1683b392695"><a id="orgd0f9177"></a><a id="ID-9243f0ff-2001-4427-8cf9-33f9a9b6fd5c"></a>function database-version ()</h3>
<div class="outline-text-3" id="text-29d56bfd-15a0-40bb-b7f1-a1683b392695">
<p>
→ string
</p>

<p>
DEPRECATED. This returns the postgresql server version number, not a version
number from the currently connected database. The format of the return string
is determined by the current postgresql server.
E.g. "PostgreSQL 12.2 on x86_64-pc-linux-gnu, compiled by gcc
(Arch Linux 9.3.0-1) 9.3.0, 64-bit".
</p>

<p>
If you want just the postgresql version
number, use (cl-postgres:get-postgresql-version).
</p>
</div>
</div>

<div id="outline-container-orgfe05e83" class="outline-3">
<h3 id="69269619-9b8a-4e88-8ede-777182579d0a"><a id="orgfe05e83"></a><a id="ID-4928edd1-e74c-4e90-92d8-bd9b98ab0894"></a>function current-database ()</h3>
<div class="outline-text-3" id="text-69269619-9b8a-4e88-8ede-777182579d0a">
<p>
→ string
</p>

<p>
Returns the string name of the current database.
</p>
</div>
</div>

<div id="outline-container-org5c93024" class="outline-3">
<h3 id="03fec9c2-6282-4b33-abf8-4db16044cf52"><a id="org5c93024"></a><a id="ID-96e0c18f-4a1e-4cc5-b9c6-5bcd368d0d13"></a>function database-exists-p (database-name)</h3>
<div class="outline-text-3" id="text-03fec9c2-6282-4b33-abf8-4db16044cf52">
<p>
→ boolean
</p>

<p>
Checks to see if a particular database exists. Returns T if true, nil if not.
</p>
</div>
</div>

<div id="outline-container-orgd97ba34" class="outline-3">
<h3 id="d8827c9d-64ff-4334-9a14-1ca4536f8d0a"><a id="orgd97ba34"></a><a id="ID-9afb5a1e-ef10-4d54-91be-b30debc708dd"></a>function database-size (&amp;optional database-name)</h3>
<div class="outline-text-3" id="text-d8827c9d-64ff-4334-9a14-1ca4536f8d0a">
<p>
→ list
</p>

<p>
Given the name of a database, will return the name, a pretty-print string of
the size of the database and the size in bytes. If a database name is not
provided, it will return the result for the currently connected database.
</p>
</div>
</div>

<div id="outline-container-org67eb41e" class="outline-3">
<h3 id="25b5233f-9a2c-4e39-8902-4a0b88e3b5b3"><a id="org67eb41e"></a><a id="ID-2893eb67-97ae-41cb-8987-1924855ec48a"></a>function num-records-in-database ()</h3>
<div class="outline-text-3" id="text-25b5233f-9a2c-4e39-8902-4a0b88e3b5b3">
<p>
→ list
</p>

<p>
Returns a list of lists with schema, table name and approximate number of
records in the currently connected database.
</p>
</div>
</div>

<div id="outline-container-orga2691d8" class="outline-3">
<h3 id="b5909c41-f24b-4678-8bd9-759d543c4d81"><a id="orga2691d8"></a><a id="ID-a47beb6b-fdbd-470b-ad85-541d0e6518f8"></a>function list-databases (&amp;key (order-by-size nil) (size t))</h3>
<div class="outline-text-3" id="text-b5909c41-f24b-4678-8bd9-759d543c4d81">
<p>
→ list
</p>

<p>
Returns a list of lists where each sub-list contains the name of the database,
a pretty-print string of the size of that database and the size in bytes. The
default order is by database name. Pass t as a parameter to :order-by-size
for order by size. Setting size to nil will return just the database names
in a single list ordered by name. This function excludes the template databases
</p>
</div>
</div>

<div id="outline-container-orgbf3f0cd" class="outline-3">
<h3 id="ff1d636e-12ba-4fb0-8513-7f808617b956"><a id="orgbf3f0cd"></a><a id="ID-61f0e7e5-cf5d-4c2e-967d-588808d1a1bc"></a>function list-database-functions ()</h3>
<div class="outline-text-3" id="text-ff1d636e-12ba-4fb0-8513-7f808617b956">
<p>
→ list
</p>

<p>
Returns a list of the functions in the database from the information_schema.
</p>


<p>
DEPRECATED FOR DESCRIBE-TRIGGERS. List detailed information on the triggers from
the information_schema table.
</p>
</div>
</div>
<div id="outline-container-org52c18b0" class="outline-3">
<h3 id="5810bfc5-9338-4a6b-807f-bc72265771a0"><a id="org52c18b0"></a><a id="ID-adfb5355-fd04-4835-a2bd-337dc9402915"></a>function list-database-users ()</h3>
<div class="outline-text-3" id="text-5810bfc5-9338-4a6b-807f-bc72265771a0">
<p>
→ list
</p>

<p>
List database users (actually 'roles' in Postgresql terminology).
</p>
</div>
</div>
<div id="outline-container-orgce92ac5" class="outline-3">
<h3 id="36e580f9-d647-4f6d-869b-0fcd347fb9d5"><a id="orgce92ac5"></a>function list-database-access-rights (&amp;optional database-name)</h3>
<div class="outline-text-3" id="text-36e580f9-d647-4f6d-869b-0fcd347fb9d5">
<p>
→ list
</p>

<p>
If the database parameter is specifed, this returns an list of lists where
each sublist is a role name and whether they have access rights (t or nil) to that
particular database. If the database-name is not provided, the sublist is
a database name, a role name and whether they have access rights (t or nil). This
excludes the template databases.
</p>
</div>
</div>

<div id="outline-container-orgc594f68" class="outline-3">
<h3 id="3aeac559-710e-4f60-b687-33b25a6f575a"><a id="orgc594f68"></a><a id="ID-b5ebabe7-31f9-45b6-8ecb-6035febaa392"></a>function list-available-types ()</h3>
<div class="outline-text-3" id="text-3aeac559-710e-4f60-b687-33b25a6f575a">
<p>
→ list
</p>

<p>
List the available data types in the connected postgresql version, It returns a
list of lists, each sublist containing the oid (object identifier number) and
the name of the data types. E.g. (21 "smallint")
</p>
</div>
</div>

<div id="outline-container-org3470fae" class="outline-3">
<h3 id="da41c0fb-9479-4e23-bdf2-ba73db959e36"><a id="org3470fae"></a>function list-available-collations ()</h3>
<div class="outline-text-3" id="text-da41c0fb-9479-4e23-bdf2-ba73db959e36">
<p>
→ list
</p>

<p>
Get a list of the collations available from the current database cluster.
Collations are a mess as different operating systems provide different
collations. We might get some sanity if Postgresql can use ICU as the default.
See <a href="https://wiki.postgresql.org/wiki/Collations">https://wiki.postgresql.org/wiki/Collations</a>.
</p>
</div>
</div>
<div id="outline-container-org96e7003" class="outline-3">
<h3 id="f6a3893a-0d39-4484-9d3d-40d0ba2e05fd"><a id="org96e7003"></a><a id="ID-353cafc2-ca5c-4197-b820-3662dbbea2e3"></a>function list-available-extensions ()</h3>
<div class="outline-text-3" id="text-f6a3893a-0d39-4484-9d3d-40d0ba2e05fd">
<p>
→ list
</p>

<p>
List the postgresql extensions which are available in the system to the
currently connected database. The extensions may or may not be installed.
</p>
</div>
</div>
<div id="outline-container-org8fb9ad7" class="outline-3">
<h3 id="2855d5f5-3957-49ba-9d07-f61464e6da28"><a id="org8fb9ad7"></a><a id="ID-922fca24-53d7-4883-844a-cf383ffc7322"></a>function list-installed-extensions ()</h3>
<div class="outline-text-3" id="text-2855d5f5-3957-49ba-9d07-f61464e6da28">
<p>
→ list
</p>

<p>
List the postgresql extensions which are installed in the currently connected
database.
</p>
</div>
</div>
<div id="outline-container-orgb8eb8b3" class="outline-3">
<h3 id="5bc847be-5de4-4e64-8feb-7256f58b1a0a"><a id="orgb8eb8b3"></a>function list-templates ()</h3>
<div class="outline-text-3" id="text-5bc847be-5de4-4e64-8feb-7256f58b1a0a">
<p>
→ list
</p>

<p>
Returns a list of existing database template names.
</p>
</div>
</div>
<div id="outline-container-orgc7f4297" class="outline-3">
<h3 id="e0ce24b7-5619-4ab7-9912-48ebfca4605f"><a id="orgc7f4297"></a><a id="ID-6d41d3c5-2013-4404-aae6-2a7cd5df4b18"></a>function change-toplevel-database (new-database user password host)</h3>
<div class="outline-text-3" id="text-e0ce24b7-5619-4ab7-9912-48ebfca4605f">
<p>
→ string
</p>

<p>
Just changes the database assuming you are using a toplevel connection.
Recommended only for development work. Returns the name of the newly connected
database as a string.
</p>
</div>
</div>

<div id="outline-container-orgcf52a85" class="outline-3">
<h3 id="932d1dde-71e2-4f26-bac4-17a238101e24"><a id="orgcf52a85"></a><a id="ID-4d405778-1b17-4928-8d40-e239f8d4c73d"></a>function cache-hit-ratio ()</h3>
<div class="outline-text-3" id="text-932d1dde-71e2-4f26-bac4-17a238101e24">
<p>
→ list
</p>

<p>
The cache hit ratio shows data on serving the data from memory compared to how
often you have to go to disk. This function returns a list of heapblocks read
from disk, heapblocks hit from memory and the ratio of heapblocks hit from
memory / total heapblocks hit. Borrowed from: <a href="https://www.citusdata.com/blog/2019/03/29/health-checks-for-your-postgres-database/">https://www.citusdata.com/blog/2019/03/29/health-checks-for-your-postgres-database/</a>
</p>
</div>
</div>

<div id="outline-container-org01a816e" class="outline-3">
<h3 id="84bc40e4-44bf-4c1e-91d2-b32ba77f86c4"><a id="org01a816e"></a><a id="ID-1d81081b-3cfe-4ef5-989f-23c5ed44d7fc"></a>function bloat-measurement ()</h3>
<div class="outline-text-3" id="text-84bc40e4-44bf-4c1e-91d2-b32ba77f86c4">
<p>
→ list
</p>

<p>
Bloat measurement of unvacuumed dead tuples.
Borrowed from: <a href="https://www.citusdata.com/blog/2019/03/29/health-checks-for-your-postgres-database/">https://www.citusdata.com/blog/2019/03/29/health-checks-for-your-postgres-database/</a> who
borrowed it from <a href="https://github.com/heroku/heroku-pg-extras/tree/master/commands">https://github.com/heroku/heroku-pg-extras/tree/master/commands</a>.
</p>
</div>
</div>

<div id="outline-container-orge1ecd2a" class="outline-3">
<h3 id="10ec1cf5-e865-43e9-a093-8f27916af0d2"><a id="orge1ecd2a"></a><a id="ID-cdbc1e43-b4a7-4709-89f7-d93ba7ac3bae"></a>function unused-indexes ()</h3>
<div class="outline-text-3" id="text-10ec1cf5-e865-43e9-a093-8f27916af0d2">
<p>
→ list
</p>

<p>
Returns a list of lists showing schema.table, indexname, index_size and number
of scans. The code was borrowed from: <a href="https://www.citusdata.com/blog/2019/03/29/health-checks-for-your-postgres-database/">https://www.citusdata.com/blog/2019/03/29/health-checks-for-your-postgres-database/</a>
</p>
</div>
</div>

<div id="outline-container-org6cd85fb" class="outline-3">
<h3 id="c532268f-61d7-4613-85cc-460d7d92aab0"><a id="org6cd85fb"></a><a id="ID-31ab040b-01fb-4a08-8c27-4b3bc35c9361"></a>function check-query-performance (&amp;optional (ob nil) (num-calls 100) (limit 20))</h3>
<div class="outline-text-3" id="text-c532268f-61d7-4613-85cc-460d7d92aab0">
<p>
→ list
</p>

<p>
This function requires that postgresql extension pg_stat_statements must be
loaded via shared_preload_libraries. It is borrowed from <a href="https://www.citusdata.com/blog/2019/03/29/health-checks-for-your-postgres-database/">https://www.citusdata.com/blog/2019/03/29/health-checks-for-your-postgres-database/</a>.
Optional parameters:
</p>

<p>
 OB allow order-by to be 'calls', 'total-time', 'rows-per'
or 'time-per', defaulting to time-per.
</p>

<p>
num-calls to require that the number of calls exceeds a certain threshold, and
limit to limit the number of rows returned. It returns a list of lists, each
row containing the query, number of calls, total_time, total_time/calls,
stddev_time, rows, rows/calls and the cache hit percentage.
</p>
</div>
</div>
</div>

<div id="outline-container-org0a08a34" class="outline-2">
<h2 id="constraints"><a id="org0a08a34"></a><a id="ID-b857f2fe-7b5c-4b13-9909-cb637f7ba367"></a>Constraints</h2>
<div class="outline-text-2" id="text-constraints">
</div>
<div id="outline-container-org7451268" class="outline-3">
<h3 id="e20d9e5c-b0a7-44a6-8907-ad205ec1e0b8"><a id="org7451268"></a><a id="ID-e5adb03e-a26a-40fa-bde2-05f541fc70cf"></a>function list-unique-or-primary-constraints (table-name)</h3>
<div class="outline-text-3" id="text-e20d9e5c-b0a7-44a6-8907-ad205ec1e0b8">
<p>
→ list
</p>

<p>
List constraints on a table. Table-name can be either a string or quoted. Turns
constraints into keywords if strings-p is not true.
</p>
</div>
</div>

<div id="outline-container-orgc78d3b7" class="outline-3">
<h3 id="4b8a62cb-647b-4c3b-b2a7-58476fff58d1"><a id="orgc78d3b7"></a><a id="ID-d641e79f-b66f-4248-9c1a-284f07182d12"></a>function list-all-constraints (table-name)</h3>
<div class="outline-text-3" id="text-4b8a62cb-647b-4c3b-b2a7-58476fff58d1">
<p>
→ list
</p>

<p>
Users information_schema to list all the constraints in a table. Table-name can
be either a string or quoted. Turns constraints into keywords if strings-p is
not true.
</p>
</div>
</div>

<div id="outline-container-org06edf65" class="outline-3">
<h3 id="4f692c41-549f-462d-b98c-a8f7e400f4cc"><a id="org06edf65"></a><a id="ID-8d6cff99-a479-4b98-9fd5-fd77517b61b4"></a>function describe-constraint (table-name constraint-name)</h3>
<div class="outline-text-3" id="text-4f692c41-549f-462d-b98c-a8f7e400f4cc">
<p>
→ list
</p>

<p>
Return a list of alists of the descriptions a particular constraint given the
table-name and the constraint name using the information_schema table.
</p>
</div>
</div>

<div id="outline-container-orgec91218" class="outline-3">
<h3 id="dfe5a61e-7450-47b7-a17b-0d9bd83e1706"><a id="orgec91218"></a><a id="ID-96f4c221-be13-440d-a7ac-0b446bfb06cc"></a>function describe-foreign-key-constraints ()</h3>
<div class="outline-text-3" id="text-dfe5a61e-7450-47b7-a17b-0d9bd83e1706">
<p>
→ list
</p>

<p>
Generates a list of lists of information on the foreign key constraints
</p>
</div>
</div>
</div>
<div id="outline-container-orgb44ae7e" class="outline-2">
<h2 id="indexes"><a id="orgb44ae7e"></a><a id="ID-a265f57e-3928-4386-92c0-ab2764f4fdc5"></a>Indexes/Indices</h2>
<div class="outline-text-2" id="text-indexes">
</div>
<div id="outline-container-org51eca5d" class="outline-3">
<h3 id="21392a30-a33c-4330-9a96-abaebcc0af66"><a id="org51eca5d"></a><a id="ID-8724742c-e2fe-48f5-b190-7c1218f9995d"></a>function create-index (name  &amp;key unique if-not-exists concurrently on using fields)</h3>
<div class="outline-text-3" id="text-21392a30-a33c-4330-9a96-abaebcc0af66">
<p>
Create an index. Slightly less sophisticated than the query version because it
does not have a where clause capability.
</p>
</div>
</div>

<div id="outline-container-org755d348" class="outline-3">
<h3 id="6bfcf7a6-6c14-4fad-82f4-5be599f1466b"><a id="org755d348"></a><a id="ID-9a3553c3-9d58-490f-93e3-2d04b5bd72bc"></a>function drop-index (name &amp;key concurrently if-exists cascade)</h3>
<div class="outline-text-3" id="text-6bfcf7a6-6c14-4fad-82f4-5be599f1466b">
<p>
Drop an index. Available keys are :concurrently, :if-exists, and :cascade.
</p>
</div>
</div>

<div id="outline-container-org45a6ff6" class="outline-3">
<h3 id="42f1ee95-201b-4d66-b02e-1b35b0e1614c"><a id="org45a6ff6"></a><a id="ID-e7fa9796-6804-4446-bfda-3455432d4453"></a>function list-indices (&amp;optional strings-p)</h3>
<div class="outline-text-3" id="text-42f1ee95-201b-4d66-b02e-1b35b0e1614c">
<p>
→ list
</p>

<p>
Return a list of the indexs in a database. Turn them into keywords if strings-p
is not true.
</p>
</div>
</div>

<div id="outline-container-org9a17b3f" class="outline-3">
<h3 id="72f27f96-392f-4f33-a152-e15888a98c5d"><a id="org9a17b3f"></a><a id="ID-d57a9331-04b4-4920-9fe5-36d4b1d785bb"></a>function list-table-indices (table-name &amp;optional strings-p)</h3>
<div class="outline-text-3" id="text-72f27f96-392f-4f33-a152-e15888a98c5d">
<p>
→ list
</p>

<p>
List the index names and the related columns in a single table. Each index will
be in a separate sublist.
</p>
</div>
</div>

<div id="outline-container-org402674d" class="outline-3">
<h3 id="c01dc7a8-0153-4857-acad-cb7ec8eccbdc"><a id="org402674d"></a><a id="ID-82c1851f-91cc-4e4d-b802-b2ba37ec6938"></a>function index-exists-p (name)</h3>
<div class="outline-text-3" id="text-c01dc7a8-0153-4857-acad-cb7ec8eccbdc">
<p>
→ boolean
</p>

<p>
Tests whether an index with the given name exists. The name can be either a
string or a symbol.
</p>
</div>
</div>

<div id="outline-container-org91120c1" class="outline-3">
<h3 id="07e4d320-8201-4cc5-803d-c83ee681d103"><a id="org91120c1"></a><a id="ID-47908329-5309-4319-9c16-56821f4b6233"></a>function list-indexed-column-and-attributes (table-name)</h3>
<div class="outline-text-3" id="text-07e4d320-8201-4cc5-803d-c83ee681d103">
<p>
→ list
</p>

<p>
List the indexed columns and their attributes in a table. Includes primary
key.
</p>
</div>
</div>

<div id="outline-container-org78e6ff9" class="outline-3">
<h3 id="56922f26-5ab4-4c1a-98a2-a0ab56eff9bb"><a id="org78e6ff9"></a><a id="ID-0078a757-8cc5-46a7-956e-ddb1fe2c579b"></a>function list-index-definitions (table-name)</h3>
<div class="outline-text-3" id="text-56922f26-5ab4-4c1a-98a2-a0ab56eff9bb">
<p>
→ list
</p>

<p>
Returns a list of the definitions used to create the current indexes for
the table
</p>
</div>
</div>
</div>

<div id="outline-container-orgadbc4e3" class="outline-2">
<h2 id="keys"><a id="orgadbc4e3"></a><a id="ID-342fdfce-eed8-4ed1-a208-37c417b5a291"></a>Keys</h2>
<div class="outline-text-2" id="text-keys">
</div>
<div id="outline-container-org6ff776f" class="outline-3">
<h3 id="5bf78e17-6506-4f49-b103-9900978f8344"><a id="org6ff776f"></a><a id="ID-87a5e1c4-fe1b-4b9a-bdcf-7dbe62bd20f1"></a>function find-primary-key-info (table-name &amp;optional (just-key nil))</h3>
<div class="outline-text-3" id="text-5bf78e17-6506-4f49-b103-9900978f8344">
<p>
→ list
</p>

<p>
Returns a list of sublists where the sublist contains two strings. If a table
primary key consists of only one column, such as 'id' there will be a single
sublist where the first string is the name of the column and the second string
is the string name for the datatype for that column. If the primary key for the
table consists of more than one column, there will be a sublist for each column
subpart of the key. The sublists will be in the order they are used in the key,
not in the order they appear in the table. If just-key is set to t, the list
being returned will contain just the column names in the primary key as string
names with no sublists. If the table is not in the public schema, provide the
fully qualified table name e.g. schema-name.table-name.
</p>
</div>
</div>

<div id="outline-container-org7161099" class="outline-3">
<h3 id="68d136c2-a216-4def-87f9-726f72dda631"><a id="org7161099"></a><a id="ID-cb0a151a-ad44-4a7a-896d-47903d0e718b"></a>function list-foreign-keys (table-name)</h3>
<div class="outline-text-3" id="text-68d136c2-a216-4def-87f9-726f72dda631">
<p>
→ list
</p>

<p>
Returns a list of sublists of foreign key info in the form of
   '((constraint-name local-table local-table-column
     foreign-table-name foreign-column-name))
</p>
</div>
</div>
</div>

<div id="outline-container-org8d7bb98" class="outline-2">
<h2 id="schema"><a id="org8d7bb98"></a><a id="ID-eef5ba67-cfe2-47dc-b432-2a75b45765d8"></a>Schema/Schemata</h2>
<div class="outline-text-2" id="text-schema">
<p>
Schema allow you to separate tables into differnet name spaces. In different
schemata two tables with the same name are allowed to exists. The tables can
be referred by fully qualified names or with the macro with-schema. You could
also set the search path with set-search-path. For listing end checking there
are also the functions list-schemata and schema-exist-p. The following
functions allow you to create, drop schemata and to set the search path.
</p>
</div>

<div id="outline-container-org676f43a" class="outline-3">
<h3 id="9b1b791c-5e04-4512-91cb-9b44fac7b76e"><a id="org676f43a"></a><a id="ID-70159647-6efd-4fcc-acf0-86b24594822b"></a>macro with-schema ((namespace &amp;key :strict t :if-not-exist :create :drop-after) &amp;body body)</h3>
<div class="outline-text-3" id="text-9b1b791c-5e04-4512-91cb-9b44fac7b76e">
<p>
A macro to set the schema search path (namespace) of the postgresql database to
include as first entry a specified schema and then executes the body. Before
executing body the PostgreSQL's session variable search_path is set to the given
namespace. After executing body the search_path variable is restored to the
original value.
</p>

<p>
   Calling with :strict 't only the specified schema is set as current search
path. All other schema are then not searched any more. If strict is nil, the
namespace is just first schema on the search path upon the the body execution.
</p>

<p>
   Calling with :if-not-exist set to :create the schema is created if this
schema did not exist.
</p>

<p>
Calling with :if-not-exist set to nil, an error is signaled.
</p>

<p>
   calling with drop-after set to 't the schema is removed after the execution
of the body form.
</p>

<p>
example :
  (with-schema (:schema-name :strict nil :drop-after nil :if-not-exist :error)
         (foo 1)
         (foo 2))
</p>

<p>
example :
  (with-schema ('uniq :if-not-exist :create) ;; changing the search path
         (schema-exists-p 'uniq))
</p>
</div>
</div>

<div id="outline-container-org4e3ac3d" class="outline-3">
<h3 id="cb98d8fa-8750-4d3c-b7c2-a060205609d6"><a id="org4e3ac3d"></a><a id="ID-8fa081ea-d959-457d-89ae-980bbb997148"></a>function list-schemata ()</h3>
<div class="outline-text-3" id="text-cb98d8fa-8750-4d3c-b7c2-a060205609d6">
<p>
→ list
</p>

<p>
List all existing user defined schemata.
</p>

<p>
Note: The query uses the portable information_schema relations instead of
pg_tables relations.
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #00ffff;">select</span> <span style="color: #00ffff;">schema_name</span>
<span style="color: #00ffff;">from</span> information_schema.schemata
<span style="color: #00ffff;">where</span> <span style="color: #00ffff;">schema_name</span> !~ <span style="color: #cd8162;">'(pg_*)|information_schema'</span>
<span style="color: #00ffff;">order</span> <span style="color: #00ffff;">by</span> <span style="color: #00ffff;">schema_name</span> ;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc206d65" class="outline-3">
<h3 id="612d3bfd-36e2-4b27-a3e9-9f4e4cf15428"><a id="orgc206d65"></a><a id="ID-06eff6ed-5de0-4947-9dd1-26ae7dedd360"></a>function list-schemas ()</h3>
<div class="outline-text-3" id="text-612d3bfd-36e2-4b27-a3e9-9f4e4cf15428">
<p>
→ list
</p>

<p>
List schemas in the current database, excluding the pg_* system schemas.
</p>
</div>
</div>

<div id="outline-container-orgab5e087" class="outline-3">
<h3 id="a8a3a0df-edf5-4f17-bb97-a3d76973d078"><a id="orgab5e087"></a><a id="ID-f52064e9-e859-416e-bb67-20f5de49613e"></a>function schema-exists-p (schema)</h3>
<div class="outline-text-3" id="text-a8a3a0df-edf5-4f17-bb97-a3d76973d078">
<p>
→ boolean
</p>

<p>
Tests the existence of a given schema. Returns T if the schema exists or NIL
otherwise. The name provided can be either a string or quoted symbol.
</p>
</div>
</div>

<div id="outline-container-orgca8976e" class="outline-3">
<h3 id="06e76060-e646-4fe8-b1b3-142afb2e370b"><a id="orgca8976e"></a><a id="ID-3d4619fa-faef-47b2-b6ab-61b36e8b52b2"></a>function create-schema (schema)</h3>
<div class="outline-text-3" id="text-06e76060-e646-4fe8-b1b3-142afb2e370b">
<p>
Creates a new schema. Raises an error if the schema is already exists.
</p>
</div>
</div>

<div id="outline-container-org1e26851" class="outline-3">
<h3 id="79d7fdbb-54d7-48e1-821d-9379e3940577"><a id="org1e26851"></a><a id="ID-cc7fe0f4-31b5-435c-9b8d-22564f7e0ad5"></a>function drop-schema (schema &amp;key (if-exists nil) (cascade nil))</h3>
<div class="outline-text-3" id="text-79d7fdbb-54d7-48e1-821d-9379e3940577">
<p>
Drops an existing database schema. Accepts :if-exists and/or :cascade arguments
like :drop-table. A notice instead of an error is raised with the is-exists
parameter.
</p>
</div>
</div>

<div id="outline-container-orgd91c43c" class="outline-3">
<h3 id="b8999d95-0ef5-492e-af5b-cfbdc91278e6"><a id="orgd91c43c"></a><a id="ID-639f826f-aed2-4a2d-811c-fe862953d195"></a>function get-search-path ()</h3>
<div class="outline-text-3" id="text-b8999d95-0ef5-492e-af5b-cfbdc91278e6">
<p>
Returns the default schema search path for the current session.
</p>
</div>
</div>

<div id="outline-container-orgaff79ae" class="outline-3">
<h3 id="125a3594-080f-40eb-997d-d7ef927420e6"><a id="orgaff79ae"></a><a id="ID-1fa0b1a6-af88-4083-b3f1-16b8b79aca3c"></a>function set-search-path (path)</h3>
<div class="outline-text-3" id="text-125a3594-080f-40eb-997d-d7ef927420e6">
<p>
This changes the postgresql runtime parameter controlling what order schemas are
searched. You can always use fully qualified names [schema.table]. By default,
this function only changes the search path for the current session. This
function is used by with-schema.
</p>
</div>
</div>
<div id="outline-container-org4d58455" class="outline-3">
<h3 id="cfacd9fe-b640-4aee-985b-149f4b9ce930"><a id="org4d58455"></a><a id="ID-1aa410f7-b60b-4c95-bc4e-dacefe8cc04c"></a>function split-fully-qualified-tablename (name)</h3>
<div class="outline-text-3" id="text-cfacd9fe-b640-4aee-985b-149f4b9ce930">
<p>
→ list
Take a tablename of the form database.schema.table or schema.table or table and
return the tablename and the schema name. The name can be a symbol or a string.
Returns a list of form '(table schema database. If the tablename is not fully
qualified, it will assume that the schema should be \"public\".
</p>
</div>
</div>
</div>

<div id="outline-container-org44418bc" class="outline-2">
<h2 id="sequences"><a id="org44418bc"></a><a id="ID-62e4d0bd-e12f-47c6-8373-a174a7d8d7b1"></a>Sequences</h2>
<div class="outline-text-2" id="text-sequences">
</div>
<div id="outline-container-orgea92b8b" class="outline-3">
<h3 id="4d295beb-7a6d-402e-a831-00db88584cb4"><a id="orgea92b8b"></a><a id="ID-37802810-069f-4219-a36a-1e4f754dd5f8"></a>function create-sequence (name &amp;key temp if-not-exists increment min-value max-value start cache)</h3>
<div class="outline-text-3" id="text-4d295beb-7a6d-402e-a831-00db88584cb4">
<p>
  Create a sequence. Available additional key parameters
are :temp :if-not-exists :increment :min-value :max-value :start and :cache. See
<a href="https://www.postgresql.org/docs/current/static/sql-createsequence.html">https://www.postgresql.org/docs/current/static/sql-createsequence.html</a> for
details on usage.
</p>
</div>
</div>

<div id="outline-container-org6c64c59" class="outline-3">
<h3 id="47336489-34f5-401b-be21-2d7cb0b47e85"><a id="org6c64c59"></a><a id="ID-3001c5dd-da96-4263-b427-c04368e8cf41"></a>function sequence-next (sequence)</h3>
<div class="outline-text-3" id="text-47336489-34f5-401b-be21-2d7cb0b47e85">
<p>
→ integer
</p>

<p>
Shortcut for getting the next value from a sequence. The sequence identifier can
be either a string or a symbol, in the latter case it will be converted to a
string according to S-SQL rules.
</p>
</div>
</div>

<div id="outline-container-org9a7ee21" class="outline-3">
<h3 id="e316b343-ad9c-4610-b074-0d554e4b63ed"><a id="org9a7ee21"></a><a id="ID-1998fd52-d0e1-439b-9cfa-d3f72c8a3609"></a>function drop-sequence (name &amp;key if-exists cascade)</h3>
<div class="outline-text-3" id="text-e316b343-ad9c-4610-b074-0d554e4b63ed">
<p>
→ list
</p>

<p>
Drop a sequence. Name should be quoted. Available key parameters are :if-exists
and :cascade.
</p>
</div>
</div>

<div id="outline-container-orge333523" class="outline-3">
<h3 id="320f409d-dfc2-4145-b106-0e642b21fa95"><a id="orge333523"></a><a id="ID-8f8b89c8-9d01-460f-b60f-020e8658bbe7"></a>function list-sequences (&amp;optional strings-p)</h3>
<div class="outline-text-3" id="text-320f409d-dfc2-4145-b106-0e642b21fa95">
<p>
→ list
</p>

<p>
Returns a list of the sequences in the current database. When strings-p is T,
the names will be given as strings, otherwise as keywords.
</p>
</div>
</div>

<div id="outline-container-org89c701d" class="outline-3">
<h3 id="da78ff64-0fb8-41a7-b17e-1f24ec8abe63"><a id="org89c701d"></a><a id="ID-e64dd37f-81c2-43f8-88fe-8444771b7631"></a>function sequence-exists-p (name)</h3>
<div class="outline-text-3" id="text-da78ff64-0fb8-41a7-b17e-1f24ec8abe63">
<p>
→ boolean
</p>

<p>
Tests  whether a sequence with the given name exists. The name can be either a
string or a symbol.
</p>
</div>
</div>
</div>

<div id="outline-container-org7b63aea" class="outline-2">
<h2 id="tables"><a id="org7b63aea"></a><a id="ID-5a351917-b940-4c94-a3dc-2795f9a76211"></a>Tables</h2>
<div class="outline-text-2" id="text-tables">
</div>
<div id="outline-container-org39016c6" class="outline-3">
<h3 id="ba11f8df-3297-4720-a267-02896b49575a"><a id="org39016c6"></a><a id="ID-bd228cd6-3651-48ca-a9c5-a27737fbaacc"></a>function list-tables (&amp;optional strings-p)</h3>
<div class="outline-text-3" id="text-ba11f8df-3297-4720-a267-02896b49575a">
<p>
→ list
</p>

<p>
DEPRECATED FOR LIST-ALL-TABLES. Return a list of the tables in the public schema
of a database. By default the table names are returned as keywords. They will be
returned as lowercase strings if strings-p is true.
</p>
</div>
</div>

<div id="outline-container-org571518f" class="outline-3">
<h3 id="ad67dcb1-7123-47dc-9402-e5adcecc7e6a"><a id="org571518f"></a>function list-all-tables (&amp;optional (fully-qualified-names-only nil))</h3>
<div class="outline-text-3" id="text-ad67dcb1-7123-47dc-9402-e5adcecc7e6a">
<p>
:ID:       bd228cd6-3651-48ca-a9c5-a27737fbaacc
</p>
<p>
→ list
</p>

<p>
If fully-qualified-names-only is set to t, returns a flattened list of all
schema.table names other than pg_catalog or the information_schema.
</p>

<p>
Otherwise returns the following info:
</p>

<p>
schema-name, table-name, table-owner, tablespace, hasindexes, hasrules, hastriggers
and rowsecurity(&amp;optional strings-p).
</p>
</div>
</div>

<div id="outline-container-orgf5446d2" class="outline-3">
<h3 id="37cd0ae4-b9b2-4776-a58e-dc396e639161"><a id="orgf5446d2"></a><a id="ID-6e7c1873-ad5b-4cd0-9389-b6389cb7ea05"></a>function list-tables-in-schema (&amp;optional (schema-name "public") (strings-p nil))</h3>
<div class="outline-text-3" id="text-37cd0ae4-b9b2-4776-a58e-dc396e639161">
<p>
→ list
</p>

<p>
Returns a list of tables in a particular schema, defaulting to public. If
schema-name is :all, it will return all the non-system tables in the database
in fully qualified form: e.g. 'public.test_table'. If string-p is t, the names
will be returned as strings with underscores converted to hyphens.
</p>
</div>
</div>

<div id="outline-container-org8103dfa" class="outline-3">
<h3 id="5d66ed97-c2b2-4ac5-aede-d6fb70a983c8"><a id="org8103dfa"></a><a id="ID-d911f929-14c6-4279-96e7-a9dfee4d1f59"></a>function list-table-sizes (&amp;key (schema "public") (order-by-size nil) (size t))</h3>
<div class="outline-text-3" id="text-5d66ed97-c2b2-4ac5-aede-d6fb70a983c8">
<p>
→ list
</p>

<p>
Returns a list of lists (table-name, size in 8k pages) of tables in the current
database. Providing a name to the schema parameter will return just the
information for tables in that schema. It defaults to just the tables in the
public schema. Setting schema to nil will return all tables, indexes etc in
the database in descending order of size. This would include system tables, so
there are a lot more than you would expect. If :size is set to nil, it returns
only a flat list of table names. Setting order-by-size to t will return the
result in order of size instead of by table name.
</p>
</div>
</div>

<div id="outline-container-org4e43442" class="outline-3">
<h3 id="55bb44d8-2732-4257-aabd-d38c5e72ef0f"><a id="org4e43442"></a><a id="ID-ece4d92b-dd60-434e-b864-e42c743deaa6"></a>function table-exists-p (name)</h3>
<div class="outline-text-3" id="text-55bb44d8-2732-4257-aabd-d38c5e72ef0f">
<p>
→ boolean
</p>

<p>
Check whether a table exists in a particular schema. Defaults to the search
path. Takes either a string or a symbol for the table name. The table-name can
be fully qualified in the form of schema.table-name or
database.schema.table-name. If the schema is specified either in a qualified
table-name or in the optional schema-name parameter, we look directly to the
information schema tables. Otherwise we use the search path which can be
controlled by being within a with-schema form.
</p>
</div>
</div>

<div id="outline-container-org5573ac3" class="outline-3">
<h3 id="bb623170-32c2-43b4-807d-66c34efe9c40"><a id="org5573ac3"></a><a id="ID-bff3f942-2652-401f-9db0-10cc5214191d"></a>function table-size (table-name)</h3>
<div class="outline-text-3" id="text-bb623170-32c2-43b4-807d-66c34efe9c40">
<p>
→ list
</p>

<p>
Return the size of a given postgresql table in k or m. Table-name can be either
a string or quoted.
</p>
</div>
</div>

<div id="outline-container-orgd2fed41" class="outline-3">
<h3 id="ee444ea2-f49f-41c9-905c-177d89770254"><a id="orgd2fed41"></a><a id="ID-45344f09-e8f2-4f82-a0f8-297623478ad8"></a>function table-description (name &amp;optional schema-name)</h3>
<div class="outline-text-3" id="text-ee444ea2-f49f-41c9-905c-177d89770254">
<p>
→ list
</p>

<p>
Returns a list of the fields in the named table. Each field is represented
by a list of three elements: the field name, the type, and a boolean indicating
whether the field may be NULL.
</p>

<p>
Table can be either a string or quoted. Table-names can be fully qualified with
the schema or not. If the table-name is not fully qualified and a schema name
is not provided, the table will be assumed to be in the public schema.
</p>
</div>
</div>

<div id="outline-container-org36ea37b" class="outline-3">
<h3 id="795b7f54-85ee-4c77-b962-9176f93ad7ac"><a id="org36ea37b"></a><a id="ID-b35cf2c1-7dd0-4676-8f09-2d5679683942"></a>function table-description-plus (table-name)</h3>
<div class="outline-text-3" id="text-795b7f54-85ee-4c77-b962-9176f93ad7ac">
<p>
→ list
</p>

<p>
Returns more table info than table-description. Specifically returns
ordinal-position, column-name, data-type, character-maximum-length, modifier,
whether it is not-null and the default value.
</p>

<p>
Table can be either a string or quoted. Table-names can be fully qualified with
the schema or not. If the table-name is not fully qualified and a schema name
is not provided, the table will be assumed to be in the public schema.
</p>
</div>
</div>

<div id="outline-container-orga0044d5" class="outline-3">
<h3 id="74baf413-72fb-4f17-abb0-1e7535af33ab"><a id="orga0044d5"></a><a id="ID-c867f758-86e5-4242-a825-a273c86acfd0"></a>function list-columns (table-name)</h3>
<div class="outline-text-3" id="text-74baf413-72fb-4f17-abb0-1e7535af33ab">
<p>
→ list
</p>

<p>
Returns a list of strings of just the column names in a table.
Pulls info from the postmodern table-description function rather than directly.
The table-name can be a string or quoted. Any table-name that is not fully
qualified with the schema will be assumed to be in the public schema.
</p>
</div>
</div>

<div id="outline-container-org4930c27" class="outline-3">
<h3 id="9ada61bd-a670-49f3-8c04-cf025cde431f"><a id="org4930c27"></a><a id="ID-8dc78de4-32aa-4b28-98c7-02a22ffe036f"></a>function list-columns-with-types (table-name)</h3>
<div class="outline-text-3" id="text-9ada61bd-a670-49f3-8c04-cf025cde431f">
<p>
→ list
</p>

<p>
Returns a list of (name type) lists for the fields of a table. Returns a list
of strings of just the column names and their sql data types in a table. Pulls
info from the postmodern table-description function rather than directly. The
table-name can be a string or quoted. Any table-name that is not fully qualified
with the schema will be assumed to be in the public schema.
</p>
</div>
</div>

<div id="outline-container-orgc023b26" class="outline-3">
<h3 id="11e937a0-91f6-4475-b393-8f4f2e5d9659"><a id="orgc023b26"></a><a id="ID-491edd0a-7da3-4289-bcea-9482cdfb6df9"></a>function column-exists-p (table-name column-name &amp;optional schema-name)</h3>
<div class="outline-text-3" id="text-11e937a0-91f6-4475-b393-8f4f2e5d9659">
<p>
→ boolean
</p>

<p>
Determine if a particular column exists. Table name and column-name can be
either strings or symbols. If the optional schema name is not given or the
table-name is not fully qualified with a schema name, the schema will be assumed
to be the public schema.
</p>
</div>
</div>

<div id="outline-container-org2ae32b3" class="outline-3">
<h3 id="8ab55683-e44b-44df-bb11-67909d402383"><a id="org2ae32b3"></a>function get-table-oid (table-name &amp;optional schema-name)</h3>
<div class="outline-text-3" id="text-8ab55683-e44b-44df-bb11-67909d402383">
<p>
→ integer
</p>

<p>
Retrieves the oid identifier for a particular table from postgresql. Works
for tables in all schemas.
</p>
</div>
</div>
<div id="outline-container-orgde7365d" class="outline-3">
<h3 id="e8d6e402-5c76-4533-9b5c-a823b9582c26"><a id="orgde7365d"></a>function get-table-comment (table-name &amp;optional schema-name)</h3>
<div class="outline-text-3" id="text-e8d6e402-5c76-4533-9b5c-a823b9582c26">
<p>
→ string
</p>

<p>
Retrieves the comment, if any attached to the table.
</p>
</div>
</div>
<div id="outline-container-org8f67d37" class="outline-3">
<h3 id="org8f67d37">function rename-table (old-name new-name)</h3>
<div class="outline-text-3" id="text-org8f67d37">
<p>
→ boolean
</p>

<p>
Renames a table. Parameters can be strings or symbols. If you are renaming
a table using a fully qualified schema.table-name, you do not need to
specify the schema in the new-name. You cannot use this function to move
tables from one schema to another. Returns t if successful
</p>
</div>
</div>

<div id="outline-container-org0ca0bf5" class="outline-3">
<h3 id="org0ca0bf5">function rename-column (table-name old-name new-name)</h3>
<div class="outline-text-3" id="text-org0ca0bf5">
<p>
→ boolean
</p>

<p>
Rename a column in a table. Parameters can be strings or symbols. If the table
is not in the public schema, it needs to be fully qualified - e.g. schema.table.
Returns t if successful
</p>
</div>
</div>
</div>
<div id="outline-container-org4dfcafd" class="outline-2">
<h2 id="tablespaces"><a id="org4dfcafd"></a><a id="ID-1772a1eb-bc79-4c5f-90d5-2fc10ae49569"></a>Tablespaces</h2>
<div class="outline-text-2" id="text-tablespaces">
</div>
<div id="outline-container-org46f6a42" class="outline-3">
<h3 id="70537823-781b-47dd-8c38-9936756c666c"><a id="org46f6a42"></a><a id="ID-44a29c6a-0002-4660-920f-a9fee4c29471"></a>function list-tablespaces ()</h3>
<div class="outline-text-3" id="text-70537823-781b-47dd-8c38-9936756c666c">
<p>
→ list
</p>

<p>
Lists the tablespaces in the currently connected database. What are tablespace
you ask? Per the Postgresql documentation
<a href="https://www.postgresql.org/docs/current/manage-ag-tablespaces.html">https://www.postgresql.org/docs/current/manage-ag-tablespaces.html</a>:
Tablespaces in PostgreSQL allow database administrators to define locations in
the file system where the files representing database objects can be stored.
Once created, a tablespace can be referred to by name when creating database
objects.
</p>

<p>
By using tablespaces, an administrator can control the disk layout of a
PostgreSQL installation. This is useful in at least two ways. First, if the
partition or volume on which the cluster was initialized runs out of space and
cannot be extended, a tablespace can be created on a different partition and
used until the system can be reconfigured.
</p>

<p>
Second, tablespaces allow an administrator to use knowledge of the usage pattern
of database objects to optimize performance. For example, an index which is very
heavily used can be placed on a very fast, highly available disk, such as an
expensive solid state device. At the same time a table storing archived data
which is rarely used or not performance critical could be stored on a less
expensive, slower disk system.
</p>
</div>
</div>
</div>

<div id="outline-container-orgf1e5af7" class="outline-2">
<h2 id="triggers"><a id="orgf1e5af7"></a><a id="ID-39786cca-6778-4f0b-9187-1f3216b97cda"></a>Triggers</h2>
<div class="outline-text-2" id="text-triggers">
</div>
<div id="outline-container-org7eebec8" class="outline-3">
<h3 id="7327ab9a-b79e-4180-8165-434fd4c8d383"><a id="org7eebec8"></a><a id="ID-10c51511-c1e4-4710-8407-3508fb96333e"></a>function describe-triggers ()</h3>
<div class="outline-text-3" id="text-7327ab9a-b79e-4180-8165-434fd4c8d383">
<p>
→ list
</p>

<p>
List detailed information on the triggers from the information_schema table.
</p>
</div>
</div>
<div id="outline-container-org26faf59" class="outline-3">
<h3 id="3bcdabed-dd01-4457-bc18-284598aee0a4"><a id="org26faf59"></a><a id="ID-68de46b8-a646-4c1d-9362-747ab1d6cc04"></a>function list-triggers (&amp;optional table-name)</h3>
<div class="outline-text-3" id="text-3bcdabed-dd01-4457-bc18-284598aee0a4">
<p>
→ list
</p>

<p>
List distinct trigger names from the information_schema table. Table-name can be
either quoted or string. (A trigger is a specification that the database should
automatically execute a particular function whenever a certain type of operation
is performed. Triggers can be attached to tables (partitioned or not), views,
and foreign tables.
See <a href="https://www.postgresql.org/docs/current/trigger-definition.html">https://www.postgresql.org/docs/current/trigger-definition.html</a>)
</p>
</div>
</div>

<div id="outline-container-orgd8d195a" class="outline-3">
<h3 id="fc3761c2-fc2e-42e4-86f2-0e918c891b5e"><a id="orgd8d195a"></a><a id="ID-10c51511-c1e4-4710-8407-3508fb96333e"></a>function list-detailed-triggers ()</h3>
<div class="outline-text-3" id="text-fc3761c2-fc2e-42e4-86f2-0e918c891b5e">
<p>
→ list
</p>
</div>
</div>
</div>

<div id="outline-container-orgf3a1c78" class="outline-2">
<h2 id="views"><a id="orgf3a1c78"></a><a id="ID-a9641e8e-3769-4af4-bdd0-3153e0dd7728"></a>Views</h2>
<div class="outline-text-2" id="text-views">
</div>
<div id="outline-container-org7bebe64" class="outline-3">
<h3 id="4fd820d9-857e-48fa-a62b-e2d72313a10c"><a id="org7bebe64"></a><a id="ID-9e9e757e-9efa-4445-9fe1-b66e78f025a8"></a>function list-views (&amp;optional strings-p)</h3>
<div class="outline-text-3" id="text-4fd820d9-857e-48fa-a62b-e2d72313a10c">
<p>
→ list
</p>

<p>
Returns list of the user defined views in the current database. When strings-p
is T, the names will be returned as strings, otherwise as keywords.
</p>
</div>
</div>

<div id="outline-container-org2a8c48a" class="outline-3">
<h3 id="f9ba3cce-95e0-45a0-9ede-5654bb71e98e"><a id="org2a8c48a"></a><a id="ID-24cd0fc5-8fb0-4b57-9504-71d9520abf6f"></a>function view-exists-p (name)</h3>
<div class="outline-text-3" id="text-f9ba3cce-95e0-45a0-9ede-5654bb71e98e">
<p>
→ boolean
</p>

<p>
Tests whether a view with the given name exists. Takes either a string or a
symbol for the view name.
</p>
</div>
</div>

<div id="outline-container-org5154c50" class="outline-3">
<h3 id="bbf87da5-981c-42ad-b97e-38c7fafbf8ca"><a id="org5154c50"></a><a id="ID-51f383ba-fe58-4a5f-bf31-ac79b18170b7"></a>function describe-views (&amp;optional (schema "public")</h3>
<div class="outline-text-3" id="text-bbf87da5-981c-42ad-b97e-38c7fafbf8ca">
<p>
→ list
</p>

<p>
Describe the current views in the specified schema. Includes the select
statements used to create the view. Takes an optional schema but defaults to
public schema.
</p>
</div>
</div>
</div>

<div id="outline-container-org19d116e" class="outline-2">
<h2 id="misc-utility-functions"><a id="org19d116e"></a><a id="ID-73c18602-c501-4399-ac07-cab915309777"></a>Miscellaneous Utility Functions</h2>
<div class="outline-text-2" id="text-misc-utility-functions">
</div>
<div id="outline-container-org1c5813f" class="outline-3">
<h3 id="9e576b29-c33d-425d-8759-e8e5e8367593"><a id="org1c5813f"></a><a id="ID-1df6bd25-618b-4a00-8ec2-cc5b0548b045"></a>function coalesce (&amp;rest arguments)</h3>
<div class="outline-text-3" id="text-9e576b29-c33d-425d-8759-e8e5e8367593">
<p>
→ value
</p>

<p>
Returns the first non-NIL, non-NULL (as in :null) argument, or NIL if none are
present. Useful for providing a fall-back value for the result of a query, or,
when given only one argument, for transforming :nulls to NIL.
</p>
</div>
</div>

<div id="outline-container-orgeb6258f" class="outline-3">
<h3 id="441f2929-9c04-4b01-8b85-7c474e200755"><a id="orgeb6258f"></a><a id="ID-37df40a0-86b4-4aef-828e-68663f74927e"></a>function execute-file (filename &amp;optional (print nil))</h3>
<div class="outline-text-3" id="text-441f2929-9c04-4b01-8b85-7c474e200755">
<p>
This function will execute sql queries stored in a file. Each sql statement in
the file will be run independently, but if one statement fails, subsequent
query statements will not be run, but any statement prior to the failing
statement will have been commited.
</p>

<p>
If you want the standard transction treatment such that all statements succeed
or no statement succeeds, then ensure that the file starts with a "begin
transaction" statement and finishes with an "end transaction" statement. See
the test file test-execute-file-broken-transaction.sql as an example.
</p>

<p>
For debugging purposes, if the optional print parameter is set to t, format will
print the count of the query and the query to the REPL.
</p>

<p>
IMPORTANT NOTE: This utility function assumes that the file containing the sql
queries can be trusted and bypasses the normal postmodern parameterization of
queries.
</p>
</div>
</div>
<div id="outline-container-org6d114da" class="outline-3">
<h3 id="fcf022af-ae93-470d-be11-23a25acf0bb9"><a id="org6d114da"></a>function num-records-in-database ()</h3>
<div class="outline-text-3" id="text-fcf022af-ae93-470d-be11-23a25acf0bb9">
<p>
→ list
</p>

<p>
Returns a list of lists with schema, table name and approximate number of
records in the currently connected database.
</p>
</div>
</div>
<div id="outline-container-org00b8c99" class="outline-3">
<h3 id="1870a515-3f02-45c6-b42c-97659580f257"><a id="org00b8c99"></a>function postgres-array-string-to-list (str)</h3>
<div class="outline-text-3" id="text-1870a515-3f02-45c6-b42c-97659580f257">
<p>
→ array
</p>

<p>
Takes a postgresql array in the form of a string like
"{wol=CTc/wol,a=c/wol,b=c/wol}" and returns a lisp array like
    #("wol=CTc/wol" "a=c/wol" "b=c/wol")
</p>
</div>
</div>
<div id="outline-container-org27e7a1c" class="outline-3">
<h3 id="6fa88adf-cd17-40a8-beb2-0ecea529f6db"><a id="org27e7a1c"></a>function postgres-array-string-to-array (str)</h3>
<div class="outline-text-3" id="text-6fa88adf-cd17-40a8-beb2-0ecea529f6db">
<p>
  "Takes a postgresql array in the form of a string like
\"{wol=CTc/wol,a=c/wol,b=c/wol}\" and returns a lisp list like
  (\"wol=CTc/wol\" \"a=c/wol\" \"b=c/wol\")."
</p>
</div>
</div>
</div>
<div id="outline-container-org7ab96b2" class="outline-2">
<h2 id="b9ec79c0-8e2e-4bad-adcd-e8aa9b6c9a27"><a id="org7ab96b2"></a><a id="ID-cd3d88e6-1e81-4675-bd17-409efdc39730"></a>Imported From s-sql</h2>
<div class="outline-text-2" id="text-b9ec79c0-8e2e-4bad-adcd-e8aa9b6c9a27">
</div>
<div id="outline-container-orga3947f3" class="outline-3">
<h3 id="8c74e736-6b4f-4996-88c4-f087f46cff05"><a id="orga3947f3"></a><a id="ID-9de76637-62f7-4c7c-a5d1-1f37491b3db3"></a>macro sql (form)</h3>
<div class="outline-text-3" id="text-8c74e736-6b4f-4996-88c4-f087f46cff05">
<p>
→ string
</p>

<p>
Convert the given form (a list starting with a keyword) to an SQL query string
at compile time, according to the rules described here. For example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(sql (<span style="color: #98fb98; font-weight: bold;">:select</span> '* <span style="color: #98fb98; font-weight: bold;">:from</span> 'country <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'a 1)))
 <span style="color: #cd8162;">"(SELECT * FROM country WHERE (a = 1))"</span>
</pre>
</div>

<p>
but
</p>
<div class="org-src-container">
<pre class="src src-lisp">(sql '(<span style="color: #98fb98; font-weight: bold;">:select</span> '* <span style="color: #98fb98; font-weight: bold;">:from</span> 'country <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'a 1)))
</pre>
</div>

<p>
would throw an error. For the later case you need to use sql-compile.
</p>
</div>
</div>

<div id="outline-container-org5ec34ca" class="outline-3">
<h3 id="ace3cbb6-04f0-435b-b2d9-55e2612ea01b"><a id="org5ec34ca"></a><a id="ID-8d161d2a-06cb-4334-9ee6-86e805eb5295"></a>function sql-compile (form)</h3>
<div class="outline-text-3" id="text-ace3cbb6-04f0-435b-b2d9-55e2612ea01b">
<p>
→ string
</p>

<p>
This is the run-time variant of the sql macro. It converts the given list to
an SQL query, with the same rules except that symbols in this list do not
have to be quoted to be interpreted as identifiers. For example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(sql-compile '(<span style="color: #98fb98; font-weight: bold;">:select</span> '* <span style="color: #98fb98; font-weight: bold;">:from</span> 'country <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'a 1)))

 \"(SELECT * FROM country WHERE (a = 1))\"
</pre>
</div>

<p>
but
</p>
<div class="org-src-container">
<pre class="src src-lisp">(sql (<span style="color: #98fb98; font-weight: bold;">:select</span> '* <span style="color: #98fb98; font-weight: bold;">:from</span> 'country <span style="color: #98fb98; font-weight: bold;">:where</span> (<span style="color: #98fb98; font-weight: bold;">:=</span> 'a 1)))
</pre>
</div>
<p>
would throw an error. For the later case you need to use sql.
</p>
</div>
</div>

<div id="outline-container-org228c246" class="outline-3">
<h3 id="55a205bf-c9f4-450c-aa86-45cce006ee79"><a id="org228c246"></a><a id="ID-3b558b7d-532c-4375-a80a-4526112ae132"></a>deftype smallint ()</h3>
<div class="outline-text-3" id="text-55a205bf-c9f4-450c-aa86-45cce006ee79">
<p>
'(signed-byte 16)
</p>
</div>
</div>
<div id="outline-container-org55018a2" class="outline-3">
<h3 id="80a15f41-d550-4f3b-adc5-4558d3ddf166"><a id="org55018a2"></a><a id="ID-d5d5048e-f212-4b5a-ae63-c18d2a411279"></a>deftype bigint ()</h3>
<div class="outline-text-3" id="text-80a15f41-d550-4f3b-adc5-4558d3ddf166">
<p>
'(signed-byte 64)
</p>
</div>
</div>
<div id="outline-container-orgf68eb86" class="outline-3">
<h3 id="4a38ba2c-b03b-4887-905b-1bf85cd3f607"><a id="orgf68eb86"></a><a id="ID-4eb58260-f8e3-4562-bfff-17211cdd98da"></a>deftype numeric (&amp;optional precision/scale scale)</h3>
<div class="outline-text-3" id="text-4a38ba2c-b03b-4887-905b-1bf85cd3f607">
<p>
(declare (ignore precision/scale scale))
'number
</p>
</div>
</div>
<div id="outline-container-org05d42df" class="outline-3">
<h3 id="8e094b66-fcc0-4f6e-91dd-5f3c63a7e8a0"><a id="org05d42df"></a><a id="ID-b4ec051b-d257-47c6-9876-25aec64f967a"></a>deftype double-precision ()</h3>
<div class="outline-text-3" id="text-8e094b66-fcc0-4f6e-91dd-5f3c63a7e8a0">
<p>
'double-float
</p>
</div>
</div>
<div id="outline-container-orgc2a0ad0" class="outline-3">
<h3 id="f4e4e8ac-2d8c-4dea-991f-af57fa589932"><a id="orgc2a0ad0"></a><a id="ID-2532e5a0-cbb5-490a-b142-e971ad0730f7"></a>deftype bytea ()</h3>
<div class="outline-text-3" id="text-f4e4e8ac-2d8c-4dea-991f-af57fa589932">
<p>
'(array (unsigned-byte 8))
</p>
</div>
</div>
<div id="outline-container-orga45d87e" class="outline-3">
<h3 id="a18ec054-2fcb-482f-bda5-988ab94e9763"><a id="orga45d87e"></a><a id="ID-d2867c78-0b66-4b45-882e-115a1192de11"></a>deftype text ()</h3>
<div class="outline-text-3" id="text-a18ec054-2fcb-482f-bda5-988ab94e9763">
<p>
'string
</p>
</div>
</div>
<div id="outline-container-org8974aa3" class="outline-3">
<h3 id="d4aa0266-7d2d-4207-909f-8b5767be03fd"><a id="org8974aa3"></a><a id="ID-eecec060-840e-42c3-9b6e-74789b19f3ac"></a>deftype varchar (length)</h3>
<div class="outline-text-3" id="text-d4aa0266-7d2d-4207-909f-8b5767be03fd">
<p>
(declare (ignore length))
`string)
</p>
</div>
</div>
<div id="outline-container-orgaf2aa3b" class="outline-3">
<h3 id="20cabfe5-d425-422d-a91a-06e7c4cf0a30"><a id="orgaf2aa3b"></a><a id="ID-cc755c1e-af5f-4958-9e18-7b47831cd786"></a>deftype serial ()</h3>
<div class="outline-text-3" id="text-20cabfe5-d425-422d-a91a-06e7c4cf0a30">
<p>
'integer
</p>
</div>
</div>
<div id="outline-container-orgb4d6128" class="outline-3">
<h3 id="15d4e630-03c8-4fe0-9b1e-b42a2b42910b"><a id="orgb4d6128"></a><a id="ID-db403045-9608-45f9-8f17-aa3dd951d614"></a>deftype serial8 ()</h3>
<div class="outline-text-3" id="text-15d4e630-03c8-4fe0-9b1e-b42a2b42910b">
<p>
'integer
</p>
</div>
</div>

<div id="outline-container-orgd73ae3d" class="outline-3">
<h3 id="f862411e-45cb-4f24-9caa-15edbe804999"><a id="orgd73ae3d"></a><a id="ID-fb204ed8-0ac7-4c74-ad47-ff9e95b75561"></a>deftype db-null ()</h3>
<div class="outline-text-3" id="text-f862411e-45cb-4f24-9caa-15edbe804999">
<p>
Type for representing NULL values. Use like (or integer db-null) for declaring a
type to be an integer that may be null."
  '(eql :null)
</p>
</div>
</div>

<div id="outline-container-orgf63de22" class="outline-3">
<h3 id="24878142-d801-4fb0-b58b-b59454ee414d"><a id="orgf63de22"></a><a id="ID-408c0a66-6772-4999-8759-bebeee43646c"></a>function from-sql-name (str)</h3>
<div class="outline-text-3" id="text-24878142-d801-4fb0-b58b-b59454ee414d">
<p>
Convert a string to a symbol, upcasing and replacing underscores with hyphens.
</p>
</div>
</div>
<div id="outline-container-orgb58c073" class="outline-3">
<h3 id="0205cc17-d05d-4ac1-96eb-1c2431e948c8"><a id="orgb58c073"></a><a id="ID-d9c23921-9839-422d-aeea-df8bfc11df47"></a>function parse-queries (file-content)</h3>
<div class="outline-text-3" id="text-0205cc17-d05d-4ac1-96eb-1c2431e948c8">
<p>
→ list
</p>

<p>
Read SQL queries in given string and split them, returns a list.
</p>
</div>
</div>
<div id="outline-container-orgfd3e38b" class="outline-3">
<h3 id="de3bb099-ed34-423a-9bcd-535e1a5f588b"><a id="orgfd3e38b"></a><a id="ID-b871c68d-2b31-444d-8c2d-9d7093fef956"></a>function read-queries (filename)</h3>
<div class="outline-text-3" id="text-de3bb099-ed34-423a-9bcd-535e1a5f588b">
<p>
Read SQL queries in a given file and split them, returns a list.
</p>
</div>
</div>
<div id="outline-container-orgfe43df8" class="outline-3">
<h3 id="a6245312-f133-481b-8aed-2bd7c4d4b972"><a id="orgfe43df8"></a><a id="ID-02edac61-f915-4d5f-b52e-d4b7ace29352"></a>function sql-escape-string (string)</h3>
<div class="outline-text-3" id="text-a6245312-f133-481b-8aed-2bd7c4d4b972">
<p>
→ string
</p>

<p>
<a href="http://www.postgresql.org/docs/current/static/sql-syntax-lexical.html#SQL-SYNTAX-STRINGS">Escapes</a> a string for inclusion in a PostgreSQL query. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(sql-escape-string \"Puss in 'Boots'\")

\"E'Puss in ''Boots'''\"

</pre>
</div>
</div>
</div>


<div id="outline-container-org04b3d18" class="outline-3">
<h3 id="73012d8f-1e5d-4518-8df8-368a4fae3441"><a id="org04b3d18"></a><a id="ID-8b533d2c-53ec-4f34-b19a-fd68bbef9384"></a>method sql-escape (arg)</h3>
<div class="outline-text-3" id="text-73012d8f-1e5d-4518-8df8-368a4fae3441">
<p>
A generalisation of sql-escape-string looks at the type of the value passed, and
properly writes it out it for inclusion in an SQL query. Symbols will be
converted to SQL names. Examples:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(sql-escape <span style="color: #cd8162;">"tr'-x"</span>)

<span style="color: #cd8162;">"E'tr''-x'"</span>

(sql-escape (/ 1 13))

<span style="color: #cd8162;">"0.0769230769230769230769230769230769230"</span>

(sql-escape #(<span style="color: #cd8162;">"Baden-Wurttemberg"</span> <span style="color: #cd8162;">"Bavaria"</span> <span style="color: #cd8162;">"Berlin"</span> <span style="color: #cd8162;">"Brandenburg"</span>))

<span style="color: #cd8162;">"ARRAY[E'Baden-Wurttemberg', E'Bavaria', E'Berlin', E'Brandenburg']"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb65733b" class="outline-3">
<h3 id="1723409d-0013-459a-a89c-236d1c7f2fb5"><a id="orgb65733b"></a>macro register-sql-operators (arity &amp;rest names)</h3>
<div class="outline-text-3" id="text-1723409d-0013-459a-a89c-236d1c7f2fb5">
<p>
Define simple operators. Arity is one of :unary (like
'not'), :unary-postfix (the operator comes after the operand),
:n-ary (like \+ : the operator falls away when there is only one
operand), :2+-ary (like '=', which is meaningless for one operand),
or :n-or-unary (like '-', where the operator is kept in the unary
case). After the arity follow any number of operators, either just a
keyword, in which case the downcased symbol name is used as the
operator, or a two-element list containing a keyword and a name
string.
</p>
</div>
</div>
<div id="outline-container-orge8efca5" class="outline-3">
<h3 id="678a9397-e784-42bf-ba21-7d1d8a5816e2"><a id="orge8efca5"></a><a id="ID-fc3763af-74e4-44ed-903e-7c32be128bd3"></a>variable <b>escape-sql-names-p</b></h3>
<div class="outline-text-3" id="text-678a9397-e784-42bf-ba21-7d1d8a5816e2">
<p>
Determines whether double quotes are added around column, table, and ** function
names in queries. Valid values:
</p>

<ul class="org-ul">
<li>T, in which case every name is escaped,</li>
<li>NIL, in which case no name is escape,</li>
<li>:auto, which causes only <a href="http://www.postgresql.org/docs/current/static/sql-keywords-appendix.html">reserved words</a> to be escaped, or.</li>
<li>:literal which is the same as :auto except it has added consequence in</li>
</ul>
<p>
to-sql-name (see below).
</p>

<p>
The default value is :auto.
</p>

<p>
Be careful when binding this with let and such ― since a lot of SQL compilation
tends to happen at compile-time, the result might not be what you expect. Mixed
case sensitivity is not currently well supported. Postgresql itself will
downcase unquoted identifiers. This will be revisited in the future if requested.
</p>
</div>
</div>

<div id="outline-container-org8fff1b1" class="outline-3">
<h3 id="3cbda7a6-974c-475d-a87c-90353ac15b75"><a id="org8fff1b1"></a><a id="ID-1b4f5a57-87f7-42f5-ae3c-eff5b41122b3"></a>function to-sql-name (name &amp;optional (escape-p <b>escape-sql-names-p</b>) (ignore-reserved-words nil))</h3>
<div class="outline-text-3" id="text-3cbda7a6-974c-475d-a87c-90353ac15b75">
<p>
Convert a symbol or string into a name that can be a sql table, column, or
operation name. Add quotes when escape-p is true, or escape-p is :auto and the
name contains reserved words. Quoted or delimited identifiers can be used by
passing :literal as the value of escape-p. If escape-p is :literal, and the
name is a string then the string is still escaped but the symbol or string is
not downcased, regardless of the setting for <b>downcase-symbols</b> and the hyphen
and forward slash characters are not replaced with underscores.
</p>

<p>
Ignore-reserved-words is only used internally for column names which are allowed
to be reserved words, but it is not recommended.
</p>
</div>
</div>

<div id="outline-container-org9431d97" class="outline-3">
<h3 id="2970d836-dcaa-4b49-aa95-27aa9d3d4f3f"><a id="org9431d97"></a><a id="ID-800c314e-4ff7-435e-84ea-fe6d3ec71353"></a>condition sql-error</h3>
<div class="outline-text-3" id="text-2970d836-dcaa-4b49-aa95-27aa9d3d4f3f">
<p>
No documentation provided.
</p>
</div>
</div>
</div>


<div id="outline-container-org2d802f1" class="outline-2">
<h2 id="5ccb5ff2-0d42-48d4-90c0-2ef6e7f8f1c7"><a id="org2d802f1"></a><a id="ID-800ef5ef-fa19-428d-83b9-f38581e38d09"></a>Conditions Imported From cl-postgres</h2>
<div class="outline-text-2" id="text-5ccb5ff2-0d42-48d4-90c0-2ef6e7f8f1c7">
</div>
<div id="outline-container-orge6c4ef0" class="outline-3">
<h3 id="b16b281c-2103-4f65-bb48-d9ac0083a302"><a id="orge6c4ef0"></a><a id="ID-5d0fdf49-8efa-4e7e-8b9d-925cb19630e1"></a>condition database-connection-error</h3>
<div class="outline-text-3" id="text-b16b281c-2103-4f65-bb48-d9ac0083a302">
<p>
Conditions of this type are signalled when an error occurs that breaks the
connection socket. They offer a :reconnect restart.
</p>
</div>
</div>

<div id="outline-container-org12c0d92" class="outline-3">
<h3 id="06f35002-f176-4bae-b9cc-271b8b3b2cf1"><a id="org12c0d92"></a><a id="ID-0ce0752e-d58b-4072-9de1-8c791ab627d0"></a>condition database-error</h3>
<div class="outline-text-3" id="text-06f35002-f176-4bae-b9cc-271b8b3b2cf1">
<p>
This is the condition type that will be used to signal virtually all
database-related errors (though in some cases socket errors may be raised when
a connection fails on the IP level).
</p>
</div>
<div id="outline-container-orgc04aa05" class="outline-4">
<h4 id="15654c72-6edc-4fec-8526-d15dbfda6e44"><a id="orgc04aa05"></a>reader database-error-code</h4>
<div class="outline-text-4" id="text-15654c72-6edc-4fec-8526-d15dbfda6e44">
<p>
Code: the Postgresql SQLSTATE code for the error
 (see the Postgresql Manual Appendix A for their meaning). Not localizable.
 Always present.
</p>
</div>
</div>

<div id="outline-container-org2232643" class="outline-4">
<h4 id="94776637-29c8-4966-9105-c00e13c1ec1d"><a id="org2232643"></a>accessor database-error-message</h4>
<div class="outline-text-4" id="text-94776637-29c8-4966-9105-c00e13c1ec1d">
<p>
Message: the primary human-readable error message. This should be accurate
but terse (typically one line). Always present.
</p>
</div>
</div>

<div id="outline-container-org885c4f1" class="outline-4">
<h4 id="b01df60b-76be-43a3-9d80-13722658bb55"><a id="org885c4f1"></a>reader database-error-detail</h4>
<div class="outline-text-4" id="text-b01df60b-76be-43a3-9d80-13722658bb55">
<p>
Detail: an optional secondary error message carrying
more detail about the problem. Might run to multiple lines or NIL if none is
available.
</p>
</div>
</div>

<div id="outline-container-org5ecd739" class="outline-4">
<h4 id="91ab0c67-4276-4eb1-8de9-4028f7f778f7"><a id="org5ecd739"></a>reader database-error-query</h4>
<div class="outline-text-4" id="text-91ab0c67-4276-4eb1-8de9-4028f7f778f7">
<p>
Query that led to the error, or NIL if no query was involved.
</p>
</div>
</div>

<div id="outline-container-org2c7f425" class="outline-4">
<h4 id="3262d3c4-53a7-4f81-9d09-ccee5bf59b66"><a id="org2c7f425"></a>reader database-error-cause</h4>
<div class="outline-text-4" id="text-3262d3c4-53a7-4f81-9d09-ccee5bf59b66">
<p>
The condition that caused this error, or NIL when it was not caused by another condition.
</p>
</div>
</div>
</div>

<div id="outline-container-orgb611528" class="outline-3">
<h3 id="77cc7700-9573-4280-ba3a-cb368fa96dcc"><a id="orgb611528"></a><a id="ID-300b1531-c01f-4674-b08c-4624d5502a5c"></a>function database-error-constraint-name (err)</h3>
<div class="outline-text-3" id="text-77cc7700-9573-4280-ba3a-cb368fa96dcc">
<p>
Given a database-error for an integrity violation, will attempt to
extract the constraint name.
</p>
</div>
</div>

<div id="outline-container-orgeb84b3d" class="outline-3">
<h3 id="52fe59d2-396d-4c36-9a94-5ef452702d79"><a id="orgeb84b3d"></a><a id="ID-91e02238-2910-47d1-9fdd-c466147fe69c"></a>function database-error-extract-name (err)</h3>
<div class="outline-text-3" id="text-52fe59d2-396d-4c36-9a94-5ef452702d79">
<p>
Given a database-error, will extract the critical name from the error message.
</p>
</div>
</div>
</div>
</div>
</body>
</html>
