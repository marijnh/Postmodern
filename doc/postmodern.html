<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2018-12-06 Thu 22:10 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Postmodern Reference Manual</title>
<meta name="generator" content="Org mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="style.css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Postmodern Reference Manual</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgd68da46">Connecting</a>
<ul>
<li><a href="#org70ba6f7">class database-connection</a></li>
<li><a href="#org4ff7373">function connect (database user password host &amp;key (port 5432) pooled-p use-ssl)</a></li>
<li><a href="#orgc2c1280">variable <b>default-use-ssl</b></a></li>
<li><a href="#orgabd7d03">method disconnect (database-connection)</a></li>
<li><a href="#orgfa42206">function connected-p (database-connection)</a></li>
<li><a href="#orgcefdd49">method reconnect (database-connection)</a></li>
<li><a href="#orgb2175fd">variable <b>database</b></a></li>
<li><a href="#org4cf3ae2">macro with-connection (spec &amp;body body)</a></li>
<li><a href="#org990d326">macro call-with-connection (spec thunk)</a></li>
<li><a href="#org8b6bb24">function connect-toplevel (database user password host &amp;key (port 5432))</a></li>
<li><a href="#org7d857e1">function disconnect-toplevel ()</a></li>
<li><a href="#orgea8a5cf">function clear-connection-pool ()</a></li>
<li><a href="#orgac9fe19">variable <b>max-pool-size</b></a></li>
<li><a href="#org1268371">function list-connections ()</a></li>
</ul>
</li>
<li><a href="#orga46f926">Querying</a>
<ul>
<li><a href="#orgce13f70">macro query (query &amp;rest args/format)</a></li>
<li><a href="#orge125277">macro execute (query &amp;rest args)</a></li>
<li><a href="#orgd8f0978">macro doquery (query (&amp;rest names) &amp;body body)</a></li>
<li><a href="#org0d98143">macro prepare (query &amp;optional (format :rows))</a></li>
<li><a href="#org51c9b8a">macro defprepared (name query &amp;optional (format :rows))</a></li>
<li><a href="#org2edf231">macro defprepared-with-names (name (&amp;rest args) (query &amp;rest query-args) &amp;optional (format :rows))</a></li>
<li><a href="#org2ca7cfd">macro with-transaction ((&amp;optional name isolation-level) &amp;body body)</a></li>
<li><a href="#org2a334a1">function commit-transaction (transaction)</a></li>
<li><a href="#org217c8ab">function abort-transaction (transaction)</a></li>
<li><a href="#org142206c">macro with-savepoint (name &amp;body body)</a></li>
<li><a href="#orge056ea9">function release-savepoint (savepoint)</a></li>
<li><a href="#orgcf724bb">function rollback-savepoint (savepoint)</a></li>
<li><a href="#org44e9da3">function commit-hooks (transaction-or-savepoint), setf (commit-hooks transaction-or-savepoint)</a></li>
<li><a href="#orge586c35">function abort-hooks (transaction-or-savepoint), setf (abort-hooks transaction-or-savepoint)</a></li>
<li><a href="#org5d15144">macro with-logical-transaction ((&amp;optional name isolation-level) &amp;body body)</a></li>
<li><a href="#org574169f">function abort-logical-transaction (transaction-or-savepoint)</a></li>
<li><a href="#org35e7b50">function commit-logical-transaction (transaction-or-savepoint)</a></li>
<li><a href="#org0e63adc">variable <b>current-logical-transaction</b></a></li>
<li><a href="#org72c4caf">macro ensure-transaction (&amp;body body)</a></li>
<li><a href="#org1b36261">macro with-schema ((namespace &amp;key :strict t :if-not-exist :create :drop-after) &amp;body body)</a></li>
<li><a href="#orgb0b155d">function sequence-next (sequence)</a></li>
<li><a href="#orgc861067">function coalesce (&amp;rest arguments)</a></li>
</ul>
</li>
<li><a href="#org2580dda">Helper functions for Prepared Statements</a>
  <ul>
<li><a href="#org730cd12a4">parameter *allow-overwriting-prepared-statements*</a></li>
<li><a href="#org730cd12">function prepared-statement-exists-p (name)</a></li>
<li><a href="#org7df9842">function list-prepared-statements(&amp;optional (names-only nil))</a></li>
<li><a href="#orgfbdd58c">function drop-prepared-statement (statement-name &amp;key (location :both) (database <b>database</b>))</a></li>
<li><a href="#org2156a7a">function list-postmodern-prepared-statements (&amp;optional (names-only nil))</a></li>
<li><a href="#org57d40d9">function find-postgresql-prepared-statement (name)</a></li>
<li><a href="#org8d04ae3">function find-postmodern-prepared-statement (name)</a></li>
<li><a href="#orgcf1544b">function reset-prepared-statement (condition)</a></li>
<li><a href="#org4532d28">function get-pid ()</a></li>
<li><a href="#orgd6d26b9">function get-pid-from-postmodern ()</a></li>
<li><a href="#orgb01e3f4">function cancel-backend (pid)</a></li>
<li><a href="#orgcf97180">function terminate-backend (pid)</a></li>
</ul>
</li>
<li><a href="#org50f54e2">Inspecting the database</a>
<ul>
<li><a href="#org9c91a7f">function list-tables (&amp;optional strings-p)</a></li>
<li><a href="#org394c43a">function list-tables-in-schema (&amp;optional strings-p)</a></li>
<li><a href="#org75f07b5">function table-exists-p (name)</a></li>
<li><a href="#org6660019">function table-description (name &amp;optional schema-name)</a></li>
<li><a href="#orgcba924e">function list-sequences (&amp;optional strings-p)</a></li>
<li><a href="#org7b9b575">function sequence-exists-p (name)</a></li>
<li><a href="#org8fc42b4">function list-views (&amp;optional strings-p)</a></li>
<li><a href="#org57e604e">function view-exists-p (name)</a></li>
<li><a href="#org31b807b">function list-schemata ()</a></li>
<li><a href="#orgc8e8592">function schema-exist-p (schema) NOW DEPRECATED IN FAVOR OF schema-exists-p which is more consistent with naming of other functions.</a></li>
<li><a href="#org185524a">function schema-exists-p (schema)</a></li>
<li><a href="#orgdfb707f">function database-version ()</a></li>
<li><a href="#orgb01e438">function num-records-in-database ()</a></li>
<li><a href="#org473451a">function current-database ()</a></li>
<li><a href="#orgf0bb307">function database-exists-p (database-name)</a></li>
<li><a href="#orga9a4653">function database-size (&amp;optional database-name)</a></li>
<li><a href="#orgc295b9b">function list-databases (&amp;key (order-by-size nil) (size t))</a></li>
<li><a href="#orged078bd">function list-schemas ()</a></li>
<li><a href="#org4e18958">function list-tablespaces ()</a></li>
<li><a href="#org82e321c">function list-available-types ()</a></li>
<li><a href="#orgd884ec3">function list-table-sizes (&amp;key (schema "public") (order-by-size nil) (size t))</a></li>
<li><a href="#org73d4b77">function table-size (table-name)</a></li>
<li><a href="#org99c4912">function more-table-info (table-name)</a></li>
<li><a href="#org5109f5d">function list-columns (table-name)</a></li>
<li><a href="#orgcb15cd7">function list-columns-with-types (table-name)</a></li>
<li><a href="#org9bfbe70">function column-exists-p (table-name column-name)</a></li>
<li><a href="#org632bf48">function describe-views (&amp;optional (schema "public")</a></li>
<li><a href="#org0062efd">function list-database-functions ()</a></li>
<li><a href="#org6616a58">function list-indices (&amp;optional strings-p)</a></li>
<li><a href="#org9c8fcb8">function list-table-indices (table-name &amp;optional strings-p)</a></li>
<li><a href="#orged78706">function index-exists-p (name)</a></li>
<li><a href="#org1aafa04">function list-indexed-column-and-attributes (table-name)</a></li>
<li><a href="#orgc908d5e">function list-index-definitions (table-name)</a></li>
<li><a href="#org51016c6">function find-primary-key-info (table-name &amp;optional (just-key nil))</a></li>
<li><a href="#orgf7d46db">function list-foreign-keys (table-name)</a></li>
<li><a href="#org9ef0101">function list-unique-or-primary-constraints (table-name)</a></li>
<li><a href="#org23734e2">function list-all-constraints (table-name)</a></li>
<li><a href="#orgb59a7a9">function describe-constraint (table-name constraint-name)</a></li>
<li><a href="#org5f2f52b">function describe-foreign-key-constraints ()</a></li>
<li><a href="#org2442647">function list-triggers (&amp;optional table-name)</a></li>
<li><a href="#orgd915c81">function list-detailed-triggers ()</a></li>
<li><a href="#orgdb505fa">function list-database-users ()</a></li>
<li><a href="#orgbde46da">function list-available-extensions ()</a></li>
<li><a href="#orgd75fa2f">function list-installed-extensions ()</a></li>
<li><a href="#orgb849d68">function change-toplevel-database (new-database user password host)</a></li>
</ul>
</li>
<li><a href="#orgc6b3918">Database access objects</a>
<ul>
<li><a href="#org007b559">metaclass dao-class</a></li>
<li><a href="#org78031d7">method dao-keys (class)</a></li>
<li><a href="#orgb288fc7">method dao-keys (dao)</a></li>
<li><a href="#org24eaf6f">method dao-exists-p (dao)</a></li>
<li><a href="#orga47a748">method make-dao (type &amp;rest args &amp;key &amp;allow-other-keys)</a></li>
<li><a href="#orge2d47f3">macro define-dao-finalization (((dao-name class) &amp;rest keyword-args) &amp;body body)</a></li>
<li><a href="#orgbf81cbc">method get-dao (type &amp;rest keys)</a></li>
<li><a href="#org1e525fb">macro select-dao (type &amp;optional (test t) &amp;rest sort)</a></li>
<li><a href="#orgd79fb79">macro do-select-dao (((type type-var) &amp;optional (test t) &amp;rest sort) &amp;body body)</a></li>
<li><a href="#orga85e21c">macro query-dao (type query &amp;rest args)</a></li>
<li><a href="#org67037b3">function do-query-dao (((type type-var) query &amp;rest args) &amp;body body)</a></li>
<li><a href="#orgc43848b">variable <b>ignore-unknown-columns</b></a></li>
<li><a href="#org3a80ac0">method insert-dao (dao)</a></li>
<li><a href="#org43e391f">method update-dao (dao)</a></li>
<li><a href="#orgd0e20ec">function save-dao (dao)</a></li>
<li><a href="#orge0c4e1f">function save-dao/transaction (dao)</a></li>
<li><a href="#org8f0c6f8">method upsert-dao (dao)</a></li>
<li><a href="#org67bf700">method delete-dao (dao)</a></li>
<li><a href="#orge7b7c0b">function dao-table-name (class)</a></li>
<li><a href="#orgf48f6ce">function dao-table-definition (class)</a></li>
<li><a href="#org59172d0">macro with-column-writers ((&amp;rest writers) &amp;body body)</a></li>
</ul>
</li>
<li><a href="#orgeed8250">Table definition and creation</a>
<ul>
<li><a href="#org6855342">macro deftable (name &amp;body definition)</a></li>
<li><a href="#orgf0d4464">function !dao-def ()</a></li>
<li><a href="#org08a3c23">function !index (&amp;rest columns), !unique-index (&amp;rest columns)</a></li>
<li><a href="#org043be46">function !foreign (target-table columns &amp;optional target-columns &amp;key on-delete on-update deferrable initially-deferred)</a></li>
<li><a href="#org8c5c6b9">function !unique (target-fields &amp;key deferrable initially-deferred)</a></li>
<li><a href="#orge4b097b">function create-table (symbol)</a></li>
<li><a href="#org2ca2b8d">function create-all-tables ()</a></li>
<li><a href="#org93120ba">function create-package-tables (package)</a></li>
<li><a href="#org5b3e257">variables <b>table-name</b>, <b>table-symbol</b></a></li>
</ul>
</li>
<li><a href="#org94988a4">Schemata</a>
<ul>
<li><a href="#orgfb8a41d">function create-schema (schema)</a></li>
<li><a href="#orga69ac80">function drop-schema (schema)</a></li>
<li><a href="#org2dbd10b">function get-search-path ()</a></li>
<li><a href="#org917c9f7">function set-search-path (path)</a></li>
<li><a href="#orgb8e5556">function split-fully-qualified-table-name (name)</a></li>
</ul>
</li>
<li><a href="#org94988a4muf">Miscellaneous Utility Functions</a>
  <ul>
    <li><a href="#orgb8e5557">function execute-file (filename &optional (print nil))</a></li>
  </ul>
</ul>
</div>
</div>
<p>
This is the reference manual for the component named postmodern, which is
part of a library of the same name.
</p>

<p>
Note that this package also exports the database-connection and
database-error types from CL-postgres and a few operators from S-SQL.
</p>

<p>
query, execute, and any other function that would logically need to
communicate with the database will raise a condition of the type
database-error when something goes wrong. As a special case, errors
that break the connection (socket errors, database shutdowns) will be
raised as subtypes of database-connection-error, providing a :reconnect
restart to re-try the operation that encountered to the error.
</p>

<div id="outline-container-orgd68da46" class="outline-2">
<h2 id="orgd68da46">Connecting</h2>
<div class="outline-text-2" id="text-orgd68da46">
</div>
<div id="outline-container-org70ba6f7" class="outline-3">
<h3 id="org70ba6f7">class database-connection</h3>
<div class="outline-text-3" id="text-org70ba6f7">
<p>
Objects of this type represent database connections.
</p>
</div>
</div>

<div id="outline-container-org4ff7373" class="outline-3">
<h3 id="org4ff7373">function connect (database user password host &amp;key (port 5432) pooled-p use-ssl)</h3>
<div class="outline-text-3" id="text-org4ff7373">
<p>
→ database-connection
</p>

<p>
Create a new database connection for the given user and the database.
Port will default to 5432, which is where most PostgreSQL servers are
running. If pooled-p is T, a connection will be taken from a pool of
connections of this type, if one is available there, and when the connection
is disconnected it will be put back into this pool instead. use-ssl can
be :no, :yes, or :try, as in open-database, and defaults to the value
of <b>default-use-ssl</b>.
</p>
</div>
</div>

<div id="outline-container-orgc2c1280" class="outline-3">
<h3 id="orgc2c1280">variable <b>default-use-ssl</b></h3>
<div class="outline-text-3" id="text-orgc2c1280">
<p>
The default for connect's use-ssl argument. This starts at :no. If you
set it to anything else, be sure to also load the CL+SSL library.
</p>
</div>
</div>

<div id="outline-container-orgabd7d03" class="outline-3">
<h3 id="orgabd7d03">method disconnect (database-connection)</h3>
<div class="outline-text-3" id="text-orgabd7d03">
<p>
Disconnects a normal database connection, or moves a pooled connection
into the pool.
</p>
</div>
</div>

<div id="outline-container-orgfa42206" class="outline-3">
<h3 id="orgfa42206">function connected-p (database-connection)</h3>
<div class="outline-text-3" id="text-orgfa42206">
<p>
→ boolean
</p>

<p>
Returns a boolean indicating whether the given connection is still connected
to the server.
</p>
</div>
</div>

<div id="outline-container-orgcefdd49" class="outline-3">
<h3 id="orgcefdd49">method reconnect (database-connection)</h3>
<div class="outline-text-3" id="text-orgcefdd49">
<p>
Reconnect a disconnected database connection. This is not allowed for pooled
connections ― after they are disconnected they might be in use by some other
process, and should no longer be used.
</p>
</div>
</div>

<div id="outline-container-orgb2175fd" class="outline-3">
<h3 id="orgb2175fd">variable <b>database</b></h3>
<div class="outline-text-3" id="text-orgb2175fd">
<p>
Special variable holding the current database. Most functions and macros
operating on a database assume this binds to a connected database.
</p>
</div>
</div>

<div id="outline-container-org4cf3ae2" class="outline-3">
<h3 id="org4cf3ae2">macro with-connection (spec &amp;body body)</h3>
<div class="outline-text-3" id="text-org4cf3ae2">
<p>
Evaluates the body with <b>database</b> bound to a connection as specified by
spec, which should be list that connect can be applied to.
</p>
</div>
</div>

<div id="outline-container-org990d326" class="outline-3">
<h3 id="org990d326">macro call-with-connection (spec thunk)</h3>
<div class="outline-text-3" id="text-org990d326">
<p>
The functional backend to with-connection. Binds <b>database</b> to a new
connection as specified by spec, which should be a list that connect can
be applied to, and runs the zero-argument function given as second argument
in the new environment. When the function returns or throws, the new
connection is disconnected.
</p>
</div>
</div>

<div id="outline-container-org8b6bb24" class="outline-3">
<h3 id="org8b6bb24">function connect-toplevel (database user password host &amp;key (port 5432))</h3>
<div class="outline-text-3" id="text-org8b6bb24">
<p>
Bind the <b>database</b> to a new connection. Use this if you only need one
connection, or if you want a connection for debugging from the REPL.
</p>
</div>
</div>

<div id="outline-container-org7d857e1" class="outline-3">
<h3 id="org7d857e1">function disconnect-toplevel ()</h3>
<div class="outline-text-3" id="text-org7d857e1">
<p>
Disconnect the <b>database</b>.
</p>
</div>
</div>

<div id="outline-container-orgea8a5cf" class="outline-3">
<h3 id="orgea8a5cf">function clear-connection-pool ()</h3>
<div class="outline-text-3" id="text-orgea8a5cf">
<p>
Disconnect and remove all connections from the connection pools.
</p>
</div>
</div>

<div id="outline-container-orgac9fe19" class="outline-3">
<h3 id="orgac9fe19">variable <b>max-pool-size</b></h3>
<div class="outline-text-3" id="text-orgac9fe19">
<p>
Set the maximum amount of connections kept in a single connection pool, where
a pool consists of all the stored connections with the exact same connect
arguments. Defaults to NIL, which means there is no maximum.
</p>
</div>
</div>

<div id="outline-container-org1268371" class="outline-3">
<h3 id="org1268371">function list-connections ()</h3>
<div class="outline-text-3" id="text-org1268371">
<p>
→ list
</p>

<p>
List the current postgresql connections to the currently connected database.
</p>
</div>
</div>
</div>
<div id="outline-container-orga46f926" class="outline-2">
<h2 id="orga46f926">Querying</h2>
<div class="outline-text-2" id="text-orga46f926">
</div>
<div id="outline-container-orgce13f70" class="outline-3">
<h3 id="orgce13f70">macro query (query &amp;rest args/format)</h3>
<div class="outline-text-3" id="text-orgce13f70">
<p>
→ result
</p>

<p>
Execute the given query, which can be either a string or an S-SQL form
(list starting with a keyword). If the query contains placeholders ($1, $2, etc)
their values can be given as extra arguments. If one of these arguments
is a keyword occurring in the table below, it will not be used as a query
argument, but will determine the format in which the results are returned
instead. Any of the following formats can be used, with the default being :rows:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">:none</td>
<td class="org-left">Ignore the result values.</td>
</tr>

<tr>
<td class="org-left">:lists, :rows</td>
<td class="org-left">Return a list of lists, each list containing the values for a row.</td>
</tr>

<tr>
<td class="org-left">:list, :row</td>
<td class="org-left">Return a single row as a list.</td>
</tr>

<tr>
<td class="org-left">:alists</td>
<td class="org-left">Return a list of alists which map column names to values, with the names represented as keywords.</td>
</tr>

<tr>
<td class="org-left">:alist</td>
<td class="org-left">Return a single row as an alist.</td>
</tr>

<tr>
<td class="org-left">:str-alists</td>
<td class="org-left">Like :alists, but use the original column names.</td>
</tr>

<tr>
<td class="org-left">:str-alist</td>
<td class="org-left">Return a single row as an alist, with strings for names.</td>
</tr>

<tr>
<td class="org-left">:plists</td>
<td class="org-left">Return a list of plists which map column names to values,with the names represented as keywords.</td>
</tr>

<tr>
<td class="org-left">:plist</td>
<td class="org-left">Return a single row as a plist.</td>
</tr>

<tr>
<td class="org-left">:column</td>
<td class="org-left">Return a single column as a list.</td>
</tr>

<tr>
<td class="org-left">:single</td>
<td class="org-left">Return a single value.</td>
</tr>

<tr>
<td class="org-left">:single!</td>
<td class="org-left">Like :single, but raise an error when the number of selected rows is not equal to 1.</td>
</tr>

<tr>
<td class="org-left">(:dao type)</td>
<td class="org-left">Return a list of DAOs of the given type. The names of the fields returned by the query must match slots in the DAO class the same way as with query-dao.</td>
</tr>

<tr>
<td class="org-left">(:dao type :single)</td>
<td class="org-left">Return a single DAO of the given type.</td>
</tr>
</tbody>
</table>

<p>
If the database returns information about the amount rows that were affected,
such as with updating or deleting queries, this is returned as a second value.
</p>
</div>
</div>

<div id="outline-container-orge125277" class="outline-3">
<h3 id="orge125277">macro execute (query &amp;rest args)</h3>
<div class="outline-text-3" id="text-orge125277">
<p>
Like query called with format :none. Returns the amount of affected rows as
its first returned value. (Also returns this amount as the second returned
value, but use of this is deprecated.)
</p>
</div>
</div>

<div id="outline-container-orgd8f0978" class="outline-3">
<h3 id="orgd8f0978">macro doquery (query (&amp;rest names) &amp;body body)</h3>
<div class="outline-text-3" id="text-orgd8f0978">
<p>
Execute the given query (a string or a list starting with a keyword),
iterating over the rows in the result. The body will be executed with the
values in the row bound to the symbols given in names. To iterate over a
parameterised query, one can specify a list whose car is the query, and
whose cdr contains the arguments. For example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(doquery (:select 'name 'score :from 'scores) (n s)
  (incf (gethash n *scores*) s))

(doquery ((:select 'name :from 'scores :where (:&gt; 'score '$1)) 100) (name)
  (print name))
</pre>
</div>
</div>
</div>

<div id="outline-container-org0d98143" class="outline-3">
<h3 id="org0d98143">macro prepare (query &amp;optional (format :rows))</h3>
<div class="outline-text-3" id="text-org0d98143">
<p>
→ function
</p>

<p>
Wraps a query into a function that can be used as the interface to a prepared
statement. The given query (either a string or an S-SQL form) may contain
placeholders, which look like $1, $2, etc. The resulting function takes one
argument for every placeholder in the query, executes the prepared query,
and returns the result in the format specified. (Allowed formats are the
same as for query.)
</p>

<p>
For queries that have to be run very often, especially when they are complex,
it may help performance since the server only has to plan them once. See
the <a href="http://www.postgresql.org/docs/current/static/sql-prepare.html">PostgreSQL manual</a> for details.
</p>

<p>
In some cases, the server will complain about not being able to deduce the
type of the arguments in a statement. In that case you should add type
declarations (either with the PostgreSQL's CAST SQL-conforming syntax or
historical :: syntax, or with S-SQL's :type construct) to help it out.
</p>

<p>
Note that it will attempt to automatically reconnect if
database-connection-error, or admin-shutdown. It will reset prepared
statements triggering an invalid-sql-statement-name error. It will
overwrite old prepared statements triggering a duplicate-prepared-statement
error.
</p>
</div>
</div>

<div id="outline-container-org51c9b8a" class="outline-3">
<h3 id="org51c9b8a">macro defprepared (name query &amp;optional (format :rows))</h3>
<div class="outline-text-3" id="text-org51c9b8a">
<p>
→ function
</p>

<p>
This is the macro-style variant of prepare. It is like prepare, but gives
the function a name which now becomes a top-level function for the
prepared statement. The name should not be quoted or a string.
</p>
</div>
</div>

<div id="outline-container-org2edf231" class="outline-3">
<h3 id="org2edf231">macro defprepared-with-names (name (&amp;rest args) (query &amp;rest query-args) &amp;optional (format :rows))</h3>
<div class="outline-text-3" id="text-org2edf231">
<p>
Like defprepared, but allows to specify names of the function arguments as
well as arguments supplied to the query.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(defprepared-with-names user-messages (user &amp;key (limit 10))
  ("select * from messages
    where user_id = $1
    order by date desc
    limit $2" (user-id user) limit)
  :plists)
</pre>
</div>
</div>
</div>

<div id="outline-container-org2ca7cfd" class="outline-3">
<h3 id="org2ca7cfd">macro with-transaction ((&amp;optional name isolation-level) &amp;body body)</h3>
<div class="outline-text-3" id="text-org2ca7cfd">
<p>
Execute the given body within a database transaction, committing it when the
body exits normally, and aborting otherwise. An optional name and/or
isolation-level can be given to the transaction. The name can be used to
force a commit or abort before the body unwinds. The isolation-level
will set the isolation-level used by the transaction.
</p>

<p>
You can specify the following isolation levels in postmodern transactions:
</p>

<ul class="org-ul">
<li>:read-committed-rw (read committed with read and write)</li>
<li>:read-committed-ro (read committed with read only)</li>
<li>:repeatable-read-rw (repeatable read with read and write)</li>
<li>:repeatable-read-ro (repeatable read with read only)</li>
<li>:serializable (serializable with reand and write)</li>
</ul>

<p>
Sample usage where "george" is just the name given to the transaction (not
quoted or a string) and &#x2026; simply indicates other statements would be
expected here:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(with-transaction ()
  (execute (:insert-into 'test-data :set 'value 77))
  ...)

(with-transaction (george)
  (execute (:insert-into 'test-data :set 'value 22))
  ...)

(with-transaction (george :read-committed-rw)
  (execute (:insert-into 'test-data :set 'value 33))
  (query (:select '* :from 'test-data))
  ...)

(with-transaction (:serializable)
  (execute (:insert-into 'test-data :set 'value 44))
  ...)
</pre>
</div>

<p>
Further discussion of transactions and isolation levels can found
<a href="isolation-notes.html">here</a>.
</p>
</div>
</div>

<div id="outline-container-org2a334a1" class="outline-3">
<h3 id="org2a334a1">function commit-transaction (transaction)</h3>
<div class="outline-text-3" id="text-org2a334a1">
<p>
Commit the given transaction.
</p>
</div>
</div>

<div id="outline-container-org217c8ab" class="outline-3">
<h3 id="org217c8ab">function abort-transaction (transaction)</h3>
<div class="outline-text-3" id="text-org217c8ab">
<p>
Roll back the given transaction.
</p>
</div>
</div>

<div id="outline-container-org142206c" class="outline-3">
<h3 id="org142206c">macro with-savepoint (name &amp;body body)</h3>
<div class="outline-text-3" id="text-org142206c">
<p>
Can only be used within a transaction. Establishes a savepoint with the given
name at the start of body, and binds the same name to a handle for that
savepoint. At the end of body, the savepoint is released, unless a
condition is thrown, in which case it is rolled back.
</p>
</div>
</div>

<div id="outline-container-orge056ea9" class="outline-3">
<h3 id="orge056ea9">function release-savepoint (savepoint)</h3>
<div class="outline-text-3" id="text-orge056ea9">
<p>
Release the given savepoint.
</p>
</div>
</div>

<div id="outline-container-orgcf724bb" class="outline-3">
<h3 id="orgcf724bb">function rollback-savepoint (savepoint)</h3>
<div class="outline-text-3" id="text-orgcf724bb">
<p>
Roll back the given savepoint.
</p>
</div>
</div>

<div id="outline-container-org44e9da3" class="outline-3">
<h3 id="org44e9da3">function commit-hooks (transaction-or-savepoint), setf (commit-hooks transaction-or-savepoint)</h3>
<div class="outline-text-3" id="text-org44e9da3">
<p>
An accessor for the transaction or savepoint's list of commit hooks, each of
which should be a function with no required arguments. These functions will
be executed when a transaction is committed or a savepoint released.
</p>
</div>
</div>

<div id="outline-container-orge586c35" class="outline-3">
<h3 id="orge586c35">function abort-hooks (transaction-or-savepoint), setf (abort-hooks transaction-or-savepoint)</h3>
<div class="outline-text-3" id="text-orge586c35">
<p>
An accessor for the transaction or savepoint's list of abort hooks, each of
which should be a function with no required arguments. These functions will
be executed when a transaction is aborted or a savepoint rolled back
(whether via a non-local transfer of control or explicitly by either
abort-transaction or rollback-savepoint).
</p>
</div>
</div>

<div id="outline-container-org5d15144" class="outline-3">
<h3 id="org5d15144">macro with-logical-transaction ((&amp;optional name isolation-level) &amp;body body)</h3>
<div class="outline-text-3" id="text-org5d15144">
<p>
Executes body within a with-transaction form if no transaction is currently
in progress, otherwise simulates a nested transaction by executing it
within a with-savepoint form. The transaction or savepoint is bound to name
if one is supplied. The isolation-level will set the isolation-level used by the transaction.
</p>

<p>
You can specify the following isolation levels in postmodern transactions:
</p>

<ul class="org-ul">
<li>:read-committed-rw (read committed with read and write)</li>
<li>:read-committed-ro (read committed with read only)</li>
<li>:repeatable-read-rw (repeatable read with read and write)</li>
<li>:repeatable-read-ro (repeatable read with read only)</li>
<li>:serializable (serializable with reand and write)</li>
</ul>

<p>
Sample usage where "george" is just the name given to the transaction (not
quoted or a string) and &#x2026; simply indicates other statements would be
expected here:
</p>

<div class="org-src-container">
<pre class="src src-lisp">(with-logical-transaction ()
  (execute (:insert-into 'test-data :set 'value 77))
  ...)

(with-logical-transaction (george)
  (execute (:insert-into 'test-data :set 'value 22))
  ...)

(with-logical-transaction (george :read-committed-rw)
  (execute (:insert-into 'test-data :set 'value 33))
  ...)

(with-logical-transaction (:serializable)
  (execute (:insert-into 'test-data :set 'value 44))
  ...)
</pre>
</div>
</div>
</div>

<div id="outline-container-org574169f" class="outline-3">
<h3 id="org574169f">function abort-logical-transaction (transaction-or-savepoint)</h3>
<div class="outline-text-3" id="text-org574169f">
<p>
Roll back the given logical transaction, regardless of whether it is an
actual transaction or a savepoint.
</p>
</div>
</div>

<div id="outline-container-org35e7b50" class="outline-3">
<h3 id="org35e7b50">function commit-logical-transaction (transaction-or-savepoint)</h3>
<div class="outline-text-3" id="text-org35e7b50">
<p>
Commit the given logical transaction, regardless of whether it is an
actual transaction or a savepoint.
</p>
</div>
</div>

<div id="outline-container-org0e63adc" class="outline-3">
<h3 id="org0e63adc">variable <b>current-logical-transaction</b></h3>
<div class="outline-text-3" id="text-org0e63adc">
<p>
This is bound to the current transaction-handle or savepoint-handle instance
representing the innermost open logical transaction.
</p>
</div>
</div>

<div id="outline-container-org72c4caf" class="outline-3">
<h3 id="org72c4caf">macro ensure-transaction (&amp;body body)</h3>
<div class="outline-text-3" id="text-org72c4caf">
<p>
Ensures that body is executed within a transaction, but does not begin a
new transaction if one is already in progress.
</p>
</div>
</div>

<div id="outline-container-org1b36261" class="outline-3">
<h3 id="org1b36261">macro with-schema ((namespace &amp;key :strict t :if-not-exist :create :drop-after) &amp;body body)</h3>
<div class="outline-text-3" id="text-org1b36261">
<p>
Sets the current schema to namespace and executes the body. Before executing
body the PostgreSQL's session variable search_path is set to the given
namespace. After executing body the search_path variable is restored
to the original value. If the keyword :strict is set to T then the namespace
is only the scheme on the search path upon the body execution. Otherwise the
namespace is just first schema on the search path upon the the body execution.
If :if-not-exist is NIL, an error is signaled. If :drop-after is T the
namespace is dropped from the database after the body execution.
</p>
</div>
</div>

<div id="outline-container-orgb0b155d" class="outline-3">
<h3 id="orgb0b155d">function sequence-next (sequence)</h3>
<div class="outline-text-3" id="text-orgb0b155d">
<p>
→ integer
</p>

<p>
Get the next value from a sequence. The sequence identifier can be either a
string or a symbol, in the latter case it will be converted to a string
according to S-SQL rules.
</p>
</div>
</div>

<div id="outline-container-orgc861067" class="outline-3">
<h3 id="orgc861067">function coalesce (&amp;rest arguments)</h3>
<div class="outline-text-3" id="text-orgc861067">
<p>
→ value
</p>

<p>
Returns the first non-NIL, non-NULL (as in :null) argument, or NIL if none are
present. Useful for providing a fall-back value for the result of a query, or,
when given only one argument, for transforming :nulls to NIL.
</p>
</div>
</div>
</div>


<div id="outline-container-org2580dda" class="outline-2">
<h2 id="org2580dda">Helper functions for Prepared Statements</h2>
<div class="outline-text-2" id="text-org2580dda">
</div>

<div id="outline-container-org730cd12a4" class="outline-3">
<h3 id="org730cd12a4">parameter *allow-overwriting-prepared-statements*</h3>
<div class="outline-text-3" id="text-org730cd12a4">
<p>
→ parameter

When set to t, ensured-prepared will overwrite prepared statements having
the same name if the query statement itself in the postmodern meta connection
is different than the query statement provided to ensure-prepared.
</p>
</div>
</div>

<div id="outline-container-org730cd12" class="outline-3">
<h3 id="org730cd12">function prepared-statement-exists-p (name)</h3>
<div class="outline-text-3" id="text-org730cd12">
<p>
→ boolean
This returns t if the prepared statement exists in the current
postgresql session, otherwise nil.
</p>
</div>
</div>

<div id="outline-container-org7df9842" class="outline-3">
<h3 id="org7df9842">function list-prepared-statements(&amp;optional (names-only nil))</h3>
<div class="outline-text-3" id="text-org7df9842">
<p>
→ list
</p>

<p>
This is syntactic sugar. It runs a query that lists the prepared statements in
the session in which the function is run. If the names-only parameter is set
to t, it will only return a list of the names of the prepared statements.
</p>
</div>
</div>

<div id="outline-container-orgfbdd58c" class="outline-3">
<h3 id="orgfbdd58c">function drop-prepared-statement (statement-name &amp;key (location :both) (database <b>database</b>))</h3>
<div class="outline-text-3" id="text-orgfbdd58c">
<p>
Prepared statements are stored both in the meta slot in the postmodern
connection and in postgresql session information. If you know the prepared
statement name, you can delete the prepared statement from both locations (the
default behavior), just from postmodern (passing :postmodern to the location
key parameter) or just from postgresql (passing :postgresql to the location
key parameter). If you pass the name 'All' as the statement name, it will
delete all prepared statements. The statement name can be a string or quoted symbol.
</p>
</div>
</div>

<div id="outline-container-org2156a7a" class="outline-3">
<h3 id="org2156a7a">function list-postmodern-prepared-statements (&amp;optional (names-only nil))</h3>
<div class="outline-text-3" id="text-org2156a7a">
<p>
→ list
</p>

<p>
List the prepared statements that postmodern has put in the meta slot in
the connection. It will return a list of alists of form:
  ((:NAME . \"SNY24\")
  (:STATEMENT . \"(SELECT name, salary FROM employee WHERE (city = $1))\")
  (:PREPARE-TIME . #&lt;TIMESTAMP 25-11-2018T15:36:43,385&gt;)
  (:PARAMETER-TYPES . \"{text}\") (:FROM-SQL)
</p>

<p>
If the names-only parameter is set to t, it will only return a list of
the names of the prepared statements.
</p>
</div>
</div>

<div id="outline-container-org57d40d9" class="outline-3">
<h3 id="org57d40d9">function find-postgresql-prepared-statement (name)</h3>
<div class="outline-text-3" id="text-org57d40d9">
<p>
→ string
</p>

<p>
Returns the specified named prepared statement (if any) that postgresql has for this
session.
</p>
</div>
</div>

<div id="outline-container-org8d04ae3" class="outline-3">
<h3 id="org8d04ae3">function find-postmodern-prepared-statement (name)</h3>
<div class="outline-text-3" id="text-org8d04ae3">
<p>
→ string
</p>

<p>
Returns the specified named prepared statement (if any) that postmodern has
put in the meta slot in the connection. Note that this is the statement itself,
not the name.
</p>
</div>
</div>

<div id="outline-container-orgcf1544b" class="outline-3">
<h3 id="orgcf1544b">function reset-prepared-statement (condition)</h3>
<div class="outline-text-3" id="text-orgcf1544b">
<p>
→ restart
</p>

<p>
If you have received an invalid-prepared-statement error but the prepared
statement is still in the meta slot in the postmodern connection, this will
try to regenerate the prepared statement at the database connection level
and restart the connection.
</p>
</div>
</div>

<div id="outline-container-org4532d28" class="outline-3">
<h3 id="org4532d28">function get-pid ()</h3>
<div class="outline-text-3" id="text-org4532d28">
<p>
→ integer
</p>

<p>
Get the process id used by postgresql for this connection.
</p>
</div>
</div>

<div id="outline-container-orgd6d26b9" class="outline-3">
<h3 id="orgd6d26b9">function get-pid-from-postmodern ()</h3>
<div class="outline-text-3" id="text-orgd6d26b9">
<p>
→ integer
</p>

<p>
Get the process id used by postgresql for this connection,
but get it from the postmodern connection parameters.
</p>
</div>
</div>

<div id="outline-container-orgb01e3f4" class="outline-3">
<h3 id="orgb01e3f4">function cancel-backend (pid)</h3>
<div class="outline-text-3" id="text-orgb01e3f4">
<p>
Polite way of terminating a query at the database (as opposed to calling close-database).
Slower than (terminate-backend pid) and does not always work.
</p>
</div>
</div>

<div id="outline-container-orgcf97180" class="outline-3">
<h3 id="orgcf97180">function terminate-backend (pid)</h3>
<div class="outline-text-3" id="text-orgcf97180">
<p>
Less polite way of terminating at the database (as opposed to calling close-database).
Faster than (cancel-backend pid) and more reliable.
</p>
</div>
</div>
</div>

<div id="outline-container-org50f54e2" class="outline-2">
<h2 id="org50f54e2">Inspecting the database</h2>
<div class="outline-text-2" id="text-org50f54e2">
</div>
<div id="outline-container-org9c91a7f" class="outline-3">
<h3 id="org9c91a7f">function list-tables (&amp;optional strings-p)</h3>
<div class="outline-text-3" id="text-org9c91a7f">
<p>
→ list
</p>

<p>
Returns a list of the tables in the current database and schema. When strings-p is T,
the names will be given as strings, otherwise as keywords.
</p>
</div>
</div>

<div id="outline-container-org394c43a" class="outline-3">
<h3 id="org394c43a">function list-tables-in-schema (&amp;optional strings-p)</h3>
<div class="outline-text-3" id="text-org394c43a">
<p>
→ list
</p>

<p>
Returns a list of the tables in the current database and the specified schema.
When strings-p is T,the names will be given as strings, otherwise as keywords.
</p>
</div>
</div>
<div id="outline-container-org75f07b5" class="outline-3">
<h3 id="org75f07b5">function table-exists-p (name)</h3>
<div class="outline-text-3" id="text-org75f07b5">
<p>
→ boolean
</p>

<p>
Tests whether a table with the given name exists. The name can be either a
string or a symbol. It can also be qualified in the form of 'schema.table
or 'database.schema.table
</p>
</div>
</div>

<div id="outline-container-org6660019" class="outline-3">
<h3 id="org6660019">function table-description (name &amp;optional schema-name)</h3>
<div class="outline-text-3" id="text-org6660019">
<p>
→ list
</p>

<p>
Returns a list of the fields in the named table. Each field is represented by
a list of three elements: the field name, the type, and a boolean indicating
whether the field may be NULL. Optionally, schema-name can be specified to
restrict the result to fields from the named schema. Without it, all fields in
the table are returned, regardless of their schema.
</p>
</div>
</div>

<div id="outline-container-orgcba924e" class="outline-3">
<h3 id="orgcba924e">function list-sequences (&amp;optional strings-p)</h3>
<div class="outline-text-3" id="text-orgcba924e">
<p>
→ list
</p>

<p>
Returns a list of the sequences in the current database. When strings-p is T,
the names will be given as strings, otherwise as keywords.
</p>
</div>
</div>

<div id="outline-container-org7b9b575" class="outline-3">
<h3 id="org7b9b575">function sequence-exists-p (name)</h3>
<div class="outline-text-3" id="text-org7b9b575">
<p>
→ boolean
</p>

<p>
Tests whether a sequence with the given name exists. The name can be either a
string or a symbol.
</p>
</div>
</div>

<div id="outline-container-org8fc42b4" class="outline-3">
<h3 id="org8fc42b4">function list-views (&amp;optional strings-p)</h3>
<div class="outline-text-3" id="text-org8fc42b4">
<p>
→ list
</p>

<p>
Returns list of the user defined views in the current database. When strings-p
is T, the names will be returned as strings, otherwise as keywords.
</p>
</div>
</div>

<div id="outline-container-org57e604e" class="outline-3">
<h3 id="org57e604e">function view-exists-p (name)</h3>
<div class="outline-text-3" id="text-org57e604e">
<p>
→ boolean
</p>

<p>
Tests whether a view with the given name exists. The name can be either a
string or a symbol.
</p>
</div>
</div>

<div id="outline-container-org31b807b" class="outline-3">
<h3 id="org31b807b">function list-schemata ()</h3>
<div class="outline-text-3" id="text-org31b807b">
<p>
→ list
</p>

<p>
Returns list of the user defined schemata (as strings) and the quantity of
existing schemata.
</p>
</div>
</div>

<div id="outline-container-orgc8e8592" class="outline-3">
<h3 id="orgc8e8592">function schema-exist-p (schema) NOW DEPRECATED IN FAVOR OF schema-exists-p which is more consistent with naming of other functions.</h3>
<div class="outline-text-3" id="text-orgc8e8592">
<p>
→ boolean
</p>

<p>
Tests the existence of a given schema. Returns T if the schema exists or NIL
otherwise.
</p>
</div>
</div>

<div id="outline-container-org185524a" class="outline-3">
<h3 id="org185524a">function schema-exists-p (schema)</h3>
<div class="outline-text-3" id="text-org185524a">
<p>
→ boolean
</p>

<p>
Tests the existence of a given schema. Returns T if the schema exists or NIL
otherwise.
</p>
</div>
</div>

<div id="outline-container-orgdfb707f" class="outline-3">
<h3 id="orgdfb707f">function database-version ()</h3>
<div class="outline-text-3" id="text-orgdfb707f">
<p>
→ string
</p>

<p>
Returns the version of the current postgresql database.
</p>
</div>
</div>

<div id="outline-container-orgb01e438" class="outline-3">
<h3 id="orgb01e438">function num-records-in-database ()</h3>
<div class="outline-text-3" id="text-orgb01e438">
<p>
→ list
</p>

<p>
Returns a list of lists with schema, table name and approximate number of
records in the currently connected database.
</p>
</div>
</div>

<div id="outline-container-org473451a" class="outline-3">
<h3 id="org473451a">function current-database ()</h3>
<div class="outline-text-3" id="text-org473451a">
<p>
→ string
</p>

<p>
Returns the string name of the current database.
</p>
</div>
</div>

<div id="outline-container-orgf0bb307" class="outline-3">
<h3 id="orgf0bb307">function database-exists-p (database-name)</h3>
<div class="outline-text-3" id="text-orgf0bb307">
<p>
→ boolean
</p>

<p>
Checks to see if a particular database exists.
</p>
</div>
</div>

<div id="outline-container-orga9a4653" class="outline-3">
<h3 id="orga9a4653">function database-size (&amp;optional database-name)</h3>
<div class="outline-text-3" id="text-orga9a4653">
<p>
→ list
</p>

<p>
Given the name of a database, will return the name, a pretty-print string of
the size of the database and the size in bytes. If a database name is not
provided, it will return the result for the currently connected database.
</p>
</div>
</div>

<div id="outline-container-orgc295b9b" class="outline-3">
<h3 id="orgc295b9b">function list-databases (&amp;key (order-by-size nil) (size t))</h3>
<div class="outline-text-3" id="text-orgc295b9b">
<p>
→ list
</p>

<p>
Returns a list of lists where each sub-list contains the name of the database,
a pretty-print string of the size of that database and the size in bytes. The
default order is by database name. Pass t as a parameter to :order-by-size
for order by size. Setting size to nil will return just the database names
in a single list ordered by name. This function excludes the template databases
</p>
</div>
</div>

<div id="outline-container-orged078bd" class="outline-3">
<h3 id="orged078bd">function list-schemas ()</h3>
<div class="outline-text-3" id="text-orged078bd">
<p>
→ list
</p>

<p>
List schemas in the current database, excluding the pg_* system schemas.
</p>
</div>
</div>

<div id="outline-container-org4e18958" class="outline-3">
<h3 id="org4e18958">function list-tablespaces ()</h3>
<div class="outline-text-3" id="text-org4e18958">
<p>
→ list
</p>

<p>
Lists the tablespaces in the currently connected database.
</p>
</div>
</div>

<div id="outline-container-org82e321c" class="outline-3">
<h3 id="org82e321c">function list-available-types ()</h3>
<div class="outline-text-3" id="text-org82e321c">
<p>
→ list
</p>

<p>
List the available types in this postgresql version.
</p>
</div>
</div>

<div id="outline-container-orgd884ec3" class="outline-3">
<h3 id="orgd884ec3">function list-table-sizes (&amp;key (schema "public") (order-by-size nil) (size t))</h3>
<div class="outline-text-3" id="text-orgd884ec3">
<p>
→ list
</p>

<p>
Returns a list of lists (table-name, size in 8k pages) of tables in the current
database. Providing a name to the schema parameter will return just the
information for tables in that schema. It defaults to just the tables in the
public schema. Setting schema to nil will return all tables, indexes etc in
the database in descending order of size. This would include system tables, so
there are a lot more than you would expect. If :size is set to nil, it returns
only a flat list of table names. Setting order-by-size to t will return the
result in order of size instead of by table name.
</p>
</div>
</div>

<div id="outline-container-org73d4b77" class="outline-3">
<h3 id="org73d4b77">function table-size (table-name)</h3>
<div class="outline-text-3" id="text-org73d4b77">
<p>
→ list
</p>

<p>
Return the size of a postgresql table in k or m. Table-name can be either a
string or quoted.
</p>
</div>
</div>

<div id="outline-container-org99c4912" class="outline-3">
<h3 id="org99c4912">function more-table-info (table-name)</h3>
<div class="outline-text-3" id="text-org99c4912">
<p>
→ list
</p>

<p>
Returns more table info than table-description. Table can be either a string
or quoted.
</p>
</div>
</div>

<div id="outline-container-org5109f5d" class="outline-3">
<h3 id="org5109f5d">function list-columns (table-name)</h3>
<div class="outline-text-3" id="text-org5109f5d">
<p>
→ list
</p>

<p>
Returns a list of strings of just the column names in a table. Pulls info
from the postmodern table-description function rather than directly.
</p>
</div>
</div>

<div id="outline-container-orgcb15cd7" class="outline-3">
<h3 id="orgcb15cd7">function list-columns-with-types (table-name)</h3>
<div class="outline-text-3" id="text-orgcb15cd7">
<p>
→ list
</p>

<p>
Return a list of (name type) lists for the fields of a table. Goes directly
to the pg-catalog tables.
</p>
</div>
</div>

<div id="outline-container-org9bfbe70" class="outline-3">
<h3 id="org9bfbe70">function column-exists-p (table-name column-name)</h3>
<div class="outline-text-3" id="text-org9bfbe70">
<p>
→ boolean
</p>

<p>
Determine if a particular column exists. Table name and column-name can be
either strings or symbols.
</p>
</div>
</div>

<div id="outline-container-org632bf48" class="outline-3">
<h3 id="org632bf48">function describe-views (&amp;optional (schema "public")</h3>
<div class="outline-text-3" id="text-org632bf48">
<p>
→ list
</p>

<p>
Describe the current views in the specified schema. Defaults to public schema.
</p>
</div>
</div>

<div id="outline-container-org0062efd" class="outline-3">
<h3 id="org0062efd">function list-database-functions ()</h3>
<div class="outline-text-3" id="text-org0062efd">
<p>
→ list
</p>

<p>
Returns a list of the functions in the database from the information_schema.
</p>
</div>
</div>

<div id="outline-container-org6616a58" class="outline-3">
<h3 id="org6616a58">function list-indices (&amp;optional strings-p)</h3>
<div class="outline-text-3" id="text-org6616a58">
<p>
→ list
</p>

<p>
Return a list of the indexs in a database. Turn them into keywords if
strings-p is not true.
</p>
</div>
</div>

<div id="outline-container-org9c8fcb8" class="outline-3">
<h3 id="org9c8fcb8">function list-table-indices (table-name &amp;optional strings-p)</h3>
<div class="outline-text-3" id="text-org9c8fcb8">
<p>
→ list
</p>

<p>
List the index names and the related columns in a table.
</p>
</div>
</div>

<div id="outline-container-orged78706" class="outline-3">
<h3 id="orged78706">function index-exists-p (name)</h3>
<div class="outline-text-3" id="text-orged78706">
<p>
→ boolean
</p>

<p>
Tests whether an index with the given name exists. The name can be either a
string or a symbol.
</p>
</div>
</div>

<div id="outline-container-org1aafa04" class="outline-3">
<h3 id="org1aafa04">function list-indexed-column-and-attributes (table-name)</h3>
<div class="outline-text-3" id="text-org1aafa04">
<p>
→ list
</p>

<p>
List the indexed columns and their attributes in a table. Includes primary
key.
</p>
</div>
</div>

<div id="outline-container-orgc908d5e" class="outline-3">
<h3 id="orgc908d5e">function list-index-definitions (table-name)</h3>
<div class="outline-text-3" id="text-orgc908d5e">
<p>
→ list
</p>

<p>
Returns a list of the definitions used to create the current indexes for
the table
</p>
</div>
</div>

<div id="outline-container-org51016c6" class="outline-3">
<h3 id="org51016c6">function find-primary-key-info (table-name &amp;optional (just-key nil))</h3>
<div class="outline-text-3" id="text-org51016c6">
<p>
→ list
</p>

<p>
Returns a list of two strings. First the column name of the primary
key of the table and second the string name for the datatype. Optionally,
just-key can be set to t and it will return just the column name of the
primary key as a string.
</p>
</div>
</div>

<div id="outline-container-orgf7d46db" class="outline-3">
<h3 id="orgf7d46db">function list-foreign-keys (table-name)</h3>
<div class="outline-text-3" id="text-orgf7d46db">
<p>
→ list
</p>

<p>
Returns a list of sublists of foreign key info in the form of
   '((constraint-name local-table local-table-column
     foreign-table-name foreign-column-name))
</p>
</div>
</div>

<div id="outline-container-org9ef0101" class="outline-3">
<h3 id="org9ef0101">function list-unique-or-primary-constraints (table-name)</h3>
<div class="outline-text-3" id="text-org9ef0101">
<p>
→ list
</p>

<p>
List constraints on a table.
</p>
</div>
</div>

<div id="outline-container-org23734e2" class="outline-3">
<h3 id="org23734e2">function list-all-constraints (table-name)</h3>
<div class="outline-text-3" id="text-org23734e2">
<p>
→ list
</p>

<p>
Users information_schema to list all the constraints in a table. Table-name
can be either a string or quoted.
</p>
</div>
</div>

<div id="outline-container-orgb59a7a9" class="outline-3">
<h3 id="orgb59a7a9">function describe-constraint (table-name constraint-name)</h3>
<div class="outline-text-3" id="text-orgb59a7a9">
<p>
→ list
</p>

<p>
Return a list of alists of the descriptions a particular constraint given
the table-name and the constraint name using the information_schema table.
</p>
</div>
</div>

<div id="outline-container-org5f2f52b" class="outline-3">
<h3 id="org5f2f52b">function describe-foreign-key-constraints ()</h3>
<div class="outline-text-3" id="text-org5f2f52b">
<p>
→ list
</p>

<p>
Generates a list of lists of information on the foreign key constraints
</p>
</div>
</div>

<div id="outline-container-org2442647" class="outline-3">
<h3 id="org2442647">function list-triggers (&amp;optional table-name)</h3>
<div class="outline-text-3" id="text-org2442647">
<p>
→ list
</p>

<p>
List distinct trigger names from the information_schema table. Table-name
can be either quoted or string.
</p>
</div>
</div>

<div id="outline-container-orgd915c81" class="outline-3">
<h3 id="orgd915c81">function list-detailed-triggers ()</h3>
<div class="outline-text-3" id="text-orgd915c81">
<p>
→ list
</p>

<p>
List detailed information on the triggers from the information_schema table.
</p>
</div>
</div>

<div id="outline-container-orgdb505fa" class="outline-3">
<h3 id="orgdb505fa">function list-database-users ()</h3>
<div class="outline-text-3" id="text-orgdb505fa">
<p>
→ list
</p>

<p>
List database users.
</p>
</div>
</div>
<div id="outline-container-orgbde46da" class="outline-3">
<h3 id="orgbde46da">function list-available-extensions ()</h3>
<div class="outline-text-3" id="text-orgbde46da">
<p>
→ list
</p>

<p>
List the postgresql extensions which are available in the system to the
currently connected database. The extensions may or may not be installed.
</p>
</div>
</div>
<div id="outline-container-orgd75fa2f" class="outline-3">
<h3 id="orgd75fa2f">function list-installed-extensions ()</h3>
<div class="outline-text-3" id="text-orgd75fa2f">
<p>
→ list
</p>

<p>
List the postgresql extensions which are installed in the currently
connected database.
</p>
</div>
</div>
<div id="outline-container-orgb849d68" class="outline-3">
<h3 id="orgb849d68">function change-toplevel-database (new-database user password host)</h3>
<div class="outline-text-3" id="text-orgb849d68">
<p>
→ string
</p>

<p>
Just changes the database assuming you are using a toplevel connection.
Recommended only for development work. Returns the name of the newly
connected database as a string.
</p>
</div>
</div>
</div>


<div id="outline-container-orgc6b3918" class="outline-2">
<h2 id="orgc6b3918">Database access objects</h2>
<div class="outline-text-2" id="text-orgc6b3918">
<p>
Postmodern contains a simple system for defining CLOS classes that
represent rows in the database. This is not intended as a full-fledged
object-relational magic system ― while serious ORM systems have their place,
they are notoriously hard to get right, and are outside of the scope of
a humble SQL library like this.
</p>
</div>

<div id="outline-container-org007b559" class="outline-3">
<h3 id="org007b559">metaclass dao-class</h3>
<div class="outline-text-3" id="text-org007b559">
<p>
At the heart of Postmodern's DAO system is the dao-class metaclass. It
allows you to define classes for your database-access objects as regular
CLOS classes. Some of the slots in these classes will refer to columns in the
database. To specify that a slot refers to a column, give it a :col-type
option containing an S-SQL type expression (useful if you want to be able
to derive a table definition from the class definition), or simply a :column
option with value T. Such slots can also take a :col-default option, used
to provide a database-side default value as an S-SQL expression. You can
use the :col-name initarg (whose unevaluated value will be passed to
to-sql-name) to specify the slot's column's name.
</p>

<p>
DAO class definitions support two extra class options: :table-name to give
the name of the table that the class refers to (defaults to the class name),
and :keys to provide a set of primary keys for the table. When no primary
keys are defined, operations such as update-dao and get-dao will not work.
</p>

<p>
IMPORTANT: Class finalization for a dao class instance are wrapped with a
thread lock. However, any time you are using threads and a class that inherits
from other classes, you should ensure that classes are finalized before you
start generating threads that create new instances of that class.
</p>

<p>
Simple example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(defclass user ()
  ((name :col-type string :initarg :name :accessor user-name)
   (creditcard :col-type (or db-null integer) :initarg :card :col-default :null)
   (score :col-type bigint :col-default 0 :accessor user-score))
  (:metaclass dao-class)
  (:keys name))
</pre>
</div>

<p>
The (or db-null integer) form is used to indicate a column can have NULL values.
</p>

<p>
When inheriting from DAO classes, a subclass' set of columns also contains all
the columns of its superclasses. The primary key for such a class is the
union of its own keys and all the keys from its superclasses. Classes
inheriting from DAO classes should probably always use the dao-class
metaclass themselves.
</p>

<p>
When a DAO is created with make-instance, the :fetch-defaults keyword
argument can be passed, which, when T, will cause a query to fetch the
default values for all slots that refers to columns with defaults and were
not bound through initargs. In some cases, such as serial columns, which
have an implicit default, this will not work. You can work around this by
creating your own sequence, e.g. "my_sequence", and defining
a (:nextval "my_sequence") default.
</p>

<p>
Finally, DAO class slots can have an option :ghost t to specify them as
ghost slots. These are selected when retrieving instances, but not written
when updating or inserting, or even included in the table definition. The
only known use for this to date is for creating the table with (oids=true),
and specify a slot like this:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(oid :col-type integer :ghost t :accessor get-oid)
</pre>
</div>
</div>
</div>

<div id="outline-container-org78031d7" class="outline-3">
<h3 id="org78031d7">method dao-keys (class)</h3>
<div class="outline-text-3" id="text-org78031d7">
<p>
→ list
</p>

<p>
Returns list of slot names that are the primary key of DAO class.
This is likely interesting if you have primary keys which are composed
of more than one slot. Pay careful attention to situations where the primary
key not only has more than one column, but they are actually in a different
order than they are in the database table itself. You can check this with the
find-primary-key-info function.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(pomo:find-primary-key-info "country1")

(("name" "text") ("id" "integer"))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb288fc7" class="outline-3">
<h3 id="orgb288fc7">method dao-keys (dao)</h3>
<div class="outline-text-3" id="text-orgb288fc7">
<p>
→ list
</p>

<p>
Returns list of values that are the primary key of dao.
</p>
</div>
</div>

<div id="outline-container-org24eaf6f" class="outline-3">
<h3 id="org24eaf6f">method dao-exists-p (dao)</h3>
<div class="outline-text-3" id="text-org24eaf6f">
<p>
→ boolean
</p>

<p>
Test whether a row with the same primary key as the given dao exists in the
database. Will also return NIL when any of the key slots in the object are
unbound.
</p>
</div>
</div>

<div id="outline-container-orga47a748" class="outline-3">
<h3 id="orga47a748">method make-dao (type &amp;rest args &amp;key &amp;allow-other-keys)</h3>
<div class="outline-text-3" id="text-orga47a748">
<p>
→ dao
</p>

<p>
Combines make-instance with insert-dao. Return the created dao.
</p>
</div>
</div>

<div id="outline-container-orge2d47f3" class="outline-3">
<h3 id="orge2d47f3">macro define-dao-finalization (((dao-name class) &amp;rest keyword-args) &amp;body body)</h3>
<div class="outline-text-3" id="text-orge2d47f3">
<p>
Create an :around-method for make-dao. The body is executed in a lexical
environment where dao-name is bound to a freshly created and inserted DAO.
The representation of the DAO in the database is then updated to reflect
changes that body might have introduced. Useful for processing values of
slots with the type serial, which are unknown before insert-dao.
</p>
</div>
</div>

<div id="outline-container-orgbf81cbc" class="outline-3">
<h3 id="orgbf81cbc">method get-dao (type &amp;rest keys)</h3>
<div class="outline-text-3" id="text-orgbf81cbc">
<p>
→ dao
</p>

<p>
Select the DAO object from the row that has the given primary key values, or
NIL if no such row exists. Objects created by this function will have
initialize-instance called on them (after loading in the values from the
database) without any arguments ― even :default-initargs are skipped.
The same goes for select-dao and query-dao.
</p>
</div>
</div>

<div id="outline-container-org1e525fb" class="outline-3">
<h3 id="org1e525fb">macro select-dao (type &amp;optional (test t) &amp;rest sort)</h3>
<div class="outline-text-3" id="text-org1e525fb">
<p>
→ list
</p>

<p>
Select DAO objects for the rows in the associated table for which the given
test (either an S-SQL expression or a string) holds. When sorting arguments
are given, which can also be S-SQL forms or strings, these are used to sort
the result.
</p>

<p>
(Note that, if you want to sort, you have to pass the test argument.)
</p>
<div class="org-src-container">
<pre class="src src-lisp">(select-dao 'user (:&gt; 'score 10000) 'name)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd79fb79" class="outline-3">
<h3 id="orgd79fb79">macro do-select-dao (((type type-var) &amp;optional (test t) &amp;rest sort) &amp;body body)</h3>
<div class="outline-text-3" id="text-orgd79fb79">
<p>
Like select-dao, but iterates over the results rather than returning them.
For each matching DAO, body is evaluated with type-var bound to the DAO
instance.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(do-select-dao (('user user) (:&gt; 'score 10000) 'name)
  (pushnew user high-scorers))
</pre>
</div>
</div>
</div>

<div id="outline-container-orga85e21c" class="outline-3">
<h3 id="orga85e21c">macro query-dao (type query &amp;rest args)</h3>
<div class="outline-text-3" id="text-orga85e21c">
<p>
→ list
</p>

<p>
Execute the given query (which can be either a string or an S-SQL expression)
and return the result as DAOs of the given type. If the query contains
placeholders ($1, $2, etc) their values can be given as extra arguments.
The names of the fields returned by the query must either match slots in
the DAO class, or be bound through with-column-writers.
</p>
</div>
</div>

<div id="outline-container-org67037b3" class="outline-3">
<h3 id="org67037b3">function do-query-dao (((type type-var) query &amp;rest args) &amp;body body)</h3>
<div class="outline-text-3" id="text-org67037b3">
<p>
→ list
</p>

<p>
Like query-dao, but iterates over the results rather than returning them.
For each matching DAO, body is evaluated with type-var bound to the instance.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(do-query-dao (('user user) (:order-by (:select '* :from 'user :where (:&gt; 'score 10000)) 'name))
  (pushnew user high-scorers))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc43848b" class="outline-3">
<h3 id="orgc43848b">variable <b>ignore-unknown-columns</b></h3>
<div class="outline-text-3" id="text-orgc43848b">
<p>
Normally, when get-dao, select-dao, or query-dao finds a column in the database
that's not in the DAO class, it will raise an error. Setting this variable to
a non-NIL will cause it to simply ignore the unknown column.
</p>
</div>
</div>

<div id="outline-container-org3a80ac0" class="outline-3">
<h3 id="org3a80ac0">method insert-dao (dao)</h3>
<div class="outline-text-3" id="text-org3a80ac0">
<p>
→ dao
</p>

<p>
Insert the given dao into the database. Column slots of the object which
are unbound implies the database defaults. Hence, if these columns has
no defaults defined in the database, the the insertion of the dao will
be failed. (This feature only works on PostgreSQL 8.2 and up.)
</p>
</div>
</div>

<div id="outline-container-org43e391f" class="outline-3">
<h3 id="org43e391f">method update-dao (dao)</h3>
<div class="outline-text-3" id="text-org43e391f">
<p>
→ dao
</p>

<p>
Update the representation of the given dao in the database to the values
in the object. This is not defined for tables that do not have any
non-primary-key columns. Raises an error when no row matching the dao exists.
</p>
</div>
</div>

<div id="outline-container-orgd0e20ec" class="outline-3">
<h3 id="orgd0e20ec">function save-dao (dao)</h3>
<div class="outline-text-3" id="text-orgd0e20ec">
<p>
→ boolean
</p>

<p>
Tries to insert the given dao using insert-dao. If this raises a unique key
violation error, it tries to update it by using update-dao instead. Be
aware that there is a possible race condition here ― if some other process
deletes the row at just the right moment, the update fails as well. Returns
a boolean telling you whether a new row was inserted.
</p>

<p>
This function is unsafe to use inside of a transaction ― when a row with the
given keys already exists, the transaction will be aborted. Use
save-dao/transaction instead in such a situation.
</p>

<p>
See also: upsert-dao.
</p>
</div>
</div>

<div id="outline-container-orge0c4e1f" class="outline-3">
<h3 id="orge0c4e1f">function save-dao/transaction (dao)</h3>
<div class="outline-text-3" id="text-orge0c4e1f">
<p>
→ boolean
</p>

<p>
Acts exactly like save-dao, except that it protects its attempt to insert the
object with a rollback point, so that a failure will not abort the transaction.
</p>

<p>
See also: upsert-dao.
</p>
</div>
</div>

<div id="outline-container-org8f0c6f8" class="outline-3">
<h3 id="org8f0c6f8">method upsert-dao (dao)</h3>
<div class="outline-text-3" id="text-org8f0c6f8">
<p>
→ dao
</p>

<p>
Like save-dao or save-dao/transaction but using a different method that doesn't
involve a database exception. This is safe to use both in and outside a
transaction, though it's advisable to always do it in a transaction to
prevent a race condition. The way it works is:
</p>

<p>
If the object contains unbound slots, we call insert-dao directly, thus
the behavior is like save-dao.
</p>

<p>
Otherwise we try to update a record with the same primary key. If the
PostgreSQL returns a non-zero number of rows updated it treated as the
record is already exists in the database, and we stop here.
</p>

<p>
If the PostgreSQL returns a zero number of rows updated, it treated as
the record does not exist and we call insert-dao.
</p>

<p>
The race condition might occur at step 3 if there's no transaction:
if UPDATE returns zero number of rows updated and another thread inserts
the record at that moment, the insertion implied by step 3 will fail.
</p>

<p>
Note, that triggers and rules may affect the number of inserted or updated
rows returned by PostgreSQL, so zero or non-zero number of affected rows may
not actually indicate the existence of record in the database.
</p>

<p>
This method returns two values: the DAO object and a boolean (T if the object
was inserted, NIL if it was updated).
</p>
</div>
</div>

<div id="outline-container-org67bf700" class="outline-3">
<h3 id="org67bf700">method delete-dao (dao)</h3>
<div class="outline-text-3" id="text-org67bf700">
<p>
Delete the given dao from the database.
</p>
</div>
</div>

<div id="outline-container-orge7b7c0b" class="outline-3">
<h3 id="orge7b7c0b">function dao-table-name (class)</h3>
<div class="outline-text-3" id="text-orge7b7c0b">
<p>
→ string
</p>

<p>
Get the name of the table associated with the given DAO class (or
symbol naming such a class).
</p>
</div>
</div>

<div id="outline-container-orgf48f6ce" class="outline-3">
<h3 id="orgf48f6ce">function dao-table-definition (class)</h3>
<div class="outline-text-3" id="text-orgf48f6ce">
<p>
→ string
</p>

<p>
Given a DAO class, or the name of one, this will produce an SQL query string
with a definition of the table. This is just the bare simple definition, so
if you need any extra indices or or constraints, you'll have to write your
own queries to add them, in which case look to s-sql's create-table function.
</p>
</div>
</div>

<div id="outline-container-org59172d0" class="outline-3">
<h3 id="org59172d0">macro with-column-writers ((&amp;rest writers) &amp;body body)</h3>
<div class="outline-text-3" id="text-org59172d0">
<p>
Provides control over the way get-dao, select-dao, and query-dao read values
from the database. This is not commonly needed, but can be used to reduce the
amount of queries a system makes. writers should be a list of alternating
column names (strings or symbols) and writers, where writers are either symbols
referring to a slot in the objects, or functions taking two arguments ― an
instance and a value ― which can be used to somehow store the value in the
new instance. When any DAO-fetching function is called in the body, and columns
matching the given names are encountered in the result, the writers are used
instead of the default behaviour (try and store the value in the slot that
matches the column name).
</p>

<p>
An example of using this is to add some non-column slots to a DAO class, and
use query-dao within a with-column-writers form to pull in extra information
about the objects, and immediately store it in the new instances.
</p>
</div>
</div>
</div>

<div id="outline-container-orgeed8250" class="outline-2">
<h2 id="orgeed8250">Table definition and creation</h2>
<div class="outline-text-2" id="text-orgeed8250">
<p>
It can be useful to have the SQL statements needed to build an application's
tables available from the source code, to do things like automatically
deploying a database. The following macro and functions allow you to group
sets of SQL statements under symbols, with some shortcuts for common elements
in table definitions.
</p>
</div>

<div id="outline-container-org6855342" class="outline-3">
<h3 id="org6855342">macro deftable (name &amp;body definition)</h3>
<div class="outline-text-3" id="text-org6855342">
<p>
Define a table. name can be either a symbol or a (symbol string) list.
In the first case, the table name is derived from the symbol's name by
S-SQL's rules. In the second case, the name is given explicitly. The body
of definitions can contain anything that evaluates to a string, as well
as S-SQL expressions. The variables <b>table-name</b> and <b>table-symbol</b> are
bound to the relevant values in the body. Note that the evaluation of the
definition is ordered, so you'll generally want to create your table first
and then define indices on it.
</p>
</div>
</div>

<div id="outline-container-orgf0d4464" class="outline-3">
<h3 id="orgf0d4464">function !dao-def ()</h3>
<div class="outline-text-3" id="text-orgf0d4464">
<p>
Should only be used inside deftable's body. Adds the result of calling
dao-table-definition on <b>table-symbol</b> to the definition.
</p>
</div>
</div>

<div id="outline-container-org08a3c23" class="outline-3">
<h3 id="org08a3c23">function !index (&amp;rest columns), !unique-index (&amp;rest columns)</h3>
<div class="outline-text-3" id="text-org08a3c23">
<p>
Define an index on the table being defined. The columns can be given as
symbols or strings.
</p>
</div>
</div>

<div id="outline-container-org043be46" class="outline-3">
<h3 id="org043be46">function !foreign (target-table columns &amp;optional target-columns &amp;key on-delete on-update deferrable initially-deferred)</h3>
<div class="outline-text-3" id="text-org043be46">
<p>
Add a foreign key to the table being defined. target-table is the referenced
table. columns is a list of column names or single name in this table, and,
if the columns have different names in the referenced table, target-columns
must be another list of column names or single column name of the target-table,
or :primary-key to denote the column(s) of the target-table's primary key
as referenced column(s).
</p>

<p>
The on-delete and on-update arguments can be used to specify ON DELETE and
ON UPDATE actions, as per the keywords allowed in create-table. In addition,
the deferrable and initially-deferred arguments can be used to indicate whether
constraint checking can be deferred until the current transaction completed,
and whether this should be done by default. Note that none of these are
really &amp;key arguments, but rather are picked out of a &amp;rest arg at runtime,
so that they can be specified even when target-columns is not given.
</p>
</div>
</div>

<div id="outline-container-org8c5c6b9" class="outline-3">
<h3 id="org8c5c6b9">function !unique (target-fields &amp;key deferrable initially-deferred)</h3>
<div class="outline-text-3" id="text-org8c5c6b9">
<p>
Constrains one or more columns to only contain unique (combinations of) values,
with deferrable and initially-deferred defined as in !foreign
</p>
</div>
</div>

<div id="outline-container-orge4b097b" class="outline-3">
<h3 id="orge4b097b">function create-table (symbol)</h3>
<div class="outline-text-3" id="text-orge4b097b">
<p>
Creates the table identified by symbol by executing all forms in its definition.
</p>
</div>
</div>

<div id="outline-container-org2ca2b8d" class="outline-3">
<h3 id="org2ca2b8d">function create-all-tables ()</h3>
<div class="outline-text-3" id="text-org2ca2b8d">
<p>
Creates all defined tables.
</p>
</div>
</div>

<div id="outline-container-org93120ba" class="outline-3">
<h3 id="org93120ba">function create-package-tables (package)</h3>
<div class="outline-text-3" id="text-org93120ba">
<p>
Creates all tables identified by symbols interned in the given package.
</p>
</div>
</div>

<div id="outline-container-org5b3e257" class="outline-3">
<h3 id="org5b3e257">variables <b>table-name</b>, <b>table-symbol</b></h3>
<div class="outline-text-3" id="text-org5b3e257">
<p>
These variables are bound to the relevant name and symbol while the forms of a
table definition are evaluated. Can be used to define shorthands like the ones
below.
</p>
</div>
</div>
</div>

<div id="outline-container-org94988a4" class="outline-2">
<h2 id="org94988a4">Schemata</h2>
<div class="outline-text-2" id="text-org94988a4">
<p>
Schema allow you to separate tables into differnet name spaces. In different
schemata two tables with the same name are allowed to exists. The tables can
be referred by fully qualified names or with the macro with-schema. You could
also set the search path with set-search-path. For listing end checking there
are also the functions list-schemata and schema-exist-p. The following
functions allow you to create, drop schemata and to set the search path.
</p>
</div>

<div id="outline-container-orgfb8a41d" class="outline-3">
<h3 id="orgfb8a41d">function create-schema (schema)</h3>
<div class="outline-text-3" id="text-orgfb8a41d">
<p>
Creates a new schema. Raises an error if the schema is already exists.
</p>
</div>
</div>

<div id="outline-container-orga69ac80" class="outline-3">
<h3 id="orga69ac80">function drop-schema (schema)</h3>
<div class="outline-text-3" id="text-orga69ac80">
<p>
Removes a schema. Raises an error if the schema is not empty.
</p>
</div>
</div>

<div id="outline-container-org2dbd10b" class="outline-3">
<h3 id="org2dbd10b">function get-search-path ()</h3>
<div class="outline-text-3" id="text-org2dbd10b">
<p>
Retrieve the current search path.
</p>
</div>
</div>

<div id="outline-container-org917c9f7" class="outline-3">
<h3 id="org917c9f7">function set-search-path (path)</h3>
<div class="outline-text-3" id="text-org917c9f7">
<p>
Sets the search path to the path. This function is used by with-schema.
</p>
</div>
</div>
<div id="outline-container-orgb8e5556" class="outline-3">
<h3 id="orgb8e5556">function split-fully-qualified-table-name (name)</h3>
<div class="outline-text-3" id="text-orgb8e5556">
<p>
→ list
Takes a name of the form database.schema.table or schema.table or just table
and returns a list in the form '(table schema database)
</p>
</div>
</div>
</div>
<div id="outline-container-org94988a7-muf" class="outline-2">
<h2 id="org94988a4muf">Miscellaneous Utility Functions</h2>
<div class="outline-text-2" id="text-org94988a4mufmuf">
<p>
Miscellaneous utility functions which do not fit above.
</p>
</div>

<div id="outline-container-orgb8e5557e" class="outline-3">
<h3 id="orgb8e5557">function execute-file (filename &optional (print nil))</h3>
<div class="outline-text-3" id="text-orgb8e5557e">
  <p>
    This function will execute sql queries stored in a file.
Each sql statement in the file will be run independently, but
if one statement fails, subsequent query statements will not
be run, but any statement prior to the failing statement will
have been commited.</p>

<p>If you want the standard transction treatment such that all
statements succeed or no statement succeeds, then ensure that
the file starts with a "begin transaction" statement and finishes
with an "end transaction" statement. See the test file
test-execute-file-broken-transaction.sql as an example. </p>

<p>For debugging purposes, if the optional print
parameter is set to t, format will print the count of the query
and the query to the REPL.</p>
<p><strong>IMPORTANT NOTE:</strong> This utility
function assumes that the file containing the sql queries can be trusted
and bypasses the normal postmodern parameterization of queries.
</p>
</div>
</div>

</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2019-04-14 Sun 12:10</p>
</div>
</body>
</html>
