<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2018-09-26 Wed 08:35 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>S-SQL Reference Manual</title>
<meta name="generator" content="Org mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="style.css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">S-SQL Reference Manual</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgc65a05f">Interface</a>
<ul>
<li><a href="#orge5cd5ad">macro sql (form)</a></li>
<li><a href="#org86c74fc">function sql-compile (form)</a></li>
<li><a href="#org074457b">function sql-template (form)</a></li>
<li><a href="#org32d8311">function enable-s-sql-syntax (&amp;optional (char #\Q))</a></li>
<li><a href="#org5d549b8">function sql-escape-string (string)</a></li>
<li><a href="#orge7ac710">method sql-escape (value)</a></li>
<li><a href="#orgb236e1e">variable <b>standard-sql-strings</b></a></li>
<li><a href="#orgee554f6">variable <b>escape-sql-names-p</b></a></li>
<li><a href="#orgb2fbe1a">function sql-type-name (type)</a></li>
<li><a href="#org2eeb263">function to-sql-name (name &amp;optional (escape-p <b>escape-sql-names-p</b>))</a></li>
<li><a href="#org8507f60">function from-sql-name (string)</a></li>
<li><a href="#org820786d">macro register-sql-operators (arity &amp;rest names)</a></li>
</ul>
</li>
<li><a href="#org85cb0cc">SQL Types</a></li>
<li><a href="#orga6895df">SQL Syntax</a>
<ul>
<li><a href="#org5935246">sql-op :select (&amp;rest args)</a></li>
<li><a href="#org792adba">sql-op :+, :*, :%, :&amp;, :|, :||, :and, :or, :=, :/, :!=, :&lt;, :&gt;, :&lt;=, :&gt;=, :^, :union, :union-all, :intersect, :intersect-all, :except, :except-all (&amp;rest args)</a></li>
<li><a href="#org47e6dd7">sql-op :~, :not (arg)</a></li>
<li><a href="#org88fce29">sql-op :function (name (&amp;rest arg-types) return-type stability body)</a></li>
<li><a href="#orgf3cac16">sql-op :~, :~*, :!~, :!~* (string pattern)</a></li>
<li><a href="#orgc2831f4">sql-op :like, :ilike (string pattern)</a></li>
<li><a href="#org4b86ffa">sql-op :@@</a></li>
<li><a href="#org0fd88c4">sql-op :desc (column)</a></li>
<li><a href="#org9d64a0d">sql-op :nulls-first, :nulls-last (column)</a></li>
<li><a href="#org22eec56">sql-op :as (form name &amp;rest fields)</a></li>
<li><a href="#org31082dd">sql-op :cast (query)</a></li>
<li><a href="#orge2f921c">sql-op :type (query)</a></li>
<li><a href="#org92de0df">sql-op :create-composite-type (type-name &amp;rest args)</a></li>
<li><a href="#org1c5a598">sql-op :exists (query)</a></li>
<li><a href="#orgf956899">sql-op :is-null (arg)</a></li>
<li><a href="#org551e73b">sql-op :not-null (arg)</a></li>
<li><a href="#org9a92dba">sql-op :in (value set)</a></li>
<li><a href="#org9de47b8">sql-op :not-in (value set)</a></li>
<li><a href="#orgc3098a7">sql-op :set (&amp;rest elements)</a></li>
<li><a href="#org121b3f7">sql-op :array (query)</a></li>
<li><a href="#orgd8359d4">sql-op :array[] (&amp;rest args)</a></li>
<li><a href="#orgeec890e">sql-op :[] (form start &amp;optional end)</a></li>
<li><a href="#org338f654">sql-op :extract (unit form)</a></li>
<li><a href="#orge90ebff">sql-op :case (&amp;rest clauses)</a></li>
<li><a href="#orgdf54c7d">sql-op :between (n start end)</a></li>
<li><a href="#orgd3fa048">sql-op :between-symmetric (n start end)</a></li>
<li><a href="#org1a04022">sql-op :dot (&amp;rest names)</a></li>
<li><a href="#org2bc675e">sql-op :type (form type)</a></li>
<li><a href="#org941ddad">sql-op :raw (string)</a></li>
<li><a href="#orgb64332b">sql-op :limit (query amount &amp;optional offset)</a></li>
<li><a href="#org9dfb9b1">sql-op :order-by (query &amp;rest exprs)</a></li>
<li><a href="#org5545a40">sql-op :values</a></li>
<li><a href="#org6afff47">sql-op :empty-set</a></li>
<li><a href="#org4fb68d0">sql-op :group-by</a></li>
<li><a href="#orgda21bdd">sql-op :grouping-sets</a></li>
</ul>
</li>
<li><a href="#org3ee5202">Time, Date and Interval Operators</a>
<ul>
<li><a href="#org92ac20f">sql-op :interval (arg)</a></li>
<li><a href="#orgbeb6516">sql-op :current-date ()</a></li>
<li><a href="#org124072f">sql-op :current-time ()</a></li>
<li><a href="#orgdefc84f">sql-op :current-timestamp ()</a></li>
<li><a href="#orgb4000e2">sql-op :timestamp (arg)</a></li>
<li><a href="#org4282e87">sql-op :age (&amp;rest args)</a></li>
<li><a href="#org173732b">sql-op :date (arg)</a></li>
</ul>
</li>
<li><a href="#orgc2cf9a3">Aggregation Operators</a>
<ul>
<li><a href="#org25c0d0e">sql-op :count (&amp;rest args)</a></li>
<li><a href="#org314e6eb">sql-op :avg (&amp;rest rest args)</a></li>
<li><a href="#org65a01bd">sql-op :sum (&amp;rest rest args)</a></li>
<li><a href="#org9d48c62">sql-op ::max (&amp;rest args)</a></li>
<li><a href="#org519bf74">sql-op ::min (&amp;rest args)</a></li>
<li><a href="#orgd8c2971">sql-op ::every (&amp;rest args)</a></li>
<li><a href="#orga314a83">sql-op :percentile-cont (&amp;rest args)</a></li>
<li><a href="#org4e00d20">sql-op :percentile-dist (&amp;rest args)</a></li>
<li><a href="#org05b6f97">sql-op :corr (y x)</a></li>
<li><a href="#org7f05cb7">sql-op :covar-pop (y x)</a></li>
<li><a href="#orgc5f6548">sql-op :covar-samp (y x)</a></li>
<li><a href="#orgc1388b7">sql-op :string-agg (&amp;rest args)</a></li>
<li><a href="#org1d0a91b">sql-op :array-agg (&amp;rest args)</a></li>
<li><a href="#org55cc6ce">sql-op :mode (&amp;rest args)</a></li>
<li><a href="#orgf20befb">sql-op :regr_avgx (y x)</a></li>
<li><a href="#orgff7b61c">sql-op :regr_avgy (y x)</a></li>
<li><a href="#orgeab3f59">sql-op :regr_count (y x)</a></li>
<li><a href="#orgc0c9dce">sql-op :regr_intercept (y x)</a></li>
<li><a href="#org3ec60ad">sql-op :regr_r2 (y x)</a></li>
<li><a href="#org5e15e22">sql-op :regr_slope (y x)</a></li>
<li><a href="#org90dc7ff">sql-op :regr_sxx (y x)</a></li>
<li><a href="#org81f5e15">sql-op :regr_sxy (y x)</a></li>
<li><a href="#org3fba004">sql-op :regr_syy (y x)</a></li>
<li><a href="#orgef930f1">sql-op :stddev (&amp;rest args)</a></li>
<li><a href="#orgc6195e6">sql-op :stddev-pop (&amp;rest args)</a></li>
<li><a href="#org1c974f9">sql-op :stddev-samp (&amp;rest args)</a></li>
<li><a href="#org23541c4">sql-op :variance (&amp;rest args)</a></li>
<li><a href="#orgddc753b">sql-op :var-pop (&amp;rest args)</a></li>
<li><a href="#orge9270ec">sql-op :var-samp (&amp;rest args)</a></li>
<li><a href="#org6c9c6d6">sql-op :over (form &amp;rest args)</a></li>
<li><a href="#orgc951d95">sql-op :partition-by (&amp;rest args)</a></li>
<li><a href="#orgbb71b37">sql-op :window (form)</a></li>
<li><a href="#orgd9a5899">sql-op :with (&amp;rest args)</a></li>
<li><a href="#org3b71ac9">sql-op :with-recursive (&amp;rest args)</a></li>
</ul>
</li>
<li><a href="#orge0d8b12">Table Functions</a>
<ul>
<li><a href="#orgf5b233c">sql-op :for-update (query &amp;key of nowait)</a></li>
<li><a href="#orgdd4a646">sql-op :for-share (query &amp;key of nowait)</a></li>
<li><a href="#org86dffb8">sql-op :insert-into (table &amp;rest rest)</a></li>
<li><a href="#org08ed01d">sql-op :insert-rows-into (table &amp;rest rest)</a></li>
<li><a href="#org47347ed">sql-op :update (table &amp;rest rest)</a></li>
<li><a href="#org70e0cd9">sql-op :delete-from (table &amp;rest rest)</a></li>
<li><a href="#org7137e81">sql-op :create-table (name (&amp;rest columns) &amp;rest options)</a>
<ul>
<li><a href="#org59b212e">Column Definition parameters</a></li>
<li><a href="#org7bd3f37">Table Constraints</a></li>
</ul>
</li>
<li><a href="#orgf424ebb">sql-op :alter-table (name action &amp;rest args)</a></li>
<li><a href="#orgbead7c2">sql-op :drop-table (name)</a></li>
<li><a href="#orga3443aa">sql-op :truncate (&amp;rest args)</a></li>
<li><a href="#orgf4354ff">sql-op :create-index (name &amp;rest args)</a></li>
<li><a href="#orgb540e6e">sql-op :create-unique-index (name &amp;rest args)</a></li>
<li><a href="#org1fc76f4">sql-op :drop-index (name)</a></li>
<li><a href="#org080ffef">sql-op :create-sequence (name &amp;key increment min-value max-value start cache cycle)</a></li>
<li><a href="#org89822f4">sql-op :alter-sequence (name)</a></li>
<li><a href="#org21b6fd3">sql-op :drop-sequence (name)</a></li>
<li><a href="#orgf7fef78">sql-op :create-view (name query)</a></li>
<li><a href="#orgf786c5b">sql-op :drop-view (name)</a></li>
<li><a href="#orgbc43b4c">sql-op :set-constraints (state &amp;rest constraints)</a></li>
<li><a href="#org072a867">sql-op :listen (channel)</a></li>
<li><a href="#orgdebd44a">sql-op :unlisten (channel)</a></li>
<li><a href="#orgaef47c3">sql-op :notify (channel &amp;optional payload)</a></li>
<li><a href="#org5b27744">sql-op :create-role (role &amp;rest args)</a></li>
<li><a href="#orga584cdc">sql-op :create-database (name)</a></li>
<li><a href="#org8fefb9e">sql-op :drop-database (name)</a></li>
<li><a href="#org550c323">sql-op :copy (table &amp;rest args)</a></li>
</ul>
</li>
<li><a href="#orgb8c8a26">Dynamic Queries and Composition</a></li>
</ul>
</div>
</div>
<p>
This is the reference manual for the S-SQL component of the postmodern library.
</p>

<p>
S-SQL provides a lispy syntax for SQL queries, and knows how to convert various
lisp types to their textual SQL representation. It takes care to do as much of
the work as possible at compile-time, so that at runtime a string concatenation
is all that is needed to produce the final SQL query.
</p>

<div id="outline-container-orgc65a05f" class="outline-2">
<h2 id="orgc65a05f">Interface</h2>
<div class="outline-text-2" id="text-orgc65a05f">
</div>
<div id="outline-container-orge5cd5ad" class="outline-3">
<h3 id="orge5cd5ad">macro sql (form)</h3>
<div class="outline-text-3" id="text-orge5cd5ad">
<p>
→ string
</p>

<p>
Convert the given form (a list starting with a keyword) to an SQL query string
at compile time, according to the rules described here.
</p>
</div>
</div>

<div id="outline-container-org86c74fc" class="outline-3">
<h3 id="org86c74fc">function sql-compile (form)</h3>
<div class="outline-text-3" id="text-org86c74fc">
<p>
→ string
</p>

<p>
This is the run-time variant of the sql macro. It converts the given list to
an SQL query, with the same rules except that symbols in this list do not
have to be quoted to be interpreted as identifiers.
</p>
</div>
</div>

<div id="outline-container-org074457b" class="outline-3">
<h3 id="org074457b">function sql-template (form)</h3>
<div class="outline-text-3" id="text-org074457b">
<p>
In cases where you do need to build the query at run time, yet you do not
want to re-compile it all the time, this function can be used to compile it
once and store the result. It takes an S-SQL form, which may contain
\[ placeholder symbols, and returns a function that takes one argument for
every \]. When called, this returned function produces an SQL string in
which the placeholders have been replaced by the values of the arguments.
</p>
</div>
</div>

<div id="outline-container-org32d8311" class="outline-3">
<h3 id="org32d8311">function enable-s-sql-syntax (&amp;optional (char #\Q))</h3>
<div class="outline-text-3" id="text-org32d8311">
<p>
Modifies the current readtable to add a #Q syntax that is read as (sql &#x2026;).
The character to use can be overridden by passing an argument.
</p>
</div>
</div>
<div id="outline-container-org5d549b8" class="outline-3">
<h3 id="org5d549b8">function sql-escape-string (string)</h3>
<div class="outline-text-3" id="text-org5d549b8">
<p>
→ string
</p>

<p>
<a href="http://www.postgresql.org/docs/current/static/sql-syntax-lexical.html#SQL-SYNTAX-STRINGS">Escapes</a> a string for inclusion in a PostgreSQL query.
</p>
</div>
</div>

<div id="outline-container-orge7ac710" class="outline-3">
<h3 id="orge7ac710">method sql-escape (value)</h3>
<div class="outline-text-3" id="text-orge7ac710">
<p>
→ string
</p>

<p>
A generalisation of sql-escape-string Looks at the type of the value passed,
and properly writes it out it for inclusion in an SQL query. Symbols will be
converted to SQL names.
</p>
</div>
</div>

<div id="outline-container-orgb236e1e" class="outline-3">
<h3 id="orgb236e1e">variable <b>standard-sql-strings</b></h3>
<div class="outline-text-3" id="text-orgb236e1e">
<p>
Used to configure whether S-SQL will use standard SQL strings (just replace #\'
with ''), or backslash-style escaping. Setting this to NIL is always safe, but
when the server is configured to allow standard strings (compile-time
parameter 'standard_conforming_strings' is 'on', which will become the default
in future versions of PostgreSQL), the noise in queries can be reduced by setting
this to T.
</p>
</div>
</div>

<div id="outline-container-orgee554f6" class="outline-3">
<h3 id="orgee554f6">variable <b>escape-sql-names-p</b></h3>
<div class="outline-text-3" id="text-orgee554f6">
<p>
Determines whether double quotes are added around column, table, and ** function names in
queries. Valid values:
</p>

<ul class="org-ul">
<li>T, in which case every name is escaped,</li>
<li>NIL, in which case no name is escape,</li>
<li>:auto, which causes only <a href="http://www.postgresql.org/docs/current/static/sql-keywords-appendix.html">reserved words</a> to be escaped, or.</li>
<li>:literal which is the same as :auto except it has added consequence in to-sql-name (see below).</li>
</ul>

<p>
The default value is :auto.
</p>

<p>
Be careful when binding this with let and such ― since a lot of SQL compilation tends to happen at
compile-time, the result might not be what you expect. Mixed case sensitivity is not currently
well supported. Postgresql itself will downcase unquoted identifiers. This will be revisited in the
future if requested.
</p>
</div>
</div>

<div id="outline-container-orgb2fbe1a" class="outline-3">
<h3 id="orgb2fbe1a">function sql-type-name (type)</h3>
<div class="outline-text-3" id="text-orgb2fbe1a">
<p>
→ string
</p>

<p>
Create the SQL equivalent of the given Lisp type, if one is known. See types.
</p>
</div>
</div>

<div id="outline-container-org2eeb263" class="outline-3">
<h3 id="org2eeb263">function to-sql-name (name &amp;optional (escape-p <b>escape-sql-names-p</b>))</h3>
<div class="outline-text-3" id="text-org2eeb263">
<p>
→ string
</p>

<p>
Convert a symbol or string to a name that can be used as an SQL identifier by
converting all non-alphanumeric characters to underscores. Also lowercases the name
to make queries look a bit less hideous. When a second argument is given, this
overrides the current value of <b>escape-sql-names-p</b>. If the second argument
is :literal then the name will be escaped only and this will be a a delimited
identifier or quoted identifier. See
</p>
</div>
</div>

<div id="outline-container-org8507f60" class="outline-3">
<h3 id="org8507f60">function from-sql-name (string)</h3>
<div class="outline-text-3" id="text-org8507f60">
<p>
→ keyword
</p>

<p>
Convert a string that represents an SQL identifier to a keyword by uppercasing
it and converting the underscores to dashes.
</p>
</div>
</div>

<div id="outline-container-org820786d" class="outline-3">
<h3 id="org820786d">macro register-sql-operators (arity &amp;rest names)</h3>
<div class="outline-text-3" id="text-org820786d">
<p>
Define simple SQL operators. Arity is one of :unary (like 'not'), :unary-postfix
(the operator comes after the operand), :n-ary (like '\+': the operator falls away
when there is only one operand), :2+-ary (like '=', which is meaningless for one
operand), or :n-or-unary (like '-', where the operator is kept in the unary case).
After the arity may follow any number of operators, either just a keyword, in
which case the downcased symbol name is used as the SQL operator, or a two-element
list containing a keyword and a name string.
</p>
</div>
</div>
</div>
<div id="outline-container-org85cb0cc" class="outline-2">
<h2 id="org85cb0cc">SQL Types</h2>
<div class="outline-text-2" id="text-org85cb0cc">
<p>
S-SQL knows the SQL equivalents to a number of Lisp types, and defines some
extra types that can be used to denote other SQL types. The following
table shows the correspondence:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">Lisp type</td>
<td class="org-left">SQL type</td>
</tr>

<tr>
<td class="org-left">smallint</td>
<td class="org-left">smallint</td>
</tr>

<tr>
<td class="org-left">integer</td>
<td class="org-left">integer</td>
</tr>

<tr>
<td class="org-left">bigint</td>
<td class="org-left">bigint</td>
</tr>

<tr>
<td class="org-left">(numeric X Y)</td>
<td class="org-left">numeric(X, Y)</td>
</tr>

<tr>
<td class="org-left">float, real</td>
<td class="org-left">real</td>
</tr>

<tr>
<td class="org-left">double-float, double-precision</td>
<td class="org-left">double-precision</td>
</tr>

<tr>
<td class="org-left">string, text</td>
<td class="org-left">text</td>
</tr>

<tr>
<td class="org-left">(string X)</td>
<td class="org-left">char(X)</td>
</tr>

<tr>
<td class="org-left">(varchar X)</td>
<td class="org-left">varchar(X)</td>
</tr>

<tr>
<td class="org-left">boolean</td>
<td class="org-left">boolean</td>
</tr>

<tr>
<td class="org-left">bytea</td>
<td class="org-left">bytea</td>
</tr>

<tr>
<td class="org-left">date</td>
<td class="org-left">date</td>
</tr>

<tr>
<td class="org-left">timestamp</td>
<td class="org-left">timestamp</td>
</tr>

<tr>
<td class="org-left"><a href="interval-info.html">interval</a></td>
<td class="org-left">interval</td>
</tr>

<tr>
<td class="org-left">array</td>
<td class="org-left">array</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
**type db-null
</p>

<p>
This is a type of which only the keyword :null is a member. It is used to represent
NULL values from the database.
</p>
</div>
</div>

<div id="outline-container-orga6895df" class="outline-2">
<h2 id="orga6895df">SQL Syntax</h2>
<div class="outline-text-2" id="text-orga6895df">
<p>
An S-SQL form is converted to a query through the following rules:
</p>

<ul class="org-ul">
<li>Lists starting with a keyword are operators. They are expanded as described below if they are known, otherwise they are expanded in the standard way: operator(arguments, &#x2026;)</li>

<li>Quoted symbols or keywords are interpreted as names of columns or tables, and converted to strings with to-sql-name.</li>

<li>Anything else is evaluated and the resulting Lisp value is converted to its textual SQL representation (or an error is raised when there is no rule for converting objects of this type). Self-quoting atoms may be converted to strings at compile-time.</li>
</ul>
</div>

<div id="outline-container-org5935246" class="outline-3">
<h3 id="org5935246">sql-op :select (&amp;rest args)</h3>
<div class="outline-text-3" id="text-org5935246">
<p>
Creates a select query. The arguments are split on the keywords found among
them. The group of arguments immediately after :select is interpreted as
the expressions that should be selected. After this, an optional :distinct
may follow, which will cause the query to only select distinct rows, or
alternatively :distinct-on followed by a group of row names. Next comes the
optional keyword :from, followed by at least one table name and then any
number of join statements. Join statements start with one of :left-join,
:right-join, :inner-join, :outer-join or :cross-join, then a table name or
subquery, then the keyword :on or :using, if applicable, and then a form.
A join can be preceded by :natural (leaving off the :on clause) to use a
natural join. After the joins an optional :where followed by a single form
may occur. And finally :group-by and :having can optionally be specified.
The first takes any number of arguments, and the second only one. An example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:+ 'field-1 100) 'field-5
        :from (:as 'my-table 'x)
        :left-join 'your-table
        :on (:= 'x.field-2 'your-table.field-1)
        :where (:not-null 'a.field-3)))
</pre>
</div>

<p>
The following operators are defined:
</p>
</div>
</div>

<div id="outline-container-org792adba" class="outline-3">
<h3 id="org792adba">sql-op :+, :*, :%, :&amp;, :|, :||, :and, :or, :=, :/, :!=, :&lt;, :&gt;, :&lt;=, :&gt;=, :^, :union, :union-all, :intersect, :intersect-all, :except, :except-all (&amp;rest args)</h3>
<div class="outline-text-3" id="text-org792adba">
<p>
These are expanded as infix operators. When meaningful, they allow more than
two arguments. :- can also be used as a unary operator to negate a value.
Note that the arguments to :union, :union-all, :intersect, and :except
should be queries (:select forms).
</p>

<p>
Note that you'll have to escape pipe characters to enter them as keywords. S-SQL
handles the empty keyword symbol (written :||) specially, and treats it like :\|\|,
so that it can be written without escapes. With :\|, this doesn't work.
</p>
</div>
</div>

<div id="outline-container-org47e6dd7" class="outline-3">
<h3 id="org47e6dd7">sql-op :~, :not (arg)</h3>
<div class="outline-text-3" id="text-org47e6dd7">
<p>
Unary operators for bitwise and logical negation.
</p>
</div>
</div>

<div id="outline-container-org88fce29" class="outline-3">
<h3 id="org88fce29">sql-op :function (name (&amp;rest arg-types) return-type stability body)</h3>
<div class="outline-text-3" id="text-org88fce29">
<p>
Create a stored procedure. The argument and return types are interpreted as
type names and not evaluated. Stability should be one of :immutable, :stable,
or :volatile (see the PostgreSQL documentation). For example, a function that
gets foobars by id:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(:function 'get-foobar (integer) foobar :stable (:select '* :from 'foobar :where (:= 'id '$1)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf3cac16" class="outline-3">
<h3 id="orgf3cac16">sql-op :~, :~*, :!~, :!~* (string pattern)</h3>
<div class="outline-text-3" id="text-orgf3cac16">
<p>
Regular expression matching operators. The exclamation mark means 'does not match',
the asterisk makes the match case-insensitive.
</p>
</div>
</div>

<div id="outline-container-orgc2831f4" class="outline-3">
<h3 id="orgc2831f4">sql-op :like, :ilike (string pattern)</h3>
<div class="outline-text-3" id="text-orgc2831f4">
<p>
Simple SQL string matching operators (:ilike is case-insensitive).
</p>
</div>
</div>

<div id="outline-container-org4b86ffa" class="outline-3">
<h3 id="org4b86ffa">sql-op :@@</h3>
<div class="outline-text-3" id="text-org4b86ffa">
<p>
Fast Text Search match operator.
</p>
</div>
</div>

<div id="outline-container-org0fd88c4" class="outline-3">
<h3 id="org0fd88c4">sql-op :desc (column)</h3>
<div class="outline-text-3" id="text-org0fd88c4">
<p>
Used to invert the meaning of an operator in an :order-by clause.
</p>
</div>
</div>

<div id="outline-container-org9d64a0d" class="outline-3">
<h3 id="org9d64a0d">sql-op :nulls-first, :nulls-last (column)</h3>
<div class="outline-text-3" id="text-org9d64a0d">
<p>
Used to determine where :null values appear in an :order-by clause.
</p>
</div>
</div>

<div id="outline-container-org22eec56" class="outline-3">
<h3 id="org22eec56">sql-op :as (form name &amp;rest fields)</h3>
<div class="outline-text-3" id="text-org22eec56">
<p>
Assigns a name to a column or table in a :select form. When fields are given,
they are added after the name, in parentheses. For example, (:as 'table1 't1 'foo 'bar)
becomes table1 AS t1(foo, bar). When you need to specify types for the fields,
you can do something like (:as 'table2 't2 ('foo integer)). Note that names are
quoted, types are not (when using sql-compile or sql-template, you can leave
out the quotes entirely).
</p>
</div>
</div>

<div id="outline-container-org31082dd" class="outline-3">
<h3 id="org31082dd">sql-op :cast (query)</h3>
<div class="outline-text-3" id="text-org31082dd">
<p>
The CAST operator. Takes a query as an argument, and returns the result
explicitly cast by postgresql to a specific type.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:cast (:as "20" 'integer)))
        :single)
20

(query (:union (:select (:as 1 'real))
               (:select (:cast (:as "2.2" 'real)))))
((1.0) (2.2))
</pre>
</div>
</div>
</div>
<div id="outline-container-orge2f921c" class="outline-3">
<h3 id="orge2f921c">sql-op :type (query)</h3>
<div class="outline-text-3" id="text-orge2f921c">
<p>
Is similar to cast but uses the postgresql :: formating. E.g.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(sql (:select (:as (:- (:type (:now) date) 'x) 'some-date) :from (:as (:generate-series 1 10) 'x)))

"(SELECT (now()::DATE - x) AS some_date FROM generate_series(1, 10) AS x)"
</pre>
</div>
</div>
</div>
<div id="outline-container-org92de0df" class="outline-3">
<h3 id="org92de0df">sql-op :create-composite-type (type-name &amp;rest args)</h3>
<div class="outline-text-3" id="text-org92de0df">
<p>
Creates a composite type with a type-name and two or more columns. E.g.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:create-composite-type fullname (first-name text) (last-name text)))
</pre>
</div>
</div>
</div>
<div id="outline-container-org1c5a598" class="outline-3">
<h3 id="org1c5a598">sql-op :exists (query)</h3>
<div class="outline-text-3" id="text-org1c5a598">
<p>
The EXISTS operator. Takes a query as an argument, and returns true or false
depending on whether that query returns any rows.
</p>
</div>
</div>

<div id="outline-container-orgf956899" class="outline-3">
<h3 id="orgf956899">sql-op :is-null (arg)</h3>
<div class="outline-text-3" id="text-orgf956899">
<p>
Test whether a value is null.
</p>
</div>
</div>

<div id="outline-container-org551e73b" class="outline-3">
<h3 id="org551e73b">sql-op :not-null (arg)</h3>
<div class="outline-text-3" id="text-org551e73b">
<p>
Test whether a value is not null.
</p>
</div>
</div>
<div id="outline-container-org9a92dba" class="outline-3">
<h3 id="org9a92dba">sql-op :in (value set)</h3>
<div class="outline-text-3" id="text-org9a92dba">
<p>
Test whether a value is in a set of values.
</p>
</div>
</div>

<div id="outline-container-org9de47b8" class="outline-3">
<h3 id="org9de47b8">sql-op :not-in (value set)</h3>
<div class="outline-text-3" id="text-org9de47b8">
<p>
Inverse of the above.
</p>
</div>
</div>

<div id="outline-container-orgc3098a7" class="outline-3">
<h3 id="orgc3098a7">sql-op :set (&amp;rest elements)</h3>
<div class="outline-text-3" id="text-orgc3098a7">
<p>
Denote a set of values. This operator has two interfaces. When
the elements are known at compile-time, they can be given as
multiple arguments to the operator. When they are not, a
single argument that evaluates to a list should be used.
</p>
</div>
</div>

<div id="outline-container-org121b3f7" class="outline-3">
<h3 id="org121b3f7">sql-op :array (query)</h3>
<div class="outline-text-3" id="text-org121b3f7">
<p>
This is used when calling a select query into an array.  See <a href="array-notes.html">array-notes.html</a>
for more detailed notes on the use of arrays.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:order-by
        (:select 'r.rolename
                 (:as (:array
                       (:select 'b.rolename
                                :from (:as 'pg_catalog.pg-auth-members 'm)
                                :inner-join (:as 'pg-catalog.pg-roles 'b)
                                :on (:= 'm.roleid 'b.oid)
                                :where (:= 'm.member 'r.oid )))
                      'memberof)

                 :from (:as 'pg-catalog.pg-roles 'r))
        1))

</pre>
</div>
</div>
</div>

<div id="outline-container-orgd8359d4" class="outline-3">
<h3 id="orgd8359d4">sql-op :array[] (&amp;rest args)</h3>
<div class="outline-text-3" id="text-orgd8359d4">
<p>
This is the general operator for arrays. It also handles statements that include
functions in the query such as (:+ 1 2), (:pi) in the array. See <a href="array-notes.html">array-notes.html</a>
for more detailed notes on the use of arrays.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:array-prepend 1 (:array[] 2 3))))

((#(1 2 3)))

(query (:select (:array-prepend 1 (:array[] 2 3)))
       :single)

#(1 2 3)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgeec890e" class="outline-3">
<h3 id="orgeec890e">sql-op :[] (form start &amp;optional end)</h3>
<div class="outline-text-3" id="text-orgeec890e">
<p>
Dereference an array value. If end is provided, extract a slice of the array.
Sample usage below, but also see <a href="array-notes.html">array-notes.html</a> for more detailed notes on
the use of arrays.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select 'receipe-id (:[] 'tags 2 3)
                :from 'receipe-tags-array
                :where (:= 'receipe-id 3)))
</pre>
</div>
</div>
</div>

<div id="outline-container-org338f654" class="outline-3">
<h3 id="org338f654">sql-op :extract (unit form)</h3>
<div class="outline-text-3" id="text-org338f654">
<p>
Extract a field from a date/time value. For example, (:extract :month (:now)).
</p>
</div>
</div>

<div id="outline-container-orge90ebff" class="outline-3">
<h3 id="orge90ebff">sql-op :case (&amp;rest clauses)</h3>
<div class="outline-text-3" id="text-orge90ebff">
<p>
A conditional expression. Clauses should take the form (test value). If
test is :else, an ELSE clause will be generated.
</p>
</div>
</div>

<div id="outline-container-orgdf54c7d" class="outline-3">
<h3 id="orgdf54c7d">sql-op :between (n start end)</h3>
<div class="outline-text-3" id="text-orgdf54c7d">
<p>
Test whether a value lies between two other values.
</p>
</div>
</div>

<div id="outline-container-orgd3fa048" class="outline-3">
<h3 id="orgd3fa048">sql-op :between-symmetric (n start end)</h3>
<div class="outline-text-3" id="text-orgd3fa048">
<p>
Works like :between, except that the start value is not required to be
less than the end value.
</p>
</div>
</div>

<div id="outline-container-org1a04022" class="outline-3">
<h3 id="org1a04022">sql-op :dot (&amp;rest names)</h3>
<div class="outline-text-3" id="text-org1a04022">
<p>
Can be used to combine multiple names into a name of the form A.B to
refer to a column in a table, or a table in a schema. Note that you
can also just use a symbol with a dot in it.
</p>
</div>
</div>

<div id="outline-container-org2bc675e" class="outline-3">
<h3 id="org2bc675e">sql-op :type (form type)</h3>
<div class="outline-text-3" id="text-org2bc675e">
<p>
Add a type declaration to a value, as in in "4.3::real". The second
argument is not evaluated normally, but put through sql-type-name to
get a type identifier.
</p>
</div>
</div>

<div id="outline-container-org941ddad" class="outline-3">
<h3 id="org941ddad">sql-op :raw (string)</h3>
<div class="outline-text-3" id="text-org941ddad">
<p>
Insert a string as-is into the query. This can be useful for doing things
that the syntax does not support, or to re-use parts of a query across
multiple queries:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(let* ((test (sql (:and (:= 'foo 22) (:not-null 'bar))))
       (rows (query (:select '* :from 'baz :where (:raw test)))))
  (query (:delete-from 'baz :where (:raw test)))
  (do-stuff rows))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb64332b" class="outline-3">
<h3 id="orgb64332b">sql-op :limit (query amount &amp;optional offset)</h3>
<div class="outline-text-3" id="text-orgb64332b">
<p>
In S-SQL limit is not part of the select operator, but an extra
operator that is applied to a query (this works out better when limiting
the union or intersection of multiple queries, same for sorting).
It limits the number of results to the amount given as the second
argument, and optionally offsets the result by the amount given
as the third argument.
</p>
</div>
</div>

<div id="outline-container-org9dfb9b1" class="outline-3">
<h3 id="org9dfb9b1">sql-op :order-by (query &amp;rest exprs)</h3>
<div class="outline-text-3" id="text-org9dfb9b1">
<p>
Order the results of a query by the given expressions. See :desc for
when you want to invert an ordering. Note: This is not the same as
passing an :order-by parameter to an aggregation operator.
See Aggregation Operators.
</p>
</div>
</div>

<div id="outline-container-org5545a40" class="outline-3">
<h3 id="org5545a40">sql-op :values</h3>
<div class="outline-text-3" id="text-org5545a40">
<p>
Values computes a row value or set of row values for use in a specific
query. See the postgresql docs at:
<a href="https://www.postgresql.org/docs/current/static/queries-values.html">https://www.postgresql.org/docs/current/static/queries-values.html</a>
and <a href="https://www.postgresql.org/docs/current/static/sql-values.html">https://www.postgresql.org/docs/current/static/sql-values.html</a>
Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select '*
                :from (:as (:values (:set 1 "one")
                                    (:set 2 "two")
                                    (:set 3 "three"))
                           (:t1 'num 'letter))))

(query (:select 'a 'b 'c (:cast (:as (:* 50 (:random)) 'int))
                :from (:as (:values (:set "a") (:set "b")) (:d1 'a))
                (:as (:values (:set "c") (:set "d")) (:d2 'b))
                (:as (:values (:set "e") (:set "f")) (:d3 'c))))

(query
 (:with-recursive
  (:as (:t1 'n)
       (:union-all (:values (:set 1))
                   (:select (:+ 'n 1)
                            :from 't1
                            :where (:&lt; 'n 100))))
  (:select (:sum 'n) :from 't1))
 :single)
</pre>
</div>
</div>
</div>

<div id="outline-container-org6afff47" class="outline-3">
<h3 id="org6afff47">sql-op :empty-set</h3>
<div class="outline-text-3" id="text-org6afff47">
<p>
This is a fudge. It returns a string "()" where something like '()
would return "false" or :() would throw an error. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select 'appnumber 'day (:sum 'inserts)
                (:sum 'updates) (:sum 'deletes) (:sum 'transactions)
                :from 'db-details
                :group-by (:grouping-sets (:set 'appnumber 'day (:empty-set)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org4fb68d0" class="outline-3">
<h3 id="org4fb68d0">sql-op :group-by</h3>
<div class="outline-text-3" id="text-org4fb68d0">
<p>
<a href="https://www.postgresql.org/docs/current/static/queries-table-expressions.html#QUERIES-GROUPING-SETS">https://www.postgresql.org/docs/current/static/queries-table-expressions.html#QUERIES-GROUPING-SETS</a>
The GROUP BY Clause is used to group together those rows in a table that
have the same values in all the columns listed. The order in which the
columns are listed does not matter. The effect is to combine each set of
rows having common values into one group row that represents all rows in
the group. This is done to eliminate redundancy in the output and/or compute
aggregates that apply to these groups. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:order-by
        (:select 'mems.surname 'mems.firstname 'mems.memid (:as (:min 'bks.starttime) 'starttime)
                 :from (:as 'cd.bookings 'bks)
                 :inner-join (:as 'cd.members 'mems)
                 :on (:= 'mems.memid 'bks.memid)
                 :where (:&gt;= 'starttime "2012-09-01")
                 :group-by 'mems.surname 'mems.firstname 'mems.memid)
        'mems.memid))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgda21bdd" class="outline-3">
<h3 id="orgda21bdd">sql-op :grouping-sets</h3>
<div class="outline-text-3" id="text-orgda21bdd">
<p>
<a href="https://www.postgresql.org/docs/current/static/queries-table-expressions.html#QUERIES-GROUPING-SETS">https://www.postgresql.org/docs/current/static/queries-table-expressions.html#QUERIES-GROUPING-SETS</a>
More complex grouping operations are possible using the concept of grouping
sets. The data selected by the FROM and WHERE clauses is grouped separately
by each specified grouping set, aggregates computed for each group just as
for simple GROUP BY clauses, and then the results returned.
This operator requires postgresql 9.5 or later. For example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select 'city (:as (:extract 'year 'start-date)  'joining-year) (:as (:count 1) 'employee_count)
                :from 'employee
                :group-by (:grouping-sets (:set 'city (:extract 'year 'start-date)))))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org3ee5202" class="outline-2">
<h2 id="org3ee5202">Time, Date and Interval Operators</h2>
<div class="outline-text-2" id="text-org3ee5202">
</div>
<div id="outline-container-org92ac20f" class="outline-3">
<h3 id="org92ac20f">sql-op :interval (arg)</h3>
<div class="outline-text-3" id="text-org92ac20f">
<p>
Creates an interval data type, generally represented in postmodern as an alist
</p>
</div>
</div>
<div id="outline-container-orgbeb6516" class="outline-3">
<h3 id="orgbeb6516">sql-op :current-date ()</h3>
</div>
<div id="outline-container-org124072f" class="outline-3">
<h3 id="org124072f">sql-op :current-time ()</h3>
</div>
<div id="outline-container-orgdefc84f" class="outline-3">
<h3 id="orgdefc84f">sql-op :current-timestamp ()</h3>
</div>
<div id="outline-container-orgb4000e2" class="outline-3">
<h3 id="orgb4000e2">sql-op :timestamp (arg)</h3>
</div>
<div id="outline-container-org4282e87" class="outline-3">
<h3 id="org4282e87">sql-op :age (&amp;rest args)</h3>
</div>
<div id="outline-container-org173732b" class="outline-3">
<h3 id="org173732b">sql-op :date (arg)</h3>
</div>
</div>
<div id="outline-container-orgc2cf9a3" class="outline-2">
<h2 id="orgc2cf9a3">Aggregation Operators</h2>
<div class="outline-text-2" id="text-orgc2cf9a3">
</div>
<div id="outline-container-org25c0d0e" class="outline-3">
<h3 id="org25c0d0e">sql-op :count (&amp;rest args)</h3>
<div class="outline-text-3" id="text-org25c0d0e">
<p>
Count returns the number of rows for which the expression is not null.
It can be the number of rows collected by the select statement as in:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:count '*)
                :from 'table1
                :where (:= 'price 100)))
</pre>
</div>

<p>
or it can be a smaller number of rows based on the allowed keyword
parameters :distinct and :filter or some other type of condition as in:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:count 'memid :distinct)
                :from 'cd.bookings))
</pre>
</div>
<p>
or
</p>

<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:as (:count '* :distinct) 'unfiltered)
                (:as (:count '* :filter (:= 1 'bid))
                     'filtered)
                :from 'testtable))
</pre>
</div>

<p>
Note that if used, the filter must be last in the count args. If distinct
is used, it must come before filter. Unlike standard sql, the word 'where'
is not used inside the filter clause. E.g.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:count '*)
                (:count '* :filter (:= 1 'bid))
                'id
                :from 'pbbench-history))
</pre>
</div>

<p>
See tests.lisp for examples.
</p>
</div>
</div>

<div id="outline-container-org314e6eb" class="outline-3">
<h3 id="org314e6eb">sql-op :avg (&amp;rest rest args)</h3>
<div class="outline-text-3" id="text-org314e6eb">
<p>
Avg calculates the average value of a list of values. Note that if the
filter keyword is used, the filter must be last in the avg args. If distinct
is used, it must come before filter. E.g. See tests.lisp for more examples.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:avg '*) (:avg '* :filter (:= 1 'bid)) 'id
                :from 'pbbench-history))
</pre>
</div>
</div>
</div>

<div id="outline-container-org65a01bd" class="outline-3">
<h3 id="org65a01bd">sql-op :sum (&amp;rest rest args)</h3>
<div class="outline-text-3" id="text-org65a01bd">
<p>
Sum calculates the total of a list of values. Note that if the keyword filter
is used, the filter must be last in the sum args. If distinct is used, it
must come before filter. Unlike standard sql, the word 'where' is not used
inside the filter clause (s-sql will properly expand it). See tests.lisp
for more examples.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:sum '*) (:sum '* :filter (:= 1 'bid)) 'id
                :from 'pbbench-history))
</pre>
</div>
</div>
</div>

<div id="outline-container-org9d48c62" class="outline-3">
<h3 id="org9d48c62">sql-op ::max (&amp;rest args)</h3>
<div class="outline-text-3" id="text-org9d48c62">
<p>
max returns the maximum value of a set of values. Note that if the filter
keyword is used, the filter must be last in the max args. If distinct is
used, it must come before filter. Unlike standard sql, the word 'where'
is not used inside the filter clause (s-sql will properly expand it).
See tests.lisp for more examples.
</p>

<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:max '*) (:max '* :filter (:= 1 'bid)) 'id
                :from 'pbbench-history))
</pre>
</div>
</div>
</div>
<div id="outline-container-org519bf74" class="outline-3">
<h3 id="org519bf74">sql-op ::min (&amp;rest args)</h3>
<div class="outline-text-3" id="text-org519bf74">
<p>
min returns the minimum value of a set of values. Note that if the filter
keyword is used, the filter must be last in the min args. If distinct is
used, it must come before filter. Unlike standard sql, the word 'where'
is not used inside the filter clause (s-sql will properly expand it).
See tests.lisp for more examples.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:min '*) (:min '* :filter (:= 1 'bid)) 'id
                :from 'pbbench-history))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd8c2971" class="outline-3">
<h3 id="orgd8c2971">sql-op ::every (&amp;rest args)</h3>
<div class="outline-text-3" id="text-orgd8c2971">
<p>
Every returns true if all input values are true, otherwise false. Note
that if the filter keyword is used, the filter must be last in the every
args. If distinct is used, it must come before filter. Unlike standard sql,
the word 'where' is not used inside the filter clause (s-sql will
properly expand it). See tests.lisp for more examples.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select '* (:every (:like 'studname "%h"))
                :from 'tbl-students
                :group-by 'studname 'studid 'studgrades))
</pre>
</div>
</div>
</div>

<div id="outline-container-orga314a83" class="outline-3">
<h3 id="orga314a83">sql-op :percentile-cont (&amp;rest args)</h3>
<div class="outline-text-3" id="text-orga314a83">
<p>
Requires Postgresql 9.4 or higher. Percentile-cont returns a value
corresponding to the specified fraction in the ordering, interpolating
between adjacent input items if needed. There are two required keyword
parameters :fraction and :order-by. If the fraction value is an array,
then it returns an array of results matching the shape of the fractions
parameter, with each non-null element replaced by the value corresponding
to that percentile. Examples:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:percentile-cont :fraction 0.5 :order-by 'number-of-staff)
                :from 'schools))

(query (:select (:percentile-cont :fraction array[0.25 0.5 0.75 1]
                                  :order-by 'number-of-staff)
                :from  'schools))
</pre>
</div>
</div>
</div>


<div id="outline-container-org4e00d20" class="outline-3">
<h3 id="org4e00d20">sql-op :percentile-dist (&amp;rest args)</h3>
<div class="outline-text-3" id="text-org4e00d20">
<p>
Requires Postgresql 9.4 or higher. There are two required keyword parameters
:fraction and :order-by. Percentile-dist returns the first input value whose
position in the ordering equals or exceeds the specified fraction. If the
fraction parameter is an array eturns an array of results matching the shape
of the fractions parameter, with each non-null element replaced by the input
value corresponding to that percentile. Examples:
</p>

<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:percentile-dist :fraction 0.5
                                  :order-by 'number-of-staff)
                :from 'schools))

(query (:select (:percentile-dist :fraction array[0.25 0.5 0.75 1]
                                  :order-by 'number-of-staff)
                :from  'schools))

</pre>
</div>
</div>
</div>

<div id="outline-container-org05b6f97" class="outline-3">
<h3 id="org05b6f97">sql-op :corr (y x)</h3>
<div class="outline-text-3" id="text-org05b6f97">
<p>
The corr function returns the correlation coefficient between a set of
dependent and independent variables. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:corr 'height 'weight)
                :from 'people))
</pre>
</div>
</div>
</div>

<div id="outline-container-org7f05cb7" class="outline-3">
<h3 id="org7f05cb7">sql-op :covar-pop (y x)</h3>
<div class="outline-text-3" id="text-org7f05cb7">
<p>
The covar-pop function returns the population covariance between a set of
dependent and independent variables. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:covar-pop 'height 'weight)
                :from 'people))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc5f6548" class="outline-3">
<h3 id="orgc5f6548">sql-op :covar-samp (y x)</h3>
<div class="outline-text-3" id="text-orgc5f6548">
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:covar-samp 'height 'weight)
                :from 'people))
</pre>
</div>
<p>
The covar-samp function returns the sample covariance between a set of
dependent and independent variables. Example:
</p>
</div>
</div>

<div id="outline-container-orgc1388b7" class="outline-3">
<h3 id="orgc1388b7">sql-op :string-agg (&amp;rest args)</h3>
<div class="outline-text-3" id="text-orgc1388b7">
<p>
String-agg allows you to concatenate strings using different types of
delimiter symbols. Allowable optional keyword parameters are :distinct,
:order-by and :filter Note that order-by in string-agg requires
postgresql 9.0 or later. Filter requires postgresql 9.4 or later.
See tests.lisp for more examples.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:as (:string-agg 'bp.step-type \",\" )
                     'step-summary)
                :from 'business-process))

(query (:select 'mid (:as (:string-agg  'y \",\" :distinct :order-by (:desc 'y))
                          'words)
                :from 'moves))

(query (:select (:string-agg  'name "," :order-by (:desc 'name) :filter (:&lt; 'id 4))
                :from 'employee))
</pre>
</div>
</div>
</div>

<div id="outline-container-org1d0a91b" class="outline-3">
<h3 id="org1d0a91b">sql-op :array-agg (&amp;rest args)</h3>
<div class="outline-text-3" id="text-org1d0a91b">
<p>
Array-agg returns a list of values concatenated into an arrays.
Allowable optional keyword parameters are :distinct, :order-by
and :filter.
</p>

<p>
Note that order-by in array-agg requires postgresql 9.0 or later.
Filter requires postgresql 9.4 or later. See <a href="array-notes.html">array-notes.html</a> for more
detailed notes on the use of arrays.
</p>

<p>
Example with Filter:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select 'g.id
                (:as (:array-agg 'g.users :filter (:= 'g.canonical \"Y\"))
                     'canonical-users)
                (:as (:array-agg 'g.users :filter (:= 'g.canonical \"N\"))
                     'non-canonical-users)
                :from (:as 'groups 'g)
                :group-by 'g.id))
</pre>
</div>
</div>
</div>

<div id="outline-container-org55cc6ce" class="outline-3">
<h3 id="org55cc6ce">sql-op :mode (&amp;rest args)</h3>
<div class="outline-text-3" id="text-org55cc6ce">
<p>
Mode is used to find the most frequent input value in a group.
See e.g. <a href="https://www.postgresql.org/docs/10/static/functions-aggregate.html#FUNCTIONS-ORDEREDSET-TABLE">https://www.postgresql.org/docs/10/static/functions-aggregate.html#FUNCTIONS-ORDEREDSET-TABLE</a>
and article at <a href="https://tapoueh.org/blog/2017/11/the-mode-ordered-set-aggregate-function">https://tapoueh.org/blog/2017/11/the-mode-ordered-set-aggregate-function</a>
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:mode 'items)
                :from 'item-table))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf20befb" class="outline-3">
<h3 id="orgf20befb">sql-op :regr_avgx (y x)</h3>
<div class="outline-text-3" id="text-orgf20befb">
<p>
The regr_avgx function returns the average of the independent variable
(sum(X)/N) Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:regr_avgx 'height 'weight)
                :from 'people))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgff7b61c" class="outline-3">
<h3 id="orgff7b61c">sql-op :regr_avgy (y x)</h3>
<div class="outline-text-3" id="text-orgff7b61c">
<p>
The regr_avgy function returns the average of the dependent variable
(sum(Y)/N). Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">
</pre>
</div>
<p>
(query (:select (:regr_avgy 'height 'weight)
                :from 'people))
</p>
</div>
</div>
<div id="outline-container-orgeab3f59" class="outline-3">
<h3 id="orgeab3f59">sql-op :regr_count (y x)</h3>
<div class="outline-text-3" id="text-orgeab3f59">
<p>
The regr_count function returns the number of input rows in which both
expressions are nonnull. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:regr_count 'height 'weight)
                :from 'people))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc0c9dce" class="outline-3">
<h3 id="orgc0c9dce">sql-op :regr_intercept (y x)</h3>
<div class="outline-text-3" id="text-orgc0c9dce">
<p>
The regr_intercept function returns the y-intercept of the least-squares-fit
linear equation determined by the (X, Y) pairs. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:regr_intercept 'height 'weight)
                :from 'people))
</pre>
</div>
</div>
</div>

<div id="outline-container-org3ec60ad" class="outline-3">
<h3 id="org3ec60ad">sql-op :regr_r2 (y x)</h3>
<div class="outline-text-3" id="text-org3ec60ad">
<p>
The regr_r2 function returns the square of the correlation coefficient. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:regr_r2 'height 'weight)
                :from 'people))
</pre>
</div>
</div>
</div>

<div id="outline-container-org5e15e22" class="outline-3">
<h3 id="org5e15e22">sql-op :regr_slope (y x)</h3>
<div class="outline-text-3" id="text-org5e15e22">
<p>
The regr_slope function returns the slope of the least-squares-fit linear
equation determined by the (X, Y) pairs. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:regr_slope 'height 'weight)
                :from 'people))
</pre>
</div>
</div>
</div>

<div id="outline-container-org90dc7ff" class="outline-3">
<h3 id="org90dc7ff">sql-op :regr_sxx (y x)</h3>
<div class="outline-text-3" id="text-org90dc7ff">
<p>
The regr_sxx function returns the sum(X^2) - sum(X)^2/N (“sum of squares” of
the independent variable). Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:regr_sxx 'height 'weight)
                :from 'people))
</pre>
</div>
</div>
</div>

<div id="outline-container-org81f5e15" class="outline-3">
<h3 id="org81f5e15">sql-op :regr_sxy (y x)</h3>
<div class="outline-text-3" id="text-org81f5e15">
<p>
The regr_sxy function returns the sum(X*Y) - sum(X) * sum(Y)/N (“sum of products”
of independent times dependent variable). Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:regr_sxy 'height 'weight)
                :from 'people))
</pre>
</div>
</div>
</div>

<div id="outline-container-org3fba004" class="outline-3">
<h3 id="org3fba004">sql-op :regr_syy (y x)</h3>
<div class="outline-text-3" id="text-org3fba004">
<p>
The regr_syy function returns the sum(Y^2) - sum(Y)^2/N (“sum of squares”
of the dependent variable). Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:regr_syy 'salary 'age)
                :from 'employee))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgef930f1" class="outline-3">
<h3 id="orgef930f1">sql-op :stddev (&amp;rest args)</h3>
<div class="outline-text-3" id="text-orgef930f1">
<p>
The stddev function returns the the sample standard deviation of the input
values. It is a historical alias for stddev-samp. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:stddev 'salary)
                :from 'employee))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc6195e6" class="outline-3">
<h3 id="orgc6195e6">sql-op :stddev-pop (&amp;rest args)</h3>
<div class="outline-text-3" id="text-orgc6195e6">
<p>
The stddev-pop function returns the population standard deviation of the
input values. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:stddev-pop 'salary)
                :from 'employee))
</pre>
</div>
</div>
</div>

<div id="outline-container-org1c974f9" class="outline-3">
<h3 id="org1c974f9">sql-op :stddev-samp (&amp;rest args)</h3>
<div class="outline-text-3" id="text-org1c974f9">
<p>
The stddev-samp function returns the sample standard deviation of the
input values. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:stddev-samp 'salary)
                :from 'employee))
</pre>
</div>
</div>
</div>

<div id="outline-container-org23541c4" class="outline-3">
<h3 id="org23541c4">sql-op :variance (&amp;rest args)</h3>
<div class="outline-text-3" id="text-org23541c4">
<p>
Variance is a historical alias for var_samp. The variance function returns
the sample variance of the input values (square of the sample standard deviation).
Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:variance 'salary)
                :from 'employee))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgddc753b" class="outline-3">
<h3 id="orgddc753b">sql-op :var-pop (&amp;rest args)</h3>
<div class="outline-text-3" id="text-orgddc753b">
<p>
The var-pop function returns the population variance of the input values
(square of the population standard deviation). Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:var-pop 'salary)
                :from 'employee)
       :single)
</pre>
</div>
</div>
</div>

<div id="outline-container-orge9270ec" class="outline-3">
<h3 id="orge9270ec">sql-op :var-samp (&amp;rest args)</h3>
<div class="outline-text-3" id="text-orge9270ec">
<p>
The var-samp function returns the sample variance of the input values
(square of the sample standard deviation). Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:var-samp 'salary)
                :from 'employee)
       :single)
</pre>
</div>

<p>
Window Functions
</p>
</div>
</div>
<div id="outline-container-org6c9c6d6" class="outline-3">
<h3 id="org6c9c6d6">sql-op :over (form &amp;rest args)</h3>
<div class="outline-text-3" id="text-org6c9c6d6">
<p>
Over, partition-by and window are so-called window functions. A window
function performs a calculation across a set of table rows that are
somehow related to the current row.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select 'salary (:over (:sum 'salary))
                :from 'empsalary))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc951d95" class="outline-3">
<h3 id="orgc951d95">sql-op :partition-by (&amp;rest args)</h3>
<div class="outline-text-3" id="text-orgc951d95">
<p>
Args is a list of one or more columns to partition by, optionally
followed by an :order-by clause.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select 'depname 'subdepname 'empno 'salary
                (:over (:avg 'salary)
                       (:partition-by 'depname 'subdepname))
                :from 'empsalary))
</pre>
</div>

<p>
Note the use of :order-by without parens:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:select 'depname 'empno 'salary
                (:over (:rank)
                       (:partition-by 'depname :order-by (:desc 'salary)))
                :from 'empsalary))
</pre>
</div>
</div>
</div>


<div id="outline-container-orgbb71b37" class="outline-3">
<h3 id="orgbb71b37">sql-op :window (form)</h3>
<div class="outline-text-3" id="text-orgbb71b37">
<div class="org-src-container">
<pre class="src src-lisp">(query (:select (:over (:sum 'salary) 'w)
                (:over (:avg 'salary) 'w)
                :from 'empsalary :window
                (:as 'w (:partition-by 'depname :order-by (:desc 'salary)))))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd9a5899" class="outline-3">
<h3 id="orgd9a5899">sql-op :with (&amp;rest args)</h3>
<div class="outline-text-3" id="text-orgd9a5899">
<p>
With provides a way to write auxillary statements for use in a larger query,
often referred to as Common Table Expressions or CTEs.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:with (:as 'upd
                   (:parens
                    (:update 'employees :set 'sales-count (:+ 'sales-count 1)
                             :where (:= 'id
                                        (:select 'sales-person
                                                 :from 'accounts
                                                 :where (:= 'name "Acme Corporation")))
                             :returning '*)))
              (:insert-into 'employees-log
                            (:select '* (:current-timestamp) :from
                                     'upd))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org3b71ac9" class="outline-3">
<h3 id="org3b71ac9">sql-op :with-recursive (&amp;rest args)</h3>
<div class="outline-text-3" id="text-org3b71ac9">
<p>
Recursive modifier to a WITH statement, allowing the query to refer to its own output.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:with-recursive
      (:as (:t1 'n)
           (:union-all (:values (:set 1))
                       (:select (:+ 'n 1)
                                :from 't1
                                :where (:&lt; 'n 100))))
      (:select (:sum 'n) :from 't1)))

(query (:with-recursive
      (:as (:included_parts 'sub-part 'part 'quantity)
           (:union-all
            (:select 'sub-part 'part 'quantity
                     :from 'parts
                     :where (:= 'part "our-product"))
            (:select 'p.sub-part 'p.part 'p.quantity
                     :from (:as 'included-parts 'pr)
                     (:as 'parts 'p)
                     :where (:= 'p.part 'pr.sub-part) )))
      (:select 'sub-part (:as (:sum 'quantity) 'total-quantity)
               :from 'included-parts
               :group-by 'sub-part)))

(query (:with-recursive
      (:as (:search-graph 'id 'link 'data 'depth)
           (:union-all (:select 'g.id 'g.link 'g.data 1
                                :from (:as 'graph 'g))
                       (:select 'g.id 'g.link 'g.data (:+ 'sg.depth 1)
                                :from (:as 'graph 'g) (:as 'search-graph 'sg)
                                :where (:= 'g.id 'sg.link))))
      (:select '* :from 'search-graph)))

(query (:with-recursive
      (:as (:search-graph 'id 'link 'data'depth 'path 'cycle)
           (:union-all
            (:select 'g.id 'g.link 'g.data 1
                     (:[] 'g.f1 'g.f2) nil
                     :from (:as 'graph 'g))
            (:select 'g.id 'g.link 'g.data (:+ 'sg.depth 1)
                     (:|| 'path (:row 'g.f1 'g.f2))
                     (:= (:row 'g.f1 'g.f2)
                         (:any* 'path))
                     :from (:as 'graph 'g)
                     (:as 'search-graph 'sg)
                     :where (:and (:= 'g.id 'sg.link)
                                  (:not 'cycle)))))
      (:select '* :from 'search-graph)))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orge0d8b12" class="outline-2">
<h2 id="orge0d8b12">Table Functions</h2>
<div class="outline-text-2" id="text-orge0d8b12">
</div>
<div id="outline-container-orgf5b233c" class="outline-3">
<h3 id="orgf5b233c">sql-op :for-update (query &amp;key of nowait)</h3>
<div class="outline-text-3" id="text-orgf5b233c">
<p>
Locks the selected rows against concurrent updates. This will prevent the
rows from being modified or deleted by other transactions until the current
transaction ends. The :of keyword should be followed by one or more table
names. If provided, PostgreSQL will lock these tables instead of the ones
detected in the select statement. The :nowait keyword should be provided
by itself (with no argument attached to it), after all the :of arguments.
If :nowait is provided, PostgreSQL will throw an error if a table cannot be
locked immediately, instead of pausing until it's possible.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:for-update (:select :* :from 'foo 'bar 'baz) :of 'bar 'baz :nowait))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdd4a646" class="outline-3">
<h3 id="orgdd4a646">sql-op :for-share (query &amp;key of nowait)</h3>
<div class="outline-text-3" id="text-orgdd4a646">
<p>
Similar to :for-update, except it acquires a shared lock on the table,
allowing other transactions to perform :for-share selects on the locked
tables.
</p>
</div>
</div>

<div id="outline-container-org86dffb8" class="outline-3">
<h3 id="org86dffb8">sql-op :insert-into (table &amp;rest rest)</h3>
<div class="outline-text-3" id="text-org86dffb8">
<p>
Insert a row into a table. When the second argument is :set, the other
arguments should be alternating field names and values, otherwise it
should be a :select form that will produce the values to be inserted.
Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:insert-into 'my-table :set 'field-1 42 'field-2 "foobar"))
</pre>
</div>

<p>
It is possible to add :returning, followed by a list of field names or
expressions, at the end of the :insert-into form. This will cause the
query to return the values of these expressions as a single row.
</p>

<p>
In postgresql versions 9.5 and above, it is possible to add
:on-conflict-do-nothing (if the item already exists, do nothing),
or :on-conflict-update (if the item already exists, update the values)
followed by a list of field names which are checked for the conflict
then using :update-set followed by a list of field names or expressions
following the syntax for updating a table. This is sometimes called
an "upsert". Note that as per the postgresql sql documentation you must
prepend the table name to the column in the where statement if you are updating.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:insert-into 'test-table :set 'column-A '$1 'column-B '$2
                     :on-conflict-update 'column-A
                     :update-set 'column-B '$2
                     :where (:= 'test-table.column-A '$1)) "c" 37)
</pre>
</div>
</div>
</div>

<div id="outline-container-org08ed01d" class="outline-3">
<h3 id="org08ed01d">sql-op :insert-rows-into (table &amp;rest rest)</h3>
<div class="outline-text-3" id="text-org08ed01d">
<p>
Insert multiple rows into a table. Specify the columns first with the
keyword :columns then provide a list of lists of the values as a
parameter to the keyword :values. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:insert-rows-into 'my-table :columns 'field-1 'field-2
                                    :values '((42 "foobar") (23 "foobaz"))))
</pre>
</div>

<p>
If you will use the default columns, this can be simplified and the :columns
parameters can be dropped. Example:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:insert-rows-into 'my-table
                          :values '((42 "foobar") (23 "foobaz"))))
</pre>
</div>
</div>
</div>

<div id="outline-container-org47347ed" class="outline-3">
<h3 id="org47347ed">sql-op :update (table &amp;rest rest)</h3>
<div class="outline-text-3" id="text-org47347ed">
<p>
Update values in a table. After the table name there should follow the
keyword :set and any number of alternating field names and values, like
for :insert-into. Next comes the optional keyword :from, followed by at
least one table name and then any number of join statements, like for
:select. After the joins, an optional :where keyword followed by the condition,
and :returning keyword followed by a list of field names or expressions
indicating values to be returned as query result.
</p>
</div>
</div>

<div id="outline-container-org70e0cd9" class="outline-3">
<h3 id="org70e0cd9">sql-op :delete-from (table &amp;rest rest)</h3>
<div class="outline-text-3" id="text-org70e0cd9">
<p>
Delete rows from the named table. Can be given a :where argument followed
by a condition, and a :returning argument, followed by one or more
expressions that should be returned for every deleted row.
</p>
</div>
</div>

<div id="outline-container-org7137e81" class="outline-3">
<h3 id="org7137e81">sql-op :create-table (name (&amp;rest columns) &amp;rest options)</h3>
<div class="outline-text-3" id="text-org7137e81">
<p>
Create a new table.
</p>
</div>
<div id="outline-container-org59b212e" class="outline-4">
<h4 id="org59b212e">Column Definition parameters</h4>
<div class="outline-text-4" id="text-org59b212e">
<p>
After the table name a list of column definitions
follows, which are lists that start with a name, followed by one or
more of the following keyword arguments:
</p>

<ul class="org-ul">
<li>:type</li>
</ul>

<p>
This one is required. It specifies the type of the column. Use a type like
(or db-null integer) to specify a column that may have NULL values.
</p>

<ul class="org-ul">
<li>:default</li>
</ul>

<p>
Provides a default value for the field.
</p>

<ul class="org-ul">
<li>:unique</li>
</ul>

<p>
If this argument is non-nil, the values of the column must be unique.
</p>

<ul class="org-ul">
<li>:primary-key</li>
</ul>

<p>
When non-nil, the column is a primary key of the table.
</p>

<ul class="org-ul">
<li>:check</li>
</ul>

<p>
Adds a constraint to this column. The value provided for this argument must
be an S-SQL expression that returns a boolean value. It can refer to other
columns in the table if needed.
</p>

<ul class="org-ul">
<li>:references</li>
</ul>

<p>
Adds a foreign key constraint to this table. The argument provided must be a
list of the form (target &amp;optional on-delete on-update). When target is a
symbol, it names the table to whose primary key this constraint refers. When
it is a list, its first element is the table, and its second element the
column within that table that the key refers to. on-delete and on-update
can be used to specify the actions that must be taken when the row that this
key refers to is deleted or changed. Allowed values are :restrict, :set-null,
</p>

<ul class="org-ul">
<li>:set-default, :cascade, and :no-action.</li>
</ul>
</div>
</div>

<div id="outline-container-org7bd3f37" class="outline-4">
<h4 id="org7bd3f37">Table Constraints</h4>
<div class="outline-text-4" id="text-org7bd3f37">
<p>
After the list of columns, zero or more extra options (table constraints) can
be specified. These are lists starting with one of the following keywords:
</p>

<ul class="org-ul">
<li>:check</li>
</ul>

<p>
Adds a constraint to the table. Takes a single S-SQL expression that produces
a boolean as its argument.
</p>

<ul class="org-ul">
<li>:primary-key</li>
</ul>

<p>
Specifies a primary key for the table. The arguments to this option are the
names of the columns that this key consists of.
</p>

<ul class="org-ul">
<li>:unique</li>
</ul>

<p>
Adds a unique constraint to a group of columns. Again, the arguments are a
list of symbols that indicate the relevant columns.
</p>

<ul class="org-ul">
<li>:foreign-key</li>
</ul>

<p>
Create a foreign key. The arguments should have the form
(columns target &amp;optional on-delete on-update), where columns is a list of
columns that are used by this key, while the rest of the arguments have
the same meaning as they have in the :references option for columns.
Every list can start with :constraint name to create a specifically named
constraint.
</p>

<p>
Note that, unlike most other operators, :create-table expects most of its
arguments to be unquoted symbols. The exception to this is the value
of :check constraints: These must be normal S-SQL expressions, which means
that any column names they contain should be quoted. When programmatically
generating table definitions, sql-compile is usually more practical than
the sql macro.
</p>

<p>
Here is an example of a :create-table form:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(:create-table enemy
  ((name :type string :primary-key t)
   (age :type integer)
   (address :type (or db-null string) :references (important-addresses :cascade :cascade))
   (fatal-weakness :type text :default "None")
   (identifying-color :type (string 20) :unique t))
  (:foreign-key (identifying-color) (colors name))
  (:constraint enemy-age-check :check (:&gt; 'age 12)))
</pre>
</div>
<p>
For more detail and examples on building tables
using the s-sql approach, see <a href="create-tables.html">create-tables.html</a>
</p>
</div>
</div>
</div>

<div id="outline-container-orgf424ebb" class="outline-3">
<h3 id="orgf424ebb">sql-op :alter-table (name action &amp;rest args)</h3>
<div class="outline-text-3" id="text-orgf424ebb">
<p>
Alters named table. Currently changing a column's data type is not supported.
The meaning of args depends on action:
</p>

<ul class="org-ul">
<li>:add-column</li>
</ul>

<p>
Adds column to table. args should be a column in the same form as for :create-table.
</p>

<ul class="org-ul">
<li>:drop-column</li>
</ul>

<p>
Drops a column from the table.
</p>

<ul class="org-ul">
<li>:add-constraint</li>
</ul>

<p>
Adds a named constraint to the table.
</p>

<ul class="org-ul">
<li>:drop-constraint</li>
</ul>

<p>
Drops constraint. First of args should name a constraint to be dropped; second,
optional argument specifies behaviour regarding objects dependent on the
constraint and it may equal :cascade or :restrict.
</p>

<ul class="org-ul">
<li>:add</li>
</ul>

<p>
Adds an unnamed constraint to table. args should be a constraint in the same
form as for :create-table. (This is for backwards-compatibility, you should
use named constraints.)
</p>

<ul class="org-ul">
<li>:rename</li>
</ul>

<p>
Adds the ability to rename a table.
</p>

<ul class="org-ul">
<li>:rename-column</li>
</ul>

<p>
Adds the ability to rename a column of a table.
</p>

<p>
Here is an example using the table defined above:
</p>
<div class="org-src-container">
<pre class="src src-lsip">(query (alter-table enemy :drop-constraint enemy-age-check))

(query (:alter-table enemy :add-constraint enemy-age-check :check (:&gt; 'age 21)))
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbead7c2" class="outline-3">
<h3 id="orgbead7c2">sql-op :drop-table (name)</h3>
<div class="outline-text-3" id="text-orgbead7c2">
<p>
Drops the named table. You may optionally pass :if-exists before the name
to suppress the error message. You can also optionally pass :cascade after
the name to indicate that it should also drop any other tables, indices,
etc which depend on that table.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:drop-table :if-exists 'table1 :cascade))
</pre>
</div>
</div>
</div>

<div id="outline-container-orga3443aa" class="outline-3">
<h3 id="orga3443aa">sql-op :truncate (&amp;rest args)</h3>
<div class="outline-text-3" id="text-orga3443aa">
<p>
Truncates one or more tables, deleting all the rows. Optional keyword arguments are
allowed in the following order. Note that :continue-identity and :restart-identity
make no sense if both are included.
</p>

<ul class="org-ul">
<li>:only (if not specified, the table and its descendants are truncated).</li>
<li>:continue-identity (the values of sequences will not be changed. This is the default)</li>
<li>:restart-identity (the values of sequences owned by the table(s) will be restarted)</li>
<li>:cascade (will cascade the truncation through tables using foreign keys.)</li>
</ul>

<p>
Example calls would be:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:truncate 'bigtable 'fattable))

(query (:truncate 'bigtable 'fattable :only))

(query (:truncate 'bigtable 'fattable :only :continue-identity))

(query (:truncate 'bigtable 'fattable :restart-identity))

(query (:truncate 'bigtable 'fattable :only :restart-identity :cascade ))

</pre>
</div>
</div>
</div>

<div id="outline-container-orgf4354ff" class="outline-3">
<h3 id="orgf4354ff">sql-op :create-index (name &amp;rest args)</h3>
<div class="outline-text-3" id="text-orgf4354ff">
<p>
Create an index on a table. After the name of the index the keyword :on should
follow, with the table name after it. Then the keyword :fields, followed by
one or more column names. Optionally, a :where clause with a condition can
be added at the end to make a partial index.
</p>

<div class="org-src-container">
<pre class="src src-lisp">(sql (:create-index 'gin-idx :on "historical-events" :using gin :fields 'data))

"CREATE INDEX gin_idx ON historical_events USING GIN (data)"
</pre>
</div>
</div>
</div>


<div id="outline-container-orgb540e6e" class="outline-3">
<h3 id="orgb540e6e">sql-op :create-unique-index (name &amp;rest args)</h3>
<div class="outline-text-3" id="text-orgb540e6e">
<p>
Works like :create-index, except that the index created is unique.
</p>
</div>
</div>

<div id="outline-container-org1fc76f4" class="outline-3">
<h3 id="org1fc76f4">sql-op :drop-index (name)</h3>
<div class="outline-text-3" id="text-org1fc76f4">
<p>
Drop an index. Takes an :if-exists argument like :drop-table.
</p>
</div>
</div>

<div id="outline-container-org080ffef" class="outline-3">
<h3 id="org080ffef">sql-op :create-sequence (name &amp;key increment min-value max-value start cache cycle)</h3>
<div class="outline-text-3" id="text-org080ffef">
<p>
Create a sequence with the given name. The rest of the arguments control
the way the sequence selects values.
</p>
</div>
</div>

<div id="outline-container-org89822f4" class="outline-3">
<h3 id="org89822f4">sql-op :alter-sequence (name)</h3>
<div class="outline-text-3" id="text-org89822f4">
<p>
Alters a sequence. See <a href="https://www.postgresql.org/docs/10/static/sql-altersequence.html">Postgresql documentation</a> for parameters.
</p>

<ul class="org-ul">
<li>:increment</li>
</ul>

<p>
Sets the amount by which each subsequent increment will be increased.
</p>

<ul class="org-ul">
<li>:min-value</li>

<li>:max-value</li>

<li>:no-min</li>

<li>:no-max</li>

<li>:start</li>

<li>:restart</li>

<li>:cache</li>

<li>:cycle</li>

<li>:no-cycle</li>

<li>:owned-by</li>

<li>:if-exists before the name to suppress the error message.</li>
</ul>
</div>
</div>

<div id="outline-container-org21b6fd3" class="outline-3">
<h3 id="org21b6fd3">sql-op :drop-sequence (name)</h3>
<div class="outline-text-3" id="text-org21b6fd3">
<p>
Drop a sequence. You may pass :if-exists as an extra first argument.
</p>
</div>
</div>

<div id="outline-container-orgf7fef78" class="outline-3">
<h3 id="orgf7fef78">sql-op :create-view (name query)</h3>
<div class="outline-text-3" id="text-orgf7fef78">
<p>
Create a view from an S-SQL-style query.
</p>
</div>
</div>

<div id="outline-container-orgf786c5b" class="outline-3">
<h3 id="orgf786c5b">sql-op :drop-view (name)</h3>
<div class="outline-text-3" id="text-orgf786c5b">
<p>
Drop a view. Takes optional :if-exists argument.
</p>
</div>
</div>

<div id="outline-container-orgbc43b4c" class="outline-3">
<h3 id="orgbc43b4c">sql-op :set-constraints (state &amp;rest constraints)</h3>
<div class="outline-text-3" id="text-orgbc43b4c">
<p>
Configure whether deferrable constraints should be checked when a statement
is executed, or when the transaction containing that statement is completed.
The provided state must be either :immediate, indicating the former,
or :deferred, indicating the latter. The constraints must be either the
names of the constraints to be configured, or unspecified, indicating that
all deferrable constraints should be thus configured.
</p>
</div>
</div>

<div id="outline-container-org072a867" class="outline-3">
<h3 id="org072a867">sql-op :listen (channel)</h3>
<div class="outline-text-3" id="text-org072a867">
<p>
Tell the server to listen for notification events on channel channel,
a string, on the current connection.
</p>
</div>
</div>

<div id="outline-container-orgdebd44a" class="outline-3">
<h3 id="orgdebd44a">sql-op :unlisten (channel)</h3>
<div class="outline-text-3" id="text-orgdebd44a">
<p>
Stop listening for events on channel.
</p>
</div>
</div>

<div id="outline-container-orgaef47c3" class="outline-3">
<h3 id="orgaef47c3">sql-op :notify (channel &amp;optional payload)</h3>
<div class="outline-text-3" id="text-orgaef47c3">
<p>
Signal a notification event on channel channel, a string. The optional
payload string can be used to send additional event information to the listeners.
</p>
</div>
</div>

<div id="outline-container-org5b27744" class="outline-3">
<h3 id="org5b27744">sql-op :create-role (role &amp;rest args)</h3>
<div class="outline-text-3" id="text-org5b27744">
<p>
Create a new role (user). Following the role name are optional keywords
arguments:
</p>

<ul class="org-ul">
<li>:options</li>
</ul>

<p>
One or more of the no-parameter options to PostgreSQL's CREATE ROLE SQL command.
</p>

<ul class="org-ul">
<li>:password</li>
</ul>

<p>
Sets the role's password. (A password is only of use for roles having the LOGIN
attribute, but you can nonetheless define one for roles without it.) If you do
not plan to use password authentication you can omit this option. If no
password is specified, the password will be set to null and password
authentication will always fail for that user.
</p>

<ul class="org-ul">
<li>:connection-limit</li>
</ul>

<p>
If role can log in, this specifies how many concurrent connections the role can
make. -1 (the default) means no limit.
</p>

<ul class="org-ul">
<li>:valid-until</li>
</ul>

<p>
The :valid-until clause sets a date and time after which the role's password
is no longer valid. If this clause is omitted the password will be valid for
all time.
</p>

<ul class="org-ul">
<li>:role</li>
</ul>

<p>
Lists one or more existing roles which are automatically added as members of
the new role. (This in effect makes the new role a “group”.)
</p>

<ul class="org-ul">
<li>:in-role</li>
</ul>

<p>
Lists one or more existing roles to which the new role will be immediately
added as a new member.
</p>

<p>
Here is an example of a :create-role form:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query (:create-role 'user23
                     :options 'SUPERUSER 'NOINHERIT 'LOGIN
                     :password "mypassword"
                     :connection-limit 100 :role 'users))
</pre>
</div>
</div>
</div>

<div id="outline-container-orga584cdc" class="outline-3">
<h3 id="orga584cdc">sql-op :create-database (name)</h3>
<div class="outline-text-3" id="text-orga584cdc">
<p>
Create a new database with the given name.
</p>
</div>
</div>

<div id="outline-container-org8fefb9e" class="outline-3">
<h3 id="org8fefb9e">sql-op :drop-database (name)</h3>
<div class="outline-text-3" id="text-org8fefb9e">
<p>
Drops the named database. You may optionally pass :if-exists before the
name to suppress the error message.
</p>
</div>
</div>

<div id="outline-container-org550c323" class="outline-3">
<h3 id="org550c323">sql-op :copy (table &amp;rest args)</h3>
<div class="outline-text-3" id="text-org550c323">
<p>
Move data between Postgres tables and filesystem files. Table name is required
followed by one or more of the following keyword arguments. Documentation for
the copy command provides a full reference. An example from the Greenplum
tutorial:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(query
   (:copy 'faa.d_airlines
    :columns 'airlineid 'airline_desc
    :from "/home/gpadmin/gpdb-sandbox-tutorials/faa/L_AIRLINE_ID.csv"
    :on-segment t
    :binary t
    :oids t
    :header t
    :delimiter ","
    :null "NULL"
    :escape "my-escape-string"
    :newline "CR"
    :csv t
    :log-errors t
    :segment-reject-limit 100 'ROWS))

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgb8c8a26" class="outline-2">
<h2 id="orgb8c8a26">Dynamic Queries and Composition</h2>
<div class="outline-text-2" id="text-orgb8c8a26">
<p>
See <a href="dynamic-queries.html">Dynamic-Queries.html</a>
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Created: 2018-09-26 Wed 08:35</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
